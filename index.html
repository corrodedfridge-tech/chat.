<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat.</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--bg-primary:#36393f;--bg-secondary:#2f3136;--bg-tertiary:#202225;--accent:#5865F2;--white:#fff;--text-muted:#b9bbbe;--border:#202225;--danger:#ed4245;--success:#3ba55c}
        body{font-family:'Inter',sans-serif;background:var(--bg-primary);color:var(--white);height:100vh;overflow:hidden;display:flex}
        
        /* Auth & Loading */
        .loading-screen{position:fixed;inset:0;background:#202225;display:flex;justify-content:center;align-items:center;z-index:9999;font-size:24px;font-weight:700}
        .auth-container{position:fixed;inset:0;background:#36393f;display:none;justify-content:center;align-items:center;z-index:5000}
        .auth-card{background:#2f3136;padding:32px;border-radius:5px;width:100%;max-width:480px;box-shadow:0 2px 10px 0 rgba(0,0,0,0.2)}
        .form-label{display:block;color:var(--text-muted);font-size:12px;font-weight:700;margin-bottom:8px;text-transform:uppercase}
        .form-input{width:100%;padding:10px;background:#202225;border:1px solid #202225;color:var(--white);border-radius:3px;margin-bottom:20px;outline:none}
        .form-input:focus{border-color:#7289da}
        .btn{width:100%;padding:12px;border:none;border-radius:3px;background:var(--accent);color:#fff;font-weight:600;cursor:pointer;font-size:16px}
        .btn:hover{background:#4752c4}
        .btn-link{background:none;border:none;color:#00aff4;cursor:pointer;font-size:14px;margin-top:10px}
        
        /* App Layout */
        .app-container{display:none;width:100%;height:100%}
        .app-container.active{display:flex}
        
        /* Server Bar */
        .servers-bar{width:72px;background:var(--bg-tertiary);display:flex;flex-direction:column;align-items:center;padding:12px 0;gap:8px;overflow-y:auto}
        .server-icon{width:48px;height:48px;border-radius:50%;background:#36393f;color:#dcddde;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:0.2s;font-weight:600;overflow:hidden;font-size:14px}
        .server-icon:hover,.server-icon.active{border-radius:16px;background:var(--accent);color:#fff}
        .server-icon img{width:100%;height:100%;object-fit:cover}
        .separator{width:32px;height:2px;background:#36393f;border-radius:1px}
        
        /* Sidebar */
        .sidebar{width:240px;background:var(--bg-secondary);display:flex;flex-direction:column}
        .sidebar-header{height:48px;padding:0 16px;display:flex;align-items:center;font-weight:600;box-shadow:0 1px 0 rgba(0,0,0,0.2);justify-content:space-between}
        .sidebar-content{flex:1;overflow-y:auto;padding:8px}
        .channel-item{display:flex;align-items:center;padding:6px 8px;border-radius:4px;color:var(--text-muted);cursor:pointer;margin-bottom:2px}
        .channel-item:hover,.channel-item.active{background:var(--bg-primary);color:var(--white)}
        .channel-name{margin-left:6px;font-weight:500}
        
        /* User Panel */
        .user-panel{background:#292b2f;padding:10px 8px;display:flex;align-items:center}
        .up-avatar{width:32px;height:32px;border-radius:50%;background:#faa61a;margin-right:8px;overflow:hidden}
        .up-avatar img{width:100%;height:100%;object-fit:cover}
        .up-info{flex:1;overflow:hidden}
        .up-username{font-size:14px;font-weight:600;white-space:nowrap}
        .up-tag{font-size:12px;color:var(--text-muted)}
        .icon-btn{background:none;border:none;color:var(--text-muted);cursor:pointer;padding:5px}
        .icon-btn:hover{color:var(--white)}
        
        /* Chat Area */
        .chat-area{flex:1;background:var(--bg-primary);display:flex;flex-direction:column;min-width:0}
        .chat-header{height:48px;padding:0 16px;display:flex;align-items:center;box-shadow:0 1px 0 rgba(0,0,0,0.2);font-weight:700}
        .chat-messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column}
        
        /* Message */
        .message{display:flex;margin-top:17px}
        .message:hover{background:rgba(0,0,0,0.02)}
        .message.stacked{margin-top:0}
        .msg-pfp{width:40px;height:40px;border-radius:50%;background:#333;margin-right:16px;flex-shrink:0;overflow:hidden;cursor:pointer}
        .msg-pfp img{width:100%;height:100%;object-fit:cover}
        .message.stacked .msg-pfp{width:0;margin-right:56px;opacity:0}
        .msg-content{flex:1;min-width:0}
        .msg-meta{display:flex;align-items:baseline;gap:8px}
        .message.stacked .msg-meta{display:none}
        .msg-user{font-weight:600;cursor:pointer}
        .msg-user:hover{text-decoration:underline}
        .msg-time{font-size:12px;color:var(--text-muted)}
        .msg-text{color:#dcddde;white-space:pre-wrap;word-break:break-word;line-height:1.375rem}
        .msg-img{max-width:400px;max-height:300px;border-radius:8px;margin-top:5px;cursor:pointer}
        
        /* Input */
        .chat-input-wrapper{padding:0 16px 24px}
        .chat-input{background:#40444b;border-radius:8px;padding:11px;display:flex;align-items:center}
        .chat-upload{color:var(--text-muted);background:none;border:none;cursor:pointer;padding:0 10px;font-size:20px}
        .chat-upload:hover{color:var(--white)}
        .chat-field{flex:1;background:transparent;border:none;color:var(--white);outline:none;font-size:15px;max-height:140px;overflow-y:auto}
        
        /* Modal */
        .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;justify-content:center;align-items:center;z-index:6000}
        .modal{background:#36393f;padding:24px;border-radius:5px;width:440px;position:relative}
        .modal h3{margin-bottom:16px;text-align:center;text-transform:uppercase}
        .close-modal{position:absolute;top:10px;right:10px;background:none;border:none;color:#aaa;cursor:pointer}
        .hidden{display:none!important}
    </style>
</head><body>
    <div class="loading-screen" id="loader">Starting...</div>

    <!-- AUTH -->
    <div class="auth-container" id="authUI">
        <div class="auth-card">
            <h2 style="text-align:center;color:#fff;margin-bottom:8px">Welcome Back!</h2>
            <p style="text-align:center;color:#b9bbbe;margin-bottom:20px">We're so excited to see you again!</p>
            
            <form id="authForm">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="email" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="password" class="form-input" required>
                </div>
                <button type="submit" class="btn">Log In</button>
            </form>
            <button class="btn-link" id="toggleAuthMode">Need an account? Register</button>
            <div style="margin-top:15px;border-top:1px solid #3f4147;padding-top:15px">
                <button class="btn" style="background:#fff;color:#000" id="googleBtn">Continue with Google</button>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div class="app-container" id="appUI">
        <!-- SERVER LIST -->
        <div class="servers-bar">
            <div class="server-icon active" id="homeBtn" title="Home">DM</div>
            <div class="separator"></div>
            <div id="serverList" style="display:flex;flex-direction:column;gap:8px;width:100%;align-items:center"></div>
            <div class="server-icon" style="color:var(--success);background:#36393f" id="addServerBtn">+</div>
        </div>

        <!-- SIDEBAR -->
        <div class="sidebar">
            <!-- DM Sidebar -->
            <div id="dmSidebar">
                <div class="sidebar-header">
                    <span>Friends</span>
                    <button class="icon-btn" id="addFriendBtn">‚ûï</button>
                </div>
                <div class="sidebar-content" id="friendsList">
                    <div style="padding:10px;color:#72767d;font-size:13px;text-align:center">No friends yet.</div>
                </div>
            </div>

            <!-- Server Sidebar -->
            <div id="serverSidebar" class="hidden">
                <div class="sidebar-header">
                    <span id="serverNameDisp">Server</span>
                    <button class="icon-btn" id="leaveServerBtn" style="color:var(--danger)">‚úï</button>
                </div>
                <div class="sidebar-content">
                    <div style="padding:6px 8px;color:#8e9297;font-size:12px;font-weight:700">CHANNELS <span style="float:right;cursor:pointer" id="createChannelBtn">‚ûï</span></div>
                    <div id="channelList"></div>
                </div>
            </div>

            <!-- User Panel -->
            <div class="user-panel">
                <div class="up-avatar" id="myPfpBtn"><img id="myPfp" src=""></div>
                <div class="up-info">
                    <div class="up-username" id="myName">User</div>
                    <div class="up-tag" id="myUserTag">#0000</div>
                </div>
                <button class="icon-btn" id="settingsBtn">‚öôÔ∏è</button>
            </div>
        </div>

        <!-- CHAT -->
        <div class="chat-area">
            <div class="chat-header">
                <span style="font-size:20px;margin-right:10px;color:#72767d">#</span>
                <span id="headerTitle">Select a chat</span>
            </div>
            <div class="chat-messages" id="messagesList"></div>
            <div class="chat-input-wrapper" id="inputWrapper">
                <div class="chat-input">
                    <button class="chat-upload" id="uploadBtn">üì∑</button>
                    <input type="file" id="fileInput" accept="image/*" hidden>
                    <textarea class="chat-field" id="msgInput" placeholder="Message..." rows="1"></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div class="modal-bg" id="modalOverlay">
        
        <!-- Username Picker (Forced) -->
        <div class="modal hidden" id="usernameModal">
            <h3>Finish Registration</h3>
            <p style="color:#b9bbbe;margin-bottom:15px;font-size:14px">Please pick a unique username to continue.</p>
            <label class="form-label">Username</label>
            <input class="form-input" id="pickUsername" placeholder="cool_user_123">
            <button class="btn" id="saveUsernameBtn">Start Chatting</button>
        </div>

        <!-- Add Friend -->
        <div class="modal hidden" id="friendModal">
            <button class="close-modal">‚úï</button>
            <h3>Add Friend</h3>
            <label class="form-label">Username</label>
            <input class="form-input" id="friendUser" placeholder="username">
            <button class="btn" id="submitFriend">Send Request</button>
        </div>

        <!-- Add Server -->
        <div class="modal hidden" id="serverModal">
            <button class="close-modal">‚úï</button>
            <h3>Add Server</h3>
            <label class="form-label">Server Name</label>
            <input class="form-input" id="newServerName" placeholder="My Awesome Server">
            <button class="btn" id="createServer">Create</button>
            <div style="text-align:center;margin:15px 0;color:#72767d">OR</div>
            <label class="form-label">Invite Code</label>
            <input class="form-input" id="inviteCode" placeholder="Code">
            <button class="btn" style="background:#3ba55c" id="joinServer">Join</button>
        </div>

        <!-- Settings -->
        <div class="modal hidden" id="settingsModal">
            <button class="close-modal">‚úï</button>
            <h3>My Profile</h3>
            <div style="display:flex;justify-content:center;margin-bottom:15px">
                <div class="up-avatar" style="width:80px;height:80px"><img id="settingPfp"></div>
            </div>
            <button class="btn" style="margin-bottom:15px;background:#4f545c" onclick="document.getElementById('pfpUpload').click()">Change Avatar</button>
            <input type="file" id="pfpUpload" accept="image/*" hidden>
            
            <label class="form-label">Display Name</label>
            <input class="form-input" id="settingDisp">
            
            <label class="form-label">Bio</label>
            <input class="form-input" id="settingBio">
            
            <button class="btn" id="saveSettings">Save Changes</button>
            <button class="btn" style="margin-top:10px;background:#ed4245" id="logoutBtn">Log Out</button>
        </div>
    </div>    <!-- SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBJMIUucxOusoVzs4lc-QurCxjlW6Hlsuw",
            authDomain: "chat-5f0bf.firebaseapp.com",
            projectId: "chat-5f0bf",
            storageBucket: "chat-5f0bf.firebasestorage.app",
            messagingSenderId: "211425841353",
            appId: "1:211425841353:web:e1c271a340d73abd0cfd18"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let userDoc = null; // Contains username, bio, etc.
        let ctx = 'dm'; // 'dm' or 'server'
        let activeId = null; // Friend UID or Server ID
        let activeSubId = null; // Channel ID
        let msgUnsub = null;

        // AUTH STATE
        auth.onAuthStateChanged(async (user) => {
            if(user) {
                currentUser = user;
                // Check if profile exists
                const doc = await db.collection('users').doc(user.uid).get();
                if(!doc.exists || !doc.data().username) {
                    // Force username selection
                    document.getElementById('loader').style.display='none';
                    document.getElementById('authUI').style.display='none';
                    openModal('usernameModal');
                } else {
                    userDoc = doc.data();
                    initApp();
                }
            } else {
                document.getElementById('loader').style.display='none';
                document.getElementById('authUI').style.display='flex';
                document.getElementById('appUI').classList.remove('active');
            }
        });

        // USERNAME PICKER LOGIC
        document.getElementById('saveUsernameBtn').onclick = async () => {
            const val = document.getElementById('pickUsername').value.trim().toLowerCase().replace(/\s/g,'');
            if(val.length < 3) return alert("Username too short");
            
            // Uniqueness check
            const check = await db.collection('users').where('username','==',val).get();
            if(!check.empty) return alert("Username taken!");

            // Create Profile
            await db.collection('users').doc(currentUser.uid).set({
                uid: currentUser.uid,
                email: currentUser.email,
                username: val,
                displayName: currentUser.displayName || val,
                photoURL: currentUser.photoURL || '',
                bio: 'New user',
                friends: [],
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            }, {merge:true});
            
            userDoc = (await db.collection('users').doc(currentUser.uid).get()).data();
            closeModal();
            initApp();
        };

        // LOGIN/SIGNUP TOGGLE
        let isRegister = false;
        document.getElementById('toggleAuthMode').onclick = (e) => {
            e.preventDefault();
            isRegister = !isRegister;
            e.target.innerText = isRegister ? "Back to Login" : "Need an account? Register";
            document.querySelector('#authForm button').innerText = isRegister ? "Register" : "Log In";
        };

        document.getElementById('authForm').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try {
                if(isRegister) await auth.createUserWithEmailAndPassword(email, pass);
                else await auth.signInWithEmailAndPassword(email, pass);
            } catch(err) { alert(err.message); }
        };

        document.getElementById('googleBtn').onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());

        // APP INIT
        function initApp() {
            document.getElementById('authUI').style.display = 'none';
            document.getElementById('loader').style.display = 'none';
            document.getElementById('appUI').classList.add('active');
            
            // Set User Panel
            document.getElementById('myName').innerText = userDoc.displayName;
            document.getElementById('myUserTag').innerText = '@' + userDoc.username;
            document.getElementById('myPfp').src = userDoc.photoURL || 'https://via.placeholder.com/150';
            document.getElementById('settingPfp').src = userDoc.photoURL || 'https://via.placeholder.com/150';
            document.getElementById('settingDisp').value = userDoc.displayName;
            document.getElementById('settingBio').value = userDoc.bio;

            loadFriends();
            loadServers();
            switchView('dm', null);
        }        // NAVIGATION
        function switchView(type, id) {
            // Cleanup
            if(msgUnsub) msgUnsub();
            document.getElementById('messagesList').innerHTML = ''; // Instant clear
            
            ctx = type;
            activeId = id;
            activeSubId = null;

            if(type === 'dm') {
                document.getElementById('dmSidebar').classList.remove('hidden');
                document.getElementById('serverSidebar').classList.add('hidden');
                document.getElementById('homeBtn').classList.add('active');
                document.querySelectorAll('.server-icon').forEach(e => e.classList.remove('active'));
                
                if(id) {
                    openDM(id);
                } else {
                    document.getElementById('headerTitle').innerText = "Friends";
                    document.getElementById('inputWrapper').style.display = 'none';
                }
            } else {
                document.getElementById('dmSidebar').classList.add('hidden');
                document.getElementById('serverSidebar').classList.remove('hidden');
                document.getElementById('homeBtn').classList.remove('active');
                document.querySelectorAll('.server-icon').forEach(e => {
                    e.classList.toggle('active', e.dataset.id === id);
                });
                loadServer(id);
            }
        }

        // FRIENDS & DM
        function loadFriends() {
            db.collection('users').doc(currentUser.uid).onSnapshot(doc => {
                userDoc = doc.data();
                const list = document.getElementById('friendsList');
                list.innerHTML = '';
                if(!userDoc.friends || userDoc.friends.length===0) return list.innerHTML='<div style="padding:10px;text-align:center;color:#72767d">No friends</div>';
                
                userDoc.friends.forEach(async fid => {
                    const fData = (await db.collection('users').doc(fid).get()).data();
                    const el = document.createElement('div');
                    el.className = 'channel-item';
                    el.innerHTML = `
                        <div style="width:32px;height:32px;border-radius:50%;overflow:hidden;margin-right:10px;background:#333"><img src="${fData.photoURL||''}" style="width:100%;height:100%"></div>
                        <div>
                            <div style="font-weight:600;color:#fff">${fData.displayName}</div>
                            <div style="font-size:11px">@${fData.username}</div>
                        </div>
                    `;
                    el.onclick = () => switchView('dm', fid);
                    list.appendChild(el);
                });
            });
        }

        async function openDM(friendId) {
            document.getElementById('inputWrapper').style.display = 'block';
            const fData = (await db.collection('users').doc(friendId).get()).data();
            document.getElementById('headerTitle').innerText = '@' + fData.username;
            
            const dmId = [currentUser.uid, friendId].sort().join('_');
            
            // Ensure permissions exist
            await db.collection('dms').doc(dmId).set({
                members: [currentUser.uid, friendId]
            }, {merge:true});

            listenChat(db.collection('dms').doc(dmId).collection('messages'));
        }

        // SERVER LOGIC
        function loadServers() {
            db.collection('servers').where('members','array-contains',currentUser.uid).onSnapshot(snap => {
                const list = document.getElementById('serverList');
                list.innerHTML = '';
                snap.forEach(d => {
                    const s = d.data();
                    const el = document.createElement('div');
                    el.className = 'server-icon';
                    el.dataset.id = d.id;
                    if(s.icon) el.innerHTML = `<img src="${s.icon}">`;
                    else el.innerText = s.name.substring(0,2);
                    el.onclick = () => switchView('server', d.id);
                    list.appendChild(el);
                });
            });
        }

        function loadServer(sid) {
            db.collection('servers').doc(sid).get().then(doc => {
                document.getElementById('serverNameDisp').innerText = doc.data().name;
            });
            
            // Channels
            db.collection('servers').doc(sid).collection('channels').orderBy('createdAt').onSnapshot(snap => {
                const list = document.getElementById('channelList');
                list.innerHTML = '';
                let first = null;
                snap.forEach(d => {
                    if(!first) first = d;
                    const el = document.createElement('div');
                    el.className = 'channel-item';
                    el.innerText = '# ' + d.data().name;
                    el.onclick = () => {
                        document.querySelectorAll('#channelList .channel-item').forEach(x=>x.classList.remove('active'));
                        el.classList.add('active');
                        activeSubId = d.id;
                        document.getElementById('headerTitle').innerText = '# ' + d.data().name;
                        document.getElementById('inputWrapper').style.display = 'block';
                        listenChat(db.collection('servers').doc(sid).collection('channels').doc(d.id).collection('messages'));
                    };
                    list.appendChild(el);
                });
                if(first && !activeSubId) {
                    activeSubId = first.id;
                    document.getElementById('headerTitle').innerText = '# ' + first.data().name;
                    document.getElementById('inputWrapper').style.display = 'block';
                    listenChat(db.collection('servers').doc(sid).collection('channels').doc(first.id).collection('messages'));
                }
            });
        }

        // CHAT LISTENER
        function listenChat(ref) {
            if(msgUnsub) msgUnsub();
            const box = document.getElementById('messagesList');
            box.innerHTML = '';
            
            msgUnsub = ref.orderBy('createdAt','asc').limitToLast(50).onSnapshot(snap => {
                box.innerHTML = '';
                let lastUser = null;
                snap.forEach(doc => {
                    const m = doc.data();
                    const stacked = lastUser === m.uid;
                    const div = document.createElement('div');
                    div.className = `message ${stacked?'stacked':''}`;
                    
                    let content = m.type === 'img' ? `<img src="${m.text}" class="msg-img" onclick="window.open(this.src)">` : `<div class="msg-text">${m.text}</div>`;
                    
                    if(stacked) {
                        div.innerHTML = `<div style="width:56px"></div><div class="msg-content">${content}</div>`;
                    } else {
                        const date = m.createdAt ? m.createdAt.toDate().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '';
                        div.innerHTML = `
                            <div class="msg-pfp"><img src="${m.pfp||''}"></div>
                            <div class="msg-content">
                                <div class="msg-meta">
                                    <span class="msg-user">${m.user}</span>
                                    <span class="msg-time">${date}</span>
                                </div>
                                ${content}
                            </div>
                        `;
                    }
                    box.appendChild(div);
                    lastUser = m.uid;
                });
                box.scrollTop = box.scrollHeight;
            });
        }        // SEND MESSAGE
        async function send(text, type='text') {
            if(!text) return;
            const msg = {
                text, type,
                uid: currentUser.uid,
                user: userDoc.displayName,
                pfp: userDoc.photoURL,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            if(ctx === 'dm') {
                const dmId = [currentUser.uid, activeId].sort().join('_');
                await db.collection('dms').doc(dmId).collection('messages').add(msg);
            } else {
                await db.collection('servers').doc(activeId).collection('channels').doc(activeSubId).collection('messages').add(msg);
            }
        }

        const inp = document.getElementById('msgInput');
        inp.onkeydown = (e) => {
            if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(inp.value.trim()); inp.value=''; }
        };

        // IMAGE HANDLER (Base64)
        const toBase64 = file => new Promise((resolve) => {
            const r = new FileReader();
            r.readAsDataURL(file);
            r.onload = () => {
                const img = new Image();
                img.src = r.result;
                img.onload = () => {
                    const cvs = document.createElement('canvas');
                    const scale = 600 / Math.max(img.width, img.height);
                    cvs.width = img.width * Math.min(1, scale);
                    cvs.height = img.height * Math.min(1, scale);
                    cvs.getContext('2d').drawImage(img,0,0,cvs.width,cvs.height);
                    resolve(cvs.toDataURL('image/jpeg', 0.6));
                }
            };
        });

        // Upload Chat Image
        document.getElementById('uploadBtn').onclick = () => document.getElementById('fileInput').click();
        document.getElementById('fileInput').onchange = async (e) => {
            if(e.target.files[0]) send(await toBase64(e.target.files[0]), 'img');
        };

        // Upload Profile Pic
        document.getElementById('pfpUpload').onchange = async (e) => {
            if(e.target.files[0]) {
                const b64 = await toBase64(e.target.files[0]);
                document.getElementById('settingPfp').src = b64;
            }
        };

        // ACTIONS
        document.getElementById('homeBtn').onclick = () => switchView('dm', null);
        document.getElementById('addServerBtn').onclick = () => openModal('serverModal');
        document.getElementById('addFriendBtn').onclick = () => openModal('friendModal');
        document.getElementById('settingsBtn').onclick = () => openModal('settingsModal');
        document.getElementById('createChannelBtn').onclick = async () => {
            const name = prompt("Channel Name:");
            if(name) await db.collection('servers').doc(activeId).collection('channels').add({name, createdAt: firebase.firestore.FieldValue.serverTimestamp()});
        };

        document.getElementById('submitFriend').onclick = async () => {
            const name = document.getElementById('friendUser').value.toLowerCase().trim();
            const snap = await db.collection('users').where('username','==',name).get();
            if(snap.empty) return alert("User not found");
            const fid = snap.docs[0].id;
            if(fid === currentUser.uid) return alert("Can't add self");
            
            await db.collection('users').doc(currentUser.uid).update({friends: firebase.firestore.FieldValue.arrayUnion(fid)});
            await db.collection('users').doc(fid).update({friends: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)});
            closeModal();
        };

        document.getElementById('createServer').onclick = async () => {
            const name = document.getElementById('newServerName').value;
            const code = Math.random().toString(36).substring(7);
            const ref = await db.collection('servers').add({
                name, owner: currentUser.uid, inviteCode: code, icon: '',
                members: [currentUser.uid]
            });
            await ref.collection('channels').add({name:'general', createdAt: firebase.firestore.FieldValue.serverTimestamp()});
            closeModal();
        };

        document.getElementById('joinServer').onclick = async () => {
            const code = document.getElementById('inviteCode').value;
            const snap = await db.collection('servers').where('inviteCode','==',code).get();
            if(snap.empty) return alert("Invalid code");
            await snap.docs[0].ref.update({members: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)});
            closeModal();
        };

        document.getElementById('saveSettings').onclick = async () => {
            await db.collection('users').doc(currentUser.uid).update({
                displayName: document.getElementById('settingDisp').value,
                bio: document.getElementById('settingBio').value,
                photoURL: document.getElementById('settingPfp').src
            });
            window.location.reload();
        };

        document.getElementById('logoutBtn').onclick = () => auth.signOut();
        document.getElementById('leaveServerBtn').onclick = async () => {
            if(confirm("Leave server?")) {
                await db.collection('servers').doc(activeId).update({members: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)});
                switchView('dm', null);
            }
        };

        // Modal Utils
        function openModal(id) {
            document.getElementById('modalOverlay').style.display='flex';
            document.querySelectorAll('.modal').forEach(m=>m.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }
        function closeModal() { document.getElementById('modalOverlay').style.display='none'; }
        document.querySelectorAll('.close-modal').forEach(b=>b.onclick=closeModal);
    </script>
</body>
</html>

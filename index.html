<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat</title>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

:root {
  --bg-primary: #313338;
  --bg-secondary: #2b2d31;
  --bg-tertiary: #1e1f22;
  --bg-modifier-hover: rgba(78, 80, 88, 0.3);
  --bg-modifier-selected: rgba(78, 80, 88, 0.6);
  --text-normal: #dbdee1;
  --text-muted: #949ba4;
  --text-link: #00a8fc;
  --header-primary: #f2f3f5;
  --header-secondary: #b5bac1;
  --brand-color: #5865f2;
  --brand-hover: #4752c4;
  --green: #23a559;
  --red: #da373c;
  --yellow: #f0b232;
  --channel-icon: #80848e;
  --input-bg: #383a40;
  --scrollbar-thin: #1a1b1e;
  --scrollbar-auto: #2b2d31;
}

body {
  font-family: 'Segoe UI', 'Helvetica Neue', Helvetica, Arial, sans-serif;
  background-color: var(--bg-primary);
  color: var(--text-normal);
  height: 100vh;
  overflow: hidden;
}

.auth-container {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100vh;
  background: var(--bg-tertiary);
}

.auth-box {
  background: var(--bg-primary);
  border-radius: 8px;
  padding: 32px;
  width: 480px;
  max-width: 90vw;
  box-shadow: 0 2px 10px rgba(0,0,0,0.3);
}

.auth-box h2 {
  color: var(--header-primary);
  text-align: center;
  margin-bottom: 8px;
  font-size: 24px;
}

.auth-box .subtitle {
  color: var(--text-muted);
  text-align: center;
  margin-bottom: 20px;
  font-size: 14px;
}

.form-group {
  margin-bottom: 16px;
}

.form-group label {
  display: block;
  color: var(--header-secondary);
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  margin-bottom: 8px;
  letter-spacing: 0.02em;
}

.form-group input {
  width: 100%;
  padding: 10px 12px;
  background: var(--bg-tertiary);
  border: none;
  border-radius: 4px;
  color: var(--text-normal);
  font-size: 16px;
  outline: none;
  transition: border 0.15s;
  border: 2px solid transparent;
}

.form-group input:focus {
  border-color: var(--brand-color);
}

.btn-primary {
  width: 100%;
  padding: 12px;
  background: var(--brand-color);
  color: white;
  border: none;
  border-radius: 4px;
  font-size: 16px;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.2s;
  margin-top: 8px;
}

.btn-primary:hover {
  background: var(--brand-hover);
}

.btn-primary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.auth-switch {
  margin-top: 12px;
  font-size: 14px;
  color: var(--text-muted);
}

.auth-switch a {
  color: var(--text-link);
  cursor: pointer;
  text-decoration: none;
}

.auth-switch a:hover {
  text-decoration: underline;
}

.error-msg {
  background: rgba(218, 55, 60, 0.1);
  color: var(--red);
  padding: 10px;
  border-radius: 4px;
  margin-bottom: 12px;
  font-size: 14px;
  display: none;
}

.app-container {
  display: none;
  height: 100vh;
}

.app-layout {
  display: flex;
  height: 100%;
}

.server-list {
  width: 72px;
  background: var(--bg-tertiary);
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 12px 0;
  gap: 4px;
  overflow-y: auto;
  flex-shrink: 0;
}

.server-list::-webkit-scrollbar {
  display: none;
}

.server-icon {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  background: var(--bg-primary);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: border-radius 0.2s, background 0.2s;
  color: var(--text-normal);
  font-weight: 700;
  font-size: 18px;
  position: relative;
  overflow: hidden;
  flex-shrink: 0;
}

.server-icon:hover, .server-icon.active {
  border-radius: 16px;
  background: var(--brand-color);
  color: white;
}

.server-icon.home {
  background: var(--brand-color);
  color: white;
  margin-bottom: 4px;
}

.server-icon.home:hover {
  background: var(--brand-hover);
}

.server-icon.add-server {
  background: var(--bg-primary);
  color: var(--green);
  font-size: 24px;
}

.server-icon.add-server:hover {
  background: var(--green);
  color: white;
  border-radius: 16px;
}

.server-divider {
  width: 32px;
  height: 2px;
  background: var(--bg-modifier-selected);
  border-radius: 1px;
  margin: 4px 0;
  flex-shrink: 0;
}

.server-pill {
  position: absolute;
  left: -4px;
  width: 8px;
  height: 0;
  background: var(--header-primary);
  border-radius: 0 4px 4px 0;
  transition: height 0.2s;
}

.server-icon:hover .server-pill {
  height: 20px;
}

.server-icon.active .server-pill {
  height: 40px;
}

.channel-sidebar {
  width: 240px;
  background: var(--bg-secondary);
  display: flex;
  flex-direction: column;
  flex-shrink: 0;
}

.server-header {
  height: 48px;
  padding: 0 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 2px solid var(--bg-tertiary);
  font-weight: 700;
  color: var(--header-primary);
  cursor: pointer;
  transition: background 0.1s;
  flex-shrink: 0;
}

.server-header:hover {
  background: var(--bg-modifier-hover);
}

.channel-list {
  flex: 1;
  overflow-y: auto;
  padding: 0 8px;
}

.channel-list::-webkit-scrollbar {
  width: 4px;
}

.channel-list::-webkit-scrollbar-thumb {
  background: var(--scrollbar-thin);
  border-radius: 4px;
}

.channel-category {
  padding: 16px 0 4px 2px;
  display: flex;
  align-items: center;
  gap: 4px;
  cursor: pointer;
}

.channel-category span {
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  color: var(--text-muted);
  letter-spacing: 0.02em;
}

.channel-category:hover span {
  color: var(--text-normal);
}

.channel-item {
  display: flex;
  align-items: center;
  padding: 6px 8px;
  border-radius: 4px;
  cursor: pointer;
  gap: 6px;
  color: var(--channel-icon);
  transition: background 0.1s, color 0.1s;
  margin: 1px 0;
}

.channel-item:hover {
  background: var(--bg-modifier-hover);
  color: var(--text-normal);
}

.channel-item.active {
  background: var(--bg-modifier-selected);
  color: var(--header-primary);
}

.channel-item .channel-hash {
  font-size: 20px;
  font-weight: 400;
  opacity: 0.7;
  flex-shrink: 0;
}

.channel-item .channel-name {
  font-size: 15px;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.channel-item .channel-actions {
  margin-left: auto;
  display: none;
  gap: 4px;
}

.channel-item:hover .channel-actions {
  display: flex;
}

.channel-action-btn {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  padding: 2px;
  font-size: 16px;
  border-radius: 4px;
}

.channel-action-btn:hover {
  color: var(--text-normal);
}

.add-channel-btn {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 16px;
  margin-left: auto;
  padding: 0 4px;
}

.add-channel-btn:hover {
  color: var(--text-normal);
}

.user-panel {
  height: 52px;
  background: rgba(17, 18, 20, 0.6);
  display: flex;
  align-items: center;
  padding: 0 8px;
  gap: 8px;
  flex-shrink: 0;
}

.user-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--brand-color);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 14px;
  color: white;
  flex-shrink: 0;
}

.user-info {
  flex: 1;
  min-width: 0;
}

.user-info .username {
  font-size: 14px;
  font-weight: 600;
  color: var(--header-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.user-info .status {
  font-size: 12px;
  color: var(--text-muted);
}

.user-panel-btn {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  padding: 6px;
  border-radius: 4px;
  font-size: 18px;
  display: flex;
  align-items: center;
}

.user-panel-btn:hover {
  background: var(--bg-modifier-hover);
  color: var(--text-normal);
}

.chat-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-width: 0;
}

.chat-header {
  height: 48px;
  padding: 0 16px;
  display: flex;
  align-items: center;
  border-bottom: 2px solid var(--bg-tertiary);
  flex-shrink: 0;
  gap: 8px;
}

.chat-header .channel-hash {
  color: var(--channel-icon);
  font-size: 24px;
}

.chat-header .channel-name {
  font-weight: 700;
  color: var(--header-primary);
  font-size: 16px;
}

.header-actions {
  margin-left: auto;
  display: flex;
  gap: 4px;
}

.header-action-btn {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  padding: 6px 8px;
  border-radius: 4px;
  font-size: 18px;
}

.header-action-btn:hover {
  color: var(--text-normal);
}

.header-action-btn.active {
  color: var(--header-primary);
}

.chat-content {
  display: flex;
  flex: 1;
  min-height: 0;
}

.messages-wrapper {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-width: 0;
}

.messages-container {
  flex: 1;
  overflow-y: auto;
  padding: 16px 0;
  display: flex;
  flex-direction: column;
}

.messages-container::-webkit-scrollbar {
  width: 8px;
}

.messages-container::-webkit-scrollbar-thumb {
  background: var(--scrollbar-thin);
  border-radius: 4px;
}

.messages-container::-webkit-scrollbar-track {
  background: var(--scrollbar-auto);
}

.welcome-message {
  padding: 16px 16px 0;
}

.welcome-message .channel-icon-large {
  width: 68px;
  height: 68px;
  background: var(--bg-modifier-selected);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 42px;
  color: var(--text-normal);
  margin-bottom: 8px;
}

.welcome-message h1 {
  color: var(--header-primary);
  font-size: 32px;
  margin-bottom: 8px;
}

.welcome-message p {
  color: var(--text-muted);
  font-size: 14px;
}

.message-group {
  padding: 2px 16px;
  display: flex;
  gap: 16px;
  position: relative;
}

.message-group:hover {
  background: rgba(0, 0, 0, 0.06);
}

.message-group.has-header {
  margin-top: 16px;
  padding-top: 4px;
}

.msg-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--brand-color);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  color: white;
  font-size: 16px;
  flex-shrink: 0;
  cursor: pointer;
}

.msg-avatar.collapsed {
  visibility: hidden;
  width: 40px;
}

.msg-content {
  flex: 1;
  min-width: 0;
}

.msg-header {
  display: flex;
  align-items: baseline;
  gap: 8px;
  margin-bottom: 2px;
}

.msg-author {
  font-weight: 600;
  color: var(--header-primary);
  font-size: 15px;
  cursor: pointer;
}

.msg-author:hover {
  text-decoration: underline;
}

.msg-timestamp {
  font-size: 12px;
  color: var(--text-muted);
}

.msg-text {
  color: var(--text-normal);
  font-size: 15px;
  line-height: 1.375;
  word-wrap: break-word;
  white-space: pre-wrap;
}

.msg-hover-timestamp {
  position: absolute;
  left: 0;
  width: 56px;
  text-align: right;
  font-size: 11px;
  color: var(--text-muted);
  display: none;
  padding-right: 4px;
}

.message-group:hover .msg-hover-timestamp {
  display: block;
}

.message-input-container {
  padding: 0 16px 24px;
  flex-shrink: 0;
}

.message-input-wrapper {
  background: var(--input-bg);
  border-radius: 8px;
  display: flex;
  align-items: flex-end;
  padding: 0 16px;
}

.message-input-wrapper button.attach-btn {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  padding: 10px 0;
  font-size: 22px;
  margin-right: 8px;
}

.message-input-wrapper button.attach-btn:hover {
  color: var(--text-normal);
}

.message-input {
  flex: 1;
  background: none;
  border: none;
  color: var(--text-normal);
  font-size: 15px;
  padding: 11px 0;
  outline: none;
  font-family: inherit;
  resize: none;
  max-height: 300px;
  min-height: 22px;
  line-height: 1.375;
}

.message-input::placeholder {
  color: var(--text-muted);
}

.members-sidebar {
  width: 240px;
  background: var(--bg-secondary);
  overflow-y: auto;
  padding: 8px 8px 0;
  flex-shrink: 0;
  display: none;
}

.members-sidebar.show {
  display: block;
}

.members-sidebar::-webkit-scrollbar {
  width: 4px;
}

.members-sidebar::-webkit-scrollbar-thumb {
  background: var(--scrollbar-thin);
  border-radius: 4px;
}

.member-category {
  padding: 16px 8px 4px;
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  color: var(--text-muted);
  letter-spacing: 0.02em;
}

.member-item {
  display: flex;
  align-items: center;
  padding: 6px 8px;
  border-radius: 4px;
  cursor: pointer;
  gap: 8px;
}

.member-item:hover {
  background: var(--bg-modifier-hover);
}

.member-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--brand-color);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  color: white;
  font-size: 13px;
  flex-shrink: 0;
  position: relative;
}

.member-status-dot {
  position: absolute;
  bottom: -1px;
  right: -1px;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  border: 2.5px solid var(--bg-secondary);
}

.member-status-dot.online { background: var(--green); }
.member-status-dot.idle { background: var(--yellow); }
.member-status-dot.offline { background: var(--text-muted); }

.member-name {
  font-size: 15px;
  font-weight: 500;
  color: var(--text-muted);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.member-item:hover .member-name {
  color: var(--text-normal);
}

.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-overlay.show {
  display: flex;
}

.modal {
  background: var(--bg-primary);
  border-radius: 8px;
  padding: 24px;
  width: 440px;
  max-width: 90vw;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
}

.modal h2 {
  color: var(--header-primary);
  margin-bottom: 16px;
  font-size: 20px;
}

.modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 8px;
  margin-top: 20px;
}

.btn-cancel {
  padding: 8px 16px;
  background: none;
  border: none;
  color: var(--text-normal);
  cursor: pointer;
  font-size: 14px;
  border-radius: 4px;
}

.btn-cancel:hover {
  text-decoration: underline;
}

.btn-submit {
  padding: 8px 16px;
  background: var(--brand-color);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
}

.btn-submit:hover {
  background: var(--brand-hover);
}

.btn-danger {
  background: var(--red);
}

.btn-danger:hover {
  background: #a12d2f;
}

.invite-code {
  background: var(--bg-tertiary);
  padding: 12px;
  border-radius: 4px;
  font-family: 'Consolas', monospace;
  font-size: 16px;
  color: var(--header-primary);
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-top: 12px;
}

.invite-code button {
  padding: 6px 16px;
  background: var(--brand-color);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
}

.invite-code button:hover {
  background: var(--brand-hover);
}

.loading-spinner {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: var(--text-muted);
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid var(--bg-modifier-selected);
  border-top-color: var(--brand-color);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.context-menu {
  position: fixed;
  background: var(--bg-tertiary);
  border-radius: 4px;
  padding: 6px 8px;
  min-width: 188px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  z-index: 1500;
  display: none;
}

.context-menu-item {
  padding: 6px 8px;
  border-radius: 2px;
  cursor: pointer;
  font-size: 14px;
  color: var(--text-normal);
  display: flex;
  align-items: center;
  gap: 8px;
}

.context-menu-item:hover {
  background: var(--brand-color);
  color: white;
}

.context-menu-item.danger {
  color: var(--red);
}

.context-menu-item.danger:hover {
  background: var(--red);
  color: white;
}

.context-menu-separator {
  height: 1px;
  background: var(--bg-modifier-selected);
  margin: 4px 0;
}

.friends-area {
  display: none;
  flex: 1;
  flex-direction: column;
}

.friends-header {
  height: 48px;
  padding: 0 16px;
  display: flex;
  align-items: center;
  border-bottom: 2px solid var(--bg-tertiary);
  gap: 16px;
}

.friends-header .title {
  font-weight: 700;
  color: var(--header-primary);
}

.friends-header .divider {
  width: 1px;
  height: 24px;
  background: var(--bg-modifier-selected);
}

.friends-tab {
  padding: 2px 8px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-muted);
}

.friends-tab:hover {
  background: var(--bg-modifier-hover);
  color: var(--text-normal);
}

.friends-tab.active {
  background: var(--bg-modifier-selected);
  color: var(--header-primary);
}

.friends-content {
  flex: 1;
  padding: 16px;
  overflow-y: auto;
  display: flex;
  align-items: center;
  justify-content: center;
}

.no-friends-msg {
  text-align: center;
  color: var(--text-muted);
}

.settings-overlay {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: var(--bg-primary);
  z-index: 2000;
  display: none;
}

.settings-overlay.show {
  display: flex;
}

.settings-sidebar {
  width: 300px;
  display: flex;
  justify-content: flex-end;
  background: var(--bg-secondary);
  padding: 60px 16px;
}

.settings-nav {
  width: 200px;
}

.settings-nav-header {
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  color: var(--text-muted);
  padding: 8px 10px;
  letter-spacing: 0.02em;
}

.settings-nav-item {
  padding: 8px 10px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 15px;
  color: var(--text-muted);
  margin: 1px 0;
}

.settings-nav-item:hover {
  background: var(--bg-modifier-hover);
  color: var(--text-normal);
}

.settings-nav-item.active {
  background: var(--bg-modifier-selected);
  color: var(--header-primary);
}

.settings-nav-item.danger {
  color: var(--red);
}

.settings-nav-item.danger:hover {
  color: white;
  background: var(--red);
}

.settings-nav-separator {
  height: 1px;
  background: var(--bg-modifier-selected);
  margin: 4px 10px;
}

.settings-content {
  flex: 1;
  padding: 60px 40px;
  overflow-y: auto;
  max-width: 740px;
  position: relative;
}

.settings-content h2 {
  color: var(--header-primary);
  font-size: 20px;
  margin-bottom: 20px;
}

.settings-close {
  position: absolute;
  top: 16px;
  right: 16px;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border: 2px solid var(--text-muted);
  background: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.settings-close:hover {
  border-color: var(--text-normal);
  color: var(--text-normal);
}

.profile-card {
  background: var(--bg-tertiary);
  border-radius: 8px;
  padding: 16px;
  display: flex;
  align-items: center;
  gap: 16px;
}

.profile-card .avatar-large {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  background: var(--brand-color);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 36px;
  font-weight: 700;
  color: white;
  flex-shrink: 0;
}

.profile-card .profile-info h3 {
  color: var(--header-primary);
  font-size: 20px;
}

.profile-card .profile-info p {
  color: var(--text-muted);
  font-size: 14px;
}

.typing-indicator {
  padding: 4px 16px;
  font-size: 12px;
  color: var(--text-muted);
  height: 24px;
  display: flex;
  align-items: center;
  gap: 4px;
  flex-shrink: 0;
}

.typing-dots {
  display: inline-flex;
  gap: 2px;
}

.typing-dots span {
  width: 4px;
  height: 4px;
  background: var(--text-muted);
  border-radius: 50%;
  animation: typing 1.4s infinite;
}

.typing-dots span:nth-child(2) { animation-delay: 0.2s; }
.typing-dots span:nth-child(3) { animation-delay: 0.4s; }

@keyframes typing {
  0%, 60%, 100% { transform: translateY(0); }
  30% { transform: translateY(-4px); }
}

.join-server-area {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.or-divider {
  text-align: center;
  color: var(--text-muted);
  font-size: 14px;
  font-weight: 700;
}

.avatar-color-0 { background: #5865f2 !important; }
.avatar-color-1 { background: #57f287 !important; }
.avatar-color-2 { background: #feb347 !important; }
.avatar-color-3 { background: #ed4245 !important; }
.avatar-color-4 { background: #eb459e !important; }
.avatar-color-5 { background: #9b59b6 !important; }

.msg-text strong { font-weight: 700; }
.msg-text em { font-style: italic; }
.msg-text code {
  background: var(--bg-tertiary);
  padding: 2px 4px;
  border-radius: 3px;
  font-family: 'Consolas', monospace;
  font-size: 14px;
}
.msg-text pre {
  background: var(--bg-tertiary);
  padding: 8px;
  border-radius: 4px;
  margin: 4px 0;
  overflow-x: auto;
}
.msg-text pre code {
  background: none;
  padding: 0;
}

.msg-text a {
  color: var(--text-link);
}

.dm-header {
  padding: 12px 8px 4px;
}

.dm-header span {
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
  color: var(--text-muted);
  letter-spacing: 0.02em;
}

@media (max-width: 768px) {
  .channel-sidebar { display: none !important; }
  .members-sidebar { display: none !important; }
  .server-list { width: 56px; }
  .server-icon { width: 40px; height: 40px; font-size: 14px; }
}
</style>
</head>
<body>

<div id="authScreen" class="auth-container">
  <div class="auth-box">
    <div id="loginForm">
      <h2>Welcome back!</h2>
      <p class="subtitle">We're so excited to see you again!</p>
      <div id="loginError" class="error-msg"></div>
      <div class="form-group">
        <label>EMAIL</label>
        <input type="email" id="loginEmail" placeholder="Enter your email">
      </div>
      <div class="form-group">
        <label>PASSWORD</label>
        <input type="password" id="loginPassword" placeholder="Enter your password">
      </div>
      <button class="btn-primary" id="loginBtn">Log In</button>
      <p class="auth-switch">Need an account? <a id="showRegister">Register</a></p>
    </div>
    <div id="registerForm" style="display:none">
      <h2>Create an account</h2>
      <div id="registerError" class="error-msg"></div>
      <div class="form-group">
        <label>EMAIL</label>
        <input type="email" id="regEmail" placeholder="Enter your email">
      </div>
      <div class="form-group">
        <label>DISPLAY NAME</label>
        <input type="text" id="regUsername" placeholder="Enter a username" maxlength="32">
      </div>
      <div class="form-group">
        <label>PASSWORD</label>
        <input type="password" id="regPassword" placeholder="Enter a password (min 6 chars)">
      </div>
      <button class="btn-primary" id="registerBtn">Continue</button>
      <p class="auth-switch"><a id="showLogin">Already have an account?</a></p>
    </div>
  </div>
</div>

<div id="appContainer" class="app-container">
  <div class="app-layout">
    <div class="server-list" id="serverList">
      <div class="server-icon home" id="homeBtn" title="Direct Messages">
        <svg width="28" height="20" viewBox="0 0 28 20"><path fill="currentColor" d="M23.0212 1.67671C21.3107 0.879656 19.5079 0.318797 17.6584 0C17.4062 0.461742 17.1749 0.934541 16.9708 1.4184C15.003 1.12145 12.9974 1.12145 11.0292 1.4184C10.8251 0.934541 10.5765 0.461742 10.3416 0C8.49019 0.321376 6.68494 0.884437 4.97458 1.68386C1.2669 7.20471 0.213493 12.5895 0.740044 17.8968C2.90156 19.5181 5.55714 20.5792 8.37854 20.9974C8.9003 20.2882 9.35995 19.5283 9.74498 18.7353C8.99847 18.4642 8.28064 18.1216 7.60107 17.7153C7.78651 17.5773 7.96738 17.4367 8.14368 17.2935C12.6645 19.396 17.4965 19.396 21.9607 17.2935C22.1396 17.4393 22.3205 17.5799 22.5034 17.7153C21.8212 18.1242 21.1007 18.4695 20.3514 18.7405C20.739 19.5309 21.1988 20.2882 21.7178 20.9999C24.5418 20.5843 27.1999 19.5233 29.3601 17.8994C29.9809 11.7411 28.3355 6.40915 23.9693 1.67671H23.0212Z"></path></svg>
        <span class="server-pill"></span>
      </div>
      <div class="server-divider"></div>
      <div id="serverIconList"></div>
      <div class="server-icon add-server" id="addServerBtn" title="Add a Server">+
        <span class="server-pill"></span>
      </div>
    </div>

    <div class="channel-sidebar" id="channelSidebar">
      <div class="server-header" id="serverHeader">
        <span id="serverName">Server Name</span>
        <span>‚ñæ</span>
      </div>
      <div class="channel-list" id="channelList"></div>
      <div class="user-panel" id="userPanel">
        <div class="user-avatar" id="userPanelAvatar">U</div>
        <div class="user-info">
          <div class="username" id="userPanelName">Username</div>
          <div class="status">Online</div>
        </div>
        <button class="user-panel-btn" id="settingsBtn" title="User Settings">‚öô</button>
      </div>
    </div>

    <div class="chat-area" id="chatArea">
      <div class="chat-header" id="chatHeader">
        <span class="channel-hash">#</span>
        <span class="channel-name" id="chatChannelName">general</span>
        <div class="header-actions">
          <button class="header-action-btn active" id="toggleMembersBtn" title="Member List">üë•</button>
        </div>
      </div>
      <div class="chat-content">
        <div class="messages-wrapper">
          <div class="messages-container" id="messagesContainer">
            <div class="loading-spinner"><div class="spinner"></div></div>
          </div>
          <div class="typing-indicator" id="typingIndicator"></div>
          <div class="message-input-container">
            <div class="message-input-wrapper">
              <button class="attach-btn">+</button>
              <textarea class="message-input" id="messageInput" placeholder="Message #general" rows="1"></textarea>
            </div>
          </div>
        </div>
        <div class="members-sidebar show" id="membersSidebar"></div>
      </div>
    </div>

    <div class="friends-area" id="friendsArea">
      <div class="friends-header">
        <span class="title">Friends</span>
        <div class="divider"></div>
        <span class="friends-tab active">Online</span>
        <span class="friends-tab">All</span>
        <span class="friends-tab">Pending</span>
      </div>
      <div class="friends-content" id="friendsContent">
        <div class="no-friends-msg">
          <p style="font-size:48px; margin-bottom:16px;">üëã</p>
          <p style="font-size:16px;">No one's around to play with Wumpus.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="createServerModal">
  <div class="modal">
    <h2>Create or Join a Server</h2>
    <div class="join-server-area">
      <div class="form-group">
        <label>SERVER NAME</label>
        <input type="text" id="newServerName" placeholder="My Awesome Server" maxlength="100">
      </div>
      <button class="btn-submit" id="createServerBtn" style="width:100%">Create Server</button>
      <div class="or-divider">OR</div>
      <div class="form-group">
        <label>JOIN WITH INVITE CODE</label>
        <input type="text" id="joinServerCode" placeholder="Enter an invite code">
      </div>
      <button class="btn-submit" id="joinServerBtn" style="width:100%">Join Server</button>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" id="cancelCreateServer">Cancel</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="createChannelModal">
  <div class="modal">
    <h2>Create Channel</h2>
    <div class="form-group">
      <label>CHANNEL NAME</label>
      <input type="text" id="newChannelName" placeholder="new-channel" maxlength="100">
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" id="cancelCreateChannel">Cancel</button>
      <button class="btn-submit" id="createChannelBtn">Create Channel</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="inviteModal">
  <div class="modal">
    <h2>Invite People</h2>
    <p style="color:var(--text-muted);font-size:14px;">Share this code with friends to let them join:</p>
    <div class="invite-code">
      <span id="inviteCodeText"></span>
      <button id="copyInviteBtn">Copy</button>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" id="closeInviteModal">Done</button>
    </div>
  </div>
</div>

<div class="context-menu" id="serverContextMenu">
  <div class="context-menu-item" id="ctxInvite">‚úâÔ∏è Invite People</div>
  <div class="context-menu-item" id="ctxCreateChannel">‚ûï Create Channel</div>
  <div class="context-menu-separator"></div>
  <div class="context-menu-item danger" id="ctxLeaveServer">üö™ Leave Server</div>
  <div class="context-menu-item danger" id="ctxDeleteServer" style="display:none">üóëÔ∏è Delete Server</div>
</div>

<div class="settings-overlay" id="settingsOverlay">
  <div class="settings-sidebar">
    <div class="settings-nav">
      <div class="settings-nav-header">User Settings</div>
      <div class="settings-nav-item active">My Account</div>
      <div class="settings-nav-separator"></div>
      <div class="settings-nav-item danger" id="logoutBtnSettings">Log Out</div>
    </div>
  </div>
  <div class="settings-content">
    <button class="settings-close" id="closeSettings">‚úï</button>
    <h2>My Account</h2>
    <div class="profile-card">
      <div class="avatar-large" id="settingsAvatar">U</div>
      <div class="profile-info">
        <h3 id="settingsUsername">Username</h3>
        <p id="settingsEmail">user@email.com</p>
      </div>
    </div>
    <div style="margin-top:24px">
      <div class="form-group">
        <label>DISPLAY NAME</label>
        <input type="text" id="editDisplayName" maxlength="32">
      </div>
      <button class="btn-submit" id="saveProfileBtn">Save Changes</button>
    </div>
  </div>
</div>

<!-- Firebase Compat SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
// ===== FIREBASE CONFIG =====
const firebaseConfig = {
  apiKey: "AIzaSyBJMIUucxOusoVzs4lc-QurCxjlW6Hlsuw",
  authDomain: "chat-5f0bf.firebaseapp.com",
  projectId: "chat-5f0bf",
  storageBucket: "chat-5f0bf.firebasestorage.app",
  messagingSenderId: "211425841353",
  appId: "1:211425841353:web:e1c271a340d73abd0cfd18"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ===== STATE =====
let currentUser = null;
let userProfile = null;
let currentServerId = null;
let currentChannelId = null;
let servers = [];
let channels = [];
let members = [];
let showMembers = true;
let unsubMessages = null;
let unsubChannels = null;
let unsubMembers = null;
let unsubServers = null;
let unsubTyping = null;
let typingTimeout = null;
let isHome = true;

// ===== DOM =====
const $ = id => document.getElementById(id);
const authScreen = $('authScreen');
const appContainer = $('appContainer');
const loginForm = $('loginForm');
const registerForm = $('registerForm');
const loginError = $('loginError');
const registerError = $('registerError');
const serverIconList = $('serverIconList');
const channelList = $('channelList');
const channelSidebar = $('channelSidebar');
const chatArea = $('chatArea');
const friendsArea = $('friendsArea');
const messagesContainer = $('messagesContainer');
const messageInput = $('messageInput');
const membersSidebar = $('membersSidebar');
const typingIndicator = $('typingIndicator');
const serverContextMenu = $('serverContextMenu');

// ===== AUTH UI =====
$('showRegister').onclick = () => {
  loginForm.style.display = 'none';
  registerForm.style.display = 'block';
  registerError.style.display = 'none';
};

$('showLogin').onclick = () => {
  registerForm.style.display = 'none';
  loginForm.style.display = 'block';
  loginError.style.display = 'none';
};

$('loginBtn').onclick = async () => {
  const email = $('loginEmail').value.trim();
  const pw = $('loginPassword').value;
  if (!email || !pw) return showError(loginError, 'Fill in all fields.');
  $('loginBtn').disabled = true;
  try { await auth.signInWithEmailAndPassword(email, pw); }
  catch (e) { showError(loginError, mapErr(e.code)); }
  $('loginBtn').disabled = false;
};

$('registerBtn').onclick = async () => {
  const email = $('regEmail').value.trim();
  const username = $('regUsername').value.trim();
  const pw = $('regPassword').value;
  if (!email || !username || !pw) return showError(registerError, 'Fill in all fields.');
  if (pw.length < 6) return showError(registerError, 'Password must be at least 6 characters.');
  $('registerBtn').disabled = true;
  try {
    const cred = await auth.createUserWithEmailAndPassword(email, pw);
    await db.collection('users').doc(cred.user.uid).set({
      email, username,
      avatarColor: Math.floor(Math.random() * 6),
      status: 'online',
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      servers: []
    });
  } catch (e) { showError(registerError, mapErr(e.code)); }
  $('registerBtn').disabled = false;
};

$('loginPassword').onkeydown = e => { if (e.key === 'Enter') $('loginBtn').click(); };
$('regPassword').onkeydown = e => { if (e.key === 'Enter') $('registerBtn').click(); };

function showError(el, msg) { el.textContent = msg; el.style.display = 'block'; }

function mapErr(code) {
  const m = {
    'auth/email-already-in-use': 'Email already registered.',
    'auth/invalid-email': 'Invalid email.',
    'auth/wrong-password': 'Incorrect password.',
    'auth/user-not-found': 'No account found.',
    'auth/weak-password': 'Password too weak.',
    'auth/invalid-credential': 'Invalid email or password.',
    'auth/too-many-requests': 'Too many attempts. Wait a bit.'
  };
  return m[code] || 'Something went wrong.';
}

// ===== AUTH STATE =====
auth.onAuthStateChanged(async user => {
  if (user) {
    currentUser = user;
    const doc = await db.collection('users').doc(user.uid).get();
    userProfile = doc.exists
      ? { id: user.uid, ...doc.data() }
      : { id: user.uid, username: user.email.split('@')[0], email: user.email, avatarColor: 0, servers: [] };
    db.collection('users').doc(user.uid).update({ status: 'online' }).catch(()=>{});
    authScreen.style.display = 'none';
    appContainer.style.display = 'block';
    initApp();
  } else {
    currentUser = null;
    userProfile = null;
    authScreen.style.display = 'flex';
    appContainer.style.display = 'none';
    cleanup();
  }
});

// ===== INIT =====
function initApp() {
  updateUserPanel();
  loadServers();
  goHome();
}

function updateUserPanel() {
  const ini = (userProfile.username || '?')[0].toUpperCase();
  const cls = `avatar-color-${userProfile.avatarColor || 0}`;
  $('userPanelAvatar').textContent = ini;
  $('userPanelAvatar').className = 'user-avatar ' + cls;
  $('userPanelName').textContent = userProfile.username;
  $('settingsAvatar').textContent = ini;
  $('settingsAvatar').className = 'avatar-large ' + cls;
  $('settingsUsername').textContent = userProfile.username;
  $('settingsEmail').textContent = userProfile.email || currentUser.email;
  $('editDisplayName').value = userProfile.username;
}

function cleanup() {
  [unsubMessages, unsubChannels, unsubMembers, unsubServers, unsubTyping].forEach(u => u && u());
  unsubMessages = unsubChannels = unsubMembers = unsubServers = unsubTyping = null;
}

// ===== SERVERS =====
function loadServers() {
  if (unsubServers) unsubServers();
  unsubServers = db.collection('users').doc(currentUser.uid).onSnapshot(async doc => {
    if (!doc.exists) return;
    const data = doc.data();
    userProfile = { id: currentUser.uid, ...data };
    updateUserPanel();
    const ids = data.servers || [];
    if (ids.length === 0) { servers = []; renderServerIcons(); return; }
    const docs = await Promise.all(ids.map(id => db.collection('servers').doc(id).get()));
    servers = docs.filter(d => d.exists).map(d => ({ id: d.id, ...d.data() }));
    renderServerIcons();
  });
}

function renderServerIcons() {
  serverIconList.innerHTML = '';
  servers.forEach(s => {
    const el = document.createElement('div');
    el.className = 'server-icon' + (currentServerId === s.id ? ' active' : '');
    el.title = s.name;
    el.textContent = s.name ? s.name.split(' ').map(w => w[0]).join('').substring(0, 3).toUpperCase() : '?';
    const pill = document.createElement('span');
    pill.className = 'server-pill';
    el.appendChild(pill);
    el.onclick = () => selectServer(s.id);
    el.oncontextmenu = e => showCtxMenu(e, s);
    serverIconList.appendChild(el);
  });
}

function selectServer(id) {
  isHome = false;
  currentServerId = id;
  renderServerIcons();
  $('homeBtn').classList.remove('active');
  chatArea.style.display = 'flex';
  friendsArea.style.display = 'none';
  channelSidebar.style.display = 'flex';
  const s = servers.find(x => x.id === id);
  $('serverName').textContent = s ? s.name : 'Server';
  loadChannels(id);
  loadMembers(id);
}

$('homeBtn').onclick = () => goHome();

function goHome() {
  isHome = true;
  currentServerId = null;
  currentChannelId = null;
  [unsubChannels, unsubMessages, unsubMembers, unsubTyping].forEach(u => u && u());
  unsubChannels = unsubMessages = unsubMembers = unsubTyping = null;
  renderServerIcons();
  $('homeBtn').classList.add('active');
  chatArea.style.display = 'none';
  friendsArea.style.display = 'flex';
  channelSidebar.style.display = 'flex';
  $('serverName').textContent = 'Direct Messages';
  channelList.innerHTML = `
    <div class="dm-header"><span>DIRECT MESSAGES</span></div>
    <div style="padding:20px 8px;text-align:center;color:var(--text-muted);font-size:14px;">
      Select a server or create one to start chatting!
    </div>`;
}

// ===== CREATE / JOIN SERVER =====
$('addServerBtn').onclick = () => {
  $('createServerModal').classList.add('show');
  $('newServerName').value = (userProfile.username || 'My') + "'s server";
  $('joinServerCode').value = '';
};
$('cancelCreateServer').onclick = () => $('createServerModal').classList.remove('show');

$('createServerBtn').onclick = async () => {
  const name = $('newServerName').value.trim();
  if (!name) return;
  $('createServerBtn').disabled = true;
  try {
    const code = genCode();
    const ref = await db.collection('servers').add({
      name, ownerId: currentUser.uid, inviteCode: code,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      members: [currentUser.uid]
    });
    await db.collection('servers').doc(ref.id).collection('channels').add({
      name: 'general', createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    await db.collection('users').doc(currentUser.uid).update({
      servers: firebase.firestore.FieldValue.arrayUnion(ref.id)
    });
    $('createServerModal').classList.remove('show');
    selectServer(ref.id);
  } catch (e) { console.error(e); alert('Failed to create server.'); }
  $('createServerBtn').disabled = false;
};

$('joinServerBtn').onclick = async () => {
  const code = $('joinServerCode').value.trim();
  if (!code) return;
  $('joinServerBtn').disabled = true;
  try {
    const snap = await db.collection('servers').where('inviteCode', '==', code).limit(1).get();
    if (snap.empty) { alert('Invalid invite code.'); $('joinServerBtn').disabled = false; return; }
    const sdoc = snap.docs[0];
    const sid = sdoc.id;
    if ((sdoc.data().members || []).includes(currentUser.uid)) {
      $('createServerModal').classList.remove('show');
      selectServer(sid);
      $('joinServerBtn').disabled = false;
      return;
    }
    await db.collection('servers').doc(sid).update({ members: firebase.firestore.FieldValue.arrayUnion(currentUser.uid) });
    await db.collection('users').doc(currentUser.uid).update({ servers: firebase.firestore.FieldValue.arrayUnion(sid) });
    $('createServerModal').classList.remove('show');
    selectServer(sid);
  } catch (e) { console.error(e); alert('Failed to join server.'); }
  $('joinServerBtn').disabled = false;
};

function genCode() {
  const c = 'ABCDEFGHJKMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
  let r = ''; for (let i = 0; i < 8; i++) r += c[Math.floor(Math.random() * c.length)]; return r;
}

// ===== CHANNELS =====
function loadChannels(serverId) {
  if (unsubChannels) unsubChannels();
  unsubChannels = db.collection('servers').doc(serverId).collection('channels')
    .orderBy('createdAt', 'asc').onSnapshot(snap => {
      channels = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderChannels();
      if (!currentChannelId || !channels.find(c => c.id === currentChannelId)) {
        if (channels.length) selectChannel(channels[0].id);
      }
    });
}

function renderChannels() {
  const server = servers.find(s => s.id === currentServerId);
  channelList.innerHTML = '';
  const cat = document.createElement('div');
  cat.className = 'channel-category';
  cat.innerHTML = '<span>Text Channels</span>';
  if (server && server.ownerId === currentUser.uid) {
    const btn = document.createElement('button');
    btn.className = 'add-channel-btn'; btn.textContent = '+'; btn.title = 'Create Channel';
    btn.onclick = e => { e.stopPropagation(); $('createChannelModal').classList.add('show'); $('newChannelName').value = ''; };
    cat.appendChild(btn);
  }
  channelList.appendChild(cat);
  channels.forEach(ch => {
    const item = document.createElement('div');
    item.className = 'channel-item' + (currentChannelId === ch.id ? ' active' : '');
    item.innerHTML = `<span class="channel-hash">#</span><span class="channel-name">${esc(ch.name)}</span>`;
    if (server && server.ownerId === currentUser.uid && channels.length > 1) {
      const acts = document.createElement('div'); acts.className = 'channel-actions';
      const del = document.createElement('button'); del.className = 'channel-action-btn'; del.textContent = '‚úï'; del.title = 'Delete';
      del.onclick = async e => { e.stopPropagation(); if (confirm(`Delete #${ch.name}?`)) await db.collection('servers').doc(currentServerId).collection('channels').doc(ch.id).delete(); };
      acts.appendChild(del); item.appendChild(acts);
    }
    item.onclick = () => selectChannel(ch.id);
    channelList.appendChild(item);
  });
}

function selectChannel(id) {
  currentChannelId = id;
  const ch = channels.find(c => c.id === id);
  if (ch) { $('chatChannelName').textContent = ch.name; messageInput.placeholder = `Message #${ch.name}`; }
  renderChannels();
  loadMessages();
  listenTyping();
}

$('cancelCreateChannel').onclick = () => $('createChannelModal').classList.remove('show');
$('createChannelBtn').onclick = async () => {
  let name = $('newChannelName').value.trim().toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9\-_]/g, '');
  if (!name) return;
  $('createChannelBtn').disabled = true;
  try {
    await db.collection('servers').doc(currentServerId).collection('channels').add({ name, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    $('createChannelModal').classList.remove('show');
  } catch (e) { console.error(e); }
  $('createChannelBtn').disabled = false;
};
$('newChannelName').onkeydown = e => { if (e.key === 'Enter') $('createChannelBtn').click(); };

// ===== MESSAGES =====
function loadMessages() {
  if (unsubMessages) unsubMessages();
  if (!currentServerId || !currentChannelId) return;
  messagesContainer.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>';
  unsubMessages = db.collection('servers').doc(currentServerId)
    .collection('channels').doc(currentChannelId)
    .collection('messages').orderBy('createdAt', 'asc').limitToLast(100)
    .onSnapshot(snap => {
      renderMessages(snap.docs.map(d => ({ id: d.id, ...d.data() })));
    });
}

function renderMessages(msgs) {
  const ch = channels.find(c => c.id === currentChannelId);
  const atBot = isAtBottom();
  messagesContainer.innerHTML = '';
  const w = document.createElement('div'); w.className = 'welcome-message';
  w.innerHTML = `<div class="channel-icon-large">#</div><h1>Welcome to #${esc(ch ? ch.name : 'channel')}</h1><p>This is the start of #${esc(ch ? ch.name : 'channel')}.</p>`;
  messagesContainer.appendChild(w);
  let lastAuth = null, lastTs = null;
  msgs.forEach(msg => {
    const newGroup = msg.authorId !== lastAuth || !lastTs || !msg.createdAt || (msg.createdAt.toMillis() - lastTs > 420000);
    const div = document.createElement('div');
    div.className = 'message-group' + (newGroup ? ' has-header' : '');
    const t = msg.createdAt ? msg.createdAt.toDate() : new Date();
    if (newGroup) {
      div.innerHTML = `
        <div class="msg-avatar avatar-color-${msg.avatarColor||0}">${esc((msg.authorName||'?')[0].toUpperCase())}</div>
        <div class="msg-content">
          <div class="msg-header">
            <span class="msg-author">${esc(msg.authorName||'Unknown')}</span>
            <span class="msg-timestamp">${fmtDate(t)} ${fmtTime(t)}</span>
          </div>
          <div class="msg-text">${fmtMsg(msg.text||'')}</div>
        </div>`;
    } else {
      div.innerHTML = `
        <div class="msg-avatar collapsed"></div>
        <div class="msg-content">
          <span class="msg-hover-timestamp">${fmtTime(t)}</span>
          <div class="msg-text">${fmtMsg(msg.text||'')}</div>
        </div>`;
    }
    messagesContainer.appendChild(div);
    lastAuth = msg.authorId;
    lastTs = msg.createdAt ? msg.createdAt.toMillis() : Date.now();
  });
  if (atBot || msgs.length === 0) scrollBot();
}

function fmtMsg(text) {
  let t = esc(text);
  t = t.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
  t = t.replace(/`([^`]+)`/g, '<code>$1</code>');
  t = t.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  t = t.replace(/\*(.+?)\*/g, '<em>$1</em>');
  t = t.replace(/__(.+?)__/g, '<u>$1</u>');
  t = t.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
  return t;
}

function isAtBottom() { return messagesContainer.scrollHeight - messagesContainer.scrollTop - messagesContainer.clientHeight < 100; }
function scrollBot() { requestAnimationFrame(() => { messagesContainer.scrollTop = messagesContainer.scrollHeight; }); }

messageInput.onkeydown = e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); } };

async function sendMsg() {
  const text = messageInput.value.trim();
  if (!text || !currentServerId || !currentChannelId) return;
  messageInput.value = '';
  autoResize();
  try {
    await db.collection('servers').doc(currentServerId)
      .collection('channels').doc(currentChannelId)
      .collection('messages').add({
        text, authorId: currentUser.uid, authorName: userProfile.username,
        avatarColor: userProfile.avatarColor || 0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    clearTyping();
  } catch (e) { console.error(e); }
}

messageInput.oninput = () => { autoResize(); setTyping(); };
function autoResize() { messageInput.style.height = 'auto'; messageInput.style.height = Math.min(messageInput.scrollHeight, 300) + 'px'; }

// ===== TYPING =====
function setTyping() {
  if (!currentServerId || !currentChannelId) return;
  const ref = db.collection('servers').doc(currentServerId).collection('channels').doc(currentChannelId).collection('typing').doc(currentUser.uid);
  ref.set({ username: userProfile.username, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
  if (typingTimeout) clearTimeout(typingTimeout);
  typingTimeout = setTimeout(() => ref.delete().catch(()=>{}), 5000);
}

function clearTyping() {
  if (!currentServerId || !currentChannelId) return;
  db.collection('servers').doc(currentServerId).collection('channels').doc(currentChannelId).collection('typing').doc(currentUser.uid).delete().catch(()=>{});
  if (typingTimeout) clearTimeout(typingTimeout);
}

function listenTyping() {
  if (unsubTyping) unsubTyping();
  if (!currentServerId || !currentChannelId) return;
  unsubTyping = db.collection('servers').doc(currentServerId).collection('channels').doc(currentChannelId).collection('typing')
    .onSnapshot(snap => {
      const now = Date.now();
      const names = [];
      snap.docs.forEach(d => {
        if (d.id === currentUser.uid) return;
        const data = d.data();
        if (data.timestamp && (now - data.timestamp.toMillis() < 8000)) names.push(data.username);
      });
      if (!names.length) typingIndicator.innerHTML = '';
      else if (names.length === 1) typingIndicator.innerHTML = `<div class="typing-dots"><span></span><span></span><span></span></div> <strong>${esc(names[0])}</strong> is typing...`;
      else if (names.length <= 3) typingIndicator.innerHTML = `<div class="typing-dots"><span></span><span></span><span></span></div> <strong>${names.map(esc).join(', ')}</strong> are typing...`;
      else typingIndicator.innerHTML = `<div class="typing-dots"><span></span><span></span><span></span></div> Several people are typing...`;
    });
}

// ===== MEMBERS =====
function loadMembers(serverId) {
  if (unsubMembers) unsubMembers();
  unsubMembers = db.collection('servers').doc(serverId).onSnapshot(async doc => {
    if (!doc.exists) return;
    const ids = doc.data().members || [];
    if (!ids.length) { members = []; renderMembers(); return; }
    const all = [];
    for (let i = 0; i < ids.length; i += 10) {
      const batch = ids.slice(i, i + 10);
      const s = await db.collection('users').where(firebase.firestore.FieldPath.documentId(), 'in', batch).get();
      s.docs.forEach(d => all.push({ id: d.id, ...d.data() }));
    }
    members = all;
    renderMembers();
  });
}

function renderMembers() {
  membersSidebar.innerHTML = '';
  const on = members.filter(m => m.status === 'online');
  const off = members.filter(m => m.status !== 'online');
  if (on.length) {
    const c = document.createElement('div'); c.className = 'member-category'; c.textContent = `ONLINE ‚Äî ${on.length}`;
    membersSidebar.appendChild(c);
    on.forEach(m => membersSidebar.appendChild(mkMember(m, 'online')));
  }
  if (off.length) {
    const c = document.createElement('div'); c.className = 'member-category'; c.textContent = `OFFLINE ‚Äî ${off.length}`;
    membersSidebar.appendChild(c);
    off.forEach(m => membersSidebar.appendChild(mkMember(m, 'offline')));
  }
}

function mkMember(m, status) {
  const d = document.createElement('div'); d.className = 'member-item';
  d.innerHTML = `<div class="member-avatar avatar-color-${m.avatarColor||0}">${esc((m.username||'?')[0].toUpperCase())}<div class="member-status-dot ${status}"></div></div><span class="member-name">${esc(m.username||'Unknown')}</span>`;
  return d;
}

$('toggleMembersBtn').onclick = () => {
  showMembers = !showMembers;
  membersSidebar.classList.toggle('show', showMembers);
  $('toggleMembersBtn').classList.toggle('active', showMembers);
};

// ===== CONTEXT MENU =====
function showCtxMenu(e, server) {
  e.preventDefault();
  const own = server.ownerId === currentUser.uid;
  $('ctxDeleteServer').style.display = own ? 'flex' : 'none';
  $('ctxLeaveServer').style.display = own ? 'none' : 'flex';
  serverContextMenu.style.display = 'block';
  serverContextMenu.style.left = e.clientX + 'px';
  serverContextMenu.style.top = e.clientY + 'px';
  serverContextMenu.dataset.serverId = server.id;
  const r = serverContextMenu.getBoundingClientRect();
  if (r.right > innerWidth) serverContextMenu.style.left = (innerWidth - r.width - 5) + 'px';
  if (r.bottom > innerHeight) serverContextMenu.style.top = (innerHeight - r.height - 5) + 'px';
}

document.addEventListener('click', () => serverContextMenu.style.display = 'none');

$('ctxInvite').onclick = () => {
  const s = servers.find(x => x.id === serverContextMenu.dataset.serverId);
  if (s) { $('inviteCodeText').textContent = s.inviteCode; $('inviteModal').classList.add('show'); }
};

$('copyInviteBtn').onclick = () => {
  navigator.clipboard.writeText($('inviteCodeText').textContent);
  $('copyInviteBtn').textContent = 'Copied!';
  setTimeout(() => $('copyInviteBtn').textContent = 'Copy', 2000);
};

$('closeInviteModal').onclick = () => $('inviteModal').classList.remove('show');

$('ctxCreateChannel').onclick = () => {
  currentServerId = serverContextMenu.dataset.serverId;
  $('createChannelModal').classList.add('show');
  $('newChannelName').value = '';
};

$('ctxLeaveServer').onclick = async () => {
  const sid = serverContextMenu.dataset.serverId;
  const s = servers.find(x => x.id === sid);
  if (!confirm(`Leave "${s?.name}"?`)) return;
  try {
    await db.collection('servers').doc(sid).update({ members: firebase.firestore.FieldValue.arrayRemove(currentUser.uid) });
    await db.collection('users').doc(currentUser.uid).update({ servers: firebase.firestore.FieldValue.arrayRemove(sid) });
    if (currentServerId === sid) goHome();
  } catch (e) { console.error(e); }
};

$('ctxDeleteServer').onclick = async () => {
  const sid = serverContextMenu.dataset.serverId;
  const s = servers.find(x => x.id === sid);
  if (!confirm(`Permanently delete "${s?.name}"? This cannot be undone.`)) return;
  try {
    const sdoc = await db.collection('servers').doc(sid).get();
    const mids = sdoc.data().members || [];
    for (const uid of mids) await db.collection('users').doc(uid).update({ servers: firebase.firestore.FieldValue.arrayRemove(sid) });
    const csnap = await db.collection('servers').doc(sid).collection('channels').get();
    for (const ch of csnap.docs) {
      const msnap = await db.collection('servers').doc(sid).collection('channels').doc(ch.id).collection('messages').get();
      for (const m of msnap.docs) await m.ref.delete();
      const tsnap = await db.collection('servers').doc(sid).collection('channels').doc(ch.id).collection('typing').get();
      for (const t of tsnap.docs) await t.ref.delete();
      await ch.ref.delete();
    }
    await db.collection('servers').doc(sid).delete();
    if (currentServerId === sid) goHome();
  } catch (e) { console.error(e); }
};

$('serverHeader').onclick = e => {
  if (!currentServerId) return;
  const s = servers.find(x => x.id === currentServerId);
  if (s) showCtxMenu(e, s);
};

// ===== SETTINGS =====
$('settingsBtn').onclick = () => { $('settingsOverlay').classList.add('show'); $('editDisplayName').value = userProfile.username; };
$('closeSettings').onclick = () => $('settingsOverlay').classList.remove('show');

$('saveProfileBtn').onclick = async () => {
  const name = $('editDisplayName').value.trim();
  if (!name) return;
  try {
    await db.collection('users').doc(currentUser.uid).update({ username: name });
    userProfile.username = name;
    updateUserPanel();
    $('settingsOverlay').classList.remove('show');
  } catch (e) { console.error(e); }
};

$('logoutBtnSettings').onclick = async () => {
  $('settingsOverlay').classList.remove('show');
  try { await db.collection('users').doc(currentUser.uid).update({ status: 'offline' }); } catch(e){}
  auth.signOut();
};

// ===== UTILS =====
function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function fmtTime(d) { return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); }
function fmtDate(d) {
  const today = new Date(), y = new Date(today); y.setDate(y.getDate() - 1);
  if (d.toDateString() === today.toDateString()) return 'Today at';
  if (d.toDateString() === y.toDateString()) return 'Yesterday at';
  return d.toLocaleDateString() + ' at';
}

// Close modals
document.querySelectorAll('.modal-overlay').forEach(o => o.addEventListener('click', e => { if (e.target === o) o.classList.remove('show'); }));
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal-overlay.show').forEach(m => m.classList.remove('show'));
    $('settingsOverlay').classList.remove('show');
  }
});

// Online/offline status
document.addEventListener('visibilitychange', () => {
  if (!currentUser) return;
  db.collection('users').doc(currentUser.uid).update({ status: document.hidden ? 'idle' : 'online' }).catch(()=>{});
});

window.addEventListener('beforeunload', () => {
  if (currentUser) db.collection('users').doc(currentUser.uid).update({ status: 'offline' }).catch(()=>{});
});
</script>
</body>
</html>

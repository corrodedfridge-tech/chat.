<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat v1.3</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Mono&family=Playfair+Display:wght@700&family=JetBrains+Mono&family=Outfit:wght@400;600;700&family=Sora:wght@400;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}html,body{height:100%;overflow:hidden}
body{font-family:'Inter',-apple-system,sans-serif;background:#000;color:#fff;-webkit-font-smoothing:antialiased}
:root{--bg0:#000;--bg1:#0a0a0a;--bg2:#111;--bg3:#1a1a1a;--bg4:#222;--tx1:#fff;--tx2:#a0a0a0;--tx3:#666;--tx4:#444;--border:#1e1e1e;--danger:#ff453a;--success:#30d158;--blue:#0a84ff;--orange:#ff9f0a;--purple:#bf5af2;--scroll:#333}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-thumb{background:var(--scroll);border-radius:6px}::-webkit-scrollbar-track{background:transparent}

/* AUTH */
.auth-wrap{display:flex;align-items:center;justify-content:center;height:100vh}
.auth-box{background:var(--bg1);border:1px solid var(--border);border-radius:24px;padding:48px;width:440px;max-width:92vw;animation:fu .4s ease}
@keyframes fu{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.auth-box .la{text-align:center;margin-bottom:32px}
.auth-box .li{width:56px;height:56px;background:#fff;border-radius:16px;display:inline-flex;align-items:center;justify-content:center;font-size:24px;color:#000;margin-bottom:16px}
.auth-box h1{font-size:26px;font-weight:700;text-align:center}
.auth-box .sub{color:var(--tx2);text-align:center;font-size:14px;margin:6px 0 32px}
.fg{margin-bottom:18px}
.fg label{display:block;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--tx3);margin-bottom:6px}
.fg input,.fg select{width:100%;padding:11px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;color:#fff;font-size:14px;font-family:inherit;outline:none;transition:border .2s}
.fg input:focus,.fg select:focus{border-color:var(--tx3)}
.fg select{cursor:pointer;-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23666' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}
.btn{width:100%;padding:12px;border:none;border-radius:12px;font-size:14px;font-weight:600;font-family:inherit;cursor:pointer;transition:all .15s}
.btn-w{background:#fff;color:#000}.btn-w:hover{opacity:.9}
.btn-g{background:var(--bg3);color:var(--tx2);margin-top:10px}.btn-g:hover{background:var(--bg4);color:#fff}
.btn-d{background:var(--danger);color:#fff}.btn-sm{width:auto;padding:8px 18px;font-size:13px}
.auth-sw{text-align:center;margin-top:20px;font-size:13px;color:var(--tx3)}
.auth-sw a{color:#fff;cursor:pointer;font-weight:500;text-decoration:underline}
.err{background:rgba(255,69,58,.1);border:1px solid rgba(255,69,58,.2);border-radius:10px;padding:10px 14px;font-size:13px;color:var(--danger);margin-bottom:16px;display:none}.err.show{display:block}

/* AUTH DIVIDER */
.auth-divider{display:flex;align-items:center;gap:16px;margin:24px 0}
.auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:var(--border)}
.auth-divider span{font-size:12px;color:var(--tx4);font-weight:500;text-transform:uppercase;letter-spacing:1px}

/* SOCIAL BUTTONS */
.social-btns{display:flex;flex-direction:column;gap:10px;margin-bottom:8px}
.social-btn{width:100%;padding:12px;border:1px solid var(--border);border-radius:12px;font-size:14px;font-weight:500;font-family:inherit;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;gap:10px;background:var(--bg3);color:#fff}
.social-btn:hover{background:var(--bg4);border-color:var(--tx4)}
.social-btn.google{background:#fff;color:#000;border-color:#ddd}
.social-btn.google:hover{background:#f0f0f0}
.social-btn.google svg{width:18px;height:18px}
.social-btn.phone{background:var(--bg3);color:#fff}
.social-btn.phone i{font-size:16px;color:var(--success)}

/* PHONE AUTH */
.phone-step{display:none}
.phone-step.on{display:block}
.phone-input-row{display:flex;gap:8px}
.phone-input-row select{width:100px;flex-shrink:0;padding:11px 8px;font-size:13px}
.phone-input-row input{flex:1}
.otp-inputs{display:flex;gap:8px;justify-content:center;margin:16px 0}
.otp-inputs input{width:48px;height:56px;text-align:center;font-size:24px;font-weight:700;background:var(--bg3);border:1px solid var(--border);border-radius:12px;color:#fff;font-family:inherit;outline:none;transition:border .2s}
.otp-inputs input:focus{border-color:var(--tx2)}
.resend-timer{text-align:center;font-size:13px;color:var(--tx4);margin-top:8px}
.resend-timer a{color:var(--blue);cursor:pointer}

/* USERNAME SETUP (for social/phone signups) */
.username-setup{display:none}
.username-setup.on{display:block}

/* RECAPTCHA */
#recaptcha-container{display:flex;justify-content:center;margin:16px 0}

/* AUTH TABS */
.auth-tabs{display:flex;gap:4px;margin-bottom:24px;background:var(--bg3);border-radius:10px;padding:4px}
.auth-tab{flex:1;padding:10px;text-align:center;font-size:13px;font-weight:600;color:var(--tx3);cursor:pointer;border-radius:8px;transition:all .15s}
.auth-tab:hover{color:var(--tx2)}
.auth-tab.on{background:var(--bg4);color:#fff}

/* REST OF APP STYLES (same as v1.2) */
.app{display:none;height:100vh;width:100vw;overflow:hidden}.app.on{display:flex}
.np{position:fixed;top:0;right:0;width:380px;max-width:100vw;height:100vh;background:var(--bg1);border-left:1px solid var(--border);z-index:900;transform:translateX(100%);transition:transform .3s;display:flex;flex-direction:column}.np.on{transform:translateX(0)}
.np-h{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}.np-h h3{font-size:16px;font-weight:700}
.np-h button{background:none;border:none;color:var(--tx3);cursor:pointer;font-size:16px;padding:4px 8px;border-radius:6px}.np-h button:hover{background:var(--bg3);color:#fff}
.np-l{flex:1;overflow-y:auto;padding:8px}
.ni{display:flex;gap:12px;padding:12px;border-radius:10px;cursor:pointer;transition:background .12s;margin-bottom:4px}.ni:hover{background:var(--bg3)}
.ni.unread{background:rgba(10,132,255,.06);border:1px solid rgba(10,132,255,.1)}
.ni .na{width:36px;height:36px;border-radius:50%;background:var(--bg4);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:600;overflow:hidden;flex-shrink:0}.ni .na img{width:100%;height:100%;object-fit:cover}
.ni .nb{flex:1;min-width:0}.ni .ns{font-size:11px;color:var(--tx3);margin-bottom:2px}.ni .ns b{color:var(--tx2)}.ni .nn{font-weight:600;font-size:13px;margin-bottom:1px}
.ni .nm{font-size:12px;color:var(--tx2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.ni .nt{font-size:10px;color:var(--tx4);margin-top:4px}
.ne{text-align:center;padding:60px 20px;color:var(--tx4)}.ne i{font-size:36px;margin-bottom:12px;display:block;opacity:.3}
.call-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.97);z-index:2000;flex-direction:column;align-items:center;justify-content:center}.call-overlay.on{display:flex}
.call-info{text-align:center;margin-bottom:40px}.call-info .ca-ava{width:96px;height:96px;border-radius:50%;background:var(--bg4);display:flex;align-items:center;justify-content:center;font-size:36px;font-weight:700;overflow:hidden;margin:0 auto 16px}.call-info .ca-ava img{width:100%;height:100%;object-fit:cover}
.call-info .ca-name{font-size:24px;font-weight:700;margin-bottom:4px}.call-info .ca-status{font-size:14px;color:var(--tx3)}.call-info .ca-status.ringing{animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
.call-videos{display:flex;gap:16px;margin-bottom:40px;flex-wrap:wrap;justify-content:center;position:relative}
.call-videos video{border-radius:16px;background:#000;object-fit:cover;border:2px solid var(--border)}
.call-videos .rv{width:480px;height:360px}.call-videos .lv{width:160px;height:120px;position:fixed;bottom:120px;right:20px;z-index:10;border-color:var(--blue);border-radius:12px}
.call-controls{display:flex;gap:16px}
.call-btn{width:56px;height:56px;border-radius:50%;border:none;font-size:20px;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center}
.call-btn.mute{background:var(--bg4);color:#fff}.call-btn.mute.on{background:var(--danger)}
.call-btn.cam{background:var(--bg4);color:#fff}.call-btn.cam.on{background:var(--blue)}
.call-btn.end{background:var(--danger);color:#fff;width:64px;height:64px;font-size:24px}
.call-timer{font-size:14px;color:var(--tx2);margin-top:16px;font-variant-numeric:tabular-nums}
.call-quality{font-size:11px;color:var(--tx4);margin-top:4px}
.incoming-call{display:none;position:fixed;top:20px;left:50%;transform:translateX(-50%);background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:16px 24px;z-index:3000;align-items:center;gap:16px;box-shadow:0 8px 32px rgba(0,0,0,.6);animation:fu .3s ease}.incoming-call.on{display:flex}
.incoming-call .ic-ava{width:44px;height:44px;border-radius:50%;background:var(--bg4);display:flex;align-items:center;justify-content:center;font-weight:600;overflow:hidden;flex-shrink:0}.incoming-call .ic-ava img{width:100%;height:100%;object-fit:cover}
.incoming-call .ic-info{flex:1}.incoming-call .ic-name{font-weight:600;font-size:14px}.incoming-call .ic-type{font-size:12px;color:var(--tx3)}
.incoming-call .ic-btns{display:flex;gap:8px}.incoming-call .ic-btns button{width:40px;height:40px;border-radius:50%;border:none;font-size:16px;cursor:pointer}
.incoming-call .ic-accept{background:var(--success);color:#fff}.incoming-call .ic-decline{background:var(--danger);color:#fff}
.sbar{width:72px;min-width:72px;background:var(--bg0);display:flex;flex-direction:column;align-items:center;padding:12px 0;gap:4px;overflow-y:auto;border-right:1px solid var(--border);flex-shrink:0}.sbar::-webkit-scrollbar{width:0}
.si{width:48px;height:48px;border-radius:24px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;background:var(--bg2);color:var(--tx2);font-size:18px;font-weight:600;position:relative;overflow:hidden;flex-shrink:0;user-select:none}.si img{width:100%;height:100%;object-fit:cover}.si:hover{border-radius:16px;background:var(--bg4)}.si.on{border-radius:16px;background:var(--bg4);color:#fff}.si.on::before{content:'';position:absolute;left:-14px;width:4px;height:20px;background:#fff;border-radius:0 4px 4px 0}.si.home{margin-bottom:2px}.si.home.on{background:#fff;color:#000}.si.home.on::before{display:none}.sdiv{width:32px;height:1px;background:var(--border);margin:4px 0;flex-shrink:0}.si.add{background:transparent;border:2px dashed var(--tx4);color:var(--tx4);font-size:20px}.si.add:hover{border-color:var(--success);color:var(--success)}
.side{width:260px;min-width:260px;background:var(--bg1);display:flex;flex-direction:column;border-right:1px solid var(--border);flex-shrink:0;height:100%}
.side-h{padding:0 16px;border-bottom:1px solid var(--border);font-weight:700;font-size:15px;display:flex;align-items:center;justify-content:space-between;height:52px;min-height:52px;flex-shrink:0}.side-h .acts{display:flex;gap:4px}.side-h .acts button{background:none;border:none;color:var(--tx3);cursor:pointer;font-size:15px;padding:6px;border-radius:8px;transition:all .12s}.side-h .acts button:hover{background:var(--bg3);color:#fff}
.side-c{flex:1;overflow-y:auto;padding:8px;min-height:0}
.side-tabs{display:flex;padding:8px 8px 0;gap:4px;flex-shrink:0}.side-tab{flex:1;padding:8px;text-align:center;font-size:12px;font-weight:600;color:var(--tx3);cursor:pointer;border-radius:8px;transition:all .15s;position:relative}.side-tab:hover{background:var(--bg3);color:var(--tx2)}.side-tab.on{background:var(--bg4);color:#fff}.side-tab .tbadge{position:absolute;top:2px;right:2px;width:8px;height:8px;border-radius:50%;background:var(--danger);display:none}.side-tab .tbadge.on{display:block}
.search-box{padding:8px;flex-shrink:0}.search-box input{width:100%;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:#fff;font-size:13px;font-family:inherit;outline:none}
.cat{padding:18px 8px 4px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--tx4);display:flex;align-items:center;justify-content:space-between}.cat .add-ch{font-size:13px;opacity:0;transition:opacity .15s;background:none;border:none;color:var(--tx4);cursor:pointer}.cat:hover .add-ch{opacity:1}
.ch,.dmi,.fri{display:flex;align-items:center;padding:7px 10px;border-radius:8px;cursor:pointer;transition:all .12s;gap:10px;font-size:14px;color:var(--tx2);margin:1px 0}.ch:hover,.dmi:hover,.fri:hover{background:var(--bg3);color:#fff}.ch.on,.dmi.on{background:var(--bg4);color:#fff}.ch i{font-size:16px;opacity:.4;width:20px;text-align:center}
.ava{width:32px;height:32px;border-radius:50%;background:var(--bg4);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;overflow:hidden;flex-shrink:0;position:relative}.ava img{width:100%;height:100%;object-fit:cover}.ava .sd{position:absolute;bottom:0;right:0;width:10px;height:10px;border-radius:50%;border:2px solid var(--bg1)}.ava .sd.on{background:var(--success)}.ava .sd.off{background:var(--tx4)}
.dmi-info{flex:1;min-width:0}.dmi-name{font-weight:500;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.dmi-sub{font-size:11px;color:var(--tx4);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.fri{justify-content:space-between}.fri-left{display:flex;align-items:center;gap:10px;flex:1;min-width:0}.fri-name{font-weight:500;font-size:13px}.fri-user{font-size:11px;color:var(--tx4)}.fri-actions{display:flex;gap:4px}.fri-actions button{background:var(--bg3);border:1px solid var(--border);color:var(--tx2);cursor:pointer;font-size:12px;padding:5px 8px;border-radius:6px;transition:all .12s}.fri-actions button:hover{background:var(--bg4);color:#fff}.fri-actions .acc{color:var(--success);border-color:rgba(48,209,88,.3)}.fri-actions .dec{color:var(--danger);border-color:rgba(255,69,58,.3)}
.label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--tx4);padding:14px 10px 6px}
.upanel{padding:10px 12px;border-top:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-shrink:0}.upanel .ua{width:34px;height:34px;border-radius:50%;background:var(--bg4);display:flex;align-items:center;justify-content:center;font-weight:600;overflow:hidden;cursor:pointer;flex-shrink:0;font-size:13px}.upanel .ua img{width:100%;height:100%;object-fit:cover}.upanel .ui{flex:1;min-width:0}.upanel .un{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.upanel .ut{font-size:11px;color:var(--tx4)}.upanel .pa{display:flex;gap:2px}.upanel .pa button{background:none;border:none;color:var(--tx4);cursor:pointer;font-size:13px;padding:5px;border-radius:6px;transition:all .12s}.upanel .pa button:hover{background:var(--bg3);color:#fff}
.nd{position:relative}.nd .dot{position:absolute;top:0;right:0;width:8px;height:8px;border-radius:50%;background:var(--danger);display:none}.nd .dot.on{display:block}
.chat{flex:1;display:flex;flex-direction:column;min-width:0;height:100vh;overflow:hidden;background:var(--bg0)}
.chat-h{padding:0 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;height:52px;min-height:52px;flex-shrink:0}.chat-h .ci{color:var(--tx4);font-size:17px}.chat-h .cn{font-weight:700;font-size:15px}.chat-h .ha{margin-left:auto;display:flex;gap:2px}.chat-h .ha button{background:none;border:none;color:var(--tx3);cursor:pointer;font-size:15px;padding:6px 8px;border-radius:6px;transition:all .12s}.chat-h .ha button:hover{background:var(--bg3);color:#fff}
.cbody{flex:1;display:flex;overflow:hidden;min-height:0}.cmain{flex:1;display:flex;flex-direction:column;min-width:0;min-height:0;overflow:hidden}
.msgs{flex:1;overflow-y:auto;overflow-x:hidden;padding:16px 20px 8px;min-height:0}
.mlist{display:flex;flex-direction:column;justify-content:flex-end;min-height:100%}
.msg{display:flex;gap:12px;padding:6px 8px;border-radius:6px;transition:background .08s;position:relative}.msg:hover{background:rgba(255,255,255,.02)}.msg.grouped{padding-top:2px;padding-bottom:2px}
.msg .ma{width:40px;height:40px;border-radius:50%;background:var(--bg2);display:flex;align-items:center;justify-content:center;font-weight:600;font-size:14px;overflow:hidden;flex-shrink:0;cursor:pointer}.msg .ma img{width:100%;height:100%;object-fit:cover}
.msg .mc{flex:1;min-width:0}.msg .mh{display:flex;align-items:baseline;gap:8px;margin-bottom:2px}.msg .mn{font-weight:600;font-size:14px;cursor:pointer}.msg .mn:hover{text-decoration:underline}.msg .mt{font-size:11px;color:var(--tx4)}
.msg .mb{font-size:14px;line-height:1.5;color:var(--tx2);word-wrap:break-word}.msg .mb a{color:var(--blue)}.msg .mi{max-width:400px;max-height:300px;border-radius:10px;margin-top:6px;cursor:pointer;display:block}
.msg.grouped .mh{display:none}.msg.grouped .ma{width:40px;visibility:hidden}
.msg .mht{font-size:10px;color:var(--tx4);opacity:0;width:40px;text-align:center;line-height:22px;flex-shrink:0}.msg.grouped:hover .mht{opacity:1}
.msg .tb{position:absolute;top:-12px;right:8px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;display:none;padding:2px;z-index:10}.msg:hover .tb{display:flex}
.tb button{background:none;border:none;color:var(--tx3);cursor:pointer;font-size:13px;padding:4px 7px;border-radius:4px}.tb button:hover{background:var(--bg4);color:#fff}
.msg .rr{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--tx3);margin-bottom:4px;cursor:pointer}.msg .rr:hover{color:var(--tx2)}.msg .rr .rrb{width:2px;height:14px;background:var(--tx4);border-radius:1px;flex-shrink:0;margin-right:4px}.msg .rr .rrn{font-weight:600}
.etag{font-size:11px;color:var(--tx4);margin-left:4px}
.welcome{padding:16px 8px 12px;border-bottom:1px solid var(--border);margin-bottom:12px}.welcome h2{font-size:24px;font-weight:700;margin-bottom:4px}.welcome p{color:var(--tx4);font-size:13px}
.abar{display:none;padding:6px 20px 0;flex-shrink:0}.abar.on{display:flex;align-items:center;gap:10px}.abar .abi{flex:1;font-size:13px;color:var(--tx2);display:flex;align-items:center;gap:8px;background:var(--bg2);padding:8px 14px;border-radius:10px 10px 0 0;border:1px solid var(--border);border-bottom:none}.abar .abi i{font-size:14px}.abar .abl{font-weight:600;color:#fff}.abar .abt{color:var(--tx3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}.abar .abc{background:none;border:none;color:var(--tx3);cursor:pointer;font-size:14px;padding:6px}.abar.on~.input-area .ibox{border-top:none;border-radius:0 0 12px 12px}
.input-area{padding:0 20px 16px;flex-shrink:0;position:relative}
.upprev{display:none;padding:10px 12px;background:var(--bg2);border:1px solid var(--border);border-bottom:none;border-radius:12px 12px 0 0;align-items:center;gap:12px}.upprev.on{display:flex}.upprev img{width:60px;height:60px;object-fit:cover;border-radius:8px}.upprev .ui2{flex:1;font-size:13px;color:var(--tx2)}.upprev .ur{background:none;border:none;color:var(--danger);cursor:pointer;font-size:15px}.upprev.on+.ibox{border-radius:0 0 12px 12px;border-top:none}
.ibox{background:var(--bg2);border:1px solid var(--border);border-radius:12px;display:flex;align-items:flex-end;padding:4px;transition:border .2s}.ibox:focus-within{border-color:var(--tx4)}
.iacts{display:flex;gap:1px;padding:4px 2px}.iacts button{background:none;border:none;color:var(--tx4);cursor:pointer;font-size:17px;padding:6px;border-radius:8px;transition:all .12s}.iacts button:hover{background:var(--bg3);color:#fff}
.ifield{flex:1;background:none;border:none;color:#fff;font-size:14px;font-family:inherit;padding:9px 8px;outline:none;resize:none;max-height:180px;line-height:1.4}.ifield::placeholder{color:var(--tx4)}
.sbtn{background:none;border:none;color:var(--tx4);cursor:pointer;font-size:17px;padding:6px 10px;margin:4px;border-radius:8px;transition:all .12s}.sbtn:hover{background:#fff;color:#000}
.gifp{display:none;position:absolute;bottom:68px;left:0;width:400px;height:420px;background:var(--bg2);border:1px solid var(--border);border-radius:14px;z-index:500;flex-direction:column;overflow:hidden}.gifp.on{display:flex}.gifp-h{padding:10px;border-bottom:1px solid var(--border);flex-shrink:0}.gifp-h input{width:100%;padding:9px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:#fff;font-size:13px;font-family:inherit;outline:none}.gifg{flex:1;overflow-y:auto;padding:8px;display:grid;grid-template-columns:1fr 1fr;gap:6px;align-content:start;min-height:0}.gifg img{width:100%;border-radius:6px;cursor:pointer;transition:transform .1s;display:block}.gifg img:hover{transform:scale(.97)}.gifg .gl{grid-column:1/-1;text-align:center;padding:40px;color:var(--tx4);font-size:13px}
.memside{width:240px;min-width:240px;background:var(--bg1);border-left:1px solid var(--border);padding:12px 8px;overflow-y:auto;display:none;flex-shrink:0}.memside.on{display:block}.memcat{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--tx4);padding:14px 8px 4px}.memi{display:flex;align-items:center;gap:10px;padding:5px 8px;border-radius:8px;cursor:pointer;transition:background .12s}.memi:hover{background:var(--bg3)}.memn{font-size:13px;font-weight:500;color:var(--tx2)}
.empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--tx4);text-align:center;padding:40px}.empty i{font-size:48px;margin-bottom:16px;opacity:.2}.empty h3{font-size:18px;margin-bottom:6px;color:var(--tx2)}.empty p{font-size:13px;max-width:300px}
.mdl-o{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(12px);z-index:1000;align-items:center;justify-content:center}.mdl-o.on{display:flex}
.mdl{background:var(--bg2);border:1px solid var(--border);border-radius:20px;padding:32px;width:460px;max-width:92vw;max-height:85vh;overflow-y:auto;position:relative;animation:fu .25s ease}.mdl h2{font-size:22px;font-weight:700;margin-bottom:6px}.mdl .md{color:var(--tx2);font-size:13px;margin-bottom:24px}
.mdl-x{position:absolute;top:16px;right:16px;background:var(--bg3);border:none;color:var(--tx3);font-size:16px;cursor:pointer;padding:6px 8px;border-radius:8px}.mdl-x:hover{background:var(--bg4);color:#fff}
.pfp-up{width:96px;height:96px;border-radius:50%;border:2px dashed var(--tx4);display:flex;align-items:center;justify-content:center;cursor:pointer;margin:0 auto 20px;overflow:hidden;transition:all .2s;position:relative}.pfp-up:hover{border-color:#fff}.pfp-up img{width:100%;height:100%;object-fit:cover}.pfp-up .pfo{position:absolute;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .2s;font-size:18px}.pfp-up:hover .pfo{opacity:1}
.si-up{width:80px;height:80px;border-radius:16px;border:2px dashed var(--tx4);display:flex;align-items:center;justify-content:center;cursor:pointer;margin:0 auto 20px;overflow:hidden;font-size:24px;color:var(--tx4)}.si-up:hover{border-color:#fff;color:#fff}.si-up img{width:100%;height:100%;object-fit:cover}
.inv-code{background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:12px 16px;font-family:'JetBrains Mono',monospace;font-size:15px;display:flex;align-items:center;justify-content:space-between;margin:12px 0;letter-spacing:1px}.inv-code button{background:#fff;color:#000;border:none;padding:6px 14px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer}
.color-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:6px;margin:8px 0 16px}.color-opt{width:100%;aspect-ratio:1;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all .15s}.color-opt:hover{transform:scale(1.15)}.color-opt.on{border-color:#fff;transform:scale(1.15)}
.font-preview{padding:12px;background:var(--bg3);border-radius:8px;margin:8px 0 16px;font-size:16px;font-weight:600;text-align:center}
.ctx{display:none;position:fixed;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:5px;z-index:3000;min-width:180px;box-shadow:0 8px 32px rgba(0,0,0,.5)}.ctx.on{display:block}.ctx-i{padding:7px 12px;font-size:13px;cursor:pointer;border-radius:6px;display:flex;align-items:center;gap:10px;transition:background .08s;color:var(--tx2)}.ctx-i:hover{background:var(--bg3);color:#fff}.ctx-i.dg{color:var(--danger)}.ctx-i.dg:hover{background:rgba(255,69,58,.1)}
.imgpv{display:none;position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:2000;align-items:center;justify-content:center;cursor:zoom-out}.imgpv.on{display:flex}.imgpv img{max-width:90vw;max-height:90vh;border-radius:8px}
.dzone{border:1px solid rgba(255,69,58,.2);border-radius:12px;padding:16px;margin-top:16px}.dzone h3{color:var(--danger);font-size:14px;font-weight:600;margin-bottom:12px}
.toast-c{position:fixed;top:20px;right:20px;z-index:5000;display:flex;flex-direction:column;gap:8px;pointer-events:none}
.toast{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:14px 16px;display:flex;gap:12px;font-size:13px;animation:si .3s ease;box-shadow:0 8px 32px rgba(0,0,0,.5);max-width:380px;pointer-events:auto;cursor:pointer}
@keyframes si{from{opacity:0;transform:translateX(40px)}to{opacity:1;transform:translateX(0)}}
.toast .ta{width:36px;height:36px;border-radius:50%;background:var(--bg4);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:600;overflow:hidden;flex-shrink:0}.toast .ta img{width:100%;height:100%;object-fit:cover}.toast .tb2{flex:1;min-width:0}.toast .ts{font-size:11px;color:var(--tx3);margin-bottom:2px}.toast .ts b{color:var(--tx2)}.toast .tn{font-weight:600;font-size:13px;margin-bottom:1px}.toast .tm{color:var(--tx2);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.toast .tx{background:none;border:none;color:var(--tx4);cursor:pointer;font-size:14px;padding:4px;flex-shrink:0;align-self:flex-start;pointer-events:auto}
.inv-f{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:8px;margin:2px 0}.inv-f:hover{background:var(--bg3)}.inv-f .ifn{flex:1;min-width:0}.inv-f .ifn div:first-child{font-size:13px;font-weight:500}.inv-f .ifn div:last-child{font-size:11px;color:var(--tx4)}.inv-btn{background:var(--blue);color:#fff;border:none;padding:6px 14px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;white-space:nowrap}.inv-btn:hover{opacity:.85}.inv-btn:disabled{opacity:.4}
.vtag{position:fixed;bottom:8px;left:50%;transform:translateX(-50%);font-size:10px;color:var(--tx4);opacity:.3;pointer-events:none;z-index:1}
</style>
</head>
<body>
<div class="toast-c" id="toasts"></div>
<div class="vtag">Chat v1.3</div>

<div class="call-overlay" id="callOverlay"><div class="call-info" id="callInfo"><div class="ca-ava" id="callAva"></div><div class="ca-name" id="callName">User</div><div class="ca-status" id="callStatus">Calling...</div></div><div class="call-videos" id="callVideos" style="display:none"><video id="remoteVideo" class="rv" autoplay playsinline></video><video id="localVideo" class="lv" autoplay playsinline muted></video></div><div class="call-controls"><button class="call-btn mute" id="muteBtn" onclick="toggleMute()"><i class="fas fa-microphone"></i></button><button class="call-btn end" onclick="endCall()"><i class="fas fa-phone-slash"></i></button><button class="call-btn cam" id="camBtn" onclick="toggleCam()" style="display:none"><i class="fas fa-video"></i></button></div><div class="call-timer" id="callTimer"></div><div class="call-quality" id="callQuality"></div></div>
<div class="incoming-call" id="incomingCall"><div class="ic-ava" id="icAva"></div><div class="ic-info"><div class="ic-name" id="icName">User</div><div class="ic-type" id="icType">Voice Call</div></div><div class="ic-btns"><button class="ic-accept" onclick="acceptCall()"><i class="fas fa-phone"></i></button><button class="ic-decline" onclick="declineCall()"><i class="fas fa-phone-slash"></i></button></div></div>

<!-- AUTH PAGE -->
<div class="auth-wrap" id="authPage">
<div class="auth-box">
<div class="la"><div class="li"><i class="fas fa-bolt"></i></div></div>
<h1 id="authTitle">Welcome to Chat</h1>
<p class="sub" id="authSub">Sign in or create an account</p>
<div class="err" id="authErr"></div>

<!-- SOCIAL SIGN IN -->
<div class="social-btns" id="socialBtns">
<button class="social-btn google" onclick="googleSignIn()">
<svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
Continue with Google
</button>
<button class="social-btn phone" onclick="showPhoneAuth()">
<i class="fas fa-phone"></i>
Continue with Phone
</button>
</div>

<div class="auth-divider"><span>or</span></div>

<!-- AUTH TABS -->
<div class="auth-tabs" id="authTabs">
<div class="auth-tab on" data-t="login" onclick="switchAuthTab('login')">Sign In</div>
<div class="auth-tab" data-t="register" onclick="switchAuthTab('register')">Create Account</div>
</div>

<!-- EMAIL LOGIN -->
<div id="emailLogin">
<div class="fg"><label>Email</label><input type="email" id="lEmail" placeholder="name@example.com"></div>
<div class="fg"><label>Password</label><input type="password" id="lPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
<button class="btn btn-w" onclick="doLogin()">Sign In</button>
</div>

<!-- EMAIL REGISTER -->
<div id="emailReg" style="display:none">
<div class="fg"><label>Display Name</label><input type="text" id="rName" placeholder="John"></div>
<div class="fg"><label>Username</label><input type="text" id="rUser" placeholder="john_doe"></div>
<div class="fg"><label>Email</label><input type="email" id="rEmail" placeholder="name@example.com"></div>
<div class="fg"><label>Password</label><input type="password" id="rPass" placeholder="Min 6 characters"></div>
<button class="btn btn-w" onclick="doReg()">Create Account</button>
</div>

<!-- PHONE AUTH -->
<div class="phone-step" id="phoneStep1">
<div class="fg"><label>Phone Number</label>
<div class="phone-input-row">
<select id="phoneCountry">
<option value="+1">üá∫üá∏ +1</option><option value="+44">üá¨üáß +44</option><option value="+91">üáÆüá≥ +91</option><option value="+61">üá¶üá∫ +61</option><option value="+81">üáØüáµ +81</option><option value="+49">üá©üá™ +49</option><option value="+33">üá´üá∑ +33</option><option value="+55">üáßüá∑ +55</option><option value="+86">üá®üá≥ +86</option><option value="+52">üá≤üáΩ +52</option><option value="+234">üá≥üá¨ +234</option><option value="+82">üá∞üá∑ +82</option><option value="+39">üáÆüáπ +39</option><option value="+34">üá™üá∏ +34</option><option value="+7">üá∑üá∫ +7</option><option value="+62">üáÆüá© +62</option><option value="+90">üáπüá∑ +90</option><option value="+966">üá∏üá¶ +966</option><option value="+971">üá¶üá™ +971</option><option value="+63">üáµüá≠ +63</option>
</select>
<input type="tel" id="phoneNum" placeholder="123 456 7890">
</div></div>
<div id="recaptcha-container"></div>
<button class="btn btn-w" onclick="sendOTP()">Send Code</button>
<button class="btn btn-g" onclick="backToMain()">‚Üê Back</button>
</div>

<div class="phone-step" id="phoneStep2">
<p style="text-align:center;color:var(--tx2);font-size:14px;margin-bottom:16px">Enter the 6-digit code sent to <span id="sentTo" style="color:#fff;font-weight:600"></span></p>
<div class="otp-inputs" id="otpInputs">
<input type="text" maxlength="1" oninput="otpNav(this,1)" onkeydown="otpBack(event,this,0)">
<input type="text" maxlength="1" oninput="otpNav(this,2)" onkeydown="otpBack(event,this,1)">
<input type="text" maxlength="1" oninput="otpNav(this,3)" onkeydown="otpBack(event,this,2)">
<input type="text" maxlength="1" oninput="otpNav(this,4)" onkeydown="otpBack(event,this,3)">
<input type="text" maxlength="1" oninput="otpNav(this,5)" onkeydown="otpBack(event,this,4)">
<input type="text" maxlength="1" oninput="otpNav(this,null)" onkeydown="otpBack(event,this,5)">
</div>
<button class="btn btn-w" onclick="verifyOTP()">Verify</button>
<div class="resend-timer" id="resendTimer">Resend in <span id="resendCount">30</span>s</div>
<button class="btn btn-g" onclick="backToPhone()">‚Üê Back</button>
</div>

<!-- USERNAME SETUP (for Google/Phone new users) -->
<div class="username-setup" id="usernameSetup">
<h1 style="margin-bottom:8px">Almost there!</h1>
<p class="sub">Pick a username to complete your account</p>
<div class="fg"><label>Display Name</label><input type="text" id="setupName" placeholder="Your name"></div>
<div class="fg"><label>Username</label><input type="text" id="setupUser" placeholder="john_doe (unique)"></div>
<button class="btn btn-w" onclick="completeSetup()">Finish Setup</button>
</div>

</div>
</div>

<!-- MAIN APP (same structure as v1.2) -->
<div class="app" id="app">
<div class="np" id="np"><div class="np-h"><h3>üîî Notifications</h3><div><button onclick="clearNotifs()"><i class="fas fa-check-double"></i></button><button onclick="togNP()"><i class="fas fa-xmark"></i></button></div></div><div class="np-l" id="npL"><div class="ne"><i class="fas fa-bell-slash"></i>No notifications</div></div></div>
<div class="sbar"><div class="si home on" onclick="goHome()"><i class="fas fa-bolt"></i></div><div class="sdiv"></div><div id="sIcons"></div><div class="si add" onclick="openM('mCS')"><i class="fas fa-plus"></i></div><div class="si add" onclick="openM('mJS')" style="font-size:16px"><i class="fas fa-arrow-right-to-bracket"></i></div></div>
<div class="side"><div id="hSide" style="display:flex;flex-direction:column;flex:1;min-height:0;overflow:hidden"><div class="side-h"><span>Chat</span><div class="acts"><button onclick="openM('mAF')"><i class="fas fa-user-plus"></i></button></div></div><div class="side-tabs"><div class="side-tab on" data-tab="friends" onclick="sTab('friends')">Friends</div><div class="side-tab" data-tab="dms" onclick="sTab('dms')">Messages</div><div class="side-tab" data-tab="requests" onclick="sTab('requests')"><span>Requests</span><div class="tbadge" id="rBadge"></div></div></div><div class="search-box"><input placeholder="Search..." id="hSearch" oninput="filterH()"></div><div class="side-c" id="hC"></div></div>
<div id="sSide" style="display:none;flex-direction:column;flex:1;min-height:0;overflow:hidden"><div class="side-h"><span id="sName">Server</span><div class="acts"><button onclick="openSS()"><i class="fas fa-gear"></i></button><button onclick="openM('mInv')"><i class="fas fa-user-plus"></i></button></div></div><div class="side-c" id="chL"></div></div>
<div class="upanel"><div class="ua" id="uAva" onclick="openM('mProf')"><span id="uLet"></span></div><div class="ui"><div class="un" id="uName">User</div><div class="ut" id="uTag">@user</div></div><div class="pa"><div class="nd"><button onclick="togNP()"><i class="fas fa-bell"></i></button><div class="dot" id="nDot"></div></div><button onclick="openM('mSet')"><i class="fas fa-gear"></i></button><button onclick="doLogout()"><i class="fas fa-arrow-right-from-bracket"></i></button></div></div></div>
<div class="chat"><div class="empty" id="es"><i class="fas fa-bolt"></i><h3>Welcome to Chat</h3><p>Select a conversation or channel</p></div>
<div id="ac" style="display:none;flex:1;flex-direction:column;overflow:hidden"><div class="chat-h"><span class="ci" id="cI"><i class="fas fa-hashtag"></i></span><span class="cn" id="cN">general</span><div class="ha"><button onclick="startCall(false)" id="vcBtn"><i class="fas fa-phone"></i></button><button onclick="startCall(true)" id="vidBtn"><i class="fas fa-video"></i></button><button onclick="toggleMem()" id="mBtn"><i class="fas fa-users"></i></button></div></div>
<div class="cbody"><div class="cmain"><div class="msgs" id="msgsC"><div class="mlist" id="msgsL"></div></div>
<div class="abar" id="aBar"><div class="abi"><i id="abI" class="fas fa-reply"></i><span class="abl" id="abL">Replying</span><span class="abt" id="abT"></span></div><button class="abc" onclick="cancelAct()"><i class="fas fa-xmark"></i></button></div>
<div class="input-area"><div class="upprev" id="upP"><img id="upI"><div class="ui2" id="upN">file</div><button class="ur" onclick="rmUp()"><i class="fas fa-xmark"></i></button></div>
<div class="ibox"><div class="iacts"><button onclick="$('fIn').click()"><i class="fas fa-circle-plus"></i></button><button onclick="togGif()"><i class="fas fa-fire"></i></button></div><textarea class="ifield" id="mIn" placeholder="Message" rows="1" onkeydown="onKey(event)" oninput="autoH(this)"></textarea><button class="sbtn" onclick="doSend()"><i class="fas fa-paper-plane"></i></button></div>
<input type="file" id="fIn" accept="image/*" style="display:none" onchange="onFile(event)">
<div class="gifp" id="gP"><div class="gifp-h"><input placeholder="Search Tenor..." id="gIn" oninput="gDeb()"></div><div class="gifg" id="gG"><div class="gl">Search for GIFs</div></div></div></div></div>
<div class="memside" id="mS"><div class="memcat" id="mCt">Members ‚Äî 0</div><div id="mL"></div></div></div></div></div></div>

<!-- ALL MODALS (same as v1.2) -->
<div class="mdl-o" id="mCS"><div class="mdl"><button class="mdl-x" onclick="closeM('mCS')"><i class="fas fa-xmark"></i></button><h2>Create server</h2><p class="md">Give it a name and icon.</p><div class="si-up" id="sIU" onclick="$('sII').click()"><i class="fas fa-camera"></i></div><input type="file" id="sII" accept="image/*" style="display:none" onchange="pSI(event)"><div class="fg"><label>Name</label><input type="text" id="nSN" placeholder="My Server"></div><button class="btn btn-w" onclick="cServ()">Create</button></div></div>
<div class="mdl-o" id="mJS"><div class="mdl"><button class="mdl-x" onclick="closeM('mJS')"><i class="fas fa-xmark"></i></button><h2>Join server</h2><div class="fg"><label>Invite Code</label><input type="text" id="jC" placeholder="ABC123"></div><button class="btn btn-w" onclick="jServ()">Join</button></div></div>
<div class="mdl-o" id="mInv"><div class="mdl"><button class="mdl-x" onclick="closeM('mInv')"><i class="fas fa-xmark"></i></button><h2>Invite people</h2><p class="md">Share code or invite friends via DM.</p><div class="inv-code"><span id="iC">...</span><button onclick="cpInv()">Copy</button></div><div class="label">Invite Friends</div><div id="iFr"></div></div></div>
<div class="mdl-o" id="mAF"><div class="mdl"><button class="mdl-x" onclick="closeM('mAF')"><i class="fas fa-xmark"></i></button><h2>Add Friend</h2><div class="fg"><label>Username</label><input type="text" id="afU" placeholder="john_doe"></div><button class="btn btn-w" onclick="sendFR()">Send Request</button></div></div>
<div class="mdl-o" id="mND"><div class="mdl"><button class="mdl-x" onclick="closeM('mND')"><i class="fas fa-xmark"></i></button><h2>New Message</h2><div class="fg"><label>Username</label><input type="text" id="ndU" placeholder="john_doe"></div><button class="btn btn-w" onclick="cDM()">Start Chat</button></div></div>
<div class="mdl-o" id="mCC"><div class="mdl"><button class="mdl-x" onclick="closeM('mCC')"><i class="fas fa-xmark"></i></button><h2>Create channel</h2><div class="fg"><label>Name</label><input type="text" id="nCN" placeholder="general"></div><button class="btn btn-w" onclick="cChan()">Create</button></div></div>
<div class="mdl-o" id="mProf"><div class="mdl"><button class="mdl-x" onclick="closeM('mProf')"><i class="fas fa-xmark"></i></button><h2>Profile</h2><p class="md">Customize your look.</p><div class="pfp-up" id="pA" onclick="$('pIn').click()"><div class="pfo"><i class="fas fa-camera"></i></div><span id="pL" style="font-size:32px;font-weight:700"></span></div><input type="file" id="pIn" accept="image/*" style="display:none" onchange="oPfp(event)"><div class="fg"><label>Display Name</label><input type="text" id="pN"></div><div class="fg"><label>Username</label><input type="text" id="pU" disabled style="opacity:.5"></div><div class="fg"><label>Bio</label><input type="text" id="pB" placeholder="About you..." maxlength="150"></div><div class="fg"><label>Name Color</label><div class="color-grid" id="cG"></div></div><div class="fg"><label>Name Font</label><select id="fS" onchange="uFP()"><option value="Inter">Inter</option><option value="Outfit">Outfit</option><option value="Sora">Sora</option><option value="Space Mono">Space Mono</option><option value="JetBrains Mono">JetBrains Mono</option><option value="Playfair Display">Playfair Display</option></select><div class="font-preview" id="fP">Name</div></div><button class="btn btn-w" onclick="sProf()">Save</button></div></div>
<div class="mdl-o" id="mSet"><div class="mdl"><button class="mdl-x" onclick="closeM('mSet')"><i class="fas fa-xmark"></i></button><h2>Settings</h2><div style="margin:16px 0"><label style="font-size:12px;color:var(--tx3)">EMAIL</label><p style="font-size:14px;margin-top:4px" id="sE">-</p></div><div style="margin:16px 0"><label style="font-size:12px;color:var(--tx3)">USERNAME</label><p style="font-size:14px;margin-top:4px" id="sU2">-</p></div><div style="margin:16px 0"><label style="font-size:12px;color:var(--tx3)">SIGN-IN METHOD</label><p style="font-size:14px;margin-top:4px" id="sMethod">-</p></div><div style="margin:16px 0"><label style="font-size:12px;color:var(--tx3)">ID</label><p style="font-size:13px;font-family:monospace;margin-top:4px;color:var(--tx3)" id="sUID">-</p></div><div class="dzone"><h3>Danger Zone</h3><button class="btn btn-d btn-sm" onclick="doLogout()">Log Out</button></div></div></div>
<div class="mdl-o" id="mSS"><div class="mdl"><button class="mdl-x" onclick="closeM('mSS')"><i class="fas fa-xmark"></i></button><h2>Server Settings</h2><div class="fg"><label>Name</label><input type="text" id="eSN"></div><button class="btn btn-w" onclick="sSS()" style="margin-bottom:16px">Save</button><div class="dzone"><h3>Danger Zone</h3><div style="display:flex;gap:8px"><button class="btn btn-d btn-sm" onclick="lServ()">Leave</button><button class="btn btn-d btn-sm" id="dSB" onclick="dServ()" style="display:none">Delete</button></div></div></div></div>
<div class="mdl-o" id="mUC"><div class="mdl" style="width:360px"><button class="mdl-x" onclick="closeM('mUC')"><i class="fas fa-xmark"></i></button><div style="text-align:center"><div id="ucA" style="width:80px;height:80px;border-radius:50%;margin:0 auto 12px;overflow:hidden;background:var(--bg4);display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:700"></div><div id="ucN" style="font-size:18px;font-weight:700;margin-bottom:2px"></div><div id="ucU" style="font-size:13px;color:var(--tx3);margin-bottom:8px"></div><div id="ucB" style="font-size:13px;color:var(--tx2);margin-bottom:16px"></div><div id="ucAc" style="display:flex;gap:8px;justify-content:center"></div></div></div></div>
<div class="imgpv" id="iPv" onclick="this.classList.remove('on')"><img id="iPvS"></div>
<div class="ctx" id="ctx"></div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script>
firebase.initializeApp({apiKey:"AIzaSyBJMIUucxOusoVzs4lc-QurCxjlW6Hlsuw",authDomain:"chat-5f0bf.firebaseapp.com",projectId:"chat-5f0bf",storageBucket:"chat-5f0bf.firebasestorage.app",messagingSenderId:"211425841353",appId:"1:211425841353:web:e1c271a340d73abd0cfd18"});
const auth=firebase.auth(),db=firebase.firestore(),TS=firebase.firestore.FieldValue.serverTimestamp,AU=firebase.firestore.FieldValue.arrayUnion,AR=firebase.firestore.FieldValue.arrayRemove;
const $=id=>document.getElementById(id);
const COLORS=['#ffffff','#ff453a','#ff9f0a','#ffd60a','#30d158','#64d2ff','#0a84ff','#bf5af2','#ff375f','#ac8e68','#ff6482','#5e5ce6','#66d4cf','#f0a0c0','#a8c8a0','#d4a0f0'];
const ICE={iceServers:[{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun1.l.google.com:19302'},{urls:'stun:stun.relay.metered.ca:80'},{urls:'turn:global.relay.metered.ca:80',username:'e7e5693e51cfe1ae09753dae',credential:'uOlGFOJWpQlRi7xJ'},{urls:'turn:global.relay.metered.ca:80?transport=tcp',username:'e7e5693e51cfe1ae09753dae',credential:'uOlGFOJWpQlRi7xJ'},{urls:'turn:global.relay.metered.ca:443',username:'e7e5693e51cfe1ae09753dae',credential:'uOlGFOJWpQlRi7xJ'},{urls:'turns:global.relay.metered.ca:443?transport=tcp',username:'e7e5693e51cfe1ae09753dae',credential:'uOlGFOJWpQlRi7xJ'}],iceCandidatePoolSize:10};

let me=null,md=null,cv='home',cSrv=null,cCh=null,cDm=null,cType=null;
let unsubs={msg:null,ch:null,fr:null,req:null,dm:null,call:null};
let gifTO=null,pendImg=null,sIconD=null,uC={},hTab='friends';
let firstLoad=true,replyD=null,editD=null,selCol='#ffffff',selFon='Inter';
let allN=[],nInt=null,seenNIds=new Set();
let callDoc=null,localStream=null,remoteStream=null,pc=null,callTimerInt=null,callStart=null;
let isCaller=false,callOtherUid=null,isVideoCall=false,isMuted=false,isCamOff=false,callUnsub=null,candUnsub=null;
let confirmationResult=null,recaptchaVerifier=null,resendInt=null;
let pendingNewUser=null; // For Google/Phone signups that need username

// ==================== AUTH ====================
function switchAuthTab(tab){
  document.querySelectorAll('.auth-tab').forEach(t=>t.classList.toggle('on',t.dataset.t===tab));
  $('emailLogin').style.display=tab==='login'?'':'none';
  $('emailReg').style.display=tab==='register'?'':'none';
}

function showAuthMain(){
  $('socialBtns').style.display='';
  document.querySelector('.auth-divider').style.display='';
  $('authTabs').style.display='';
  $('emailLogin').style.display='';$('emailReg').style.display='none';
  $('phoneStep1').classList.remove('on');$('phoneStep2').classList.remove('on');
  $('usernameSetup').classList.remove('on');
  $('authTitle').textContent='Welcome to Chat';$('authSub').textContent='Sign in or create an account';
  switchAuthTab('login');
}

function hideAuthMain(){
  $('socialBtns').style.display='none';
  document.querySelector('.auth-divider').style.display='none';
  $('authTabs').style.display='none';
  $('emailLogin').style.display='none';$('emailReg').style.display='none';
}

// EMAIL
async function doLogin(){
  const e=$('lEmail').value.trim(),p=$('lPass').value;
  if(!e||!p)return sErr('authErr','Fill in all fields.');
  try{await auth.signInWithEmailAndPassword(e,p)}catch(er){sErr('authErr',er.message)}
}
async function doReg(){
  const n=$('rName').value.trim(),u=$('rUser').value.trim().toLowerCase().replace(/\s/g,''),e=$('rEmail').value.trim(),p=$('rPass').value;
  if(!n||!u||!e||!p)return sErr('authErr','Fill in all fields.');
  if(!/^[a-z0-9_]{3,20}$/.test(u))return sErr('authErr','Username: 3-20 chars, a-z 0-9 _');
  const ex=await db.collection('users').where('username','==',u).limit(1).get();
  if(!ex.empty)return sErr('authErr','Username taken.');
  try{const cr=await auth.createUserWithEmailAndPassword(e,p);
  await db.collection('users').doc(cr.user.uid).set({displayName:n,username:u,email:e,photoURL:'',nameColor:'#ffffff',nameFont:'Inter',bio:'',createdAt:TS(),status:'online',friends:[]})}catch(er){sErr('authErr',er.message)}
}

// GOOGLE
async function googleSignIn(){
  const provider=new firebase.auth.GoogleAuthProvider();
  try{
    const result=await auth.signInWithPopup(provider);
    const user=result.user;
    // Check if user doc exists
    const doc=await db.collection('users').doc(user.uid).get();
    if(!doc.exists){
      // New user - needs username setup
      pendingNewUser={uid:user.uid,displayName:user.displayName||'',email:user.email||'',photoURL:user.photoURL||''};
      hideAuthMain();
      $('usernameSetup').classList.add('on');
      $('setupName').value=user.displayName||'';
      $('authTitle').textContent='Almost there!';$('authSub').textContent='Pick a username to finish';
    }
  }catch(er){if(er.code!=='auth/popup-closed-by-user')sErr('authErr',er.message)}
}

// PHONE
function showPhoneAuth(){
  hideAuthMain();
  $('phoneStep1').classList.add('on');
  $('authTitle').textContent='Phone Sign In';$('authSub').textContent='We\'ll send you a verification code';
  if(!recaptchaVerifier){
    recaptchaVerifier=new firebase.auth.RecaptchaVerifier('recaptcha-container',{size:'normal',theme:'dark'});
    recaptchaVerifier.render();
  }
}

async function sendOTP(){
  const country=$('phoneCountry').value;
  const num=$('phoneNum').value.trim().replace(/\D/g,'');
  if(!num)return sErr('authErr','Enter phone number');
  const fullNum=country+num;
  try{
    confirmationResult=await auth.signInWithPhoneNumber(fullNum,recaptchaVerifier);
    $('phoneStep1').classList.remove('on');
    $('phoneStep2').classList.add('on');
    $('sentTo').textContent=fullNum;
    $('authTitle').textContent='Verify Code';$('authSub').textContent='';
    // Focus first OTP input
    $('otpInputs').children[0].focus();
    startResendTimer();
  }catch(er){sErr('authErr',er.message)}
}

async function verifyOTP(){
  const inputs=$('otpInputs').querySelectorAll('input');
  let code='';inputs.forEach(i=>code+=i.value);
  if(code.length!==6)return sErr('authErr','Enter all 6 digits');
  try{
    const result=await confirmationResult.confirm(code);
    const user=result.user;
    const doc=await db.collection('users').doc(user.uid).get();
    if(!doc.exists){
      pendingNewUser={uid:user.uid,displayName:'',email:'',photoURL:'',phone:user.phoneNumber||''};
      $('phoneStep2').classList.remove('on');
      $('usernameSetup').classList.add('on');
      $('authTitle').textContent='Almost there!';$('authSub').textContent='Pick a username to finish';
    }
  }catch(er){sErr('authErr','Invalid code. Try again.')}
}

async function completeSetup(){
  if(!pendingNewUser)return;
  const name=$('setupName').value.trim();
  const username=$('setupUser').value.trim().toLowerCase().replace(/\s/g,'');
  if(!name||!username)return sErr('authErr','Fill in all fields.');
  if(!/^[a-z0-9_]{3,20}$/.test(username))return sErr('authErr','Username: 3-20 chars, a-z 0-9 _');
  const ex=await db.collection('users').where('username','==',username).limit(1).get();
  if(!ex.empty)return sErr('authErr','Username taken.');
  await db.collection('users').doc(pendingNewUser.uid).set({
    displayName:name,username,email:pendingNewUser.email||'',phone:pendingNewUser.phone||'',
    photoURL:pendingNewUser.photoURL||'',nameColor:'#ffffff',nameFont:'Inter',bio:'',
    createdAt:TS(),status:'online',friends:[]
  });
  pendingNewUser=null;
  // Auth state listener will handle the rest
}

function backToMain(){
  $('phoneStep1').classList.remove('on');
  $('phoneStep2').classList.remove('on');
  showAuthMain();
}
function backToPhone(){
  $('phoneStep2').classList.remove('on');
  $('phoneStep1').classList.add('on');
  $('authTitle').textContent='Phone Sign In';
}

// OTP input navigation
function otpNav(el,nextIdx){
  if(el.value.length===1&&nextIdx!==null){
    const inputs=$('otpInputs').querySelectorAll('input');
    if(inputs[nextIdx])inputs[nextIdx].focus();
  }
  // Auto submit when all filled
  const inputs=$('otpInputs').querySelectorAll('input');
  let code='';inputs.forEach(i=>code+=i.value);
  if(code.length===6)verifyOTP();
}
function otpBack(e,el,prevIdx){
  if(e.key==='Backspace'&&!el.value){
    const inputs=$('otpInputs').querySelectorAll('input');
    if(inputs[prevIdx]){inputs[prevIdx].focus();inputs[prevIdx].value=''}
  }
}

function startResendTimer(){
  let sec=30;$('resendCount').textContent=sec;
  $('resendTimer').innerHTML=`Resend in <span id="resendCount">${sec}</span>s`;
  if(resendInt)clearInterval(resendInt);
  resendInt=setInterval(()=>{
    sec--;$('resendCount').textContent=sec;
    if(sec<=0){clearInterval(resendInt);$('resendTimer').innerHTML='<a onclick="resendCode()">Resend code</a>'}
  },1000);
}
function resendCode(){backToPhone();sendOTP()}

function sErr(id,m){const el=$(id);el.textContent=m;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),5000)}

// AUTH STATE
auth.onAuthStateChanged(async u=>{
  if(u){
    me=u;
    // Check if user has a profile doc
    const doc=await db.collection('users').doc(u.uid).get();
    if(!doc.exists){
      // Needs username setup (Google/Phone first time)
      if(!pendingNewUser){
        pendingNewUser={uid:u.uid,displayName:u.displayName||'',email:u.email||'',photoURL:u.photoURL||'',phone:u.phoneNumber||''};
        hideAuthMain();
        $('usernameSetup').classList.add('on');
        $('setupName').value=u.displayName||'';
        $('authTitle').textContent='Almost there!';$('authSub').textContent='Pick a username';
      }
      return; // Don't enter app yet
    }
    // Has profile - enter app
    $('authPage').style.display='none';
    $('app').classList.add('on');
    await loadMe();loadServs();listenFR();listenReqs();listenDMs();startNPoll();listenCalls();
    db.collection('users').doc(u.uid).update({status:'online'});sTab('friends');
  }else{
    me=null;md=null;$('app').classList.remove('on');
    $('authPage').style.display='flex';showAuthMain();
    Object.values(unsubs).forEach(fn=>fn&&fn());stopNPoll();
  }
});

function doLogout(){if(me)db.collection('users').doc(me.uid).update({status:'offline'});auth.signOut()}

async function loadMe(){
  const d=await db.collection('users').doc(me.uid).get();
  if(d.exists){md=d.data();uC[me.uid]=md;updP()}
}
function updP(){
  if(!md)return;const n=md.displayName||'User';
  $('uName').textContent=n;$('uTag').textContent='@'+(md.username||'');
  $('uAva').innerHTML=md.photoURL?`<img src="${md.photoURL}">`:`<span>${n[0].toUpperCase()}</span>`;
  $('sE').textContent=md.email||md.phone||'-';$('sUID').textContent=me.uid;
  $('sU2').textContent='@'+(md.username||'');
  // Show sign-in method
  const providers=me.providerData.map(p=>p.providerId);
  let method='Email';
  if(providers.includes('google.com'))method='Google';
  else if(providers.includes('phone'))method='Phone';
  $('sMethod').textContent=method;
}

// ==================== REST OF APP (identical to v1.2) ====================
async function gU(uid){if(uC[uid])return uC[uid];try{const d=await db.collection('users').doc(uid).get();if(d.exists){uC[uid]=d.data();return d.data()}}catch(e){}return{displayName:'Unknown',username:'?',photoURL:'',nameColor:'#fff',nameFont:'Inter',bio:''}}
async function gUn(un){const s=await db.collection('users').where('username','==',un.toLowerCase().trim()).limit(1).get();if(s.empty)return null;return{uid:s.docs[0].id,...s.docs[0].data()}}
function startNPoll(){fetchN();nInt=setInterval(fetchN,4000)}
function stopNPoll(){if(nInt)clearInterval(nInt)}
async function fetchN(){if(!me)return;try{const snap=await db.collection('notifications').where('userId','==',me.uid).orderBy('createdAt','desc').limit(50).get();const nw=[];snap.forEach(doc=>{const d=doc.data();d._id=doc.id;nw.push(d)});nw.forEach(n=>{if(!n.read&&!seenNIds.has(n._id)&&n.fromId!==me.uid){seenNIds.add(n._id);if(n.type==='dm'&&n.dmId===cDm){markNR(n._id);return}if(n.type==='channel'&&n.channelId===cCh&&n.serverId===cSrv){markNR(n._id);return}showToast(n)}else{seenNIds.add(n._id)}});allN=nw;$('nDot').classList.toggle('on',nw.some(n=>!n.read));renderNP()}catch(e){}}
function renderNP(){const c=$('npL');if(!allN.length){c.innerHTML='<div class="ne"><i class="fas fa-bell-slash"></i>No notifications</div>';return}let h='';allN.forEach(n=>{const av=n.fromPhoto?`<img src="${n.fromPhoto}">`:(n.fromName||'U')[0].toUpperCase();let src='';if(n.type==='channel')src=`<b>${esc(n.serverName||'')}</b> #${esc(n.channelName||'')}`;else if(n.type==='dm')src='<b>Direct Message</b>';else if(n.type==='friend_request')src='<b>Friend Request</b>';else if(n.type==='friend_accept')src='<b>Friends</b>';else src='<b>Notification</b>';const t=n.createdAt?tAgo(n.createdAt.toDate()):'';h+=`<div class="ni${n.read?'':' unread'}" onclick="onNC('${n._id}','${n.type}','${n.dmId||''}','${n.serverId||''}','${n.channelId||''}')"><div class="na">${av}</div><div class="nb"><div class="ns">${src}</div><div class="nn">${esc(n.fromName||'User')}</div><div class="nm">${esc(n.message||'')}</div><div class="nt">${t}</div></div></div>`});c.innerHTML=h}
function onNC(id,type,dmId,srvId,chId){markNR(id);if(type==='dm'&&dmId){goHome();sTab('dms');db.collection('dms').doc(dmId).get().then(doc=>{if(doc.exists){const o=doc.data().members.find(m=>m!==me.uid);setTimeout(()=>selDM(dmId,o),200)}})}else if(type==='channel'&&srvId){selServ(srvId);setTimeout(()=>{if(chId)selCh2(chId)},500)}else if(type==='friend_request'||type==='friend_accept'){goHome();sTab('requests')}$('np').classList.remove('on')}
function markNR(id){db.collection('notifications').doc(id).update({read:true}).catch(()=>{})}
async function clearNotifs(){const b=db.batch();allN.filter(n=>!n.read).forEach(n=>b.update(db.collection('notifications').doc(n._id),{read:true}));await b.commit();toast('Cleared');fetchN()}
function togNP(){$('np').classList.toggle('on')}
function showToast(n){const c=$('toasts');const t=document.createElement('div');t.className='toast';const av=n.fromPhoto?`<img src="${n.fromPhoto}">`:(n.fromName||'U')[0].toUpperCase();let src='';if(n.type==='channel')src=`<b>${esc(n.serverName||'')}</b> ‚Ä∫ #${esc(n.channelName||'')}`;else if(n.type==='dm')src='<b>Direct Message</b>';else if(n.type==='friend_request')src='<b>üëã Friend Request</b>';else if(n.type==='friend_accept')src='<b>ü§ù Accepted</b>';t.innerHTML=`<div class="ta">${av}</div><div class="tb2"><div class="ts">${src}</div><div class="tn">${esc(n.fromName||'User')}</div><div class="tm">${esc(n.message||'')}</div></div><button class="tx" onclick="event.stopPropagation();this.parentElement.remove()"><i class="fas fa-xmark"></i></button>`;t.onclick=()=>{onNC(n._id,n.type,n.dmId||'',n.serverId||'',n.channelId||'');t.remove()};c.appendChild(t);setTimeout(()=>{if(t.parentElement)t.remove()},6000)}
function tAgo(d){const s=Math.floor((Date.now()-d)/1000);if(s<60)return'now';if(s<3600)return Math.floor(s/60)+'m';if(s<86400)return Math.floor(s/3600)+'h';return Math.floor(s/86400)+'d'}
async function addN(userId,type,message,extra={}){await db.collection('notifications').add({userId,type,fromId:me.uid,fromName:md.displayName,fromPhoto:md.photoURL||'',message,read:false,createdAt:TS(),...extra})}
function listenCalls(){unsubs.call=db.collection('calls').where('to','==',me.uid).where('status','==','ringing').onSnapshot(snap=>{snap.docChanges().forEach(ch=>{if(ch.type==='added')showIncoming(ch.doc.id,ch.doc.data())})})}
async function showIncoming(callId,data){const u=await gU(data.from);$('icAva').innerHTML=avI(u);$('icName').textContent=u.displayName||'User';$('icType').textContent=data.video?'üìπ Video Call':'üìû Voice Call';$('incomingCall').classList.add('on');$('incomingCall').dataset.callId=callId;$('incomingCall').dataset.from=data.from;$('incomingCall').dataset.video=data.video;setTimeout(()=>{if($('incomingCall').classList.contains('on'))declineCall()},30000)}
async function startCall(video){if(cType!=='dm'||!cDm)return toast('Calls only in DMs');const dmDoc=await db.collection('dms').doc(cDm).get();const otherUid=dmDoc.data().members.find(m=>m!==me.uid);isVideoCall=video;isCaller=true;callOtherUid=otherUid;try{localStream=await navigator.mediaDevices.getUserMedia({audio:true,video})}catch(e){return toast('Mic/camera denied')}pc=new RTCPeerConnection(ICE);remoteStream=new MediaStream();localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));pc.ontrack=e=>{e.streams[0].getTracks().forEach(t=>remoteStream.addTrack(t));if(video&&$('callVideos').style.display==='flex')$('remoteVideo').srcObject=remoteStream};pc.oniceconnectionstatechange=()=>{const s=pc.iceConnectionState;$('callQuality').textContent=s==='connected'||s==='completed'?'üü¢ Connected':s==='checking'?'üü° Connecting...':s==='failed'?'üî¥ Failed':'';if(s==='failed')pc.restartIce()};const callRef=db.collection('calls').doc();callDoc=callRef;pc.onicecandidate=e=>{if(e.candidate)callRef.collection('callerCandidates').add(e.candidate.toJSON())};const offer=await pc.createOffer();await pc.setLocalDescription(offer);await callRef.set({from:me.uid,to:otherUid,status:'ringing',video,offer:{type:offer.type,sdp:offer.sdp},createdAt:TS()});const u=await gU(otherUid);showCallUI(u,video);$('callStatus').textContent='Ringing...';$('callStatus').classList.add('ringing');callUnsub=callRef.onSnapshot(async snap=>{const d=snap.data();if(!d)return;if(d.status==='answered'&&d.answer&&!pc.currentRemoteDescription){await pc.setRemoteDescription(new RTCSessionDescription(d.answer));$('callStatus').textContent='Connected';$('callStatus').classList.remove('ringing');startCallTimer();if(video)showVideos()}if(d.status==='declined'||d.status==='ended'){endCallCleanup();toast(d.status==='declined'?'Declined':'Ended')}});candUnsub=callRef.collection('calleeCandidates').onSnapshot(snap=>{snap.docChanges().forEach(ch=>{if(ch.type==='added'&&pc)pc.addIceCandidate(new RTCIceCandidate(ch.doc.data())).catch(()=>{})})});addN(otherUid,'call',`${md.displayName} is calling you`)}
async function acceptCall(){const callId=$('incomingCall').dataset.callId;const fromUid=$('incomingCall').dataset.from;const video=$('incomingCall').dataset.video==='true';$('incomingCall').classList.remove('on');isCaller=false;isVideoCall=video;callOtherUid=fromUid;try{localStream=await navigator.mediaDevices.getUserMedia({audio:true,video})}catch(e){return toast('Permission denied')}pc=new RTCPeerConnection(ICE);remoteStream=new MediaStream();localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));pc.ontrack=e=>{e.streams[0].getTracks().forEach(t=>remoteStream.addTrack(t));if(video)$('remoteVideo').srcObject=remoteStream};pc.oniceconnectionstatechange=()=>{const s=pc.iceConnectionState;$('callQuality').textContent=s==='connected'||s==='completed'?'üü¢ Connected':s==='checking'?'üü° Connecting...':s==='failed'?'üî¥ Failed':'';if(s==='failed')pc.restartIce()};callDoc=db.collection('calls').doc(callId);pc.onicecandidate=e=>{if(e.candidate)callDoc.collection('calleeCandidates').add(e.candidate.toJSON())};const snap=await callDoc.get();const d=snap.data();await pc.setRemoteDescription(new RTCSessionDescription(d.offer));const answer=await pc.createAnswer();await pc.setLocalDescription(answer);await callDoc.update({status:'answered',answer:{type:answer.type,sdp:answer.sdp}});candUnsub=callDoc.collection('callerCandidates').onSnapshot(snap2=>{snap2.docChanges().forEach(ch=>{if(ch.type==='added'&&pc)pc.addIceCandidate(new RTCIceCandidate(ch.doc.data())).catch(()=>{})})});callUnsub=callDoc.onSnapshot(snap2=>{const d2=snap2.data();if(d2&&d2.status==='ended'){endCallCleanup();toast('Call ended')}});const u=await gU(fromUid);showCallUI(u,video);$('callStatus').textContent='Connected';startCallTimer();if(video)showVideos()}
function declineCall(){const callId=$('incomingCall').dataset.callId;$('incomingCall').classList.remove('on');db.collection('calls').doc(callId).update({status:'declined'})}
function showCallUI(u,video){$('callOverlay').classList.add('on');$('callAva').innerHTML=avI(u);$('callAva').style.fontSize='36px';$('callName').textContent=u.displayName||'User';isMuted=false;isCamOff=false;$('muteBtn').classList.remove('on');$('muteBtn').innerHTML='<i class="fas fa-microphone"></i>';$('camBtn').style.display=video?'flex':'none';$('camBtn').classList.add('on');$('callInfo').style.display=''}
function showVideos(){$('callVideos').style.display='flex';$('remoteVideo').srcObject=remoteStream;$('localVideo').srcObject=localStream;$('callInfo').style.display='none'}
function toggleMute(){isMuted=!isMuted;localStream?.getAudioTracks().forEach(t=>t.enabled=!isMuted);$('muteBtn').classList.toggle('on',isMuted);$('muteBtn').innerHTML=isMuted?'<i class="fas fa-microphone-slash"></i>':'<i class="fas fa-microphone"></i>'}
function toggleCam(){isCamOff=!isCamOff;localStream?.getVideoTracks().forEach(t=>t.enabled=!isCamOff);$('camBtn').classList.toggle('on',!isCamOff)}
function endCall(){if(callDoc)callDoc.update({status:'ended'}).catch(()=>{});endCallCleanup()}
function endCallCleanup(){$('callOverlay').classList.remove('on');$('callVideos').style.display='none';$('incomingCall').classList.remove('on');$('callQuality').textContent='';if(localStream){localStream.getTracks().forEach(t=>t.stop());localStream=null}if(pc){pc.close();pc=null}remoteStream=null;callDoc=null;if(callTimerInt)clearInterval(callTimerInt);$('callTimer').textContent='';if(callUnsub){callUnsub();callUnsub=null}if(candUnsub){candUnsub();candUnsub=null}}
function startCallTimer(){callStart=Date.now();callTimerInt=setInterval(()=>{const s=Math.floor((Date.now()-callStart)/1000);$('callTimer').textContent=`${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`},1000)}
function listenFR(){unsubs.fr=db.collection('users').doc(me.uid).onSnapshot(doc=>{if(!doc.exists)return;md=doc.data();uC[me.uid]=md;if(hTab==='friends')renderFr()})}
async function renderFr(){const c=$('hC');const fr=md.friends||[];if(!fr.length){c.innerHTML='<div class="empty" style="padding:40px"><i class="fas fa-user-group" style="font-size:32px;opacity:.2;margin-bottom:12px"></i><h3 style="font-size:15px">No friends yet</h3></div>';return}let h='<div class="label">Friends ‚Äî '+fr.length+'</div>';for(const uid of fr){const u=await gU(uid);const sc=u.status==='online'?'on':'off';h+=`<div class="fri" onclick="startDmW('${uid}')"><div class="fri-left"><div class="ava">${avI(u)}<div class="sd ${sc}"></div></div><div><div class="fri-name">${esc(u.displayName||'User')}</div><div class="fri-user">@${esc(u.username||'?')}</div></div></div><div class="fri-actions"><button onclick="event.stopPropagation();startDmW('${uid}')"><i class="fas fa-comment"></i></button><button class="dec" onclick="event.stopPropagation();rmFr('${uid}')"><i class="fas fa-user-minus"></i></button></div></div>`}c.innerHTML=h}
function listenReqs(){unsubs.req=db.collection('friendRequests').where('to','==',me.uid).where('status','==','pending').onSnapshot(snap=>{$('rBadge').classList.toggle('on',snap.size>0);if(hTab==='requests')renderReqs(snap)})}
async function renderReqs(snap){const c=$('hC');let h='';const inc=snap&&!snap.empty?snap.docs:[];const sent=await db.collection('friendRequests').where('from','==',me.uid).where('status','==','pending').get();if(!inc.length&&sent.empty){c.innerHTML='<div class="empty" style="padding:40px"><i class="fas fa-inbox" style="font-size:32px;opacity:.2;margin-bottom:12px"></i><h3 style="font-size:15px">No requests</h3></div>';return}if(inc.length){h+='<div class="label">Incoming</div>';for(const doc of inc){const d=doc.data();const u=await gU(d.from);h+=`<div class="fri"><div class="fri-left"><div class="ava">${avI(u)}</div><div><div class="fri-name">${esc(u.displayName)}</div><div class="fri-user">@${esc(u.username||'?')}</div></div></div><div class="fri-actions"><button class="acc" onclick="accR('${doc.id}','${d.from}')"><i class="fas fa-check"></i></button><button class="dec" onclick="decR('${doc.id}')"><i class="fas fa-xmark"></i></button></div></div>`}}if(!sent.empty){h+='<div class="label">Sent</div>';for(const doc of sent.docs){const d=doc.data();const u=await gU(d.to);h+=`<div class="fri"><div class="fri-left"><div class="ava">${avI(u)}</div><div><div class="fri-name">${esc(u.displayName)}</div><div class="fri-user">@${esc(u.username||'?')}</div></div></div><div class="fri-actions"><button class="dec" onclick="canR('${doc.id}')"><i class="fas fa-xmark"></i></button></div></div>`}}c.innerHTML=h}
async function sendFR(){const un=$('afU').value.trim().toLowerCase();if(!un)return toast('Enter username');if(un===md.username)return toast("Can't add yourself");const t=await gUn(un);if(!t)return toast('Not found');if((md.friends||[]).includes(t.uid))return toast('Already friends');const ex=await db.collection('friendRequests').where('from','==',me.uid).where('to','==',t.uid).where('status','==','pending').get();if(!ex.empty)return toast('Already sent');const rev=await db.collection('friendRequests').where('from','==',t.uid).where('to','==',me.uid).where('status','==','pending').get();if(!rev.empty){accR(rev.docs[0].id,t.uid);closeM('mAF');return}await db.collection('friendRequests').add({from:me.uid,to:t.uid,status:'pending',createdAt:TS()});await addN(t.uid,'friend_request',`${md.displayName} wants to be friends`);closeM('mAF');$('afU').value='';toast('Sent!')}
async function accR(id,from){await db.collection('friendRequests').doc(id).update({status:'accepted'});await db.collection('users').doc(me.uid).update({friends:AU(from)});await db.collection('users').doc(from).update({friends:AU(me.uid)});await addN(from,'friend_accept',`${md.displayName} accepted`);toast('Added!')}
async function decR(id){await db.collection('friendRequests').doc(id).update({status:'declined'})}
async function canR(id){await db.collection('friendRequests').doc(id).delete()}
async function rmFr(uid){if(!confirm('Remove friend?'))return;await db.collection('users').doc(me.uid).update({friends:AR(uid)});await db.collection('users').doc(uid).update({friends:AR(me.uid)})}
async function sendFRD(uid){if((md.friends||[]).includes(uid))return toast('Already friends');const ex=await db.collection('friendRequests').where('from','==',me.uid).where('to','==',uid).where('status','==','pending').get();if(!ex.empty)return toast('Already sent');await db.collection('friendRequests').add({from:me.uid,to:uid,status:'pending',createdAt:TS()});await addN(uid,'friend_request',`${md.displayName} wants to be friends`);toast('Sent!')}
function listenDMs(){unsubs.dm=db.collection('dms').where('members','array-contains',me.uid).orderBy('lastMessageAt','desc').onSnapshot(snap=>{if(hTab==='dms')renderDMs(snap)})}
async function renderDMs(snap){const c=$('hC');if(!snap||snap.empty){c.innerHTML='<div style="padding:4px 8px"><button class="btn btn-g" onclick="openM(\'mND\')" style="font-size:13px;padding:8px"><i class="fas fa-pen-to-square"></i> New Message</button></div><div class="empty" style="padding:30px"><h3 style="font-size:15px">No messages</h3></div>';return}let h='<div style="padding:4px 8px"><button class="btn btn-g" onclick="openM(\'mND\')" style="font-size:13px;padding:8px"><i class="fas fa-pen-to-square"></i> New Message</button></div><div class="label">Recent</div>';for(const doc of snap.docs){const d=doc.data();const oid=d.members.find(m=>m!==me.uid);const u=await gU(oid);const sc=u.status==='online'?'on':'off';h+=`<div class="dmi${cDm===doc.id?' on':''}" data-id="${doc.id}" onclick="selDM('${doc.id}','${oid}')"><div class="ava">${avI(u)}<div class="sd ${sc}"></div></div><div class="dmi-info"><div class="dmi-name">${esc(u.displayName||'User')}</div><div class="dmi-sub">${d.lastMessage?esc(trn(d.lastMessage,28)):'Start chatting'}</div></div></div>`}c.innerHTML=h}
async function startDmW(uid){const ex=await db.collection('dms').where('members','array-contains',me.uid).get();let found=null;ex.forEach(doc=>{if(doc.data().members.includes(uid))found=doc.id});if(found){goHome();sTab('dms');setTimeout(()=>selDM(found,uid),200);return}const ref=await db.collection('dms').add({members:[me.uid,uid],createdAt:TS(),lastMessageAt:TS(),lastMessage:''});goHome();sTab('dms');setTimeout(()=>selDM(ref.id,uid),200)}
async function cDM(){const un=$('ndU').value.trim().toLowerCase();if(!un)return toast('Enter username');const t=await gUn(un);if(!t)return toast('Not found');if(t.uid===me.uid)return toast("Can't DM yourself");closeM('mND');$('ndU').value='';startDmW(t.uid)}
async function selDM(dmId,oid){cDm=dmId;cType='dm';cCh=null;cSrv=null;cv='home';document.querySelectorAll('.dmi').forEach(e=>e.classList.toggle('on',e.dataset.id===dmId));const u=await gU(oid);showChat();$('cI').innerHTML='<i class="fas fa-at"></i>';$('cN').textContent=u.displayName||'User';$('mIn').placeholder=`Message ${u.displayName||'User'}`;$('mBtn').style.display='none';$('mS').classList.remove('on');$('vcBtn').style.display='';$('vidBtn').style.display='';cancelAct();loadMsgs()}
function sTab(tab){hTab=tab;document.querySelectorAll('.side-tab').forEach(t=>t.classList.toggle('on',t.dataset.tab===tab));if(tab==='friends')renderFr();else if(tab==='dms')db.collection('dms').where('members','array-contains',me.uid).orderBy('lastMessageAt','desc').get().then(s=>renderDMs(s));else if(tab==='requests')db.collection('friendRequests').where('to','==',me.uid).where('status','==','pending').get().then(s=>renderReqs(s))}
function filterH(){const q=$('hSearch').value.toLowerCase();document.querySelectorAll('.fri,.dmi').forEach(e=>{e.style.display=e.textContent.toLowerCase().includes(q)?'':'none'})}
function loadServs(){db.collection('servers').where('members','array-contains',me.uid).onSnapshot(snap=>{const c=$('sIcons');c.innerHTML='';snap.forEach(doc=>{const d=doc.data();const div=document.createElement('div');div.className=`si${cSrv===doc.id?' on':''}`;div.title=d.name;div.dataset.id=doc.id;div.onclick=()=>selServ(doc.id);div.oncontextmenu=e=>sCtx(e,doc.id,d);div.innerHTML=d.iconURL?`<img src="${d.iconURL}">`:(d.name?d.name[0].toUpperCase():'S');c.appendChild(div)})})}
async function cServ(){const name=$('nSN').value.trim();if(!name)return toast('Enter name');const code=Math.random().toString(36).substring(2,8).toUpperCase();const ref=await db.collection('servers').add({name,iconURL:sIconD||'',ownerId:me.uid,members:[me.uid],inviteCode:code,createdAt:TS()});await db.collection('servers').doc(ref.id).collection('channels').add({name:'general',createdAt:TS()});closeM('mCS');$('nSN').value='';sIconD=null;$('sIU').innerHTML='<i class="fas fa-camera"></i>';selServ(ref.id)}
async function jServ(){const code=$('jC').value.trim().toUpperCase();if(!code)return toast('Enter code');const snap=await db.collection('servers').where('inviteCode','==',code).limit(1).get();if(snap.empty)return toast('Invalid');const doc=snap.docs[0];if(doc.data().members.includes(me.uid)){closeM('mJS');selServ(doc.id);return}await db.collection('servers').doc(doc.id).update({members:AU(me.uid)});closeM('mJS');$('jC').value='';selServ(doc.id);toast('Joined!')}
async function selServ(id){cv='server';cSrv=id;cDm=null;cType=null;cCh=null;document.querySelectorAll('.si').forEach(e=>e.classList.remove('on'));document.querySelectorAll(`.si[data-id="${id}"]`).forEach(e=>e.classList.add('on'));$('hSide').style.display='none';$('sSide').style.display='flex';const doc=await db.collection('servers').doc(id).get();if(!doc.exists)return;$('sName').textContent=doc.data().name;showEmpty();loadChs(id)}
function loadChs(sid){if(unsubs.ch)unsubs.ch();unsubs.ch=db.collection('servers').doc(sid).collection('channels').orderBy('createdAt').onSnapshot(snap=>{const c=$('chL');c.innerHTML='';const cat=document.createElement('div');cat.className='cat';cat.innerHTML=`TEXT CHANNELS <button class="add-ch" onclick="openM('mCC')"><i class="fas fa-plus"></i></button>`;c.appendChild(cat);let first=null;snap.forEach(doc=>{if(!first)first=doc;const d=doc.data();const div=document.createElement('div');div.className=`ch${cCh===doc.id?' on':''}`;div.dataset.id=doc.id;div.innerHTML=`<i class="fas fa-hashtag"></i><span>${d.name}</span>`;div.onclick=()=>selCh(doc.id,d.name);c.appendChild(div)});if(!cCh&&first)selCh(first.id,first.data().name)})}
async function cChan(){if(!cSrv)return;const name=$('nCN').value.trim().toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'');if(!name)return toast('Enter name');await db.collection('servers').doc(cSrv).collection('channels').add({name,createdAt:TS()});closeM('mCC');$('nCN').value=''}
function selCh(chId,chName){cCh=chId;cType='channel';cDm=null;document.querySelectorAll('.ch').forEach(e=>e.classList.toggle('on',e.dataset.id===chId));showChat();$('cI').innerHTML='<i class="fas fa-hashtag"></i>';$('cN').textContent=chName;$('mIn').placeholder=`Message #${chName}`;$('mBtn').style.display='';$('vcBtn').style.display='none';$('vidBtn').style.display='none';cancelAct();loadMsgs();loadMem()}
function selCh2(chId){db.collection('servers').doc(cSrv).collection('channels').doc(chId).get().then(doc=>{if(doc.exists)selCh(chId,doc.data().name)})}
function goHome(){cv='home';cSrv=null;cCh=null;if(unsubs.ch){unsubs.ch();unsubs.ch=null}document.querySelectorAll('.si').forEach(e=>e.classList.remove('on'));document.querySelector('.si.home').classList.add('on');$('hSide').style.display='flex';$('sSide').style.display='none';if(!cDm)showEmpty();sTab(hTab)}
function loadMsgs(){if(unsubs.msg)unsubs.msg();$('msgsL').innerHTML='';firstLoad=true;let ref;if(cType==='channel')ref=db.collection('servers').doc(cSrv).collection('channels').doc(cCh).collection('messages');else if(cType==='dm')ref=db.collection('dms').doc(cDm).collection('messages');else return;unsubs.msg=ref.orderBy('createdAt').limitToLast(100).onSnapshot(snap=>{const list=$('msgsL');if(firstLoad){list.innerHTML='';const w=document.createElement('div');w.className='welcome';w.innerHTML=cType==='channel'?`<h2># ${$('cN').textContent}</h2><p>Start of channel.</p>`:`<h2>${$('cN').textContent}</h2><p>Start of conversation.</p>`;list.appendChild(w);let pA=null,pT=0;snap.forEach(doc=>{const d=doc.data();const ts=d.createdAt?d.createdAt.toMillis():0;const g=d.authorId===pA&&ts-pT<300000&&pA!==null;appMsg(doc.id,d,g,list);pA=d.authorId;pT=ts});firstLoad=false;scBot()}else{snap.docChanges().forEach(ch=>{if(ch.type==='added'){if($('m-'+ch.doc.id))return;const d=ch.doc.data();const all=list.querySelectorAll('.msg');const prev=all.length?all[all.length-1]:null;let g=false;if(prev&&prev.dataset.author===d.authorId){const pt=parseInt(prev.dataset.ts||'0');const ct=d.createdAt?d.createdAt.toMillis():0;if(ct-pt<300000)g=true}appMsg(ch.doc.id,d,g,list);if(d.authorId===me.uid)scBot();else{const c=$('msgsC');if(c.scrollHeight-c.scrollTop-c.clientHeight<200)scBot()}}else if(ch.type==='removed'){const el=$('m-'+ch.doc.id);if(el)el.remove()}else if(ch.type==='modified'){updMsg(ch.doc.id,ch.doc.data())}})}})}
function appMsg(id,data,grouped,container){const div=document.createElement('div');div.className=`msg${grouped?' grouped':''}`;div.id='m-'+id;div.dataset.author=data.authorId;div.dataset.ts=data.createdAt?data.createdAt.toMillis():'0';const time=data.createdAt?fmtT(data.createdAt.toDate()):'';const full=data.createdAt?fmtF(data.createdAt.toDate()):'';const tb=`<div class="tb"><button onclick="startReply('${id}')"><i class="fas fa-reply"></i></button>${data.authorId===me.uid?`<button onclick="startEdit('${id}')"><i class="fas fa-pen"></i></button><button onclick="delMsg('${id}')"><i class="fas fa-trash"></i></button>`:`<button onclick="showUC('${data.authorId}')"><i class="fas fa-user"></i></button>`}</div>`;let rr='';if(data.replyTo)rr=`<div class="rr" onclick="scToMsg('${data.replyTo.id}')"><div class="rrb"></div><span class="rrn">${esc(data.replyTo.authorName||'User')}</span> ${esc(trn(data.replyTo.text||'attachment',50))}</div>`;let ct='';if(data.text)ct+=`<div class="mb">${linkify(esc(data.text))}${data.edited?'<span class="etag">(edited)</span>':''}</div>`;if(data.imageURL)ct+=`<img class="mi" src="${data.imageURL}" onclick="pvI(this.src)" loading="lazy">`;if(data.gifURL)ct+=`<img class="mi" src="${data.gifURL}" onclick="pvI(this.src)" loading="lazy">`;if(grouped){div.innerHTML=`<div class="mht">${time}</div><div class="mc">${rr}${ct}</div>${tb}`}else{div.innerHTML=`<div class="ma">...</div><div class="mc"><div class="mh"><span class="mn">...</span><span class="mt">${full}</span></div>${rr}${ct}</div>${tb}`}container.appendChild(div);gU(data.authorId).then(u=>{if(!grouped){const ma=div.querySelector('.ma');const mn=div.querySelector('.mn');if(ma){ma.innerHTML=avI(u);ma.onclick=()=>showUC(data.authorId)}if(mn){mn.textContent=u.displayName||'?';mn.style.color=u.nameColor||'#fff';mn.style.fontFamily=u.nameFont||'Inter';mn.onclick=()=>showUC(data.authorId)}}})}
function updMsg(id,data){const el=$('m-'+id);if(!el)return;const mb=el.querySelector('.mb');if(mb)mb.innerHTML=linkify(esc(data.text||''))+(data.edited?'<span class="etag">(edited)</span>':'')}
function startReply(id){cancelAct();replyD={id};const el=$('m-'+id);const name=el?.querySelector('.mn')?.textContent||'User';const text=el?.querySelector('.mb')?.textContent?.replace(/\(edited\)$/,'').trim()||'';$('abI').className='fas fa-reply';$('abI').style.color='var(--blue)';$('abL').textContent='Replying to '+name;$('abT').textContent=trn(text,60);$('aBar').classList.add('on');$('mIn').focus()}
function startEdit(id){cancelAct();const el=$('m-'+id);const text=el?.querySelector('.mb')?.textContent?.replace(/\(edited\)$/,'').trim()||'';editD={id};$('abI').className='fas fa-pen';$('abI').style.color='var(--orange)';$('abL').textContent='Editing';$('abT').textContent='';$('aBar').classList.add('on');$('mIn').value=text;$('mIn').focus();autoH($('mIn'))}
function cancelAct(){replyD=null;editD=null;$('aBar').classList.remove('on');$('mIn').value='';autoH($('mIn'))}
function scToMsg(id){const el=$('m-'+id);if(el){el.scrollIntoView({behavior:'smooth',block:'center'});el.style.background='rgba(255,255,255,.06)';setTimeout(()=>el.style.background='',1500)}}
async function doSend(){const input=$('mIn');const text=input.value.trim();if(editD){if(!text)return;let ref;if(cType==='channel')ref=db.collection('servers').doc(cSrv).collection('channels').doc(cCh).collection('messages');else if(cType==='dm')ref=db.collection('dms').doc(cDm).collection('messages');else return;await ref.doc(editD.id).update({text,edited:true});editD=null;$('aBar').classList.remove('on');input.value='';autoH(input);return}if(!text&&!pendImg)return;let ref;if(cType==='channel')ref=db.collection('servers').doc(cSrv).collection('channels').doc(cCh).collection('messages');else if(cType==='dm')ref=db.collection('dms').doc(cDm).collection('messages');else return;const msg={authorId:me.uid,text,createdAt:TS(),edited:false};if(pendImg){msg.imageURL=pendImg;rmUp()}if(replyD){const rEl=$('m-'+replyD.id);msg.replyTo={id:replyD.id,authorName:rEl?.querySelector('.mn')?.textContent||'User',text:rEl?.querySelector('.mb')?.textContent?.replace(/\(edited\)$/,'').trim()||''};replyD=null;$('aBar').classList.remove('on')}await ref.add(msg);if(cType==='dm'){const dmDoc=await db.collection('dms').doc(cDm).get();const oid=dmDoc.data().members.find(m=>m!==me.uid);db.collection('dms').doc(cDm).update({lastMessage:text||'üì∑',lastMessageAt:TS()});addN(oid,'dm',text||'üì∑',{dmId:cDm,serverName:'Direct Message',channelName:md.displayName})}if(cType==='channel'){const sDoc=await db.collection('servers').doc(cSrv).get();const sd=sDoc.data();const cn=$('cN').textContent;sd.members.forEach(uid=>{if(uid!==me.uid)addN(uid,'channel',text||'üì∑',{serverId:cSrv,channelId:cCh,serverName:sd.name,channelName:cn})})}input.value='';autoH(input)}
function sendGif(url){let ref;if(cType==='channel')ref=db.collection('servers').doc(cSrv).collection('channels').doc(cCh).collection('messages');else if(cType==='dm')ref=db.collection('dms').doc(cDm).collection('messages');else return;ref.add({authorId:me.uid,text:'',gifURL:url,createdAt:TS(),edited:false});if(cType==='dm')db.collection('dms').doc(cDm).update({lastMessage:'GIF',lastMessageAt:TS()});togGif()}
async function delMsg(id){if(!confirm('Delete?'))return;let ref;if(cType==='channel')ref=db.collection('servers').doc(cSrv).collection('channels').doc(cCh).collection('messages');else if(cType==='dm')ref=db.collection('dms').doc(cDm).collection('messages');else return;await ref.doc(id).delete()}
function onKey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();doSend()}if(e.key==='Escape')cancelAct()}
function autoH(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,180)+'px'}
function scBot(){requestAnimationFrame(()=>{const c=$('msgsC');c.scrollTop=c.scrollHeight})}
async function loadMem(){if(cType!=='channel'||!cSrv)return;const doc=await db.collection('servers').doc(cSrv).get();if(!doc.exists)return;const mems=doc.data().members||[];$('mCt').textContent=`Members ‚Äî ${mems.length}`;const c=$('mL');c.innerHTML='';for(const uid of mems){const u=await gU(uid);const div=document.createElement('div');div.className='memi';div.onclick=()=>showUC(uid);div.innerHTML=`<div class="ava" style="width:28px;height:28px;font-size:11px">${avI(u)}</div><span class="memn" style="color:${u.nameColor||'#fff'};font-family:${u.nameFont||'Inter'}">${esc(u.displayName||'?')}</span>`;c.appendChild(div)}}
function toggleMem(){$('mS').classList.toggle('on')}
async function showUC(uid){const u=await gU(uid);$('ucA').innerHTML=avI(u);$('ucA').style.fontSize='28px';const n=$('ucN');n.textContent=u.displayName||'?';n.style.color=u.nameColor||'#fff';n.style.fontFamily=u.nameFont||'Inter';$('ucU').textContent='@'+(u.username||'?');$('ucB').textContent=u.bio||'No bio.';let a='';if(uid!==me.uid){const isFr=(md.friends||[]).includes(uid);a+=`<button class="btn btn-w btn-sm" onclick="startDmW('${uid}');closeM('mUC')"><i class="fas fa-comment"></i> Message</button>`;a+=isFr?`<button class="btn btn-g btn-sm" onclick="rmFr('${uid}');closeM('mUC')"><i class="fas fa-user-minus"></i></button>`:`<button class="btn btn-g btn-sm" onclick="sendFRD('${uid}')"><i class="fas fa-user-plus"></i></button>`}$('ucAc').innerHTML=a;openM('mUC')}
async function loadInvFr(){const c=$('iFr');c.innerHTML='';const fr=md.friends||[];if(!fr.length){c.innerHTML='<p style="font-size:13px;color:var(--tx3);padding:8px">No friends</p>';return}const sDoc=await db.collection('servers').doc(cSrv).get();const mems=sDoc.data().members||[];const code=sDoc.data().inviteCode;const sName=sDoc.data().name;for(const uid of fr){const u=await gU(uid);const inS=mems.includes(uid);const div=document.createElement('div');div.className='inv-f';div.innerHTML=`<div class="ava">${avI(u)}</div><div class="ifn"><div>${esc(u.displayName)}</div><div>@${esc(u.username||'')}</div></div>${inS?'<span style="font-size:12px;color:var(--tx4)">Joined</span>':`<button class="inv-btn" onclick="sendSInv('${uid}','${code}','${esc(sName)}',this)"><i class="fas fa-paper-plane"></i> Invite</button>`}`;c.appendChild(div)}}
async function sendSInv(uid,code,sName,btn){const ex=await db.collection('dms').where('members','array-contains',me.uid).get();let dmId=null;ex.forEach(doc=>{if(doc.data().members.includes(uid))dmId=doc.id});if(!dmId){const ref=await db.collection('dms').add({members:[me.uid,uid],createdAt:TS(),lastMessageAt:TS(),lastMessage:''});dmId=ref.id}await db.collection('dms').doc(dmId).collection('messages').add({authorId:me.uid,text:`üéâ Join **${sName}**! Code: **${code}**`,createdAt:TS(),edited:false});await db.collection('dms').doc(dmId).update({lastMessage:`Invited to ${sName}`,lastMessageAt:TS()});await addN(uid,'dm',`Invited you to ${sName}`,{dmId,serverName:'Server Invite',channelName:md.displayName});btn.innerHTML='<i class="fas fa-check"></i> Sent';btn.disabled=true}
function onFile(e){const f=e.target.files[0];if(!f||f.size>2*1024*1024)return toast('Max 2MB');const r=new FileReader();r.onload=ev=>{pendImg=ev.target.result;$('upP').classList.add('on');$('upI').src=pendImg;$('upN').textContent=f.name};r.readAsDataURL(f);e.target.value=''}
function rmUp(){pendImg=null;$('upP').classList.remove('on')}
function oPfp(e){const f=e.target.files[0];if(!f||f.size>1024*1024)return toast('Max 1MB');const r=new FileReader();r.onload=ev=>{const a=$('pA');a.innerHTML=`<img src="${ev.target.result}"><div class="pfo"><i class="fas fa-camera"></i></div>`;a.dataset.url=ev.target.result};r.readAsDataURL(f);e.target.value=''}
async function sProf(){const name=$('pN').value.trim();const url=$('pA').dataset.url||md.photoURL||'';const bio=$('pB').value.trim();const up={photoURL:url,nameColor:selCol,nameFont:selFon,bio};if(name)up.displayName=name;await db.collection('users').doc(me.uid).update(up);md={...md,...up};uC[me.uid]=md;updP();closeM('mProf');toast('Saved!')}
function pSI(e){const f=e.target.files[0];if(!f||f.size>1024*1024)return;const r=new FileReader();r.onload=ev=>{sIconD=ev.target.result;$('sIU').innerHTML=`<img src="${sIconD}">`};r.readAsDataURL(f);e.target.value=''}
function initCG(){const g=$('cG');g.innerHTML='';COLORS.forEach(c=>{const d=document.createElement('div');d.className=`color-opt${selCol===c?' on':''}`;d.style.background=c;d.onclick=()=>{selCol=c;document.querySelectorAll('.color-opt').forEach(x=>x.classList.remove('on'));d.classList.add('on');uFP()};g.appendChild(d)})}
function uFP(){selFon=$('fS').value;$('fP').style.fontFamily=selFon;$('fP').style.color=selCol;$('fP').textContent=$('pN').value||md?.displayName||'Name'}
const TK='AIzaSyBJMIUucxOusoVzs4lc-QurCxjlW6Hlsuw';
function togGif(){$('gP').classList.toggle('on');if($('gP').classList.contains('on')){$('gIn').value='';$('gIn').focus();loadTr()}}
function gDeb(){clearTimeout(gifTO);gifTO=setTimeout(sGif2,400)}
async function loadTr(){$('gG').innerHTML='<div class="gl"><i class="fas fa-spinner fa-spin"></i></div>';try{const r=await fetch(`https://tenor.googleapis.com/v2/featured?key=${TK}&limit=30&media_filter=tinygif`);rGifs((await r.json()).results)}catch(e){$('gG').innerHTML='<div class="gl">Failed</div>'}}
async function sGif2(){const q=$('gIn').value.trim();if(!q)return loadTr();$('gG').innerHTML='<div class="gl"><i class="fas fa-spinner fa-spin"></i></div>';try{const r=await fetch(`https://tenor.googleapis.com/v2/search?q=${encodeURIComponent(q)}&key=${TK}&limit=30&media_filter=tinygif`);rGifs((await r.json()).results)}catch(e){$('gG').innerHTML='<div class="gl">Failed</div>'}}
function rGifs(res){const g=$('gG');g.innerHTML='';if(!res?.length){g.innerHTML='<div class="gl">No GIFs</div>';return}res.forEach(gif=>{const url=gif.media_formats?.tinygif?.url;if(!url)return;const img=document.createElement('img');img.src=url;img.loading='lazy';img.onclick=()=>sendGif(url);g.appendChild(img)})}
function openSS(){if(!cSrv)return;db.collection('servers').doc(cSrv).get().then(doc=>{if(!doc.exists)return;const d=doc.data();$('eSN').value=d.name;$('dSB').style.display=d.ownerId===me.uid?'':'none';openM('mSS')})}
async function sSS(){const name=$('eSN').value.trim();if(!name)return;await db.collection('servers').doc(cSrv).update({name});$('sName').textContent=name;closeM('mSS')}
async function lServ(){if(!confirm('Leave?'))return;await db.collection('servers').doc(cSrv).update({members:AR(me.uid)});closeM('mSS');cSrv=null;cCh=null;goHome();showEmpty()}
async function dServ(){if(!confirm('DELETE?'))return;await db.collection('servers').doc(cSrv).delete();closeM('mSS');cSrv=null;cCh=null;goHome();showEmpty()}
function updInv(){if(!cSrv)return;db.collection('servers').doc(cSrv).get().then(doc=>{if(doc.exists)$('iC').textContent=doc.data().inviteCode||'N/A'})}
function cpInv(){navigator.clipboard.writeText($('iC').textContent);event.target.textContent='Copied!';setTimeout(()=>event.target.textContent='Copy',2000)}
function sCtx(e,id,data){e.preventDefault();const m=$('ctx');let h=`<div class="ctx-i" onclick="cSrv='${id}';openM('mInv');updInv();loadInvFr();closeCtx()"><i class="fas fa-user-plus"></i> Invite</div>`;if(data.ownerId===me.uid)h+=`<div class="ctx-i" onclick="cSrv='${id}';openSS();closeCtx()"><i class="fas fa-gear"></i> Settings</div>`;h+=`<div class="ctx-i dg" onclick="cSrv='${id}';lServ();closeCtx()"><i class="fas fa-arrow-right-from-bracket"></i> Leave</div>`;m.innerHTML=h;m.style.left=Math.min(e.clientX,innerWidth-200)+'px';m.style.top=Math.min(e.clientY,innerHeight-150)+'px';m.classList.add('on')}
function closeCtx(){$('ctx').classList.remove('on')}
document.addEventListener('click',closeCtx);
function openM(id){$(id).classList.add('on');if(id==='mProf'){$('pN').value=md?.displayName||'';$('pU').value=md?.username||'';$('pB').value=md?.bio||'';selCol=md?.nameColor||'#ffffff';selFon=md?.nameFont||'Inter';$('fS').value=selFon;const a=$('pA');if(md?.photoURL){a.innerHTML=`<img src="${md.photoURL}"><div class="pfo"><i class="fas fa-camera"></i></div>`;a.dataset.url=md.photoURL}else{a.innerHTML=`<span style="font-size:32px;font-weight:700">${(md?.displayName||'U')[0].toUpperCase()}</span><div class="pfo"><i class="fas fa-camera"></i></div>`;a.dataset.url=''}initCG();uFP()}if(id==='mInv'){updInv();loadInvFr()}}
function closeM(id){$(id).classList.remove('on')}
document.querySelectorAll('.mdl-o').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('on')}));
function showChat(){$('es').style.display='none';$('ac').style.display='flex'}
function showEmpty(){$('es').style.display='flex';$('ac').style.display='none';if(unsubs.msg){unsubs.msg();unsubs.msg=null}}
function esc(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML}
function linkify(t){return t.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>').replace(/(https?:\/\/[^\s<]+)/g,'<a href="$1" target="_blank" rel="noopener">$1</a>')}
function trn(s,n){return s.length>n?s.substring(0,n)+'‚Ä¶':s}
function fmtT(d){return d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}
function fmtF(d){const now=new Date(),t=fmtT(d);if(d.toDateString()===now.toDateString())return'Today '+t;const y=new Date(now);y.setDate(y.getDate()-1);if(d.toDateString()===y.toDateString())return'Yesterday '+t;return d.toLocaleDateString()+' '+t}
function avI(u){return u.photoURL?`<img src="${u.photoURL}">`:(u.displayName||'U')[0].toUpperCase()}
function pvI(url){$('iPvS').src=url;$('iPv').classList.add('on')}
function toast(title,msg,color){const c=$('toasts');const t=document.createElement('div');t.className='toast';t.innerHTML=`<div class="ta" style="background:${color||'var(--blue)'}"><i class="fas fa-bell" style="font-size:14px"></i></div><div class="tb2"><div class="tn">${esc(title)}</div>${msg?`<div class="tm">${esc(msg)}</div>`:''}</div><button class="tx" onclick="event.stopPropagation();this.parentElement.remove()"><i class="fas fa-xmark"></i></button>`;c.appendChild(t);setTimeout(()=>{if(t.parentElement)t.remove()},4000)}
document.addEventListener('click',e=>{const p=$('gP');if(p.classList.contains('on')&&!p.contains(e.target)&&!e.target.closest('.iacts'))p.classList.remove('on')});
document.addEventListener('keydown',e=>{if(e.key==='Escape'){document.querySelectorAll('.mdl-o.on').forEach(m=>m.classList.remove('on'));$('gP').classList.remove('on');$('iPv').classList.remove('on');$('np').classList.remove('on');cancelAct()}});
</script>
</body>
</html>

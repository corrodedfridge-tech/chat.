<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
* { margin:0; padding:0; box-sizing:border-box; }
html, body {
  height: 100%;
  overflow: hidden;
}
body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: #000;
  color: #fff;
  -webkit-font-smoothing: antialiased;
}

:root {
  --bg-primary: #000000;
  --bg-secondary: #0a0a0a;
  --bg-tertiary: #111111;
  --bg-hover: #1a1a1a;
  --bg-active: #222222;
  --bg-input: #1a1a1a;
  --bg-modal: #111111;
  --text-primary: #ffffff;
  --text-secondary: #a0a0a0;
  --text-muted: #666666;
  --border: #222222;
  --accent: #ffffff;
  --danger: #ff453a;
  --success: #30d158;
  --online: #30d158;
  --scrollbar: #333333;
}

/* ============ AUTH ============ */
.auth-container {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100vh;
  background: var(--bg-primary);
}
.auth-box {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 48px;
  width: 420px;
  max-width: 90vw;
}
.auth-box h1 {
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 8px;
  letter-spacing: -0.5px;
}
.auth-box p {
  color: var(--text-secondary);
  margin-bottom: 32px;
  font-size: 14px;
}
.auth-box .logo {
  font-size: 40px;
  margin-bottom: 24px;
  display: block;
}
.form-group {
  margin-bottom: 20px;
}
.form-group label {
  display: block;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-secondary);
  margin-bottom: 8px;
}
.form-group input {
  width: 100%;
  padding: 12px 16px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 12px;
  color: var(--text-primary);
  font-size: 15px;
  font-family: inherit;
  outline: none;
  transition: border-color 0.2s;
}
.form-group input:focus {
  border-color: var(--text-muted);
}
.btn {
  width: 100%;
  padding: 12px;
  border: none;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 600;
  font-family: inherit;
  cursor: pointer;
  transition: all 0.2s;
}
.btn-primary {
  background: var(--accent);
  color: #000;
}
.btn-primary:hover {
  opacity: 0.9;
  transform: scale(0.98);
}
.btn-secondary {
  background: transparent;
  color: var(--text-secondary);
  border: 1px solid var(--border);
  margin-top: 12px;
}
.btn-secondary:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}
.auth-switch {
  text-align: center;
  margin-top: 24px;
  font-size: 13px;
  color: var(--text-secondary);
}
.auth-switch a {
  color: var(--accent);
  cursor: pointer;
  text-decoration: none;
  font-weight: 500;
}

/* ============ MAIN LAYOUT ============ */
.app-container {
  display: none;
  height: 100vh;
  width: 100vw;
  overflow: hidden;
}
.app-container.active {
  display: flex;
}

/* ============ SERVER LIST ============ */
.server-list {
  width: 72px;
  min-width: 72px;
  background: var(--bg-primary);
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 12px 0;
  gap: 4px;
  overflow-y: auto;
  border-right: 1px solid var(--border);
  flex-shrink: 0;
}
.server-list::-webkit-scrollbar { width: 0; }
.server-icon {
  width: 48px;
  height: 48px;
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
  background: var(--bg-tertiary);
  color: var(--text-secondary);
  font-size: 18px;
  font-weight: 600;
  position: relative;
  overflow: hidden;
  flex-shrink: 0;
}
.server-icon img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.server-icon:hover, .server-icon.active {
  border-radius: 12px;
  background: var(--bg-active);
  color: var(--text-primary);
}
.server-icon.active::before {
  content: '';
  position: absolute;
  left: -16px;
  width: 4px;
  height: 24px;
  background: var(--accent);
  border-radius: 0 4px 4px 0;
}
.server-icon.home-btn {
  background: var(--bg-tertiary);
  margin-bottom: 4px;
}
.server-icon.home-btn.active {
  background: var(--accent);
  color: #000;
}
.server-divider {
  width: 32px;
  height: 1px;
  background: var(--border);
  margin: 4px 0;
  flex-shrink: 0;
}
.server-icon.add-server {
  background: transparent;
  border: 1px dashed var(--text-muted);
  color: var(--text-muted);
  font-size: 22px;
}
.server-icon.add-server:hover {
  border-color: var(--accent);
  color: var(--accent);
  background: transparent;
}
.server-icon.join-server {
  background: transparent;
  border: 1px dashed var(--text-muted);
  color: var(--text-muted);
  font-size: 16px;
}
.server-icon.join-server:hover {
  border-color: var(--success);
  color: var(--success);
  background: transparent;
}

/* ============ SIDEBAR ============ */
.sidebar {
  width: 260px;
  min-width: 260px;
  background: var(--bg-secondary);
  display: flex;
  flex-direction: column;
  border-right: 1px solid var(--border);
  flex-shrink: 0;
  height: 100%;
  overflow: hidden;
}
.sidebar-header {
  padding: 16px 16px;
  border-bottom: 1px solid var(--border);
  font-weight: 700;
  font-size: 15px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  min-height: 52px;
  flex-shrink: 0;
}
.sidebar-header .actions {
  display: flex;
  gap: 8px;
}
.sidebar-header .actions button {
  background: none;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  font-size: 16px;
  padding: 4px;
  border-radius: 6px;
  transition: all 0.15s;
}
.sidebar-header .actions button:hover {
  color: var(--text-primary);
  background: var(--bg-hover);
}
.sidebar-content {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
  min-height: 0;
}
.sidebar-content::-webkit-scrollbar { width: 4px; }
.sidebar-content::-webkit-scrollbar-thumb { background: var(--scrollbar); border-radius: 4px; }

.channel-category {
  padding: 16px 8px 4px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
}
.channel-category .add-ch {
  font-size: 14px;
  opacity: 0;
  transition: opacity 0.15s;
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
}
.channel-category:hover .add-ch {
  opacity: 1;
}
.channel-item, .dm-item {
  display: flex;
  align-items: center;
  padding: 8px 12px;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.15s;
  gap: 10px;
  font-size: 14px;
  color: var(--text-secondary);
  margin: 1px 0;
}
.channel-item:hover, .dm-item:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}
.channel-item.active, .dm-item.active {
  background: var(--bg-active);
  color: var(--text-primary);
}
.channel-item i {
  font-size: 16px;
  opacity: 0.5;
  width: 20px;
  text-align: center;
}
.dm-item .dm-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--bg-active);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 13px;
  font-weight: 600;
  overflow: hidden;
  flex-shrink: 0;
}
.dm-item .dm-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.dm-item .dm-info {
  flex: 1;
  min-width: 0;
}
.dm-item .dm-name {
  font-weight: 500;
  font-size: 14px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.dm-item .dm-status {
  font-size: 11px;
  color: var(--text-muted);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

/* ============ USER PANEL ============ */
.user-panel {
  padding: 12px;
  border-top: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 10px;
  background: var(--bg-secondary);
  flex-shrink: 0;
}
.user-panel .user-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: var(--bg-active);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  overflow: hidden;
  cursor: pointer;
  flex-shrink: 0;
}
.user-panel .user-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.user-panel .user-info {
  flex: 1;
  min-width: 0;
}
.user-panel .user-name {
  font-size: 13px;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.user-panel .user-tag {
  font-size: 11px;
  color: var(--text-muted);
}
.user-panel .panel-actions {
  display: flex;
  gap: 4px;
}
.user-panel .panel-actions button {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 14px;
  padding: 6px;
  border-radius: 6px;
  transition: all 0.15s;
}
.user-panel .panel-actions button:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}

/* ============ CHAT AREA - THE KEY FIX ============ */
.chat-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: var(--bg-primary);
  min-width: 0;
  height: 100vh;
  overflow: hidden;
}

.chat-header {
  padding: 12px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 12px;
  height: 52px;
  min-height: 52px;
  flex-shrink: 0;
  background: var(--bg-primary);
}
.chat-header .ch-icon {
  color: var(--text-muted);
  font-size: 18px;
}
.chat-header .ch-name {
  font-weight: 700;
  font-size: 15px;
}
.chat-header .ch-topic {
  font-size: 12px;
  color: var(--text-muted);
  margin-left: 8px;
  padding-left: 12px;
  border-left: 1px solid var(--border);
}
.chat-header .header-actions {
  margin-left: auto;
  display: flex;
  gap: 4px;
}
.chat-header .header-actions button {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 16px;
  padding: 6px 8px;
  border-radius: 6px;
  transition: all 0.15s;
}
.chat-header .header-actions button:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}

/* THIS IS THE CRITICAL PART */
.chat-body {
  flex: 1;
  display: flex;
  overflow: hidden;
  min-height: 0;
}
.chat-main {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-width: 0;
  min-height: 0;
  overflow: hidden;
}

.messages-container {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 20px;
  min-height: 0;
}
.messages-container::-webkit-scrollbar { width: 6px; }
.messages-container::-webkit-scrollbar-thumb { background: var(--scrollbar); border-radius: 6px; }
.messages-list {
  display: flex;
  flex-direction: column;
  justify-content: flex-end;
  min-height: 100%;
}

/* Messages */
.message {
  display: flex;
  gap: 14px;
  padding: 6px 12px;
  border-radius: 8px;
  transition: background 0.1s;
  margin: 1px 0;
}
.message:hover {
  background: rgba(255,255,255,0.02);
}
.message.grouped {
  padding-top: 2px;
  padding-bottom: 2px;
}
.message .msg-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--bg-tertiary);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 14px;
  overflow: hidden;
  flex-shrink: 0;
  cursor: pointer;
}
.message .msg-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.message .msg-content {
  flex: 1;
  min-width: 0;
}
.message .msg-header {
  display: flex;
  align-items: baseline;
  gap: 8px;
  margin-bottom: 2px;
}
.message .msg-author {
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
}
.message .msg-author:hover {
  text-decoration: underline;
}
.message .msg-time {
  font-size: 11px;
  color: var(--text-muted);
}
.message .msg-text {
  font-size: 14px;
  line-height: 1.5;
  color: var(--text-secondary);
  word-wrap: break-word;
  overflow-wrap: break-word;
}
.message .msg-image {
  max-width: 400px;
  max-height: 300px;
  border-radius: 12px;
  margin-top: 8px;
  cursor: pointer;
  display: block;
}
.message.grouped .msg-header {
  display: none;
}
.message.grouped .msg-avatar {
  visibility: hidden;
}
.msg-hover-time {
  font-size: 10px;
  color: var(--text-muted);
  opacity: 0;
  min-width: 40px;
  text-align: center;
  line-height: 20px;
  flex-shrink: 0;
}
.message.grouped:hover .msg-hover-time {
  opacity: 1;
}
.welcome-msg {
  padding: 20px 12px;
  margin-bottom: 16px;
}
.welcome-msg h2 {
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 8px;
}
.welcome-msg p {
  color: var(--text-muted);
  font-size: 14px;
}

/* ============ MESSAGE INPUT ============ */
.message-input-container {
  padding: 0 20px 20px;
  flex-shrink: 0;
  position: relative;
}
.message-input-wrapper {
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: 14px;
  display: flex;
  align-items: flex-end;
  padding: 4px;
  transition: border-color 0.2s;
}
.message-input-wrapper:focus-within {
  border-color: var(--text-muted);
}
.input-actions {
  display: flex;
  gap: 2px;
  padding: 6px 4px;
}
.input-actions button {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 18px;
  padding: 6px;
  border-radius: 8px;
  transition: all 0.15s;
}
.input-actions button:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}
.message-input {
  flex: 1;
  background: none;
  border: none;
  color: var(--text-primary);
  font-size: 14px;
  font-family: inherit;
  padding: 10px 8px;
  outline: none;
  resize: none;
  max-height: 200px;
  line-height: 1.4;
}
.message-input::placeholder {
  color: var(--text-muted);
}
.send-btn {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 18px;
  padding: 6px 10px;
  margin: 6px 4px;
  border-radius: 8px;
  transition: all 0.15s;
}
.send-btn:hover {
  background: var(--accent);
  color: #000;
}

/* Upload preview */
.upload-preview {
  display: none;
  padding: 8px 12px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-bottom: none;
  border-radius: 14px 14px 0 0;
}
.upload-preview.active {
  display: flex;
  align-items: center;
  gap: 12px;
}
.upload-preview img {
  width: 60px;
  height: 60px;
  object-fit: cover;
  border-radius: 8px;
}
.upload-preview .upload-info {
  flex: 1;
  font-size: 13px;
  color: var(--text-secondary);
}
.upload-preview .remove-upload {
  background: none;
  border: none;
  color: var(--danger);
  cursor: pointer;
  font-size: 16px;
  padding: 4px;
}
.upload-preview.active + .message-input-wrapper {
  border-radius: 0 0 14px 14px;
  border-top: none;
}

/* Typing indicator */
.typing-indicator {
  padding: 2px 20px;
  font-size: 12px;
  color: var(--text-muted);
  height: 20px;
  flex-shrink: 0;
}

/* ============ GIF PICKER ============ */
.gif-picker {
  display: none;
  position: absolute;
  bottom: 70px;
  left: 0;
  width: 420px;
  height: 460px;
  background: var(--bg-modal);
  border: 1px solid var(--border);
  border-radius: 16px;
  z-index: 500;
  flex-direction: column;
  overflow: hidden;
}
.gif-picker.active {
  display: flex;
}
.gif-picker-header {
  padding: 12px;
  border-bottom: 1px solid var(--border);
  flex-shrink: 0;
}
.gif-picker-header input {
  width: 100%;
  padding: 10px 14px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text-primary);
  font-size: 13px;
  font-family: inherit;
  outline: none;
}
.gif-picker-header input:focus {
  border-color: var(--text-muted);
}
.gif-grid {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 6px;
  align-content: start;
  min-height: 0;
}
.gif-grid::-webkit-scrollbar { width: 4px; }
.gif-grid::-webkit-scrollbar-thumb { background: var(--scrollbar); border-radius: 4px; }
.gif-grid img {
  width: 100%;
  border-radius: 8px;
  cursor: pointer;
  transition: transform 0.1s;
  display: block;
}
.gif-grid img:hover {
  transform: scale(0.97);
}
.gif-grid .gif-loading {
  grid-column: 1 / -1;
  text-align: center;
  padding: 40px;
  color: var(--text-muted);
  font-size: 13px;
}

/* ============ MEMBERS SIDEBAR ============ */
.members-sidebar {
  width: 240px;
  min-width: 240px;
  background: var(--bg-secondary);
  border-left: 1px solid var(--border);
  padding: 16px 8px;
  overflow-y: auto;
  display: none;
  flex-shrink: 0;
}
.members-sidebar.active {
  display: block;
}
.members-sidebar::-webkit-scrollbar { width: 4px; }
.members-sidebar::-webkit-scrollbar-thumb { background: var(--scrollbar); border-radius: 4px; }
.member-category {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  padding: 16px 8px 4px;
}
.member-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 6px 8px;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.15s;
}
.member-item:hover {
  background: var(--bg-hover);
}
.member-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--bg-active);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 600;
  overflow: hidden;
  flex-shrink: 0;
}
.member-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.member-name {
  font-size: 13px;
  font-weight: 500;
  color: var(--text-secondary);
}

/* ============ MODALS ============ */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(8px);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}
.modal-overlay.active {
  display: flex;
}
.modal {
  background: var(--bg-modal);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 32px;
  width: 460px;
  max-width: 90vw;
  max-height: 85vh;
  overflow-y: auto;
  position: relative;
}
.modal::-webkit-scrollbar { width: 4px; }
.modal::-webkit-scrollbar-thumb { background: var(--scrollbar); border-radius: 4px; }
.modal h2 {
  font-size: 22px;
  font-weight: 700;
  margin-bottom: 8px;
  letter-spacing: -0.3px;
}
.modal p.modal-desc {
  color: var(--text-secondary);
  font-size: 13px;
  margin-bottom: 24px;
}
.modal-close {
  position: absolute;
  top: 20px;
  right: 20px;
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 20px;
  cursor: pointer;
  padding: 4px;
  border-radius: 6px;
  transition: all 0.15s;
}
.modal-close:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}

/* ============ MISC ============ */
.empty-state {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: var(--text-muted);
  text-align: center;
  padding: 40px;
}
.empty-state i {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.3;
}
.empty-state h3 {
  font-size: 18px;
  margin-bottom: 8px;
  color: var(--text-secondary);
}
.empty-state p {
  font-size: 13px;
  max-width: 300px;
}
.image-preview {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.9);
  z-index: 2000;
  align-items: center;
  justify-content: center;
  cursor: zoom-out;
}
.image-preview.active {
  display: flex;
}
.image-preview img {
  max-width: 90vw;
  max-height: 90vh;
  border-radius: 8px;
}
.pfp-upload-area {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  border: 2px dashed var(--text-muted);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  margin: 0 auto 20px;
  overflow: hidden;
  transition: all 0.2s;
  position: relative;
}
.pfp-upload-area:hover {
  border-color: var(--accent);
}
.pfp-upload-area img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.pfp-upload-area .pfp-overlay {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.2s;
  font-size: 20px;
}
.pfp-upload-area:hover .pfp-overlay {
  opacity: 1;
}
.server-icon-upload {
  width: 80px;
  height: 80px;
  border-radius: 16px;
  border: 2px dashed var(--text-muted);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  margin: 0 auto 20px;
  overflow: hidden;
  transition: all 0.2s;
  font-size: 28px;
  color: var(--text-muted);
}
.server-icon-upload:hover {
  border-color: var(--accent);
  color: var(--accent);
}
.server-icon-upload img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.invite-code {
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 12px 16px;
  font-family: 'SF Mono', 'Courier New', monospace;
  font-size: 14px;
  color: var(--accent);
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin: 12px 0;
}
.invite-code button {
  background: var(--accent);
  color: #000;
  border: none;
  padding: 6px 14px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
}
.dm-search {
  padding: 8px;
  flex-shrink: 0;
}
.dm-search input {
  width: 100%;
  padding: 8px 12px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text-primary);
  font-size: 13px;
  font-family: inherit;
  outline: none;
}
.dm-search input:focus {
  border-color: var(--text-muted);
}
.section-label {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  padding: 12px 12px 4px;
}
.context-menu {
  display: none;
  position: fixed;
  background: var(--bg-modal);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 6px;
  z-index: 3000;
  min-width: 180px;
}
.context-menu.active {
  display: block;
}
.context-menu-item {
  padding: 8px 12px;
  font-size: 13px;
  cursor: pointer;
  border-radius: 6px;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: background 0.1s;
  color: var(--text-secondary);
}
.context-menu-item:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}
.context-menu-item.danger {
  color: var(--danger);
}
.context-menu-item.danger:hover {
  background: rgba(255,69,58,0.1);
}
.settings-section {
  margin-bottom: 24px;
}
.settings-section h3 {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--text-secondary);
}
.settings-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
}
.settings-row:last-child {
  border-bottom: none;
}
.settings-row label {
  font-size: 14px;
}
.settings-row span {
  font-size: 12px;
  color: var(--text-muted);
}
.danger-zone {
  border: 1px solid rgba(255,69,58,0.3);
  border-radius: 12px;
  padding: 16px;
}
.danger-zone h3 {
  color: var(--danger) !important;
}
.btn-danger {
  background: var(--danger);
  color: #fff;
  width: auto;
  padding: 8px 16px;
  font-size: 13px;
}
.btn-sm {
  width: auto;
  padding: 8px 16px;
  font-size: 13px;
}

#activeChat {
  flex-direction: column;
  min-height: 0;
  overflow: hidden;
}
</style>
</head>
<body>

<!-- AUTH: LOGIN -->
<div class="auth-container" id="loginPage">
  <div class="auth-box">
    <span class="logo">ðŸ’¬</span>
    <h1>Welcome back</h1>
    <p>Sign in to continue to Chat</p>
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="loginEmail" placeholder="name@example.com">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
    </div>
    <button class="btn btn-primary" onclick="login()">Sign In</button>
    <div class="auth-switch">
      Don't have an account? <a onclick="showRegister()">Create one</a>
    </div>
  </div>
</div>

<!-- AUTH: REGISTER -->
<div class="auth-container" id="registerPage" style="display:none">
  <div class="auth-box">
    <span class="logo">ðŸ’¬</span>
    <h1>Create account</h1>
    <p>Join Chat and start messaging</p>
    <div class="form-group">
      <label>Display Name</label>
      <input type="text" id="regName" placeholder="John Doe">
    </div>
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="regEmail" placeholder="name@example.com">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="regPassword" placeholder="Min 6 characters">
    </div>
    <button class="btn btn-primary" onclick="register()">Create Account</button>
    <div class="auth-switch">
      Already have an account? <a onclick="showLogin()">Sign in</a>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div class="app-container" id="appContainer">

  <!-- SERVER LIST -->
  <div class="server-list" id="serverList">
    <div class="server-icon home-btn active" onclick="goHome()" title="Direct Messages">
      <i class="fas fa-comment-dots"></i>
    </div>
    <div class="server-divider"></div>
    <div id="serverIcons"></div>
    <div class="server-icon add-server" onclick="openModal('createServerModal')" title="Create Server">
      <i class="fas fa-plus"></i>
    </div>
    <div class="server-icon join-server" onclick="openModal('joinServerModal')" title="Join Server">
      <i class="fas fa-arrow-right-to-bracket"></i>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div id="dmSidebar" style="display:flex;flex-direction:column;flex:1;min-height:0;overflow:hidden;">
      <div class="sidebar-header">
        <span>Messages</span>
        <div class="actions">
          <button onclick="openModal('newDmModal')" title="New Message"><i class="fas fa-pen-to-square"></i></button>
        </div>
      </div>
      <div class="dm-search">
        <input type="text" placeholder="Search conversations..." id="dmSearchInput" oninput="filterDMs()">
      </div>
      <div class="sidebar-content" id="dmList"></div>
    </div>
    <div id="serverSidebar" style="display:none;flex-direction:column;flex:1;min-height:0;overflow:hidden;">
      <div class="sidebar-header">
        <span id="serverNameDisplay">Server</span>
        <div class="actions">
          <button onclick="openServerSettings()" title="Settings"><i class="fas fa-gear"></i></button>
          <button onclick="openModal('inviteModal')" title="Invite"><i class="fas fa-user-plus"></i></button>
        </div>
      </div>
      <div class="sidebar-content" id="channelList"></div>
    </div>
    <div class="user-panel">
      <div class="user-avatar" id="userPanelAvatar" onclick="openModal('profileModal')">
        <span id="userAvatarLetter"></span>
      </div>
      <div class="user-info">
        <div class="user-name" id="userPanelName">User</div>
        <div class="user-tag" id="userPanelTag">Online</div>
      </div>
      <div class="panel-actions">
        <button onclick="openModal('settingsModal')" title="Settings"><i class="fas fa-gear"></i></button>
        <button onclick="logout()" title="Logout"><i class="fas fa-arrow-right-from-bracket"></i></button>
      </div>
    </div>
  </div>

  <!-- CHAT AREA -->
  <div class="chat-area" id="chatArea">
    <div class="empty-state" id="emptyState">
      <i class="fas fa-comment-dots"></i>
      <h3>Welcome to Chat</h3>
      <p>Select a conversation or server to start messaging</p>
    </div>

    <div id="activeChat" style="display:none;flex:1;">
      <div class="chat-header">
        <span class="ch-icon" id="chatIcon"><i class="fas fa-hashtag"></i></span>
        <span class="ch-name" id="chatName">general</span>
        <span class="ch-topic" id="chatTopic" style="display:none"></span>
        <div class="header-actions">
          <button onclick="toggleMembers()" title="Members" id="membersToggle"><i class="fas fa-users"></i></button>
        </div>
      </div>
      <div class="chat-body">
        <div class="chat-main">
          <div class="messages-container" id="messagesContainer">
            <div class="messages-list" id="messagesList"></div>
          </div>
          <div class="typing-indicator" id="typingIndicator"></div>
          <div class="message-input-container">
            <div class="upload-preview" id="uploadPreview">
              <img id="uploadPreviewImg" src="">
              <div class="upload-info" id="uploadPreviewName">image.png</div>
              <button class="remove-upload" onclick="removeUpload()"><i class="fas fa-times"></i></button>
            </div>
            <div class="message-input-wrapper">
              <div class="input-actions">
                <button onclick="triggerImageUpload()" title="Upload Image"><i class="fas fa-plus-circle"></i></button>
                <button onclick="toggleGifPicker()" title="GIFs"><i class="fas fa-icons"></i></button>
              </div>
              <textarea class="message-input" id="messageInput" placeholder="Message #general" rows="1" onkeydown="handleKeyDown(event)" oninput="autoResize(this)"></textarea>
              <button class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
            <input type="file" id="imageUploadInput" accept="image/*" style="display:none" onchange="handleImageUpload(event)">
            <div class="gif-picker" id="gifPicker">
              <div class="gif-picker-header">
                <input type="text" placeholder="Search GIFs..." id="gifSearchInput" oninput="searchGifsDebounced()">
              </div>
              <div class="gif-grid" id="gifGrid">
                <div class="gif-loading">Search for GIFs above</div>
              </div>
            </div>
          </div>
        </div>
        <div class="members-sidebar" id="membersSidebar">
          <div class="member-category" id="membersCount">Members â€” 0</div>
          <div id="membersList"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="createServerModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('createServerModal')"><i class="fas fa-xmark"></i></button>
    <h2>Create a server</h2>
    <p class="modal-desc">Your server is where you and your friends hang out.</p>
    <div class="server-icon-upload" id="serverIconUpload" onclick="document.getElementById('serverIconInput').click()">
      <i class="fas fa-camera"></i>
    </div>
    <input type="file" id="serverIconInput" accept="image/*" style="display:none" onchange="previewServerIcon(event)">
    <div class="form-group">
      <label>Server Name</label>
      <input type="text" id="createServerName" placeholder="My Awesome Server">
    </div>
    <button class="btn btn-primary" onclick="createServer()">Create Server</button>
  </div>
</div>

<div class="modal-overlay" id="joinServerModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('joinServerModal')"><i class="fas fa-xmark"></i></button>
    <h2>Join a server</h2>
    <p class="modal-desc">Enter a server invite code to join.</p>
    <div class="form-group">
      <label>Invite Code</label>
      <input type="text" id="joinServerCode" placeholder="Enter invite code">
    </div>
    <button class="btn btn-primary" onclick="joinServer()">Join Server</button>
  </div>
</div>

<div class="modal-overlay" id="inviteModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('inviteModal')"><i class="fas fa-xmark"></i></button>
    <h2>Invite people</h2>
    <p class="modal-desc">Share this invite code with friends.</p>
    <div class="invite-code">
      <span id="inviteCodeDisplay">LOADING...</span>
      <button onclick="copyInvite()">Copy</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="newDmModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('newDmModal')"><i class="fas fa-xmark"></i></button>
    <h2>New Message</h2>
    <p class="modal-desc">Start a conversation with someone by entering their email.</p>
    <div class="form-group">
      <label>Recipient Email</label>
      <input type="email" id="newDmEmail" placeholder="friend@example.com">
    </div>
    <button class="btn btn-primary" onclick="createDM()">Start Conversation</button>
  </div>
</div>

<div class="modal-overlay" id="createChannelModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('createChannelModal')"><i class="fas fa-xmark"></i></button>
    <h2>Create channel</h2>
    <p class="modal-desc">Add a new text channel to the server.</p>
    <div class="form-group">
      <label>Channel Name</label>
      <input type="text" id="createChannelName" placeholder="general">
    </div>
    <button class="btn btn-primary" onclick="createChannel()">Create Channel</button>
  </div>
</div>

<div class="modal-overlay" id="profileModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('profileModal')"><i class="fas fa-xmark"></i></button>
    <h2>Your Profile</h2>
    <p class="modal-desc">Customize how others see you.</p>
    <div class="pfp-upload-area" id="pfpUploadArea" onclick="document.getElementById('pfpInput').click()">
      <div class="pfp-overlay"><i class="fas fa-camera"></i></div>
      <span id="pfpPreviewLetter" style="font-size:32px;font-weight:700;"></span>
    </div>
    <input type="file" id="pfpInput" accept="image/*" style="display:none" onchange="handlePfpUpload(event)">
    <div class="form-group">
      <label>Display Name</label>
      <input type="text" id="profileDisplayName" placeholder="Your name">
    </div>
    <button class="btn btn-primary" onclick="saveProfile()">Save Changes</button>
  </div>
</div>

<div class="modal-overlay" id="settingsModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('settingsModal')"><i class="fas fa-xmark"></i></button>
    <h2>Settings</h2>
    <div class="settings-section">
      <h3>Account</h3>
      <div class="settings-row">
        <div>
          <label>Email</label><br>
          <span id="settingsEmail">-</span>
        </div>
      </div>
      <div class="settings-row">
        <div>
          <label>User ID</label><br>
          <span id="settingsUid" style="font-family:monospace">-</span>
        </div>
      </div>
    </div>
    <div class="settings-section danger-zone">
      <h3>Danger Zone</h3>
      <button class="btn btn-danger" onclick="logout()">Log Out</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="serverSettingsModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('serverSettingsModal')"><i class="fas fa-xmark"></i></button>
    <h2>Server Settings</h2>
    <div class="form-group">
      <label>Server Name</label>
      <input type="text" id="editServerName" placeholder="Server name">
    </div>
    <button class="btn btn-primary" onclick="saveServerSettings()" style="margin-bottom:16px">Save</button>
    <div class="settings-section danger-zone" style="margin-top:12px">
      <h3>Danger Zone</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn btn-danger" onclick="leaveServer()">Leave Server</button>
        <button class="btn btn-danger" onclick="deleteServer()" id="deleteServerBtn" style="display:none">Delete Server</button>
      </div>
    </div>
  </div>
</div>

<div class="image-preview" id="imagePreview" onclick="this.classList.remove('active')">
  <img id="imagePreviewImg" src="">
</div>

<div class="context-menu" id="contextMenu"></div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBJMIUucxOusoVzs4lc-QurCxjlW6Hlsuw",
  authDomain: "chat-5f0bf.firebaseapp.com",
  projectId: "chat-5f0bf",
  storageBucket: "chat-5f0bf.firebasestorage.app",
  messagingSenderId: "211425841353",
  appId: "1:211425841353:web:e1c271a340d73abd0cfd18"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ========== STATE ==========
let currentUser = null;
let currentUserData = null;
let currentView = 'home';
let currentServerId = null;
let currentChannelId = null;
let currentDmId = null;
let currentChatType = null;
let messageUnsub = null;
let channelUnsub = null;
let gifSearchTimeout = null;
let pendingImageData = null;
let serverIconData = null;
let usersCache = {};

// ========== AUTH ==========
function showLogin() {
  document.getElementById('loginPage').style.display = 'flex';
  document.getElementById('registerPage').style.display = 'none';
}
function showRegister() {
  document.getElementById('loginPage').style.display = 'none';
  document.getElementById('registerPage').style.display = 'flex';
}

async function login() {
  const email = document.getElementById('loginEmail').value.trim();
  const pw = document.getElementById('loginPassword').value;
  if (!email || !pw) return alert('Please fill in all fields.');
  try { await auth.signInWithEmailAndPassword(email, pw); }
  catch(e) { alert(e.message); }
}

async function register() {
  const name = document.getElementById('regName').value.trim();
  const email = document.getElementById('regEmail').value.trim();
  const pw = document.getElementById('regPassword').value;
  if (!name || !email || !pw) return alert('Please fill in all fields.');
  try {
    const cred = await auth.createUserWithEmailAndPassword(email, pw);
    await db.collection('users').doc(cred.user.uid).set({
      displayName: name, email, photoURL: '',
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      status: 'online'
    });
  } catch(e) { alert(e.message); }
}

function logout() {
  if (currentUser) db.collection('users').doc(currentUser.uid).update({ status: 'offline' });
  auth.signOut();
}

auth.onAuthStateChanged(async user => {
  if (user) {
    currentUser = user;
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('registerPage').style.display = 'none';
    document.getElementById('appContainer').classList.add('active');
    await loadUserData();
    loadServers();
    loadDMs();
    db.collection('users').doc(user.uid).update({ status: 'online' });
  } else {
    currentUser = null;
    currentUserData = null;
    document.getElementById('appContainer').classList.remove('active');
    document.getElementById('loginPage').style.display = 'flex';
    if (messageUnsub) messageUnsub();
    if (channelUnsub) channelUnsub();
  }
});

async function loadUserData() {
  const doc = await db.collection('users').doc(currentUser.uid).get();
  if (doc.exists) { currentUserData = doc.data(); updateUserPanel(); }
}

function updateUserPanel() {
  if (!currentUserData) return;
  const name = currentUserData.displayName || 'User';
  document.getElementById('userPanelName').textContent = name;
  document.getElementById('userPanelTag').textContent = 'Online';
  const el = document.getElementById('userPanelAvatar');
  el.innerHTML = currentUserData.photoURL
    ? `<img src="${currentUserData.photoURL}">`
    : `<span>${name.charAt(0).toUpperCase()}</span>`;
  document.getElementById('settingsEmail').textContent = currentUserData.email || '';
  document.getElementById('settingsUid').textContent = currentUser.uid;
}

// ========== USER CACHE ==========
async function getUser(uid) {
  if (usersCache[uid]) return usersCache[uid];
  try {
    const doc = await db.collection('users').doc(uid).get();
    if (doc.exists) { usersCache[uid] = doc.data(); return doc.data(); }
  } catch(e) {}
  return { displayName: 'Unknown', photoURL: '' };
}

async function getUserByEmail(email) {
  const snap = await db.collection('users').where('email', '==', email).limit(1).get();
  if (snap.empty) return null;
  return { uid: snap.docs[0].id, ...snap.docs[0].data() };
}

// ========== SERVERS ==========
function loadServers() {
  db.collection('servers').where('members', 'array-contains', currentUser.uid)
    .onSnapshot(snap => {
      const container = document.getElementById('serverIcons');
      container.innerHTML = '';
      snap.forEach(doc => {
        const data = doc.data();
        const div = document.createElement('div');
        div.className = `server-icon${currentServerId === doc.id ? ' active' : ''}`;
        div.title = data.name;
        div.dataset.id = doc.id;
        div.onclick = () => selectServer(doc.id);
        div.oncontextmenu = e => showServerContext(e, doc.id, data);
        div.innerHTML = data.iconURL
          ? `<img src="${data.iconURL}">`
          : (data.name ? data.name.charAt(0).toUpperCase() : 'S');
        container.appendChild(div);
      });
    });
}

async function createServer() {
  const name = document.getElementById('createServerName').value.trim();
  if (!name) return alert('Please enter a server name.');
  const inviteCode = Math.random().toString(36).substring(2, 8).toUpperCase();
  const ref = await db.collection('servers').add({
    name, iconURL: serverIconData || '', ownerId: currentUser.uid,
    members: [currentUser.uid], inviteCode,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  await db.collection('servers').doc(ref.id).collection('channels').add({
    name: 'general', createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  closeModal('createServerModal');
  document.getElementById('createServerName').value = '';
  serverIconData = null;
  document.getElementById('serverIconUpload').innerHTML = '<i class="fas fa-camera"></i>';
  selectServer(ref.id);
}

async function joinServer() {
  const code = document.getElementById('joinServerCode').value.trim().toUpperCase();
  if (!code) return alert('Enter an invite code.');
  const snap = await db.collection('servers').where('inviteCode', '==', code).limit(1).get();
  if (snap.empty) return alert('Invalid invite code.');
  const doc = snap.docs[0];
  if (doc.data().members.includes(currentUser.uid)) {
    closeModal('joinServerModal');
    selectServer(doc.id);
    return;
  }
  await db.collection('servers').doc(doc.id).update({
    members: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
  });
  closeModal('joinServerModal');
  document.getElementById('joinServerCode').value = '';
  selectServer(doc.id);
}

async function selectServer(serverId) {
  currentView = 'server';
  currentServerId = serverId;
  currentDmId = null;
  currentChatType = null;
  currentChannelId = null;

  // Update icons
  document.querySelectorAll('.server-icon').forEach(el => el.classList.remove('active'));
  document.querySelectorAll(`[data-id="${serverId}"]`).forEach(el => el.classList.add('active'));

  document.getElementById('dmSidebar').style.display = 'none';
  const ss = document.getElementById('serverSidebar');
  ss.style.display = 'flex';

  const doc = await db.collection('servers').doc(serverId).get();
  if (!doc.exists) return;
  document.getElementById('serverNameDisplay').textContent = doc.data().name;

  showEmptyState();
  loadChannels(serverId);
}

function loadChannels(serverId) {
  if (channelUnsub) channelUnsub();
  channelUnsub = db.collection('servers').doc(serverId).collection('channels')
    .orderBy('createdAt')
    .onSnapshot(snap => {
      const container = document.getElementById('channelList');
      container.innerHTML = '';
      const cat = document.createElement('div');
      cat.className = 'channel-category';
      cat.innerHTML = `TEXT CHANNELS <button class="add-ch" onclick="openModal('createChannelModal')"><i class="fas fa-plus"></i></button>`;
      container.appendChild(cat);

      let first = null;
      snap.forEach(doc => {
        if (!first) first = doc;
        const data = doc.data();
        const div = document.createElement('div');
        div.className = `channel-item${currentChannelId === doc.id ? ' active' : ''}`;
        div.dataset.id = doc.id;
        div.innerHTML = `<i class="fas fa-hashtag"></i><span>${data.name}</span>`;
        div.onclick = () => selectChannel(doc.id, data.name);
        container.appendChild(div);
      });

      if (!currentChannelId && first) {
        selectChannel(first.id, first.data().name);
      }
    });
}

async function createChannel() {
  if (!currentServerId) return;
  const name = document.getElementById('createChannelName').value.trim().toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
  if (!name) return alert('Enter a channel name.');
  await db.collection('servers').doc(currentServerId).collection('channels').add({
    name, createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  closeModal('createChannelModal');
  document.getElementById('createChannelName').value = '';
}

function selectChannel(channelId, channelName) {
  currentChannelId = channelId;
  currentChatType = 'channel';
  currentDmId = null;

  document.querySelectorAll('.channel-item').forEach(el => {
    el.classList.toggle('active', el.dataset.id === channelId);
  });

  document.getElementById('emptyState').style.display = 'none';
  const ac = document.getElementById('activeChat');
  ac.style.display = 'flex';
  document.getElementById('chatIcon').innerHTML = '<i class="fas fa-hashtag"></i>';
  document.getElementById('chatName').textContent = channelName;
  document.getElementById('messageInput').placeholder = `Message #${channelName}`;
  document.getElementById('membersToggle').style.display = '';

  loadMessages();
  loadMembers();
}

// ========== DMS ==========
function goHome() {
  currentView = 'home';
  currentServerId = null;
  currentChannelId = null;
  if (channelUnsub) { channelUnsub(); channelUnsub = null; }

  document.querySelectorAll('.server-icon').forEach(el => el.classList.remove('active'));
  document.querySelector('.server-icon.home-btn').classList.add('active');
  document.getElementById('dmSidebar').style.display = 'flex';
  document.getElementById('serverSidebar').style.display = 'none';

  if (!currentDmId) showEmptyState();
}

function loadDMs() {
  db.collection('dms').where('members', 'array-contains', currentUser.uid)
    .orderBy('lastMessageAt', 'desc')
    .onSnapshot(async snap => {
      const container = document.getElementById('dmList');
      container.innerHTML = '';
      if (snap.empty) {
        container.innerHTML = '<div class="section-label">No conversations yet</div>';
        return;
      }
      container.innerHTML = '<div class="section-label">Direct Messages</div>';
      for (const doc of snap.docs) {
        const data = doc.data();
        const otherUid = data.members.find(m => m !== currentUser.uid);
        const otherUser = await getUser(otherUid);
        const div = document.createElement('div');
        div.className = `dm-item${currentDmId === doc.id ? ' active' : ''}`;
        div.dataset.id = doc.id;
        div.onclick = () => selectDM(doc.id, otherUser, otherUid);
        const avatar = otherUser.photoURL
          ? `<img src="${otherUser.photoURL}">`
          : (otherUser.displayName || 'U').charAt(0).toUpperCase();
        div.innerHTML = `
          <div class="dm-avatar">${avatar}</div>
          <div class="dm-info">
            <div class="dm-name">${otherUser.displayName || 'User'}</div>
            <div class="dm-status">${data.lastMessage ? truncate(data.lastMessage, 30) : 'No messages yet'}</div>
          </div>`;
        container.appendChild(div);
      }
    });
}

function truncate(s, n) { return s.length > n ? s.substring(0, n) + 'â€¦' : s; }

async function createDM() {
  const email = document.getElementById('newDmEmail').value.trim();
  if (!email) return alert('Enter an email address.');
  if (email === currentUserData.email) return alert("You can't message yourself.");
  const target = await getUserByEmail(email);
  if (!target) return alert('User not found.');

  const existing = await db.collection('dms').where('members', 'array-contains', currentUser.uid).get();
  let existingId = null;
  existing.forEach(doc => { if (doc.data().members.includes(target.uid)) existingId = doc.id; });

  if (existingId) {
    closeModal('newDmModal');
    document.getElementById('newDmEmail').value = '';
    goHome();
    selectDM(existingId, target, target.uid);
    return;
  }

  const ref = await db.collection('dms').add({
    members: [currentUser.uid, target.uid],
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    lastMessageAt: firebase.firestore.FieldValue.serverTimestamp(),
    lastMessage: ''
  });
  closeModal('newDmModal');
  document.getElementById('newDmEmail').value = '';
  goHome();
  selectDM(ref.id, target, target.uid);
}

function selectDM(dmId, otherUser, otherUid) {
  currentDmId = dmId;
  currentChatType = 'dm';
  currentChannelId = null;
  currentServerId = null;
  currentView = 'home';

  document.querySelectorAll('.dm-item').forEach(el => {
    el.classList.toggle('active', el.dataset.id === dmId);
  });
  document.querySelectorAll('.server-icon').forEach(el => el.classList.remove('active'));
  document.querySelector('.server-icon.home-btn').classList.add('active');
  document.getElementById('dmSidebar').style.display = 'flex';
  document.getElementById('serverSidebar').style.display = 'none';

  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('activeChat').style.display = 'flex';
  document.getElementById('chatIcon').innerHTML = '<i class="fas fa-at"></i>';
  document.getElementById('chatName').textContent = otherUser.displayName || 'User';
  document.getElementById('messageInput').placeholder = `Message ${otherUser.displayName || 'User'}`;
  document.getElementById('membersToggle').style.display = 'none';
  document.getElementById('membersSidebar').classList.remove('active');

  loadMessages();
}

function filterDMs() {
  const q = document.getElementById('dmSearchInput').value.toLowerCase();
  document.querySelectorAll('.dm-item').forEach(el => {
    const name = el.querySelector('.dm-name')?.textContent?.toLowerCase() || '';
    el.style.display = name.includes(q) ? '' : 'none';
  });
}

// ========== MESSAGES ==========
function loadMessages() {
  if (messageUnsub) messageUnsub();
  const container = document.getElementById('messagesList');
  container.innerHTML = '';

  let ref;
  if (currentChatType === 'channel') {
    ref = db.collection('servers').doc(currentServerId)
      .collection('channels').doc(currentChannelId).collection('messages');
  } else if (currentChatType === 'dm') {
    ref = db.collection('dms').doc(currentDmId).collection('messages');
  } else return;

  messageUnsub = ref.orderBy('createdAt').limitToLast(100)
    .onSnapshot(async snap => {
      container.innerHTML = '';

      const welcome = document.createElement('div');
      welcome.className = 'welcome-msg';
      welcome.innerHTML = currentChatType === 'channel'
        ? `<h2>Welcome to #${document.getElementById('chatName').textContent}</h2><p>This is the start of the channel.</p>`
        : `<h2>${document.getElementById('chatName').textContent}</h2><p>This is the beginning of your conversation.</p>`;
      container.appendChild(welcome);

      let lastAuthor = null, lastTime = null;

      for (const doc of snap.docs) {
        const data = doc.data();
        const user = await getUser(data.authorId);
        const isGrouped = lastAuthor === data.authorId && lastTime &&
          data.createdAt && (data.createdAt.toMillis() - lastTime < 300000);

        const msgDiv = document.createElement('div');
        msgDiv.className = `message${isGrouped ? ' grouped' : ''}`;
        msgDiv.oncontextmenu = e => showMessageContext(e, doc.id, data);

        const time = data.createdAt ? formatTime(data.createdAt.toDate()) : '';
        const fullTime = data.createdAt ? formatFullTime(data.createdAt.toDate()) : '';

        let content = '';
        if (data.text) content += `<div class="msg-text">${linkify(escapeHtml(data.text))}</div>`;
        if (data.imageURL) content += `<img class="msg-image" src="${data.imageURL}" onclick="previewImage('${data.imageURL.replace(/'/g, "\\'")}')">`;
        if (data.gifURL) content += `<img class="msg-image" src="${data.gifURL}" onclick="previewImage('${data.gifURL.replace(/'/g, "\\'")}')">`;

        const avatarContent = user.photoURL
          ? `<img src="${user.photoURL}">`
          : (user.displayName || 'U').charAt(0).toUpperCase();

        if (isGrouped) {
          msgDiv.innerHTML = `
            <div class="msg-hover-time">${time}</div>
            <div class="msg-content">${content}</div>`;
        } else {
          msgDiv.innerHTML = `
            <div class="msg-avatar">${avatarContent}</div>
            <div class="msg-content">
              <div class="msg-header">
                <span class="msg-author">${escapeHtml(user.displayName || 'Unknown')}</span>
                <span class="msg-time">${fullTime}</span>
              </div>
              ${content}
            </div>`;
        }

        container.appendChild(msgDiv);
        lastAuthor = data.authorId;
        lastTime = data.createdAt ? data.createdAt.toMillis() : null;
      }

      const mc = document.getElementById('messagesContainer');
      mc.scrollTop = mc.scrollHeight;
    });
}

async function sendMessage() {
  const input = document.getElementById('messageInput');
  const text = input.value.trim();
  if (!text && !pendingImageData) return;

  let ref;
  if (currentChatType === 'channel') {
    ref = db.collection('servers').doc(currentServerId)
      .collection('channels').doc(currentChannelId).collection('messages');
  } else if (currentChatType === 'dm') {
    ref = db.collection('dms').doc(currentDmId).collection('messages');
  } else return;

  const msg = { authorId: currentUser.uid, text, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
  if (pendingImageData) { msg.imageURL = pendingImageData; removeUpload(); }

  await ref.add(msg);

  if (currentChatType === 'dm') {
    db.collection('dms').doc(currentDmId).update({
      lastMessage: text || 'ðŸ“· Image',
      lastMessageAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }

  input.value = '';
  autoResize(input);
}

function sendGifMessage(gifUrl) {
  let ref;
  if (currentChatType === 'channel') {
    ref = db.collection('servers').doc(currentServerId)
      .collection('channels').doc(currentChannelId).collection('messages');
  } else if (currentChatType === 'dm') {
    ref = db.collection('dms').doc(currentDmId).collection('messages');
  } else return;

  ref.add({ authorId: currentUser.uid, text: '', gifURL: gifUrl,
    createdAt: firebase.firestore.FieldValue.serverTimestamp() });

  if (currentChatType === 'dm') {
    db.collection('dms').doc(currentDmId).update({
      lastMessage: 'GIF', lastMessageAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }
  toggleGifPicker();
}

function handleKeyDown(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 200) + 'px';
}

// ========== MEMBERS ==========
async function loadMembers() {
  if (currentChatType !== 'channel' || !currentServerId) return;
  const doc = await db.collection('servers').doc(currentServerId).get();
  if (!doc.exists) return;
  const members = doc.data().members || [];
  document.getElementById('membersCount').textContent = `Members â€” ${members.length}`;
  const container = document.getElementById('membersList');
  container.innerHTML = '';
  for (const uid of members) {
    const user = await getUser(uid);
    const div = document.createElement('div');
    div.className = 'member-item';
    const avatar = user.photoURL
      ? `<img src="${user.photoURL}">`
      : (user.displayName || 'U').charAt(0).toUpperCase();
    div.innerHTML = `<div class="member-avatar">${avatar}</div><span class="member-name">${escapeHtml(user.displayName || 'Unknown')}</span>`;
    container.appendChild(div);
  }
}

function toggleMembers() {
  document.getElementById('membersSidebar').classList.toggle('active');
}

// ========== IMAGE UPLOAD ==========
function triggerImageUpload() { document.getElementById('imageUploadInput').click(); }

function handleImageUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  if (file.size > 2 * 1024 * 1024) return alert('Image must be under 2MB.');
  const reader = new FileReader();
  reader.onload = ev => {
    pendingImageData = ev.target.result;
    document.getElementById('uploadPreview').classList.add('active');
    document.getElementById('uploadPreviewImg').src = pendingImageData;
    document.getElementById('uploadPreviewName').textContent = file.name;
  };
  reader.readAsDataURL(file);
  e.target.value = '';
}

function removeUpload() {
  pendingImageData = null;
  document.getElementById('uploadPreview').classList.remove('active');
}

// ========== PFP ==========
function handlePfpUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  if (file.size > 1024 * 1024) return alert('Profile picture must be under 1MB.');
  const reader = new FileReader();
  reader.onload = ev => {
    const area = document.getElementById('pfpUploadArea');
    area.innerHTML = `<img src="${ev.target.result}"><div class="pfp-overlay"><i class="fas fa-camera"></i></div>`;
    area.dataset.url = ev.target.result;
  };
  reader.readAsDataURL(file);
  e.target.value = '';
}

async function saveProfile() {
  const name = document.getElementById('profileDisplayName').value.trim();
  const url = document.getElementById('pfpUploadArea').dataset.url || currentUserData.photoURL || '';
  const updates = { photoURL: url };
  if (name) updates.displayName = name;
  await db.collection('users').doc(currentUser.uid).update(updates);
  currentUserData = { ...currentUserData, ...updates };
  usersCache[currentUser.uid] = currentUserData;
  updateUserPanel();
  closeModal('profileModal');
}

// ========== SERVER ICON ==========
function previewServerIcon(e) {
  const file = e.target.files[0];
  if (!file) return;
  if (file.size > 1024 * 1024) return alert('Icon must be under 1MB.');
  const reader = new FileReader();
  reader.onload = ev => {
    serverIconData = ev.target.result;
    document.getElementById('serverIconUpload').innerHTML = `<img src="${serverIconData}">`;
  };
  reader.readAsDataURL(file);
  e.target.value = '';
}

// ========== GIF PICKER ==========
const TENOR_KEY = 'AIzaSyBJMIUucxOusoVzs4lc-QurCxjlW6Hlsuw';

function toggleGifPicker() {
  const p = document.getElementById('gifPicker');
  p.classList.toggle('active');
  if (p.classList.contains('active')) {
    document.getElementById('gifSearchInput').value = '';
    document.getElementById('gifSearchInput').focus();
    loadTrendingGifs();
  }
}

function searchGifsDebounced() {
  clearTimeout(gifSearchTimeout);
  gifSearchTimeout = setTimeout(searchGifs, 400);
}

async function loadTrendingGifs() {
  const grid = document.getElementById('gifGrid');
  grid.innerHTML = '<div class="gif-loading"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
  try {
    const r = await fetch(`https://tenor.googleapis.com/v2/featured?key=${TENOR_KEY}&limit=30&media_filter=tinygif`);
    renderGifs((await r.json()).results);
  } catch(e) { grid.innerHTML = '<div class="gif-loading">Failed to load</div>'; }
}

async function searchGifs() {
  const q = document.getElementById('gifSearchInput').value.trim();
  if (!q) return loadTrendingGifs();
  const grid = document.getElementById('gifGrid');
  grid.innerHTML = '<div class="gif-loading"><i class="fas fa-spinner fa-spin"></i> Searching...</div>';
  try {
    const r = await fetch(`https://tenor.googleapis.com/v2/search?q=${encodeURIComponent(q)}&key=${TENOR_KEY}&limit=30&media_filter=tinygif`);
    renderGifs((await r.json()).results);
  } catch(e) { grid.innerHTML = '<div class="gif-loading">Failed to load</div>'; }
}

function renderGifs(results) {
  const grid = document.getElementById('gifGrid');
  grid.innerHTML = '';
  if (!results?.length) { grid.innerHTML = '<div class="gif-loading">No GIFs found</div>'; return; }
  results.forEach(gif => {
    const url = gif.media_formats?.tinygif?.url || gif.media_formats?.gif?.url;
    if (!url) return;
    const img = document.createElement('img');
    img.src = url;
    img.loading = 'lazy';
    img.onclick = () => sendGifMessage(url);
    grid.appendChild(img);
  });
}

// ========== SERVER SETTINGS ==========
function openServerSettings() {
  if (!currentServerId) return;
  db.collection('servers').doc(currentServerId).get().then(doc => {
    if (!doc.exists) return;
    const d = doc.data();
    document.getElementById('editServerName').value = d.name;
    document.getElementById('deleteServerBtn').style.display = d.ownerId === currentUser.uid ? '' : 'none';
    openModal('serverSettingsModal');
  });
}

async function saveServerSettings() {
  const name = document.getElementById('editServerName').value.trim();
  if (!name) return;
  await db.collection('servers').doc(currentServerId).update({ name });
  document.getElementById('serverNameDisplay').textContent = name;
  closeModal('serverSettingsModal');
}

async function leaveServer() {
  if (!confirm('Leave this server?')) return;
  await db.collection('servers').doc(currentServerId).update({
    members: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
  });
  closeModal('serverSettingsModal');
  currentServerId = null;
  currentChannelId = null;
  goHome();
  showEmptyState();
}

async function deleteServer() {
  if (!confirm('DELETE this server? This cannot be undone.')) return;
  await db.collection('servers').doc(currentServerId).delete();
  closeModal('serverSettingsModal');
  currentServerId = null;
  currentChannelId = null;
  goHome();
  showEmptyState();
}

// ========== INVITE ==========
function updateInviteCode() {
  if (!currentServerId) return;
  db.collection('servers').doc(currentServerId).get().then(doc => {
    if (doc.exists) document.getElementById('inviteCodeDisplay').textContent = doc.data().inviteCode || 'N/A';
  });
}

function copyInvite() {
  const code = document.getElementById('inviteCodeDisplay').textContent;
  navigator.clipboard.writeText(code);
  event.target.textContent = 'Copied!';
  setTimeout(() => event.target.textContent = 'Copy', 2000);
}

// ========== CONTEXT MENUS ==========
function showServerContext(e, id, data) {
  e.preventDefault();
  const menu = document.getElementById('contextMenu');
  let html = `<div class="context-menu-item" onclick="currentServerId='${id}';openModal('inviteModal');updateInviteCode();closeContext()"><i class="fas fa-user-plus"></i> Invite People</div>`;
  if (data.ownerId === currentUser.uid)
    html += `<div class="context-menu-item" onclick="currentServerId='${id}';openServerSettings();closeContext()"><i class="fas fa-gear"></i> Server Settings</div>`;
  html += `<div class="context-menu-item danger" onclick="currentServerId='${id}';leaveServer();closeContext()"><i class="fas fa-arrow-right-from-bracket"></i> Leave Server</div>`;
  menu.innerHTML = html;
  showContextAt(menu, e);
}

function showMessageContext(e, msgId, data) {
  e.preventDefault();
  const menu = document.getElementById('contextMenu');
  let html = '';
  if (data.text) html += `<div class="context-menu-item" onclick="copyText(\`${escapeHtml(data.text).replace(/`/g,'\\`')}\`);closeContext()"><i class="fas fa-copy"></i> Copy Text</div>`;
  if (data.authorId === currentUser.uid) html += `<div class="context-menu-item danger" onclick="deleteMessage('${msgId}');closeContext()"><i class="fas fa-trash"></i> Delete Message</div>`;
  if (!html) return;
  menu.innerHTML = html;
  showContextAt(menu, e);
}

function copyText(t) { navigator.clipboard.writeText(t); }

function showContextAt(menu, e) {
  menu.style.left = Math.min(e.clientX, window.innerWidth - 200) + 'px';
  menu.style.top = Math.min(e.clientY, window.innerHeight - 150) + 'px';
  menu.classList.add('active');
}
function closeContext() { document.getElementById('contextMenu').classList.remove('active'); }
document.addEventListener('click', closeContext);

async function deleteMessage(msgId) {
  let ref;
  if (currentChatType === 'channel')
    ref = db.collection('servers').doc(currentServerId).collection('channels').doc(currentChannelId).collection('messages');
  else if (currentChatType === 'dm')
    ref = db.collection('dms').doc(currentDmId).collection('messages');
  else return;
  await ref.doc(msgId).delete();
}

// ========== MODALS ==========
function openModal(id) {
  document.getElementById(id).classList.add('active');
  if (id === 'profileModal') {
    document.getElementById('profileDisplayName').value = currentUserData?.displayName || '';
    const area = document.getElementById('pfpUploadArea');
    if (currentUserData?.photoURL) {
      area.innerHTML = `<img src="${currentUserData.photoURL}"><div class="pfp-overlay"><i class="fas fa-camera"></i></div>`;
      area.dataset.url = currentUserData.photoURL;
    } else {
      const l = (currentUserData?.displayName || 'U').charAt(0).toUpperCase();
      area.innerHTML = `<span style="font-size:32px;font-weight:700;">${l}</span><div class="pfp-overlay"><i class="fas fa-camera"></i></div>`;
      area.dataset.url = '';
    }
  }
  if (id === 'inviteModal') updateInviteCode();
}

function closeModal(id) { document.getElementById(id).classList.remove('active'); }

document.querySelectorAll('.modal-overlay').forEach(o => {
  o.addEventListener('click', e => { if (e.target === o) o.classList.remove('active'); });
});

function previewImage(url) {
  document.getElementById('imagePreviewImg').src = url;
  document.getElementById('imagePreview').classList.add('active');
}

// ========== HELPERS ==========
function showEmptyState() {
  document.getElementById('emptyState').style.display = 'flex';
  document.getElementById('activeChat').style.display = 'none';
  if (messageUnsub) { messageUnsub(); messageUnsub = null; }
}

function escapeHtml(t) {
  const d = document.createElement('div');
  d.textContent = t;
  return d.innerHTML;
}

function linkify(text) {
  return text.replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener" style="color:#999;text-decoration:underline;">$1</a>');
}

function formatTime(d) { return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); }

function formatFullTime(d) {
  const now = new Date();
  const time = formatTime(d);
  if (d.toDateString() === now.toDateString()) return `Today at ${time}`;
  const y = new Date(now); y.setDate(y.getDate() - 1);
  if (d.toDateString() === y.toDateString()) return `Yesterday at ${time}`;
  return `${d.toLocaleDateString()} ${time}`;
}

// Close pickers on escape / outside click
document.addEventListener('click', e => {
  const p = document.getElementById('gifPicker');
  if (p.classList.contains('active') && !p.contains(e.target) && !e.target.closest('.input-actions'))
    p.classList.remove('active');
});

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
    document.getElementById('gifPicker').classList.remove('active');
    document.getElementById('imagePreview').classList.remove('active');
  }
});
</script>
</body>
</html>

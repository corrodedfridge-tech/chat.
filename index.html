<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat ‚Äî Version 1</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Mono&family=Playfair+Display:wght@700&family=JetBrains+Mono&family=Outfit:wght@400;600;700&family=Sora:wght@400;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:#000;color:#fff;-webkit-font-smoothing:antialiased}
:root{
--bg0:#000;--bg1:#0a0a0a;--bg2:#111;--bg3:#1a1a1a;--bg4:#222;--bg5:#2a2a2a;
--tx1:#fff;--tx2:#a0a0a0;--tx3:#666;--tx4:#444;
--border:#1e1e1e;--accent:#fff;--danger:#ff453a;--success:#30d158;--blue:#0a84ff;--orange:#ff9f0a;--purple:#bf5af2;--pink:#ff375f;--teal:#64d2ff;--scroll:#333
}
::-webkit-scrollbar{width:6px}::-webkit-scrollbar-thumb{background:var(--scroll);border-radius:6px}::-webkit-scrollbar-track{background:transparent}

/* AUTH */
.auth-wrap{display:flex;align-items:center;justify-content:center;height:100vh;background:var(--bg0)}
.auth-box{background:var(--bg1);border:1px solid var(--border);border-radius:24px;padding:48px;width:440px;max-width:92vw;animation:fadeUp .4s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.auth-box .logo-area{text-align:center;margin-bottom:32px}
.auth-box .logo-icon{width:56px;height:56px;background:var(--accent);border-radius:16px;display:inline-flex;align-items:center;justify-content:center;font-size:24px;color:#000;margin-bottom:16px}
.auth-box h1{font-size:26px;font-weight:700;letter-spacing:-.5px;text-align:center}
.auth-box .sub{color:var(--tx2);text-align:center;font-size:14px;margin-top:6px;margin-bottom:32px}
.fg{margin-bottom:18px}
.fg label{display:block;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--tx3);margin-bottom:6px}
.fg input,.fg select,.fg textarea{width:100%;padding:11px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;color:var(--tx1);font-size:14px;font-family:inherit;outline:none;transition:border .2s}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--tx3)}
.fg select{cursor:pointer;-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%23666' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}
.fg select option{background:var(--bg2);color:var(--tx1)}
.btn{width:100%;padding:12px;border:none;border-radius:12px;font-size:14px;font-weight:600;font-family:inherit;cursor:pointer;transition:all .15s}
.btn-w{background:var(--accent);color:#000}.btn-w:hover{opacity:.9}
.btn-g{background:var(--bg3);color:var(--tx2);margin-top:10px}.btn-g:hover{background:var(--bg4);color:var(--tx1)}
.btn-d{background:var(--danger);color:#fff}
.btn-blue{background:var(--blue);color:#fff}
.btn-sm{width:auto;padding:8px 18px;font-size:13px}
.auth-sw{text-align:center;margin-top:20px;font-size:13px;color:var(--tx3)}
.auth-sw a{color:var(--tx1);cursor:pointer;font-weight:500;text-decoration:underline;text-underline-offset:2px}
.err{background:rgba(255,69,58,.1);border:1px solid rgba(255,69,58,.2);border-radius:10px;padding:10px 14px;font-size:13px;color:var(--danger);margin-bottom:16px;display:none}
.err.show{display:block}

/* APP */
.app{display:none;height:100vh;width:100vw;overflow:hidden}.app.on{display:flex}

/* NOTIF PANEL */
.notif-panel{position:fixed;top:0;right:0;width:380px;max-width:100vw;height:100vh;background:var(--bg1);border-left:1px solid var(--border);z-index:900;transform:translateX(100%);transition:transform .3s ease;display:flex;flex-direction:column}
.notif-panel.on{transform:translateX(0)}
.notif-panel .np-h{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0}
.notif-panel .np-h h3{font-size:16px;font-weight:700}
.notif-panel .np-h button{background:none;border:none;color:var(--tx3);cursor:pointer;font-size:16px;padding:4px 8px;border-radius:6px}
.notif-panel .np-h button:hover{background:var(--bg3);color:var(--tx1)}
.notif-panel .np-list{flex:1;overflow-y:auto;padding:8px}
.notif-item{display:flex;gap:12px;padding:12px;border-radius:10px;cursor:pointer;transition:background .12s;margin-bottom:4px}
.notif-item:hover{background:var(--bg3)}
.notif-item.unread{background:rgba(10,132,255,.06);border:1px solid rgba(10,132,255,.1)}
.notif-item .ni-ava{width:36px;height:36px;border-radius:50%;background:var(--bg4);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:600;overflow:hidden;flex-shrink:0}
.notif-item .ni-ava img{width:100%;height:100%;object-fit:cover}
.notif-item .ni-body{flex:1;min-width:0}
.notif-item .ni-source{font-size:11px;color:var(--tx3);margin-bottom:2px;display:flex;align-items:center;gap:4px}
.notif-item .ni-source b{color:var(--tx2)}
.notif-item .ni-sender{font-weight:600;font-size:13px;margin-bottom:1px}
.notif-item .ni-msg{font-size:12px;color:var(--tx2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.notif-item .ni-time{font-size:10px;color:var(--tx4);margin-top:4px}
.notif-empty{text-align:center;padding:60px 20px;color:var(--tx4)}
.notif-empty i{font-size:36px;margin-bottom:12px;display:block;opacity:.3}

/* SERVER BAR */
.sbar{width:72px;min-width:72px;background:var(--bg0);display:flex;flex-direction:column;align-items:center;padding:12px 0;gap:4px;overflow-y:auto;border-right:1px solid var(--border);flex-shrink:0}.sbar::-webkit-scrollbar{width:0}
.si{width:48px;height:48px;border-radius:24px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;background:var(--bg2);color:var(--tx2);font-size:18px;font-weight:600;position:relative;overflow:hidden;flex-shrink:0;user-select:none}
.si img{width:100%;height:100%;object-fit:cover}
.si:hover{border-radius:16px;background:var(--bg4)}
.si.on{border-radius:16px;background:var(--bg4);color:var(--tx1)}
.si.on::before{content:'';position:absolute;left:-14px;width:4px;height:20px;background:var(--accent);border-radius:0 4px 4px 0}
.si.home{margin-bottom:2px}.si.home.on{background:var(--accent);color:#000}.si.home.on::before{display:none}
.sdiv{width:32px;height:1px;background:var(--border);margin:4px 0;flex-shrink:0}
.si.add{background:transparent;border:2px dashed var(--tx4);color:var(--tx4);font-size:20px}
.si.add:hover{border-color:var(--success);color:var(--success)}
.si .badge{position:absolute;bottom:-1px;right:-1px;background:var(--danger);color:#fff;font-size:9px;font-weight:700;min-width:16px;height:16px;border-radius:8px;display:flex;align-items:center;justify-content:center;padding:0 4px;border:2px solid var(--bg0)}

/* SIDEBAR */
.side{width:260px;min-width:260px;background:var(--bg1);display:flex;flex-direction:column;border-right:1px solid var(--border);flex-shrink:0;height:100%}
.side-h{padding:0 16px;border-bottom:1px solid var(--border);font-weight:700;font-size:15px;display:flex;align-items:center;justify-content:space-between;height:52px;min-height:52px;flex-shrink:0}
.side-h .acts{display:flex;gap:4px}
.side-h .acts button,.ib{background:none;border:none;color:var(--tx3);cursor:pointer;font-size:15px;padding:6px;border-radius:8px;transition:all .12s}
.side-h .acts button:hover,.ib:hover{background:var(--bg3);color:var(--tx1)}
.side-c{flex:1;overflow-y:auto;padding:8px;min-height:0}
.side-tabs{display:flex;padding:8px 8px 0;gap:4px;flex-shrink:0}
.side-tab{flex:1;padding:8px;text-align:center;font-size:12px;font-weight:600;color:var(--tx3);cursor:pointer;border-radius:8px;transition:all .15s;position:relative}
.side-tab:hover{background:var(--bg3);color:var(--tx2)}.side-tab.on{background:var(--bg4);color:var(--tx1)}
.side-tab .tbadge{position:absolute;top:2px;right:2px;width:8px;height:8px;border-radius:50%;background:var(--danger);display:none}
.side-tab .tbadge.on{display:block}
.search-box{padding:8px;flex-shrink:0}
.search-box input{width:100%;padding:8px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--tx1);font-size:13px;font-family:inherit;outline:none}
.search-box input:focus{border-color:var(--tx4)}

.cat{padding:18px 8px 4px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--tx4);display:flex;align-items:center;justify-content:space-between}
.cat .add-ch{font-size:13px;opacity:0;transition:opacity .15s;background:none;border:none;color:var(--tx4);cursor:pointer}.cat:hover .add-ch{opacity:1}
.ch,.dmi,.fri{display:flex;align-items:center;padding:7px 10px;border-radius:8px;cursor:pointer;transition:all .12s;gap:10px;font-size:14px;color:var(--tx2);margin:1px 0}
.ch:hover,.dmi:hover,.fri:hover{background:var(--bg3);color:var(--tx1)}
.ch.on,.dmi.on{background:var(--bg4);color:var(--tx1)}
.ch i{font-size:16px;opacity:.4;width:20px;text-align:center}
.ava{width:32px;height:32px;border-radius:50%;background:var(--bg4);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:600;overflow:hidden;flex-shrink:0;position:relative}
.ava img{width:100%;height:100%;object-fit:cover}
.ava .sd{position:absolute;bottom:0;right:0;width:10px;height:10px;border-radius:50%;border:2px solid var(--bg1)}
.ava .sd.on{background:var(--success)}.ava .sd.off{background:var(--tx4)}
.dmi-info{flex:1;min-width:0}.dmi-name{font-weight:500;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.dmi-sub{font-size:11px;color:var(--tx4);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.fri{justify-content:space-between}.fri-left{display:flex;align-items:center;gap:10px;flex:1;min-width:0}
.fri-name{font-weight:500;font-size:13px}.fri-user{font-size:11px;color:var(--tx4)}
.fri-actions{display:flex;gap:4px}.fri-actions button{background:var(--bg3);border:1px solid var(--border);color:var(--tx2);cursor:pointer;font-size:12px;padding:5px 8px;border-radius:6px;transition:all .12s}
.fri-actions button:hover{background:var(--bg4);color:var(--tx1)}
.fri-actions .acc{color:var(--success);border-color:rgba(48,209,88,.3)}.fri-actions .acc:hover{background:rgba(48,209,88,.15)}
.fri-actions .dec{color:var(--danger);border-color:rgba(255,69,58,.3)}.fri-actions .dec:hover{background:rgba(255,69,58,.15)}
.label{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--tx4);padding:14px 10px 6px}

/* USER PANEL */
.upanel{padding:10px 12px;border-top:1px solid var(--border);display:flex;align-items:center;gap:10px;flex-shrink:0}
.upanel .ua{width:34px;height:34px;border-radius:50%;background:var(--bg4);display:flex;align-items:center;justify-content:center;font-weight:600;overflow:hidden;cursor:pointer;flex-shrink:0;font-size:13px}
.upanel .ua img{width:100%;height:100%;object-fit:cover}
.upanel .ui{flex:1;min-width:0}.upanel .un{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.upanel .ut{font-size:11px;color:var(--tx4)}
.upanel .pa{display:flex;gap:2px}.upanel .pa button{background:none;border:none;color:var(--tx4);cursor:pointer;font-size:13px;padding:5px;border-radius:6px;transition:all .12s}
.upanel .pa button:hover{background:var(--bg3);color:var(--tx1)}
.notif-dot{position:relative}.notif-dot .ndot{position:absolute;top:0;right:0;width:8px;height:8px;border-radius:50%;background:var(--danger);display:none}.notif-dot .ndot.on{display:block}

/* CHAT */
.chat{flex:1;display:flex;flex-direction:column;min-width:0;height:100vh;overflow:hidden;background:var(--bg0)}
.chat-h{padding:0 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;height:52px;min-height:52px;flex-shrink:0}
.chat-h .ci{color:var(--tx4);font-size:17px}.chat-h .cn{font-weight:700;font-size:15px}
.chat-h .ha{margin-left:auto;display:flex;gap:2px}
.chat-h .ha button{background:none;border:none;color:var(--tx3);cursor:pointer;font-size:15px;padding:6px 8px;border-radius:6px;transition:all .12s}
.chat-h .ha button:hover{background:var(--bg3);color:var(--tx1)}
.cbody{flex:1;display:flex;overflow:hidden;min-height:0}
.cmain{flex:1;display:flex;flex-direction:column;min-width:0;min-height:0;overflow:hidden}

/* MESSAGES */
.msgs{flex:1;overflow-y:auto;overflow-x:hidden;padding:16px 20px 8px;min-height:0}
.mlist{display:flex;flex-direction:column;justify-content:flex-end;min-height:100%}
.msg{display:flex;gap:12px;padding:4px 8px;border-radius:6px;transition:background .08s;position:relative}
.msg:hover{background:rgba(255,255,255,.02)}
.msg+.msg:not(.grouped){margin-top:12px}
.msg.grouped{padding-top:1px;padding-bottom:1px}
.msg .ma{width:40px;height:40px;border-radius:50%;background:var(--bg2);display:flex;align-items:center;justify-content:center;font-weight:600;font-size:14px;overflow:hidden;flex-shrink:0;cursor:pointer}
.msg .ma img{width:100%;height:100%;object-fit:cover}
.msg .mc{flex:1;min-width:0}
.msg .mh{display:flex;align-items:baseline;gap:8px;margin-bottom:1px}
.msg .mn{font-weight:600;font-size:14px;cursor:pointer}.msg .mn:hover{text-decoration:underline}
.msg .mt{font-size:11px;color:var(--tx4)}
.msg .mb{font-size:14px;line-height:1.5;color:var(--tx2);word-wrap:break-word;overflow-wrap:break-word}
.msg .mb a{color:var(--blue);text-decoration:none}.msg .mb a:hover{text-decoration:underline}
.msg .mi{max-width:400px;max-height:300px;border-radius:10px;margin-top:6px;cursor:pointer;display:block}
.msg.grouped .mh{display:none}.msg.grouped .ma{visibility:hidden}
.mht{font-size:10px;color:var(--tx4);opacity:0;min-width:40px;text-align:center;line-height:20px;flex-shrink:0}
.msg.grouped:hover .mht{opacity:1}
.msg .toolbar{position:absolute;top:-14px;right:8px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;display:none;padding:2px;gap:1px;z-index:10}
.msg:hover .toolbar{display:flex}
.toolbar button{background:none;border:none;color:var(--tx3);cursor:pointer;font-size:13px;padding:4px 7px;border-radius:4px;transition:all .1s}
.toolbar button:hover{background:var(--bg4);color:var(--tx1)}
.msg .reply-ref{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--tx3);margin-bottom:4px;cursor:pointer}
.msg .reply-ref:hover{color:var(--tx2)}
.msg .reply-ref .rr-bar{width:2px;height:14px;background:var(--tx4);border-radius:1px;flex-shrink:0;margin-right:4px}
.msg .reply-ref .rr-name{font-weight:600}
.edited-tag{font-size:11px;color:var(--tx4);margin-left:4px}
.welcome{padding:16px 8px 12px;border-bottom:1px solid var(--border);margin-bottom:12px}
.welcome h2{font-size:24px;font-weight:700;margin-bottom:4px}.welcome p{color:var(--tx4);font-size:13px}

/* REPLY/EDIT BAR */
.action-bar{display:none;padding:6px 20px 0;flex-shrink:0}
.action-bar.on{display:flex;align-items:center;gap:10px}
.action-bar .ab-info{flex:1;font-size:13px;color:var(--tx2);display:flex;align-items:center;gap:8px;background:var(--bg2);padding:8px 14px;border-radius:10px 10px 0 0;border:1px solid var(--border);border-bottom:none}
.action-bar .ab-info i{font-size:14px}
.action-bar .ab-info .ab-label{font-weight:600;color:var(--tx1)}
.action-bar .ab-info .ab-text{color:var(--tx3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1}
.action-bar .ab-close{background:none;border:none;color:var(--tx3);cursor:pointer;font-size:14px;padding:6px}
.action-bar.on~.input-area .ibox{border-top:none;border-radius:0 0 12px 12px}

/* INPUT */
.input-area{padding:0 20px 16px;flex-shrink:0;position:relative}
.upload-prev{display:none;padding:10px 12px;background:var(--bg2);border:1px solid var(--border);border-bottom:none;border-radius:12px 12px 0 0;align-items:center;gap:12px}
.upload-prev.on{display:flex}
.upload-prev img{width:60px;height:60px;object-fit:cover;border-radius:8px}
.upload-prev .uinfo{flex:1;font-size:13px;color:var(--tx2)}
.upload-prev .urem{background:none;border:none;color:var(--danger);cursor:pointer;font-size:15px;padding:4px}
.upload-prev.on+.ibox{border-radius:0 0 12px 12px;border-top:none}
.ibox{background:var(--bg2);border:1px solid var(--border);border-radius:12px;display:flex;align-items:flex-end;padding:4px;transition:border .2s}
.ibox:focus-within{border-color:var(--tx4)}
.iacts{display:flex;gap:1px;padding:4px 2px}
.iacts button{background:none;border:none;color:var(--tx4);cursor:pointer;font-size:17px;padding:6px;border-radius:8px;transition:all .12s}
.iacts button:hover{background:var(--bg3);color:var(--tx1)}
.ifield{flex:1;background:none;border:none;color:var(--tx1);font-size:14px;font-family:inherit;padding:9px 8px;outline:none;resize:none;max-height:180px;line-height:1.4}
.ifield::placeholder{color:var(--tx4)}
.sbtn{background:none;border:none;color:var(--tx4);cursor:pointer;font-size:17px;padding:6px 10px;margin:4px;border-radius:8px;transition:all .12s}
.sbtn:hover{background:var(--accent);color:#000}

/* GIF */
.gifp{display:none;position:absolute;bottom:68px;left:0;width:400px;height:420px;background:var(--bg2);border:1px solid var(--border);border-radius:14px;z-index:500;flex-direction:column;overflow:hidden}
.gifp.on{display:flex}
.gifp-h{padding:10px;border-bottom:1px solid var(--border);flex-shrink:0}
.gifp-h input{width:100%;padding:9px 12px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--tx1);font-size:13px;font-family:inherit;outline:none}
.gifg{flex:1;overflow-y:auto;padding:8px;display:grid;grid-template-columns:1fr 1fr;gap:6px;align-content:start;min-height:0}
.gifg img{width:100%;border-radius:6px;cursor:pointer;transition:transform .1s;display:block}.gifg img:hover{transform:scale(.97)}
.gifg .gl{grid-column:1/-1;text-align:center;padding:40px;color:var(--tx4);font-size:13px}

/* MEMBERS */
.memside{width:240px;min-width:240px;background:var(--bg1);border-left:1px solid var(--border);padding:12px 8px;overflow-y:auto;display:none;flex-shrink:0}
.memside.on{display:block}
.memcat{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--tx4);padding:14px 8px 4px}
.memi{display:flex;align-items:center;gap:10px;padding:5px 8px;border-radius:8px;cursor:pointer;transition:background .12s}
.memi:hover{background:var(--bg3)}
.memn{font-size:13px;font-weight:500;color:var(--tx2)}

/* EMPTY */
.empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--tx4);text-align:center;padding:40px}
.empty i{font-size:48px;margin-bottom:16px;opacity:.2}.empty h3{font-size:18px;margin-bottom:6px;color:var(--tx2)}.empty p{font-size:13px;max-width:300px}

/* MODAL */
.mdl-o{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(12px);z-index:1000;align-items:center;justify-content:center}
.mdl-o.on{display:flex}
.mdl{background:var(--bg2);border:1px solid var(--border);border-radius:20px;padding:32px;width:460px;max-width:92vw;max-height:85vh;overflow-y:auto;position:relative;animation:fadeUp .25s ease}
.mdl h2{font-size:22px;font-weight:700;margin-bottom:6px}.mdl .md{color:var(--tx2);font-size:13px;margin-bottom:24px}
.mdl-x{position:absolute;top:16px;right:16px;background:var(--bg3);border:none;color:var(--tx3);font-size:16px;cursor:pointer;padding:6px 8px;border-radius:8px}
.mdl-x:hover{background:var(--bg4);color:var(--tx1)}
.pfp-up{width:96px;height:96px;border-radius:50%;border:2px dashed var(--tx4);display:flex;align-items:center;justify-content:center;cursor:pointer;margin:0 auto 20px;overflow:hidden;transition:all .2s;position:relative}
.pfp-up:hover{border-color:var(--accent)}.pfp-up img{width:100%;height:100%;object-fit:cover}
.pfp-up .pfp-ov{position:absolute;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .2s;font-size:18px}
.pfp-up:hover .pfp-ov{opacity:1}
.si-up{width:80px;height:80px;border-radius:16px;border:2px dashed var(--tx4);display:flex;align-items:center;justify-content:center;cursor:pointer;margin:0 auto 20px;overflow:hidden;transition:all .2s;font-size:24px;color:var(--tx4)}
.si-up:hover{border-color:var(--accent);color:var(--accent)}.si-up img{width:100%;height:100%;object-fit:cover}
.inv-code{background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:12px 16px;font-family:'JetBrains Mono',monospace;font-size:15px;color:var(--accent);display:flex;align-items:center;justify-content:space-between;margin:12px 0;letter-spacing:1px}
.inv-code button{background:var(--accent);color:#000;border:none;padding:6px 14px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit}
.color-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:6px;margin:8px 0 16px}
.color-opt{width:100%;aspect-ratio:1;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all .15s}
.color-opt:hover{transform:scale(1.15)}.color-opt.on{border-color:var(--tx1);transform:scale(1.15)}
.font-preview{padding:12px;background:var(--bg3);border-radius:8px;margin:8px 0 16px;font-size:16px;font-weight:600;text-align:center}
.ctx{display:none;position:fixed;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:5px;z-index:3000;min-width:180px;box-shadow:0 8px 32px rgba(0,0,0,.5)}
.ctx.on{display:block}
.ctx-i{padding:7px 12px;font-size:13px;cursor:pointer;border-radius:6px;display:flex;align-items:center;gap:10px;transition:background .08s;color:var(--tx2)}
.ctx-i:hover{background:var(--bg3);color:var(--tx1)}
.ctx-i.dg{color:var(--danger)}.ctx-i.dg:hover{background:rgba(255,69,58,.1)}
.imgpv{display:none;position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:2000;align-items:center;justify-content:center;cursor:zoom-out}
.imgpv.on{display:flex}.imgpv img{max-width:90vw;max-height:90vh;border-radius:8px}
.dzone{border:1px solid rgba(255,69,58,.2);border-radius:12px;padding:16px;margin-top:16px}
.dzone h3{color:var(--danger);font-size:14px;font-weight:600;margin-bottom:12px}

/* INLINE TOAST */
.toast-c{position:fixed;top:20px;right:20px;z-index:5000;display:flex;flex-direction:column;gap:8px;pointer-events:none}
.toast{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:14px 16px;display:flex;gap:12px;font-size:13px;animation:slideIn .3s ease;box-shadow:0 8px 32px rgba(0,0,0,.5);max-width:380px;pointer-events:auto;cursor:pointer}
@keyframes slideIn{from{opacity:0;transform:translateX(40px)}to{opacity:1;transform:translateX(0)}}
.toast .t-ava{width:36px;height:36px;border-radius:50%;background:var(--bg4);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:600;overflow:hidden;flex-shrink:0}
.toast .t-ava img{width:100%;height:100%;object-fit:cover}
.toast .t-body{flex:1;min-width:0}
.toast .t-src{font-size:11px;color:var(--tx3);margin-bottom:2px}.toast .t-src b{color:var(--tx2)}
.toast .t-name{font-weight:600;font-size:13px;margin-bottom:1px}
.toast .t-msg{color:var(--tx2);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.toast .t-x{background:none;border:none;color:var(--tx4);cursor:pointer;font-size:14px;padding:4px;flex-shrink:0;align-self:flex-start;pointer-events:auto}

.inv-friend{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:8px;margin:2px 0}
.inv-friend:hover{background:var(--bg3)}
.inv-friend .if-info{flex:1;min-width:0}
.inv-friend .if-name{font-size:13px;font-weight:500}.inv-friend .if-user{font-size:11px;color:var(--tx4)}
.inv-btn{background:var(--blue);color:#fff;border:none;padding:6px 14px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;white-space:nowrap}
.inv-btn:hover{opacity:.85}
.inv-btn:disabled{opacity:.4;cursor:default}
.version-tag{position:fixed;bottom:8px;left:50%;transform:translateX(-50%);font-size:10px;color:var(--tx4);opacity:.3;pointer-events:none;z-index:1}
</style>
</head>
<body>

<div class="toast-c" id="toasts"></div>
<div class="version-tag">Chat v1.0</div>

<!-- LOGIN -->
<div class="auth-wrap" id="loginPage">
<div class="auth-box"><div class="logo-area"><div class="logo-icon"><i class="fas fa-bolt"></i></div></div><h1>Welcome back</h1><p class="sub">Sign in to Chat</p><div class="err" id="loginErr"></div>
<div class="fg"><label>Email</label><input type="email" id="lEmail" placeholder="name@example.com"></div>
<div class="fg"><label>Password</label><input type="password" id="lPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
<button class="btn btn-w" onclick="doLogin()">Sign In</button>
<div class="auth-sw">Need an account? <a onclick="showP('regPage')">Create one</a></div></div></div>

<!-- REGISTER -->
<div class="auth-wrap" id="regPage" style="display:none">
<div class="auth-box"><div class="logo-area"><div class="logo-icon"><i class="fas fa-bolt"></i></div></div><h1>Create account</h1><p class="sub">Pick a unique username</p><div class="err" id="regErr"></div>
<div class="fg"><label>Display Name</label><input type="text" id="rName" placeholder="John"></div>
<div class="fg"><label>Username</label><input type="text" id="rUser" placeholder="john_doe"></div>
<div class="fg"><label>Email</label><input type="email" id="rEmail" placeholder="name@example.com"></div>
<div class="fg"><label>Password</label><input type="password" id="rPass" placeholder="Min 6 characters"></div>
<button class="btn btn-w" onclick="doReg()">Create Account</button>
<div class="auth-sw">Have an account? <a onclick="showP('loginPage')">Sign in</a></div></div></div>

<!-- APP -->
<div class="app" id="app">

<!-- NOTIF PANEL -->
<div class="notif-panel" id="notifPanel">
<div class="np-h"><h3>üîî Notifications</h3><div><button onclick="clearAllNotifs()" title="Clear all"><i class="fas fa-check-double"></i></button><button onclick="toggleNotifPanel()" title="Close"><i class="fas fa-xmark"></i></button></div></div>
<div class="np-list" id="notifList"><div class="notif-empty"><i class="fas fa-bell-slash"></i>No notifications yet</div></div>
</div>

<!-- SERVER BAR -->
<div class="sbar">
<div class="si home on" onclick="goHome()" title="Home"><i class="fas fa-bolt"></i></div>
<div class="sdiv"></div>
<div id="sIcons"></div>
<div class="si add" onclick="openM('mCreateServ')" title="Create"><i class="fas fa-plus"></i></div>
<div class="si add" onclick="openM('mJoinServ')" title="Join" style="font-size:16px"><i class="fas fa-arrow-right-to-bracket"></i></div>
</div>

<!-- SIDEBAR -->
<div class="side">
<div id="homeSide" style="display:flex;flex-direction:column;flex:1;min-height:0;overflow:hidden">
<div class="side-h"><span>Chat</span><div class="acts"><button onclick="openM('mAddFriend')" title="Add Friend"><i class="fas fa-user-plus"></i></button></div></div>
<div class="side-tabs">
<div class="side-tab on" data-tab="friends" onclick="sTab('friends')">Friends</div>
<div class="side-tab" data-tab="dms" onclick="sTab('dms')">Messages</div>
<div class="side-tab" data-tab="requests" onclick="sTab('requests')"><span>Requests</span><div class="tbadge" id="reqBadge"></div></div>
</div>
<div class="search-box"><input placeholder="Search..." id="homeSearch" oninput="filterH()"></div>
<div class="side-c" id="homeC"></div>
</div>
<div id="servSide" style="display:none;flex-direction:column;flex:1;min-height:0;overflow:hidden">
<div class="side-h"><span id="servName">Server</span><div class="acts"><button onclick="openServSet()"><i class="fas fa-gear"></i></button><button onclick="openM('mInvite')"><i class="fas fa-user-plus"></i></button></div></div>
<div class="side-c" id="chList"></div>
</div>
<div class="upanel">
<div class="ua" id="uAva" onclick="openM('mProfile')"><span id="uLet"></span></div>
<div class="ui"><div class="un" id="uName">User</div><div class="ut" id="uTag">@user</div></div>
<div class="pa">
<div class="notif-dot"><button onclick="toggleNotifPanel()"><i class="fas fa-bell"></i></button><div class="ndot" id="notifDot"></div></div>
<button onclick="openM('mSettings')"><i class="fas fa-gear"></i></button>
<button onclick="doLogout()"><i class="fas fa-arrow-right-from-bracket"></i></button>
</div>
</div>
</div>

<!-- CHAT -->
<div class="chat">
<div class="empty" id="emptyState"><i class="fas fa-bolt"></i><h3>Welcome to Chat</h3><p>Select a conversation or server channel</p></div>
<div id="activeChat" style="display:none;flex:1;flex-direction:column;overflow:hidden">
<div class="chat-h"><span class="ci" id="chatIcon"><i class="fas fa-hashtag"></i></span><span class="cn" id="chatName">general</span>
<div class="ha"><button onclick="toggleMem()" id="memBtn"><i class="fas fa-users"></i></button></div></div>
<div class="cbody"><div class="cmain">
<div class="msgs" id="msgsC"><div class="mlist" id="msgsL"></div></div>
<div class="action-bar" id="actionBar"><div class="ab-info"><i id="abIcon" class="fas fa-reply"></i><span class="ab-label" id="abLabel">Replying to</span><span class="ab-text" id="abText"></span></div><button class="ab-close" onclick="cancelAction()"><i class="fas fa-xmark"></i></button></div>
<div class="input-area">
<div class="upload-prev" id="upPrev"><img id="upImg"><div class="uinfo" id="upName">file</div><button class="urem" onclick="rmUp()"><i class="fas fa-xmark"></i></button></div>
<div class="ibox"><div class="iacts"><button onclick="$('fileIn').click()"><i class="fas fa-circle-plus"></i></button><button onclick="togGif()"><i class="fas fa-fire"></i></button></div>
<textarea class="ifield" id="msgIn" placeholder="Message" rows="1" onkeydown="onKey(event)" oninput="autoH(this)"></textarea>
<button class="sbtn" onclick="doSend()"><i class="fas fa-paper-plane"></i></button></div>
<input type="file" id="fileIn" accept="image/*" style="display:none" onchange="onFile(event)">
<div class="gifp" id="gifP"><div class="gifp-h"><input placeholder="Search Tenor..." id="gifIn" oninput="gifDeb()"></div><div class="gifg" id="gifG"><div class="gl">Type to search GIFs</div></div></div>
</div></div>
<div class="memside" id="memSide"><div class="memcat" id="memCt">Members ‚Äî 0</div><div id="memL"></div></div>
</div></div></div></div>

<!-- MODALS -->
<div class="mdl-o" id="mCreateServ"><div class="mdl"><button class="mdl-x" onclick="closeM('mCreateServ')"><i class="fas fa-xmark"></i></button><h2>Create a server</h2><p class="md">Give your server a personality.</p><div class="si-up" id="sIconUp" onclick="$('sIconIn').click()"><i class="fas fa-camera"></i></div><input type="file" id="sIconIn" accept="image/*" style="display:none" onchange="prevSIcon(event)"><div class="fg"><label>Server Name</label><input type="text" id="newServName" placeholder="My Server"></div><button class="btn btn-w" onclick="createServ()">Create</button></div></div>
<div class="mdl-o" id="mJoinServ"><div class="mdl"><button class="mdl-x" onclick="closeM('mJoinServ')"><i class="fas fa-xmark"></i></button><h2>Join a server</h2><p class="md">Got an invite code?</p><div class="fg"><label>Invite Code</label><input type="text" id="joinCode" placeholder="ABC123"></div><button class="btn btn-w" onclick="joinServ()">Join</button></div></div>
<div class="mdl-o" id="mInvite"><div class="mdl"><button class="mdl-x" onclick="closeM('mInvite')"><i class="fas fa-xmark"></i></button><h2>Invite people</h2><p class="md">Share the code or invite friends directly via DM.</p><div class="inv-code"><span id="invCode">...</span><button onclick="copyInv()">Copy</button></div><div class="label">Invite Friends Directly</div><div id="invFriends"></div></div></div>
<div class="mdl-o" id="mAddFriend"><div class="mdl"><button class="mdl-x" onclick="closeM('mAddFriend')"><i class="fas fa-xmark"></i></button><h2>Add Friend</h2><p class="md">Enter their username.</p><div class="fg"><label>Username</label><input type="text" id="addFrUser" placeholder="john_doe"></div><button class="btn btn-w" onclick="sendFR()">Send Request</button></div></div>
<div class="mdl-o" id="mNewDm"><div class="mdl"><button class="mdl-x" onclick="closeM('mNewDm')"><i class="fas fa-xmark"></i></button><h2>New Message</h2><p class="md">DM a friend by username.</p><div class="fg"><label>Username</label><input type="text" id="newDmUser" placeholder="john_doe"></div><button class="btn btn-w" onclick="createDM()">Start Chat</button></div></div>
<div class="mdl-o" id="mCreateCh"><div class="mdl"><button class="mdl-x" onclick="closeM('mCreateCh')"><i class="fas fa-xmark"></i></button><h2>Create channel</h2><div class="fg"><label>Channel Name</label><input type="text" id="newChName" placeholder="general"></div><button class="btn btn-w" onclick="createCh()">Create</button></div></div>
<div class="mdl-o" id="mProfile"><div class="mdl"><button class="mdl-x" onclick="closeM('mProfile')"><i class="fas fa-xmark"></i></button><h2>Your Profile</h2><p class="md">Customize your look.</p>
<div class="pfp-up" id="pfpArea" onclick="$('pfpIn').click()"><div class="pfp-ov"><i class="fas fa-camera"></i></div><span id="pfpLet" style="font-size:32px;font-weight:700"></span></div><input type="file" id="pfpIn" accept="image/*" style="display:none" onchange="onPfp(event)">
<div class="fg"><label>Display Name</label><input type="text" id="profName"></div>
<div class="fg"><label>Username</label><input type="text" id="profUser" disabled style="opacity:.5"></div>
<div class="fg"><label>Bio</label><input type="text" id="profBio" placeholder="About you..." maxlength="150"></div>
<div class="fg"><label>Name Color</label><div class="color-grid" id="colorGrid"></div></div>
<div class="fg"><label>Name Font</label><select id="fontSel" onchange="updFontPrev()"><option value="Inter">Inter</option><option value="Outfit">Outfit</option><option value="Sora">Sora</option><option value="Space Mono">Space Mono</option><option value="JetBrains Mono">JetBrains Mono</option><option value="Playfair Display">Playfair Display</option></select><div class="font-preview" id="fontPrev">Your Name</div></div>
<button class="btn btn-w" onclick="saveProf()">Save</button></div></div>
<div class="mdl-o" id="mSettings"><div class="mdl"><button class="mdl-x" onclick="closeM('mSettings')"><i class="fas fa-xmark"></i></button><h2>Settings</h2>
<div style="margin:16px 0"><label style="font-size:12px;color:var(--tx3)">EMAIL</label><p style="font-size:14px;margin-top:4px" id="setEmail">-</p></div>
<div style="margin:16px 0"><label style="font-size:12px;color:var(--tx3)">USERNAME</label><p style="font-size:14px;margin-top:4px" id="setUser">-</p></div>
<div style="margin:16px 0"><label style="font-size:12px;color:var(--tx3)">USER ID</label><p style="font-size:13px;font-family:monospace;margin-top:4px;color:var(--tx3)" id="setUid">-</p></div>
<div class="dzone"><h3>Danger Zone</h3><button class="btn btn-d btn-sm" onclick="doLogout()">Log Out</button></div></div></div>
<div class="mdl-o" id="mServSet"><div class="mdl"><button class="mdl-x" onclick="closeM('mServSet')"><i class="fas fa-xmark"></i></button><h2>Server Settings</h2><div class="fg"><label>Server Name</label><input type="text" id="editServName"></div><button class="btn btn-w" onclick="saveServSet()" style="margin-bottom:16px">Save</button><div class="dzone"><h3>Danger Zone</h3><div style="display:flex;gap:8px;flex-wrap:wrap"><button class="btn btn-d btn-sm" onclick="leaveServ()">Leave</button><button class="btn btn-d btn-sm" id="delServBtn" onclick="delServ()" style="display:none">Delete</button></div></div></div></div>
<div class="mdl-o" id="mUserCard"><div class="mdl" style="width:360px"><button class="mdl-x" onclick="closeM('mUserCard')"><i class="fas fa-xmark"></i></button>
<div style="text-align:center"><div id="ucAva" style="width:80px;height:80px;border-radius:50%;margin:0 auto 12px;overflow:hidden;background:var(--bg4);display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:700"></div><div id="ucName" style="font-size:18px;font-weight:700;margin-bottom:2px"></div><div id="ucUser" style="font-size:13px;color:var(--tx3);margin-bottom:8px"></div><div id="ucBio" style="font-size:13px;color:var(--tx2);margin-bottom:16px;padding:0 20px"></div><div id="ucActs" style="display:flex;gap:8px;justify-content:center"></div></div></div></div>
<div class="imgpv" id="imgPv" onclick="this.classList.remove('on')"><img id="imgPvSrc"></div>
<div class="ctx" id="ctx"></div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script>
firebase.initializeApp({apiKey:"AIzaSyBJMIUucxOusoVzs4lc-QurCxjlW6Hlsuw",authDomain:"chat-5f0bf.firebaseapp.com",projectId:"chat-5f0bf",storageBucket:"chat-5f0bf.firebasestorage.app",messagingSenderId:"211425841353",appId:"1:211425841353:web:e1c271a340d73abd0cfd18"});
const auth=firebase.auth(),db=firebase.firestore(),TS=firebase.firestore.FieldValue.serverTimestamp,AU=firebase.firestore.FieldValue.arrayUnion,AR=firebase.firestore.FieldValue.arrayRemove;
const $=id=>document.getElementById(id);
const COLORS=['#ffffff','#ff453a','#ff9f0a','#ffd60a','#30d158','#64d2ff','#0a84ff','#bf5af2','#ff375f','#ac8e68','#ff6482','#5e5ce6','#66d4cf','#f0a0c0','#a8c8a0','#d4a0f0'];

let me=null,md=null,cv='home',cSrv=null,cCh=null,cDm=null,cType=null;
let unsubs={msg:null,ch:null,fr:null,req:null,dm:null,notif:null};
let gifTO=null,pendImg=null,sIconData=null,uCache={},hTab='friends';
let firstLoad=true,replyData=null,editData=null,selColor='#ffffff',selFont='Inter';
let allNotifs=[];

// PAGES
function showP(id){document.querySelectorAll('.auth-wrap').forEach(e=>e.style.display='none');$(id).style.display='flex'}

// AUTH
async function doLogin(){
  const e=$('lEmail').value.trim(),p=$('lPass').value;
  if(!e||!p)return sErr('loginErr','Fill in all fields.');
  try{await auth.signInWithEmailAndPassword(e,p)}catch(er){sErr('loginErr',er.message)}}
async function doReg(){
  const n=$('rName').value.trim(),u=$('rUser').value.trim().toLowerCase().replace(/\s/g,''),e=$('rEmail').value.trim(),p=$('rPass').value;
  if(!n||!u||!e||!p)return sErr('regErr','Fill in all fields.');
  if(!/^[a-z0-9_]{3,20}$/.test(u))return sErr('regErr','Username: 3-20 chars, a-z 0-9 _ only.');
  const ex=await db.collection('users').where('username','==',u).limit(1).get();
  if(!ex.empty)return sErr('regErr','Username taken.');
  try{const cred=await auth.createUserWithEmailAndPassword(e,p);
  await db.collection('users').doc(cred.user.uid).set({displayName:n,username:u,email:e,photoURL:'',nameColor:'#ffffff',nameFont:'Inter',bio:'',createdAt:TS(),status:'online',friends:[]})}catch(er){sErr('regErr',er.message)}}
function doLogout(){if(me)db.collection('users').doc(me.uid).update({status:'offline'});auth.signOut()}
function sErr(id,m){const el=$(id);el.textContent=m;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),5000)}

auth.onAuthStateChanged(async u=>{
  if(u){me=u;document.querySelectorAll('.auth-wrap').forEach(e=>e.style.display='none');$('app').classList.add('on');
  await loadMe();loadServs();listenFR();listenReqs();listenDMs();startNotifPolling();
  db.collection('users').doc(u.uid).update({status:'online'});sTab('friends')}
  else{me=null;md=null;$('app').classList.remove('on');$('loginPage').style.display='flex';
  Object.values(unsubs).forEach(fn=>fn&&fn());stopNotifPolling()}});

async function loadMe(){const d=await db.collection('users').doc(me.uid).get();if(d.exists){md=d.data();uCache[me.uid]=md;updPanel()}}
function updPanel(){if(!md)return;const n=md.displayName||'User';$('uName').textContent=n;$('uTag').textContent='@'+(md.username||'user');
$('uAva').innerHTML=md.photoURL?`<img src="${md.photoURL}">`:`<span>${n[0].toUpperCase()}</span>`;
$('setEmail').textContent=md.email||'';$('setUid').textContent=me.uid;$('setUser').textContent='@'+(md.username||'')}

// USER CACHE
async function gU(uid){if(uCache[uid])return uCache[uid];try{const d=await db.collection('users').doc(uid).get();if(d.exists){uCache[uid]=d.data();return d.data()}}catch(e){}return{displayName:'Unknown',username:'?',photoURL:'',nameColor:'#fff',nameFont:'Inter',bio:''}}
async function gUn(username){const s=await db.collection('users').where('username','==',username.toLowerCase().trim()).limit(1).get();if(s.empty)return null;return{uid:s.docs[0].id,...s.docs[0].data()}}

// ========== NOTIFICATIONS - POLLING APPROACH ==========
let notifInterval=null;
function startNotifPolling(){fetchNotifs();notifInterval=setInterval(fetchNotifs,5000)}
function stopNotifPolling(){if(notifInterval)clearInterval(notifInterval)}

async function fetchNotifs(){
  if(!me)return;
  try{
    const snap=await db.collection('notifications').where('userId','==',me.uid).orderBy('createdAt','desc').limit(50).get();
    const newNotifs=[];const unreadIds=[];
    snap.forEach(doc=>{const d=doc.data();d._id=doc.id;newNotifs.push(d);if(!d.read)unreadIds.push(doc.id)});
    // Check for NEW unread ones we haven't seen
    const prevIds=allNotifs.filter(n=>!n.read).map(n=>n._id);
    const brandNew=newNotifs.filter(n=>!n.read&&!prevIds.includes(n._id));
    brandNew.forEach(n=>{
      if(n.fromId===me.uid)return;// Don't notify yourself
      if(n.type==='channel'&&n.channelId===cCh&&n.serverId===cSrv)return;
      if(n.type==='dm'&&n.dmId===cDm)return;
      showToast(n)});
    allNotifs=newNotifs;
    $('notifDot').classList.toggle('on',unreadIds.length>0);
    renderNotifPanel()
  }catch(e){console.log('Notif fetch error:',e)}}

function renderNotifPanel(){
  const c=$('notifList');
  if(!allNotifs.length){c.innerHTML='<div class="notif-empty"><i class="fas fa-bell-slash"></i>No notifications yet</div>';return}
  let html='';
  allNotifs.forEach(n=>{
    const avHtml=n.fromPhoto?`<img src="${n.fromPhoto}">`:(n.fromName||'U')[0].toUpperCase();
    let src='';
    if(n.type==='channel')src=`<b>${esc(n.serverName||'Server')}</b> #${esc(n.channelName||'')}`;
    else if(n.type==='dm')src='<b>Direct Message</b>';
    else if(n.type==='friend_request')src='<b>Friend Request</b>';
    else if(n.type==='friend_accept')src='<b>Friends</b>';
    else src=`<b>${n.type||'Notification'}</b>`;
    const timeStr=n.createdAt?timeAgo(n.createdAt.toDate()):'';
    html+=`<div class="notif-item${n.read?'':' unread'}" onclick="onNotifClick('${n._id}','${n.type}','${n.dmId||''}','${n.serverId||''}','${n.channelId||''}')">
      <div class="ni-ava">${avHtml}</div><div class="ni-body"><div class="ni-source">${src}</div><div class="ni-sender">${esc(n.fromName||'User')}</div><div class="ni-msg">${esc(n.message||'')}</div><div class="ni-time">${timeStr}</div></div></div>`});
  c.innerHTML=html}

function onNotifClick(nId,type,dmId,servId,chId){
  markNRead(nId);
  if(type==='dm'&&dmId){goHome();sTab('dms');
    db.collection('dms').doc(dmId).get().then(doc=>{if(doc.exists){const other=doc.data().members.find(m=>m!==me.uid);setTimeout(()=>selDM(dmId,other),200)}})}
  else if(type==='channel'&&servId){selServ(servId);setTimeout(()=>{if(chId)selCh2(chId)},500)}
  else if(type==='friend_request'||type==='friend_accept'){goHome();sTab('requests')}
  closeNotifPanel()}

function markNRead(id){db.collection('notifications').doc(id).update({read:true}).catch(()=>{})}
async function clearAllNotifs(){for(const n of allNotifs){if(!n.read)await markNRead(n._id)};toast('Cleared!');fetchNotifs()}

function toggleNotifPanel(){$('notifPanel').classList.toggle('on')}
function closeNotifPanel(){$('notifPanel').classList.remove('on')}

function showToast(n){
  const c=$('toasts');const t=document.createElement('div');t.className='toast';
  const avHtml=n.fromPhoto?`<img src="${n.fromPhoto}">`:(n.fromName||'U')[0].toUpperCase();
  let src='';
  if(n.type==='channel')src=`<b>${esc(n.serverName||'Server')}</b> ‚Ä∫ #${esc(n.channelName||'')}`;
  else if(n.type==='dm')src='<b>Direct Message</b>';
  else if(n.type==='friend_request')src='<b>üëã Friend Request</b>';
  else if(n.type==='friend_accept')src='<b>ü§ù Accepted</b>';
  t.innerHTML=`<div class="t-ava">${avHtml}</div><div class="t-body"><div class="t-src">${src}</div><div class="t-name">${esc(n.fromName||'User')}</div><div class="t-msg">${esc(n.message||'')}</div></div><button class="t-x" onclick="event.stopPropagation();this.parentElement.remove()"><i class="fas fa-xmark"></i></button>`;
  t.onclick=()=>{onNotifClick(n._id,n.type,n.dmId||'',n.serverId||'',n.channelId||'');t.remove()};
  c.appendChild(t);setTimeout(()=>{if(t.parentElement)t.remove()},6000)}

function timeAgo(d){const s=Math.floor((Date.now()-d.getTime())/1000);if(s<60)return'Just now';if(s<3600)return Math.floor(s/60)+'m ago';if(s<86400)return Math.floor(s/3600)+'h ago';return Math.floor(s/86400)+'d ago'}

// ========== FRIENDS ==========
function listenFR(){unsubs.fr=db.collection('users').doc(me.uid).onSnapshot(doc=>{if(!doc.exists)return;md=doc.data();uCache[me.uid]=md;if(hTab==='friends')renderFr()})}
async function renderFr(){const c=$('homeC');const fr=md.friends||[];
if(!fr.length){c.innerHTML='<div class="empty" style="padding:40px"><i class="fas fa-user-group" style="font-size:32px;opacity:.2;margin-bottom:12px"></i><h3 style="font-size:15px">No friends yet</h3></div>';return}
let h='<div class="label">Friends ‚Äî '+fr.length+'</div>';
for(const uid of fr){const u=await gU(uid);const sc=u.status==='online'?'on':'off';
h+=`<div class="fri" onclick="startDmW('${uid}')"><div class="fri-left"><div class="ava">${avI(u)}<div class="sd ${sc}"></div></div><div><div class="fri-name">${esc(u.displayName||'User')}</div><div class="fri-user">@${esc(u.username||'?')}</div></div></div><div class="fri-actions"><button onclick="event.stopPropagation();startDmW('${uid}')"><i class="fas fa-comment"></i></button><button class="dec" onclick="event.stopPropagation();rmFriend('${uid}')"><i class="fas fa-user-minus"></i></button></div></div>`}
c.innerHTML=h}

function listenReqs(){unsubs.req=db.collection('friendRequests').where('to','==',me.uid).where('status','==','pending').onSnapshot(snap=>{
$('reqBadge').classList.toggle('on',snap.size>0);if(hTab==='requests')renderReqs(snap)})}
async function renderReqs(snap){const c=$('homeC');let h='';
const inc=snap&&!snap.empty?snap.docs:[];
const sent=await db.collection('friendRequests').where('from','==',me.uid).where('status','==','pending').get();
if(!inc.length&&sent.empty){c.innerHTML='<div class="empty" style="padding:40px"><i class="fas fa-inbox" style="font-size:32px;opacity:.2;margin-bottom:12px"></i><h3 style="font-size:15px">No requests</h3></div>';return}
if(inc.length){h+='<div class="label">Incoming</div>';for(const doc of inc){const d=doc.data();const u=await gU(d.from);
h+=`<div class="fri"><div class="fri-left"><div class="ava">${avI(u)}</div><div><div class="fri-name">${esc(u.displayName)}</div><div class="fri-user">@${esc(u.username||'?')}</div></div></div><div class="fri-actions"><button class="acc" onclick="accReq('${doc.id}','${d.from}')"><i class="fas fa-check"></i></button><button class="dec" onclick="decReq('${doc.id}')"><i class="fas fa-xmark"></i></button></div></div>`}}
if(!sent.empty){h+='<div class="label">Sent</div>';for(const doc of sent.docs){const d=doc.data();const u=await gU(d.to);
h+=`<div class="fri"><div class="fri-left"><div class="ava">${avI(u)}</div><div><div class="fri-name">${esc(u.displayName)}</div><div class="fri-user">@${esc(u.username||'?')}</div></div></div><div class="fri-actions"><button class="dec" onclick="canReq('${doc.id}')"><i class="fas fa-xmark"></i></button></div></div>`}}
c.innerHTML=h}

async function sendFR(){const un=$('addFrUser').value.trim().toLowerCase();if(!un)return toast('Enter username');if(un===md.username)return toast("Can't add yourself");
const t=await gUn(un);if(!t)return toast('User not found');if((md.friends||[]).includes(t.uid))return toast('Already friends');
const ex=await db.collection('friendRequests').where('from','==',me.uid).where('to','==',t.uid).where('status','==','pending').get();if(!ex.empty)return toast('Already sent');
const rev=await db.collection('friendRequests').where('from','==',t.uid).where('to','==',me.uid).where('status','==','pending').get();
if(!rev.empty){accReq(rev.docs[0].id,t.uid);closeM('mAddFriend');return}
await db.collection('friendRequests').add({from:me.uid,to:t.uid,status:'pending',createdAt:TS()});
await addNotif(t.uid,'friend_request',`${md.displayName} wants to be friends`);
closeM('mAddFriend');$('addFrUser').value='';toast('Request sent!','to @'+un,'var(--success)')}
async function accReq(id,from){await db.collection('friendRequests').doc(id).update({status:'accepted'});await db.collection('users').doc(me.uid).update({friends:AU(from)});await db.collection('users').doc(from).update({friends:AU(me.uid)});
await addNotif(from,'friend_accept',`${md.displayName} accepted your request`);toast('Friend added!','','var(--success)')}
async function decReq(id){await db.collection('friendRequests').doc(id).update({status:'declined'})}
async function canReq(id){await db.collection('friendRequests').doc(id).delete()}
async function rmFriend(uid){if(!confirm('Remove friend?'))return;await db.collection('users').doc(me.uid).update({friends:AR(uid)});await db.collection('users').doc(uid).update({friends:AR(me.uid)})}

async function addNotif(userId,type,message,extra={}){
  await db.collection('notifications').add({userId,type,fromId:me.uid,fromName:md.displayName,fromPhoto:md.photoURL||'',message,read:false,createdAt:TS(),...extra})}

// DMS
function listenDMs(){unsubs.dm=db.collection('dms').where('members','array-contains',me.uid).orderBy('lastMessageAt','desc').onSnapshot(snap=>{if(hTab==='dms')renderDMs(snap)})}
async function renderDMs(snap){const c=$('homeC');
if(!snap||snap.empty){c.innerHTML='<div style="padding:4px 8px"><button class="btn btn-g" onclick="openM(\'mNewDm\')" style="font-size:13px;padding:8px"><i class="fas fa-pen-to-square"></i> New Message</button></div><div class="empty" style="padding:30px"><i class="fas fa-inbox" style="font-size:32px;opacity:.2;margin-bottom:12px"></i><h3 style="font-size:15px">No messages</h3></div>';return}
let h='<div style="padding:4px 8px"><button class="btn btn-g" onclick="openM(\'mNewDm\')" style="font-size:13px;padding:8px"><i class="fas fa-pen-to-square"></i> New Message</button></div><div class="label">Recent</div>';
for(const doc of snap.docs){const d=doc.data();const oid=d.members.find(m=>m!==me.uid);const u=await gU(oid);const sc=u.status==='online'?'on':'off';
h+=`<div class="dmi${cDm===doc.id?' on':''}" data-id="${doc.id}" onclick="selDM('${doc.id}','${oid}')"><div class="ava">${avI(u)}<div class="sd ${sc}"></div></div><div class="dmi-info"><div class="dmi-name">${esc(u.displayName||'User')}</div><div class="dmi-sub">${d.lastMessage?esc(trn(d.lastMessage,28)):'Start chatting'}</div></div></div>`}
c.innerHTML=h}

async function startDmW(uid){const ex=await db.collection('dms').where('members','array-contains',me.uid).get();let found=null;
ex.forEach(doc=>{if(doc.data().members.includes(uid))found=doc.id});
if(found){goHome();sTab('dms');setTimeout(()=>selDM(found,uid),200);return}
const ref=await db.collection('dms').add({members:[me.uid,uid],createdAt:TS(),lastMessageAt:TS(),lastMessage:''});
goHome();sTab('dms');setTimeout(()=>selDM(ref.id,uid),200)}
async function createDM(){const un=$('newDmUser').value.trim().toLowerCase();if(!un)return toast('Enter username');
const t=await gUn(un);if(!t)return toast('User not found');if(t.uid===me.uid)return toast("Can't DM yourself");
closeM('mNewDm');$('newDmUser').value='';startDmW(t.uid)}
async function selDM(dmId,oid){cDm=dmId;cType='dm';cCh=null;cSrv=null;cv='home';
document.querySelectorAll('.dmi').forEach(e=>e.classList.toggle('on',e.dataset.id===dmId));
const u=await gU(oid);showCh();$('chatIcon').innerHTML='<i class="fas fa-at"></i>';$('chatName').textContent=u.displayName||'User';
$('msgIn').placeholder=`Message ${u.displayName||'User'}`;$('memBtn').style.display='none';$('memSide').classList.remove('on');
cancelAction();loadMsgs()}

// TABS
function sTab(tab){hTab=tab;document.querySelectorAll('.side-tab').forEach(t=>t.classList.toggle('on',t.dataset.tab===tab));
if(tab==='friends')renderFr();
else if(tab==='dms')db.collection('dms').where('members','array-contains',me.uid).orderBy('lastMessageAt','desc').get().then(s=>renderDMs(s));
else if(tab==='requests')db.collection('friendRequests').where('to','==',me.uid).where('status','==','pending').get().then(s=>renderReqs(s))}
function filterH(){const q=$('homeSearch').value.toLowerCase();document.querySelectorAll('.fri,.dmi').forEach(e=>{e.style.display=e.textContent.toLowerCase().includes(q)?'':'none'})}

// SERVERS
function loadServs(){db.collection('servers').where('members','array-contains',me.uid).onSnapshot(snap=>{const c=$('sIcons');c.innerHTML='';
snap.forEach(doc=>{const d=doc.data();const div=document.createElement('div');div.className=`si${cSrv===doc.id?' on':''}`;div.title=d.name;div.dataset.id=doc.id;
div.onclick=()=>selServ(doc.id);div.oncontextmenu=e=>sCtx(e,doc.id,d);
div.innerHTML=d.iconURL?`<img src="${d.iconURL}">`:(d.name?d.name[0].toUpperCase():'S');c.appendChild(div)})})}
async function createServ(){const name=$('newServName').value.trim();if(!name)return toast('Enter a name');
const code=Math.random().toString(36).substring(2,8).toUpperCase();
const ref=await db.collection('servers').add({name,iconURL:sIconData||'',ownerId:me.uid,members:[me.uid],inviteCode:code,createdAt:TS()});
await db.collection('servers').doc(ref.id).collection('channels').add({name:'general',createdAt:TS()});
closeM('mCreateServ');$('newServName').value='';sIconData=null;$('sIconUp').innerHTML='<i class="fas fa-camera"></i>';selServ(ref.id)}
async function joinServ(){const code=$('joinCode').value.trim().toUpperCase();if(!code)return toast('Enter a code');
const snap=await db.collection('servers').where('inviteCode','==',code).limit(1).get();if(snap.empty)return toast('Invalid code');
const doc=snap.docs[0];if(doc.data().members.includes(me.uid)){closeM('mJoinServ');selServ(doc.id);return}
await db.collection('servers').doc(doc.id).update({members:AU(me.uid)});closeM('mJoinServ');$('joinCode').value='';selServ(doc.id);toast('Joined!',doc.data().name,'var(--success)')}
async function selServ(id){cv='server';cSrv=id;cDm=null;cType=null;cCh=null;
document.querySelectorAll('.si').forEach(e=>e.classList.remove('on'));document.querySelectorAll(`.si[data-id="${id}"]`).forEach(e=>e.classList.add('on'));
$('homeSide').style.display='none';$('servSide').style.display='flex';
const doc=await db.collection('servers').doc(id).get();if(!doc.exists)return;$('servName').textContent=doc.data().name;showEmpty();loadChs(id)}
function loadChs(sid){if(unsubs.ch)unsubs.ch();unsubs.ch=db.collection('servers').doc(sid).collection('channels').orderBy('createdAt').onSnapshot(snap=>{const c=$('chList');c.innerHTML='';
const cat=document.createElement('div');cat.className='cat';cat.innerHTML=`TEXT CHANNELS <button class="add-ch" onclick="openM('mCreateCh')"><i class="fas fa-plus"></i></button>`;c.appendChild(cat);
let first=null;snap.forEach(doc=>{if(!first)first=doc;const d=doc.data();const div=document.createElement('div');div.className=`ch${cCh===doc.id?' on':''}`;div.dataset.id=doc.id;
div.innerHTML=`<i class="fas fa-hashtag"></i><span>${d.name}</span>`;div.onclick=()=>selCh(doc.id,d.name);c.appendChild(div)});
if(!cCh&&first)selCh(first.id,first.data().name)})}
async function createCh(){if(!cSrv)return;const name=$('newChName').value.trim().toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'');
if(!name)return toast('Enter a name');await db.collection('servers').doc(cSrv).collection('channels').add({name,createdAt:TS()});closeM('mCreateCh');$('newChName').value=''}
function selCh(chId,chName){cCh=chId;cType='channel';cDm=null;document.querySelectorAll('.ch').forEach(e=>e.classList.toggle('on',e.dataset.id===chId));showCh();
$('chatIcon').innerHTML='<i class="fas fa-hashtag"></i>';$('chatName').textContent=chName;$('msgIn').placeholder=`Message #${chName}`;$('memBtn').style.display='';
cancelAction();loadMsgs();loadMem()}
function selCh2(chId){db.collection('servers').doc(cSrv).collection('channels').doc(chId).get().then(doc=>{if(doc.exists)selCh(chId,doc.data().name)})}
function goHome(){cv='home';cSrv=null;cCh=null;if(unsubs.ch){unsubs.ch();unsubs.ch=null}
document.querySelectorAll('.si').forEach(e=>e.classList.remove('on'));document.querySelector('.si.home').classList.add('on');
$('homeSide').style.display='flex';$('servSide').style.display='none';if(!cDm)showEmpty();sTab(hTab)}

// MESSAGES
function loadMsgs(){if(unsubs.msg)unsubs.msg();$('msgsL').innerHTML='';firstLoad=true;
let ref;if(cType==='channel')ref=db.collection('servers').doc(cSrv).collection('channels').doc(cCh).collection('messages');
else if(cType==='dm')ref=db.collection('dms').doc(cDm).collection('messages');else return;
unsubs.msg=ref.orderBy('createdAt').limitToLast(100).onSnapshot(snap=>{const list=$('msgsL');
if(firstLoad){list.innerHTML='';const w=document.createElement('div');w.className='welcome';
w.innerHTML=cType==='channel'?`<h2># ${$('chatName').textContent}</h2><p>Start of the channel.</p>`:`<h2>${$('chatName').textContent}</h2><p>Start of conversation.</p>`;
list.appendChild(w);let la=null,lt=null;
snap.forEach(doc=>{const d=doc.data();const g=la===d.authorId&&lt&&d.createdAt&&(d.createdAt.toMillis()-lt<300000);
appMsg(doc.id,d,g,list);la=d.authorId;lt=d.createdAt?d.createdAt.toMillis():null});
firstLoad=false;scBot()}else{
snap.docChanges().forEach(ch=>{
if(ch.type==='added'){if($('m-'+ch.doc.id))return;const d=ch.doc.data();const prev=list.lastElementChild;
let g=false;if(prev?.dataset?.author===d.authorId){const pt=parseInt(prev.dataset.ts||'0');if(d.createdAt&&(d.createdAt.toMillis()-pt<300000))g=true}
appMsg(ch.doc.id,d,g,list);if(d.authorId===me.uid)scBot();else{const c=$('msgsC');if(c.scrollHeight-c.scrollTop-c.clientHeight<200)scBot()}}
else if(ch.type==='removed'){const el=$('m-'+ch.doc.id);if(el)el.remove()}
else if(ch.type==='modified'){updMsgEl(ch.doc.id,ch.doc.data())}})}})}

function appMsg(id,data,grouped,container){
const div=document.createElement('div');div.className=`msg${grouped?' grouped':''}`;div.id='m-'+id;div.dataset.author=data.authorId;div.dataset.ts=data.createdAt?data.createdAt.toMillis():'0';
const time=data.createdAt?fmtT(data.createdAt.toDate()):'';const full=data.createdAt?fmtF(data.createdAt.toDate()):'';
const tb=`<div class="toolbar"><button onclick="startReply('${id}')" title="Reply"><i class="fas fa-reply"></i></button>${data.authorId===me.uid?`<button onclick="startEdit('${id}')" title="Edit"><i class="fas fa-pen"></i></button><button onclick="delMsg('${id}')" title="Delete"><i class="fas fa-trash"></i></button>`:`<button onclick="showUC('${data.authorId}')" title="Profile"><i class="fas fa-user"></i></button>`}</div>`;
let rr='';if(data.replyTo)rr=`<div class="reply-ref" onclick="scToMsg('${data.replyTo.id}')"><div class="rr-bar"></div><span class="rr-name">${esc(data.replyTo.authorName||'User')}</span> ${esc(trn(data.replyTo.text||'attachment',50))}</div>`;
let ct='';if(data.text)ct+=`<div class="mb">${linkify(esc(data.text))}${data.edited?'<span class="edited-tag">(edited)</span>':''}</div>`;
if(data.imageURL)ct+=`<img class="mi" src="${data.imageURL}" onclick="pvI(this.src)" loading="lazy">`;
if(data.gifURL)ct+=`<img class="mi" src="${data.gifURL}" onclick="pvI(this.src)" loading="lazy">`;
if(grouped){div.innerHTML=`<div class="mht">${time}</div><div class="mc">${rr}${ct}</div>${tb}`}
else{div.innerHTML=`<div class="ma">...</div><div class="mc"><div class="mh"><span class="mn">...</span><span class="mt">${full}</span></div>${rr}${ct}</div>${tb}`}
container.appendChild(div);
gU(data.authorId).then(u=>{if(!grouped){const ma=div.querySelector('.ma');const mn=div.querySelector('.mn');
if(ma){ma.innerHTML=avI(u);ma.onclick=()=>showUC(data.authorId)}
if(mn){mn.textContent=u.displayName||'Unknown';mn.style.color=u.nameColor||'#fff';mn.style.fontFamily=u.nameFont||'Inter';mn.onclick=()=>showUC(data.authorId)}}})}

function updMsgEl(id,data){const el=$('m-'+id);if(!el)return;const mb=el.querySelector('.mb');if(mb)mb.innerHTML=linkify(esc(data.text||''))+(data.edited?'<span class="edited-tag">(edited)</span>':'')}

function startReply(id){cancelAction();replyData={id};const el=$('m-'+id);
const name=el?.querySelector('.mn')?.textContent||'User';const text=el?.querySelector('.mb')?.textContent?.replace(/\(edited\)$/,'').trim()||'';
$('abIcon').className='fas fa-reply';$('abIcon').style.color='var(--blue)';$('abLabel').textContent='Replying to '+name;$('abText').textContent=trn(text,60);
$('actionBar').classList.add('on');$('msgIn').focus()}
function startEdit(id){cancelAction();const el=$('m-'+id);const text=el?.querySelector('.mb')?.textContent?.replace(/\(edited\)$/,'').trim()||'';
editData={id};$('abIcon').className='fas fa-pen';$('abIcon').style.color='var(--orange)';$('abLabel').textContent='Editing message';$('abText').textContent='';
$('actionBar').classList.add('on');$('msgIn').value=text;$('msgIn').focus();autoH($('msgIn'))}
function cancelAction(){replyData=null;editData=null;$('actionBar').classList.remove('on');if(editData===null){/*keep text if just canceling reply*/}$('msgIn').value='';autoH($('msgIn'))}
function scToMsg(id){const el=$('m-'+id);if(el){el.scrollIntoView({behavior:'smooth',block:'center'});el.style.background='rgba(255,255,255,.06)';setTimeout(()=>el.style.background='',1500)}}

async function doSend(){const input=$('msgIn');const text=input.value.trim();
if(editData){if(!text)return;let ref;if(cType==='channel')ref=db.collection('servers').doc(cSrv).collection('channels').doc(cCh).collection('messages');
else if(cType==='dm')ref=db.collection('dms').doc(cDm).collection('messages');else return;
await ref.doc(editData.id).update({text,edited:true});editData=null;$('actionBar').classList.remove('on');input.value='';autoH(input);return}
if(!text&&!pendImg)return;
let ref;if(cType==='channel')ref=db.collection('servers').doc(cSrv).collection('channels').doc(cCh).collection('messages');
else if(cType==='dm')ref=db.collection('dms').doc(cDm).collection('messages');else return;
const msg={authorId:me.uid,text,createdAt:TS(),edited:false};if(pendImg){msg.imageURL=pendImg;rmUp()}
if(replyData){const rEl=$('m-'+replyData.id);msg.replyTo={id:replyData.id,authorName:rEl?.querySelector('.mn')?.textContent||'User',text:rEl?.querySelector('.mb')?.textContent?.replace(/\(edited\)$/,'').trim()||''};replyData=null;$('actionBar').classList.remove('on')}
await ref.add(msg);
if(cType==='dm'){const dmDoc=await db.collection('dms').doc(cDm).get();const oid=dmDoc.data().members.find(m=>m!==me.uid);
db.collection('dms').doc(cDm).update({lastMessage:text||'üì∑',lastMessageAt:TS()});
addNotif(oid,'dm',text||'üì∑ Image',{dmId:cDm,serverName:'Direct Message',channelName:md.displayName})}
if(cType==='channel'){const sDoc=await db.collection('servers').doc(cSrv).get();const sd=sDoc.data();const chName=$('chatName').textContent;
sd.members.forEach(uid=>{if(uid!==me.uid)addNotif(uid,'channel',text||'üì∑ Image',{serverId:cSrv,channelId:cCh,serverName:sd.name,channelName:chName})})}
input.value='';autoH(input)}

function sendGif(url){let ref;if(cType==='channel')ref=db.collection('servers').doc(cSrv).collection('channels').doc(cCh).collection('messages');
else if(cType==='dm')ref=db.collection('dms').doc(cDm).collection('messages');else return;
ref.add({authorId:me.uid,text:'',gifURL:url,createdAt:TS(),edited:false});
if(cType==='dm')db.collection('dms').doc(cDm).update({lastMessage:'GIF',lastMessageAt:TS()});togGif()}

async function delMsg(id){if(!confirm('Delete message?'))return;let ref;
if(cType==='channel')ref=db.collection('servers').doc(cSrv).collection('channels').doc(cCh).collection('messages');
else if(cType==='dm')ref=db.collection('dms').doc(cDm).collection('messages');else return;await ref.doc(id).delete()}

function onKey(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();doSend()}if(e.key==='Escape')cancelAction()}
function autoH(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,180)+'px'}
function scBot(){requestAnimationFrame(()=>{const c=$('msgsC');c.scrollTop=c.scrollHeight})}

// MEMBERS
async function loadMem(){if(cType!=='channel'||!cSrv)return;const doc=await db.collection('servers').doc(cSrv).get();if(!doc.exists)return;
const mems=doc.data().members||[];$('memCt').textContent=`Members ‚Äî ${mems.length}`;const c=$('memL');c.innerHTML='';
for(const uid of mems){const u=await gU(uid);const div=document.createElement('div');div.className='memi';div.onclick=()=>showUC(uid);
div.innerHTML=`<div class="ava" style="width:28px;height:28px;font-size:11px">${avI(u)}</div><span class="memn" style="color:${u.nameColor||'#fff'};font-family:${u.nameFont||'Inter'}">${esc(u.displayName||'Unknown')}</span>`;c.appendChild(div)}}
function toggleMem(){$('memSide').classList.toggle('on')}

// USER CARD
async function showUC(uid){const u=await gU(uid);
$('ucAva').innerHTML=avI(u);$('ucAva').style.fontSize='28px';
const n=$('ucName');n.textContent=u.displayName||'Unknown';n.style.color=u.nameColor||'#fff';n.style.fontFamily=u.nameFont||'Inter';
$('ucUser').textContent='@'+(u.username||'?');$('ucBio').textContent=u.bio||'No bio yet.';
let acts='';if(uid!==me.uid){const isFr=(md.friends||[]).includes(uid);
acts+=`<button class="btn btn-w btn-sm" onclick="startDmW('${uid}');closeM('mUserCard')"><i class="fas fa-comment"></i> Message</button>`;
acts+=isFr?`<button class="btn btn-g btn-sm" onclick="rmFriend('${uid}');closeM('mUserCard')"><i class="fas fa-user-minus"></i></button>`
:`<button class="btn btn-g btn-sm" onclick="sendFRDirect('${uid}')"><i class="fas fa-user-plus"></i> Add</button>`}
$('ucActs').innerHTML=acts;openM('mUserCard')}
async function sendFRDirect(uid){if((md.friends||[]).includes(uid))return toast('Already friends');
const ex=await db.collection('friendRequests').where('from','==',me.uid).where('to','==',uid).where('status','==','pending').get();if(!ex.empty)return toast('Already sent');
await db.collection('friendRequests').add({from:me.uid,to:uid,status:'pending',createdAt:TS()});
await addNotif(uid,'friend_request',`${md.displayName} wants to be friends`);toast('Request sent!','','var(--success)')}

// INVITE FRIENDS TO SERVER
async function loadInvFr(){const c=$('invFriends');c.innerHTML='';const fr=md.friends||[];
if(!fr.length){c.innerHTML='<p style="font-size:13px;color:var(--tx3);padding:8px">No friends to invite</p>';return}
const sDoc=await db.collection('servers').doc(cSrv).get();const mems=sDoc.data().members||[];const code=sDoc.data().inviteCode;const sName=sDoc.data().name;
for(const uid of fr){const u=await gU(uid);const inServ=mems.includes(uid);
const div=document.createElement('div');div.className='inv-friend';
div.innerHTML=`<div class="ava">${avI(u)}</div><div class="if-info"><div class="if-name">${esc(u.displayName)}</div><div class="if-user">@${esc(u.username||'')}</div></div>${inServ?'<span style="font-size:12px;color:var(--tx4)">Joined</span>':`<button class="inv-btn" onclick="sendServInv('${uid}','${code}','${esc(sName)}',this)"><i class="fas fa-paper-plane"></i> Invite</button>`}`;
c.appendChild(div)}}
async function sendServInv(uid,code,sName,btn){
const ex=await db.collection('dms').where('members','array-contains',me.uid).get();let dmId=null;ex.forEach(doc=>{if(doc.data().members.includes(uid))dmId=doc.id});
if(!dmId){const ref=await db.collection('dms').add({members:[me.uid,uid],createdAt:TS(),lastMessageAt:TS(),lastMessage:''});dmId=ref.id}
await db.collection('dms').doc(dmId).collection('messages').add({authorId:me.uid,text:`üéâ Join my server **${sName}**! Code: **${code}**`,createdAt:TS(),edited:false});
await db.collection('dms').doc(dmId).update({lastMessage:`Invited to ${sName}`,lastMessageAt:TS()});
await addNotif(uid,'dm',`Invited you to ${sName}`,{dmId,serverName:'Server Invite',channelName:md.displayName});
btn.innerHTML='<i class="fas fa-check"></i> Sent';btn.disabled=true;toast('Invite sent!')}

// FILES
function onFile(e){const f=e.target.files[0];if(!f)return;if(f.size>2*1024*1024)return toast('Max 2MB');
const r=new FileReader();r.onload=ev=>{pendImg=ev.target.result;$('upPrev').classList.add('on');$('upImg').src=pendImg;$('upName').textContent=f.name};r.readAsDataURL(f);e.target.value=''}
function rmUp(){pendImg=null;$('upPrev').classList.remove('on')}
function onPfp(e){const f=e.target.files[0];if(!f)return;if(f.size>1024*1024)return toast('Max 1MB');
const r=new FileReader();r.onload=ev=>{const a=$('pfpArea');a.innerHTML=`<img src="${ev.target.result}"><div class="pfp-ov"><i class="fas fa-camera"></i></div>`;a.dataset.url=ev.target.result};r.readAsDataURL(f);e.target.value=''}
async function saveProf(){const name=$('profName').value.trim();const url=$('pfpArea').dataset.url||md.photoURL||'';
const bio=$('profBio').value.trim();const up={photoURL:url,nameColor:selColor,nameFont:selFont,bio};if(name)up.displayName=name;
await db.collection('users').doc(me.uid).update(up);md={...md,...up};uCache[me.uid]=md;updPanel();closeM('mProfile');toast('Saved!','','var(--success)')}
function prevSIcon(e){const f=e.target.files[0];if(!f)return;if(f.size>1024*1024)return toast('Max 1MB');
const r=new FileReader();r.onload=ev=>{sIconData=ev.target.result;$('sIconUp').innerHTML=`<img src="${sIconData}">`};r.readAsDataURL(f);e.target.value=''}

// COLORS/FONTS
function initCG(){const g=$('colorGrid');g.innerHTML='';COLORS.forEach(c=>{const d=document.createElement('div');d.className=`color-opt${selColor===c?' on':''}`;d.style.background=c;
d.onclick=()=>{selColor=c;document.querySelectorAll('.color-opt').forEach(x=>x.classList.remove('on'));d.classList.add('on');updFontPrev()};g.appendChild(d)})}
function updFontPrev(){selFont=$('fontSel').value;$('fontPrev').style.fontFamily=selFont;$('fontPrev').style.color=selColor;$('fontPrev').textContent=$('profName').value||md?.displayName||'Your Name'}

// GIF
const TK='AIzaSyBJMIUucxOusoVzs4lc-QurCxjlW6Hlsuw';
function togGif(){$('gifP').classList.toggle('on');if($('gifP').classList.contains('on')){$('gifIn').value='';$('gifIn').focus();loadTrend()}}
function gifDeb(){clearTimeout(gifTO);gifTO=setTimeout(sGif,400)}
async function loadTrend(){$('gifG').innerHTML='<div class="gl"><i class="fas fa-spinner fa-spin"></i></div>';
try{const r=await fetch(`https://tenor.googleapis.com/v2/featured?key=${TK}&limit=30&media_filter=tinygif`);rGifs((await r.json()).results)}catch(e){$('gifG').innerHTML='<div class="gl">Failed</div>'}}
async function sGif(){const q=$('gifIn').value.trim();if(!q)return loadTrend();$('gifG').innerHTML='<div class="gl"><i class="fas fa-spinner fa-spin"></i></div>';
try{const r=await fetch(`https://tenor.googleapis.com/v2/search?q=${encodeURIComponent(q)}&key=${TK}&limit=30&media_filter=tinygif`);rGifs((await r.json()).results)}catch(e){$('gifG').innerHTML='<div class="gl">Failed</div>'}}
function rGifs(res){const g=$('gifG');g.innerHTML='';if(!res?.length){g.innerHTML='<div class="gl">No GIFs</div>';return}
res.forEach(gif=>{const url=gif.media_formats?.tinygif?.url;if(!url)return;const img=document.createElement('img');img.src=url;img.loading='lazy';img.onclick=()=>sendGif(url);g.appendChild(img)})}

// SERVER SETTINGS
function openServSet(){if(!cSrv)return;db.collection('servers').doc(cSrv).get().then(doc=>{if(!doc.exists)return;const d=doc.data();$('editServName').value=d.name;$('delServBtn').style.display=d.ownerId===me.uid?'':'none';openM('mServSet')})}
async function saveServSet(){const name=$('editServName').value.trim();if(!name)return;await db.collection('servers').doc(cSrv).update({name});$('servName').textContent=name;closeM('mServSet');toast('Saved!')}
async function leaveServ(){if(!confirm('Leave?'))return;await db.collection('servers').doc(cSrv).update({members:AR(me.uid)});closeM('mServSet');cSrv=null;cCh=null;goHome();showEmpty()}
async function delServ(){if(!confirm('DELETE permanently?'))return;await db.collection('servers').doc(cSrv).delete();closeM('mServSet');cSrv=null;cCh=null;goHome();showEmpty()}
function updInv(){if(!cSrv)return;db.collection('servers').doc(cSrv).get().then(doc=>{if(doc.exists)$('invCode').textContent=doc.data().inviteCode||'N/A'})}
function copyInv(){navigator.clipboard.writeText($('invCode').textContent);event.target.textContent='Copied!';setTimeout(()=>event.target.textContent='Copy',2000)}

// CONTEXT
function sCtx(e,id,data){e.preventDefault();const m=$('ctx');
let h=`<div class="ctx-i" onclick="cSrv='${id}';openM('mInvite');updInv();loadInvFr();closeCtx()"><i class="fas fa-user-plus"></i> Invite</div>`;
if(data.ownerId===me.uid)h+=`<div class="ctx-i" onclick="cSrv='${id}';openServSet();closeCtx()"><i class="fas fa-gear"></i> Settings</div>`;
h+=`<div class="ctx-i dg" onclick="cSrv='${id}';leaveServ();closeCtx()"><i class="fas fa-arrow-right-from-bracket"></i> Leave</div>`;
m.innerHTML=h;m.style.left=Math.min(e.clientX,innerWidth-200)+'px';m.style.top=Math.min(e.clientY,innerHeight-150)+'px';m.classList.add('on')}
function closeCtx(){$('ctx').classList.remove('on')}
document.addEventListener('click',closeCtx);

// MODALS
function openM(id){$(id).classList.add('on');
if(id==='mProfile'){$('profName').value=md?.displayName||'';$('profUser').value=md?.username||'';$('profBio').value=md?.bio||'';
selColor=md?.nameColor||'#ffffff';selFont=md?.nameFont||'Inter';$('fontSel').value=selFont;
const a=$('pfpArea');if(md?.photoURL){a.innerHTML=`<img src="${md.photoURL}"><div class="pfp-ov"><i class="fas fa-camera"></i></div>`;a.dataset.url=md.photoURL}
else{a.innerHTML=`<span style="font-size:32px;font-weight:700">${(md?.displayName||'U')[0].toUpperCase()}</span><div class="pfp-ov"><i class="fas fa-camera"></i></div>`;a.dataset.url=''}
initCG();updFontPrev()}
if(id==='mInvite'){updInv();loadInvFr()}}
function closeM(id){$(id).classList.remove('on')}
document.querySelectorAll('.mdl-o').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('on')}));

// HELPERS
function showCh(){$('emptyState').style.display='none';$('activeChat').style.display='flex'}
function showEmpty(){$('emptyState').style.display='flex';$('activeChat').style.display='none';if(unsubs.msg){unsubs.msg();unsubs.msg=null}}
function esc(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML}
function linkify(t){return t.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>').replace(/(https?:\/\/[^\s<]+)/g,'<a href="$1" target="_blank" rel="noopener">$1</a>')}
function trn(s,n){return s.length>n?s.substring(0,n)+'‚Ä¶':s}
function fmtT(d){return d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}
function fmtF(d){const now=new Date(),t=fmtT(d);if(d.toDateString()===now.toDateString())return'Today '+t;const y=new Date(now);y.setDate(y.getDate()-1);if(d.toDateString()===y.toDateString())return'Yesterday '+t;return d.toLocaleDateString()+' '+t}
function avI(u){return u.photoURL?`<img src="${u.photoURL}">`:(u.displayName||'U')[0].toUpperCase()}
function pvI(url){$('imgPvSrc').src=url;$('imgPv').classList.add('on')}
function toast(title,msg,color){const c=$('toasts');const t=document.createElement('div');t.className='toast';
t.innerHTML=`<div class="t-ava" style="background:${color||'var(--blue)'}"><i class="fas fa-bell" style="font-size:14px"></i></div><div class="t-body"><div class="t-name">${esc(title)}</div>${msg?`<div class="t-msg">${esc(msg)}</div>`:''}</div><button class="t-x" onclick="event.stopPropagation();this.parentElement.remove()"><i class="fas fa-xmark"></i></button>`;
c.appendChild(t);setTimeout(()=>{if(t.parentElement)t.remove()},4000)}

document.addEventListener('click',e=>{const p=$('gifP');if(p.classList.contains('on')&&!p.contains(e.target)&&!e.target.closest('.iacts'))p.classList.remove('on')});
document.addEventListener('keydown',e=>{if(e.key==='Escape'){document.querySelectorAll('.mdl-o.on').forEach(m=>m.classList.remove('on'));$('gifP').classList.remove('on');$('imgPv').classList.remove('on');closeNotifPanel();cancelAction()}});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Chat</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}

:root{
  --bg-0:#000000;
  --bg-1:#0d0d0d;
  --bg-2:#141414;
  --bg-3:#1c1c1e;
  --bg-4:#2c2c2e;
  --bg-5:#3a3a3c;
  --bg-glass:rgba(28,28,30,0.72);
  --bg-hover:rgba(255,255,255,0.03);
  --bg-active:rgba(255,255,255,0.06);
  --bg-hover-2:rgba(255,255,255,0.05);
  --bg-active-2:rgba(255,255,255,0.09);
  --border:rgba(255,255,255,0.08);
  --border-solid:#2c2c2e;
  --border-focus:rgba(10,132,255,0.5);
  --text-0:#ffffff;
  --text-1:#f5f5f7;
  --text-2:#a1a1a6;
  --text-3:#6e6e73;
  --text-4:#48484a;
  --accent:#0a84ff;
  --accent-hover:#3da0ff;
  --accent-pressed:#0070e0;
  --accent-bg:rgba(10,132,255,0.12);
  --accent-bg-2:rgba(10,132,255,0.18);
  --green:#30d158;
  --green-bg:rgba(48,209,88,0.12);
  --red:#ff453a;
  --red-bg:rgba(255,69,58,0.12);
  --orange:#ff9f0a;
  --yellow:#ffd60a;
  --purple:#bf5af2;
  --pink:#ff375f;
  --teal:#64d2ff;
  --indigo:#5e5ce6;
  --shadow-sm:0 1px 2px rgba(0,0,0,0.3),0 1px 3px rgba(0,0,0,0.15);
  --shadow-md:0 4px 12px rgba(0,0,0,0.4),0 1px 4px rgba(0,0,0,0.2);
  --shadow-lg:0 12px 40px rgba(0,0,0,0.5),0 4px 12px rgba(0,0,0,0.3);
  --shadow-xl:0 24px 80px rgba(0,0,0,0.6);
  --r-xs:6px;
  --r-sm:10px;
  --r-md:14px;
  --r-lg:18px;
  --r-xl:22px;
  --r-full:9999px;
  --ease:cubic-bezier(0.25,0.1,0.25,1);
  --ease-spring:cubic-bezier(0.34,1.56,0.64,1);
  --ease-out:cubic-bezier(0,0,0.2,1);
  --t-fast:0.15s;
  --t-normal:0.2s;
  --t-slow:0.3s;
  --font:-apple-system,BlinkMacSystemFont,'SF Pro Display','SF Pro Text','Inter','Helvetica Neue',sans-serif;
}

html,body{
  font-family:var(--font);
  background:var(--bg-0);
  color:var(--text-1);
  height:100vh;
  overflow:hidden;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  letter-spacing:-0.011em;
  font-size:15px;
  line-height:1.47;
}

::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.1);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,0.18)}

::selection{background:var(--accent);color:white}

a{color:var(--accent);text-decoration:none}
a:hover{text-decoration:underline}

/* ===== AUTH ===== */
#authScreen{
  display:flex;align-items:center;justify-content:center;
  height:100vh;background:var(--bg-0);
  position:relative;overflow:hidden;
}

.auth-bg{
  position:absolute;inset:0;
  background:
    radial-gradient(ellipse 60% 50% at 25% 20%,rgba(10,132,255,0.06) 0%,transparent 100%),
    radial-gradient(ellipse 50% 60% at 75% 80%,rgba(191,90,242,0.05) 0%,transparent 100%),
    radial-gradient(ellipse 40% 40% at 50% 50%,rgba(94,92,230,0.04) 0%,transparent 100%);
  animation:authBgPulse 8s ease-in-out infinite alternate;
}

@keyframes authBgPulse{
  0%{opacity:0.7}
  100%{opacity:1}
}

.auth-card{
  position:relative;
  background:var(--bg-glass);
  -webkit-backdrop-filter:blur(40px) saturate(180%);
  backdrop-filter:blur(40px) saturate(180%);
  border:1px solid var(--border);
  border-radius:var(--r-xl);
  padding:44px 40px 40px;
  width:400px;max-width:92vw;
  box-shadow:var(--shadow-xl);
}

.auth-logo{
  width:52px;height:52px;
  background:linear-gradient(135deg,var(--accent),var(--indigo));
  border-radius:var(--r-md);
  display:flex;align-items:center;justify-content:center;
  margin:0 auto 28px;
  box-shadow:0 4px 16px rgba(10,132,255,0.3);
}

.auth-logo svg{width:28px;height:28px;color:white}

.auth-card h2{
  text-align:center;margin-bottom:4px;
  font-size:28px;font-weight:700;
  letter-spacing:-0.04em;color:var(--text-0);
}

.auth-card .sub{
  text-align:center;margin-bottom:28px;
  font-size:15px;color:var(--text-2);font-weight:400;
}

.fg{margin-bottom:16px}

.fg label{
  display:block;font-size:13px;font-weight:600;
  color:var(--text-2);margin-bottom:6px;
  letter-spacing:0.01em;
}

.fg input{
  width:100%;padding:11px 14px;
  background:var(--bg-3);
  border:1px solid var(--border-solid);
  border-radius:var(--r-sm);
  color:var(--text-1);font-size:15px;
  font-family:var(--font);
  outline:none;
  transition:border-color var(--t-fast) var(--ease),box-shadow var(--t-fast) var(--ease);
}

.fg input:focus{
  border-color:var(--accent);
  box-shadow:0 0 0 3px var(--accent-bg);
}

.fg input::placeholder{color:var(--text-4)}

.btn{
  display:inline-flex;align-items:center;justify-content:center;
  padding:11px 20px;
  border:none;border-radius:var(--r-sm);
  font-size:15px;font-weight:600;
  font-family:var(--font);
  cursor:pointer;
  transition:all var(--t-fast) var(--ease);
  letter-spacing:-0.01em;
  gap:6px;
}

.btn-blue{background:var(--accent);color:white}
.btn-blue:hover{background:var(--accent-hover);transform:translateY(-0.5px);box-shadow:0 4px 16px rgba(10,132,255,0.25)}
.btn-blue:active{background:var(--accent-pressed);transform:translateY(0)}
.btn-blue:disabled{opacity:0.4;cursor:not-allowed;transform:none;box-shadow:none}
.btn-full{width:100%}

.btn-green{background:var(--green);color:white}
.btn-green:hover{background:#3bda66;transform:translateY(-0.5px)}
.btn-green:active{transform:translateY(0)}
.btn-green:disabled{opacity:0.4;cursor:not-allowed;transform:none}

.btn-ghost{
  background:transparent;color:var(--text-2);
  padding:8px 14px;
}
.btn-ghost:hover{background:var(--bg-hover-2);color:var(--text-1)}

.btn-danger{background:var(--red);color:white}
.btn-danger:hover{background:#ff6259}

.auth-link{
  margin-top:20px;text-align:center;
  font-size:14px;color:var(--text-3);
}

.auth-link a{color:var(--accent);cursor:pointer;font-weight:500}

.err-box{
  background:var(--red-bg);
  border:1px solid rgba(255,69,58,0.15);
  color:var(--red);padding:10px 14px;
  border-radius:var(--r-sm);margin-bottom:16px;
  font-size:13px;font-weight:500;display:none;
  line-height:1.4;
}

/* ===== APP ===== */
#app{display:none;height:100vh}
.app-row{display:flex;height:100%}

/* ===== SERVER RAIL ===== */
.rail{
  width:72px;background:var(--bg-1);
  display:flex;flex-direction:column;align-items:center;
  padding:12px 0 12px;gap:3px;
  overflow-y:auto;flex-shrink:0;
  border-right:1px solid var(--border);
}

.rail::-webkit-scrollbar{display:none}

.ri{
  width:46px;height:46px;
  border-radius:var(--r-full);
  background:var(--bg-3);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:all var(--t-normal) var(--ease);
  color:var(--text-2);font-weight:600;font-size:16px;
  position:relative;flex-shrink:0;
  border:2px solid transparent;
}

.ri:hover{border-radius:var(--r-md);background:var(--bg-4);color:var(--text-1)}
.ri.active{border-radius:var(--r-md);background:var(--accent);color:white;border-color:transparent}

.ri .ri-img{
  width:100%;height:100%;border-radius:inherit;
  object-fit:cover;
}

.ri.home{
  background:linear-gradient(135deg,var(--accent),var(--purple));
  color:white;margin-bottom:2px;
}
.ri.home:hover{opacity:0.85;border-radius:var(--r-md)}
.ri.home.active{box-shadow:0 0 0 2px var(--bg-0),0 0 0 4px var(--accent);opacity:1}

.ri.add{
  background:transparent;
  border:1.5px dashed var(--bg-5);
  color:var(--text-3);font-size:22px;margin-top:2px;
}
.ri.add:hover{
  border-color:var(--accent);color:var(--accent);
  background:var(--accent-bg);border-radius:var(--r-md);
  border-style:solid;
}

.ri-pill{
  position:absolute;left:-13px;width:4px;height:0;
  background:var(--text-0);border-radius:0 4px 4px 0;
  transition:height var(--t-normal) var(--ease);
}

.ri:hover .ri-pill{height:16px}
.ri.active .ri-pill{height:32px}

.ri-sep{
  width:28px;height:1px;
  background:var(--border);margin:5px 0;flex-shrink:0;
}

.ri-badge{
  position:absolute;bottom:-2px;right:-2px;
  min-width:16px;height:16px;padding:0 4px;
  background:var(--red);color:white;
  font-size:10px;font-weight:700;
  border-radius:var(--r-full);
  display:flex;align-items:center;justify-content:center;
  border:2px solid var(--bg-1);
}

/* ===== SIDEBAR ===== */
.sidebar{
  width:260px;background:var(--bg-1);
  display:flex;flex-direction:column;flex-shrink:0;
  border-right:1px solid var(--border);
}

.sb-head{
  height:52px;padding:0 16px;
  display:flex;align-items:center;justify-content:space-between;
  border-bottom:1px solid var(--border);flex-shrink:0;
}

.sb-head h3{
  font-size:16px;font-weight:700;color:var(--text-0);
  letter-spacing:-0.025em;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  flex:1;
}

.sb-btn{
  width:28px;height:28px;
  display:flex;align-items:center;justify-content:center;
  background:none;border:none;color:var(--text-3);
  cursor:pointer;border-radius:var(--r-xs);
  transition:all var(--t-fast) var(--ease);flex-shrink:0;
}

.sb-btn:hover{background:var(--bg-hover-2);color:var(--text-1)}

.sb-body{flex:1;overflow-y:auto;padding:8px}

.sb-section{
  padding:14px 8px 4px;
  display:flex;align-items:center;justify-content:space-between;
}

.sb-section-t{
  font-size:11px;font-weight:700;
  text-transform:uppercase;letter-spacing:0.06em;
  color:var(--text-4);
}

.sb-section-btn{
  width:16px;height:16px;
  display:flex;align-items:center;justify-content:center;
  background:none;border:none;color:var(--text-4);
  cursor:pointer;font-size:14px;
  transition:color var(--t-fast) var(--ease);
}

.sb-section-btn:hover{color:var(--text-2)}

.ci{
  display:flex;align-items:center;
  padding:7px 10px;border-radius:var(--r-sm);
  cursor:pointer;gap:8px;
  color:var(--text-2);
  transition:all var(--t-fast) var(--ease);
  margin:1px 0;font-size:14px;font-weight:500;
  position:relative;
}

.ci:hover{background:var(--bg-hover-2);color:var(--text-1)}
.ci.active{background:var(--bg-active-2);color:var(--text-0)}

.ci .ci-icon{
  font-size:18px;color:var(--text-4);flex-shrink:0;
  width:20px;text-align:center;
  transition:color var(--t-fast) var(--ease);
}

.ci.active .ci-icon{color:var(--text-3)}
.ci:hover .ci-icon{color:var(--text-3)}

.ci .ci-name{
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;
}

.ci .ci-x{
  display:none;background:none;border:none;
  color:var(--text-4);cursor:pointer;font-size:13px;
  padding:2px;border-radius:4px;
  transition:all var(--t-fast) var(--ease);
  flex-shrink:0;
}

.ci:hover .ci-x{display:flex}
.ci .ci-x:hover{color:var(--red);background:var(--red-bg)}

/* DM items */
.dm-item{
  display:flex;align-items:center;
  padding:7px 10px;border-radius:var(--r-sm);
  cursor:pointer;gap:10px;
  color:var(--text-2);
  transition:all var(--t-fast) var(--ease);
  margin:1px 0;
}

.dm-item:hover{background:var(--bg-hover-2);color:var(--text-1)}
.dm-item.active{background:var(--bg-active-2);color:var(--text-0)}

.dm-av{
  width:32px;height:32px;border-radius:var(--r-full);
  display:flex;align-items:center;justify-content:center;
  font-weight:600;color:white;font-size:13px;
  flex-shrink:0;position:relative;
  overflow:hidden;
}

.dm-av img{width:100%;height:100%;object-fit:cover}

.dm-dot{
  position:absolute;bottom:-1px;right:-1px;
  width:10px;height:10px;border-radius:50%;
  border:2.5px solid var(--bg-1);
}

.dm-dot.online{background:var(--green)}
.dm-dot.idle{background:var(--orange)}
.dm-dot.offline{background:var(--text-4)}

.dm-info{flex:1;min-width:0}

.dm-info .dm-name{
  font-size:14px;font-weight:500;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}

.dm-info .dm-preview{
  font-size:12px;color:var(--text-3);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}

.dm-badge{
  min-width:18px;height:18px;padding:0 5px;
  background:var(--red);color:white;
  font-size:11px;font-weight:700;
  border-radius:var(--r-full);
  display:flex;align-items:center;justify-content:center;
}

/* ===== USER BAR ===== */
.ubar{
  padding:8px 10px;
  display:flex;align-items:center;gap:10px;
  border-top:1px solid var(--border);flex-shrink:0;
}

.ubar-av{
  width:34px;height:34px;border-radius:var(--r-full);
  display:flex;align-items:center;justify-content:center;
  font-weight:600;font-size:14px;color:white;flex-shrink:0;
  position:relative;cursor:pointer;overflow:hidden;
  transition:opacity var(--t-fast) var(--ease);
}

.ubar-av:hover{opacity:0.85}
.ubar-av img{width:100%;height:100%;object-fit:cover}

.ubar-dot{
  position:absolute;bottom:-1px;right:-1px;
  width:10px;height:10px;border-radius:50%;
  border:2.5px solid var(--bg-1);background:var(--green);
}

.ubar-info{flex:1;min-width:0}

.ubar-info .n{
  font-size:13px;font-weight:600;color:var(--text-0);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}

.ubar-info .s{font-size:11px;color:var(--text-3);font-weight:400}

.ubar-btn{
  width:30px;height:30px;
  display:flex;align-items:center;justify-content:center;
  background:none;border:none;color:var(--text-3);
  cursor:pointer;border-radius:var(--r-xs);
  transition:all var(--t-fast) var(--ease);
}

.ubar-btn:hover{background:var(--bg-hover-2);color:var(--text-1)}

/* ===== CHAT MAIN ===== */
.chat{
  flex:1;display:flex;flex-direction:column;
  min-width:0;background:var(--bg-2);
}

.chat-head{
  height:52px;padding:0 20px;
  display:flex;align-items:center;
  border-bottom:1px solid var(--border);
  flex-shrink:0;gap:10px;
}

.chat-head .ch-icon{color:var(--text-4);font-size:20px;display:flex;align-items:center}
.chat-head .ch-title{font-weight:600;color:var(--text-0);font-size:16px;letter-spacing:-0.025em}

.chat-head-dm{
  display:flex;align-items:center;gap:10px;
}

.chat-head-dm .dm-head-av{
  width:28px;height:28px;border-radius:var(--r-full);
  display:flex;align-items:center;justify-content:center;
  font-weight:600;color:white;font-size:11px;
  flex-shrink:0;overflow:hidden;
}

.chat-head-dm .dm-head-av img{width:100%;height:100%;object-fit:cover}

.chat-head-r{margin-left:auto;display:flex;gap:2px}

.chat-hbtn{
  width:34px;height:34px;
  display:flex;align-items:center;justify-content:center;
  background:none;border:none;color:var(--text-3);
  cursor:pointer;border-radius:var(--r-sm);
  transition:all var(--t-fast) var(--ease);
}

.chat-hbtn:hover{background:var(--bg-hover-2);color:var(--text-1)}
.chat-hbtn.on{color:var(--accent);background:var(--accent-bg)}

/* ===== MESSAGES ===== */
.chat-body{display:flex;flex:1;min-height:0}

.msg-col{flex:1;display:flex;flex-direction:column;min-width:0}

.msg-scroll{
  flex:1;overflow-y:auto;
  padding:8px 0 0;
  display:flex;flex-direction:column;
}

.msg-welcome{padding:28px 24px 16px}

.msg-welcome .wi{
  width:52px;height:52px;
  background:var(--bg-4);border-radius:var(--r-lg);
  display:flex;align-items:center;justify-content:center;
  font-size:26px;color:var(--text-3);margin-bottom:14px;
}

.msg-welcome h2{
  font-size:22px;font-weight:700;color:var(--text-0);
  margin-bottom:6px;letter-spacing:-0.03em;
}

.msg-welcome p{font-size:14px;color:var(--text-3);line-height:1.5}

/* Message row */
.mr{
  padding:3px 24px;display:flex;gap:14px;
  position:relative;
  transition:background var(--t-fast) var(--ease);
}

.mr:hover{background:var(--bg-hover)}

.mr.ng{margin-top:12px;padding-top:6px}

.mr-av{
  width:36px;height:36px;border-radius:var(--r-full);
  display:flex;align-items:center;justify-content:center;
  font-weight:600;color:white;font-size:14px;
  flex-shrink:0;cursor:pointer;
  transition:opacity var(--t-fast) var(--ease);
  overflow:hidden;
}

.mr-av:hover{opacity:0.8}
.mr-av img{width:100%;height:100%;object-fit:cover}
.mr-av.hid{visibility:hidden}

.mr-body{flex:1;min-width:0}

.mr-head{display:flex;align-items:baseline;gap:8px;margin-bottom:2px}

.mr-name{
  font-weight:600;font-size:14px;color:var(--text-0);
  cursor:pointer;letter-spacing:-0.01em;
}
.mr-name:hover{text-decoration:underline}

.mr-time{font-size:11px;color:var(--text-4);font-weight:400}

.mr-edited{
  font-size:10px;color:var(--text-4);font-weight:400;
  margin-left:4px;
}

.mr-txt{
  font-size:14.5px;line-height:1.5;
  color:var(--text-1);word-wrap:break-word;
  white-space:pre-wrap;font-weight:400;
}

.mr-txt strong{font-weight:700}
.mr-txt em{font-style:italic}
.mr-txt code{
  background:var(--bg-4);padding:1.5px 5px;
  border-radius:4px;
  font-family:'SF Mono','Fira Code','Cascadia Code',monospace;
  font-size:13px;
}
.mr-txt pre{
  background:var(--bg-3);padding:12px 16px;
  border-radius:var(--r-sm);margin:6px 0;
  overflow-x:auto;border:1px solid var(--border);
}
.mr-txt pre code{background:none;padding:0}
.mr-txt a{color:var(--accent)}
.mr-txt a:hover{text-decoration:underline}

.mr-img{
  max-width:420px;max-height:320px;
  border-radius:var(--r-md);margin-top:6px;
  cursor:pointer;transition:all var(--t-fast) var(--ease);
  border:1px solid var(--border);
  display:block;
}

.mr-img:hover{opacity:0.92;border-color:var(--border-solid)}

/* Message hover actions */
.mr-actions{
  position:absolute;top:-14px;right:24px;
  background:var(--bg-3);
  border:1px solid var(--border-solid);
  border-radius:var(--r-sm);
  display:none;
  box-shadow:var(--shadow-sm);
  overflow:hidden;
}

.mr:hover .mr-actions{display:flex}

.mr-act{
  width:32px;height:28px;
  display:flex;align-items:center;justify-content:center;
  background:none;border:none;color:var(--text-3);
  cursor:pointer;font-size:14px;
  transition:all var(--t-fast) var(--ease);
}

.mr-act:hover{background:var(--bg-hover-2);color:var(--text-1)}
.mr-act.danger:hover{background:var(--red-bg);color:var(--red)}

.mr-hover-t{
  position:absolute;left:4px;
  font-size:10px;color:var(--text-4);
  display:none;width:50px;text-align:right;
  font-weight:400;padding-top:2px;
}

.mr:hover .mr-hover-t{display:block}

/* Editing */
.mr-edit-box{
  background:var(--bg-3);border:1px solid var(--border-solid);
  border-radius:var(--r-sm);margin-top:4px;
  padding:8px;display:flex;flex-direction:column;gap:6px;
}

.mr-edit-box textarea{
  width:100%;background:transparent;border:none;
  color:var(--text-1);font-size:14px;font-family:var(--font);
  resize:none;outline:none;line-height:1.4;
  min-height:20px;max-height:200px;
}

.mr-edit-box .edit-hint{
  font-size:11px;color:var(--text-4);
}

/* ===== TYPING ===== */
.typing-bar{
  padding:2px 24px;height:22px;
  font-size:12px;color:var(--text-3);
  display:flex;align-items:center;gap:4px;
  flex-shrink:0;font-weight:400;
}

.td{display:inline-flex;gap:2px;margin-right:2px}
.td span{
  width:4px;height:4px;background:var(--text-3);
  border-radius:50%;animation:tdot 1.4s infinite;
}
.td span:nth-child(2){animation-delay:.2s}
.td span:nth-child(3){animation-delay:.4s}

@keyframes tdot{
  0%,60%,100%{transform:translateY(0)}
  30%{transform:translateY(-3px)}
}

/* ===== INPUT ===== */
.in-area{padding:0 20px 20px;flex-shrink:0}

.in-preview{
  display:none;padding:8px 8px 4px;
  background:var(--bg-3);
  border:1px solid var(--border-solid);
  border-bottom:none;
  border-radius:var(--r-sm) var(--r-sm) 0 0;
}

.in-preview.show{display:block}

.in-preview-inner{position:relative;display:inline-block}

.in-preview img{
  max-height:120px;max-width:200px;
  border-radius:var(--r-xs);border:1px solid var(--border);
}

.in-preview-x{
  position:absolute;top:-6px;right:-6px;
  width:20px;height:20px;
  background:var(--red);color:white;
  border:2px solid var(--bg-3);
  border-radius:50%;cursor:pointer;
  font-size:11px;font-weight:700;
  display:flex;align-items:center;justify-content:center;
  transition:transform var(--t-fast) var(--ease);
}

.in-preview-x:hover{transform:scale(1.15)}

.in-box{
  background:var(--bg-3);
  border:1px solid var(--border-solid);
  border-radius:var(--r-md);
  display:flex;align-items:flex-end;
  padding:4px 4px 4px 6px;
  transition:border-color var(--t-fast) var(--ease),box-shadow var(--t-fast) var(--ease);
}

.in-box.has-preview{border-radius:0 0 var(--r-md) var(--r-md);border-top:none}

.in-box:focus-within{
  border-color:var(--accent);
  box-shadow:0 0 0 3px var(--accent-bg);
}

.in-btn{
  width:34px;height:34px;
  display:flex;align-items:center;justify-content:center;
  background:none;border:none;color:var(--text-4);
  cursor:pointer;border-radius:var(--r-xs);
  transition:all var(--t-fast) var(--ease);flex-shrink:0;
}

.in-btn:hover{color:var(--text-2);background:var(--bg-hover-2)}

.in-btn.send{color:var(--accent)}
.in-btn.send:hover{color:var(--accent-hover);background:var(--accent-bg)}

.in-ta{
  flex:1;background:none;border:none;
  color:var(--text-1);font-size:14.5px;
  padding:7px 8px;outline:none;
  font-family:var(--font);
  resize:none;max-height:200px;min-height:20px;
  line-height:1.4;letter-spacing:-0.01em;
}

.in-ta::placeholder{color:var(--text-4)}

input[type="file"]{display:none}

/* ===== MEMBERS ===== */
.mbar{
  width:240px;background:var(--bg-1);
  overflow-y:auto;padding:12px 8px;
  flex-shrink:0;display:none;
  border-left:1px solid var(--border);
}

.mbar.show{display:block}

.mbar-cat{
  padding:14px 10px 4px;
  font-size:11px;font-weight:700;
  text-transform:uppercase;letter-spacing:0.06em;
  color:var(--text-4);
}

.mbar-i{
  display:flex;align-items:center;
  padding:6px 10px;border-radius:var(--r-sm);
  cursor:pointer;gap:10px;
  transition:background var(--t-fast) var(--ease);
}

.mbar-i:hover{background:var(--bg-hover-2)}

.mbar-av{
  width:30px;height:30px;border-radius:var(--r-full);
  display:flex;align-items:center;justify-content:center;
  font-weight:600;color:white;font-size:12px;
  flex-shrink:0;position:relative;overflow:hidden;
}

.mbar-av img{width:100%;height:100%;object-fit:cover}

.mbar-dot{
  position:absolute;bottom:-1px;right:-1px;
  width:9px;height:9px;border-radius:50%;
  border:2px solid var(--bg-1);
}

.mbar-dot.online{background:var(--green)}
.mbar-dot.idle{background:var(--orange)}
.mbar-dot.offline{background:var(--text-4)}

.mbar-n{
  font-size:13px;font-weight:500;color:var(--text-2);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}

.mbar-i:hover .mbar-n{color:var(--text-1)}
.mbar-i.off .mbar-n{opacity:0.45}
.mbar-i.off .mbar-av{opacity:0.45}

/* ===== HOME ===== */
.home{
  display:none;flex:1;flex-direction:column;
  background:var(--bg-2);
}

.home-head{
  height:52px;padding:0 20px;
  display:flex;align-items:center;
  border-bottom:1px solid var(--border);gap:12px;flex-shrink:0;
}

.home-head .ht{font-weight:700;color:var(--text-0);font-size:16px;letter-spacing:-0.025em}

.home-body{
  flex:1;display:flex;align-items:center;justify-content:center;
}

.home-empty{text-align:center;padding:40px}
.home-empty .em{font-size:72px;margin-bottom:20px;display:block}
.home-empty h3{font-size:20px;font-weight:700;color:var(--text-1);margin-bottom:8px;letter-spacing:-0.025em}
.home-empty p{font-size:14px;color:var(--text-3);line-height:1.6;max-width:320px;margin:0 auto}

/* ===== MODALS ===== */
.mo{
  position:fixed;inset:0;
  background:rgba(0,0,0,0.55);
  display:none;align-items:center;justify-content:center;
  z-index:1000;
  -webkit-backdrop-filter:blur(8px);
  backdrop-filter:blur(8px);
}

.mo.show{display:flex}

.md{
  background:var(--bg-glass);
  -webkit-backdrop-filter:blur(40px) saturate(180%);
  backdrop-filter:blur(40px) saturate(180%);
  border:1px solid var(--border);
  border-radius:var(--r-xl);
  padding:32px;width:440px;max-width:92vw;
  box-shadow:var(--shadow-xl);
  animation:mdIn 0.2s var(--ease-out);
}

@keyframes mdIn{
  from{opacity:0;transform:scale(0.96) translateY(8px)}
  to{opacity:1;transform:scale(1) translateY(0)}
}

.md h2{
  color:var(--text-0);margin-bottom:4px;
  font-size:22px;font-weight:700;letter-spacing:-0.035em;
}

.md .md-sub{color:var(--text-3);font-size:14px;margin-bottom:20px;line-height:1.5}

.md-foot{display:flex;justify-content:flex-end;gap:8px;margin-top:20px}

.or-line{
  text-align:center;color:var(--text-4);
  font-size:11px;font-weight:700;
  text-transform:uppercase;letter-spacing:0.08em;
  padding:4px 0;position:relative;
  margin:4px 0;
}

.or-line::before,.or-line::after{
  content:'';position:absolute;top:50%;
  width:calc(50% - 16px);height:1px;background:var(--border-solid);
}
.or-line::before{left:0}
.or-line::after{right:0}

.invite-box{
  background:var(--bg-3);border:1px solid var(--border-solid);
  padding:14px 16px;border-radius:var(--r-sm);
  display:flex;align-items:center;justify-content:space-between;
  margin-top:12px;gap:12px;
}

.invite-box code{
  font-family:'SF Mono','Fira Code',monospace;
  font-size:17px;color:var(--text-0);
  font-weight:600;letter-spacing:0.03em;
}

/* ===== CTX MENU ===== */
.ctx{
  position:fixed;
  background:var(--bg-glass);
  -webkit-backdrop-filter:blur(40px) saturate(180%);
  backdrop-filter:blur(40px) saturate(180%);
  border:1px solid var(--border);
  border-radius:var(--r-md);
  padding:5px;min-width:200px;
  box-shadow:var(--shadow-lg);
  z-index:1500;display:none;
  animation:ctxIn 0.12s var(--ease-out);
}

@keyframes ctxIn{
  from{opacity:0;transform:scale(0.96)}
  to{opacity:1;transform:scale(1)}
}

.ctx-i{
  padding:7px 12px;border-radius:var(--r-xs);
  cursor:pointer;font-size:13px;font-weight:500;
  color:var(--text-2);display:flex;align-items:center;gap:10px;
  transition:all 0.08s var(--ease);
}

.ctx-i:hover{background:var(--accent);color:white}
.ctx-i.danger{color:var(--red)}
.ctx-i.danger:hover{background:var(--red);color:white}

.ctx-i svg{width:16px;height:16px;flex-shrink:0}

.ctx-sep{height:1px;background:var(--border);margin:3px 6px}

/* ===== SETTINGS ===== */
.settings{
  position:fixed;inset:0;
  background:var(--bg-1);
  z-index:2000;display:none;
}

.settings.show{display:flex}

.settings-l{
  width:280px;display:flex;justify-content:flex-end;
  background:var(--bg-1);padding:48px 12px;
  border-right:1px solid var(--border);
}

.settings-nav{width:180px}

.sn-head{
  font-size:11px;font-weight:700;
  text-transform:uppercase;letter-spacing:0.06em;
  color:var(--text-4);padding:8px 10px;
}

.sn-item{
  padding:8px 10px;border-radius:var(--r-sm);
  cursor:pointer;font-size:14px;font-weight:500;
  color:var(--text-2);margin:1px 0;
  transition:all var(--t-fast) var(--ease);
}

.sn-item:hover{background:var(--bg-hover-2);color:var(--text-1)}
.sn-item.active{background:var(--bg-active-2);color:var(--text-0)}
.sn-item.danger{color:var(--red)}
.sn-item.danger:hover{background:var(--red-bg)}

.sn-sep{height:1px;background:var(--border);margin:6px 10px}

.settings-r{
  flex:1;padding:48px 40px;overflow-y:auto;
  max-width:700px;position:relative;
}

.settings-r h2{
  font-size:22px;font-weight:700;color:var(--text-0);
  margin-bottom:24px;letter-spacing:-0.035em;
}

.settings-x{
  position:absolute;top:16px;right:16px;
  width:36px;height:36px;border-radius:var(--r-full);
  border:1.5px solid var(--border-solid);
  background:none;color:var(--text-3);cursor:pointer;
  font-size:18px;display:flex;align-items:center;justify-content:center;
  transition:all var(--t-fast) var(--ease);
}

.settings-x:hover{border-color:var(--text-3);color:var(--text-1);background:var(--bg-hover-2)}

.pcard{
  background:var(--bg-3);border:1px solid var(--border-solid);
  border-radius:var(--r-lg);padding:20px;
  display:flex;align-items:center;gap:16px;
}

.pcard .av-big{
  width:76px;height:76px;border-radius:var(--r-full);
  display:flex;align-items:center;justify-content:center;
  font-size:32px;font-weight:700;color:white;flex-shrink:0;
  overflow:hidden;cursor:pointer;
  position:relative;
  transition:opacity var(--t-fast) var(--ease);
}

.pcard .av-big:hover{opacity:0.85}
.pcard .av-big img{width:100%;height:100%;object-fit:cover}

.pcard .av-big .av-overlay{
  position:absolute;inset:0;
  background:rgba(0,0,0,0.5);
  display:flex;align-items:center;justify-content:center;
  opacity:0;transition:opacity var(--t-fast) var(--ease);
  font-size:11px;font-weight:600;letter-spacing:0.02em;
  text-transform:uppercase;color:white;
}

.pcard .av-big:hover .av-overlay{opacity:1}

.pcard .pi h3{font-size:20px;font-weight:700;color:var(--text-0);letter-spacing:-0.025em}
.pcard .pi p{font-size:13px;color:var(--text-3);margin-top:2px}

/* ===== LIGHTBOX ===== */
.lb{
  position:fixed;inset:0;z-index:3000;
  background:rgba(0,0,0,0.85);
  display:none;align-items:center;justify-content:center;
  cursor:zoom-out;
  -webkit-backdrop-filter:blur(20px);
  backdrop-filter:blur(20px);
  animation:lbIn 0.2s var(--ease-out);
}

.lb.show{display:flex}

@keyframes lbIn{from{opacity:0}to{opacity:1}}

.lb img{
  max-width:92vw;max-height:92vh;
  border-radius:var(--r-md);box-shadow:var(--shadow-xl);
}

/* ===== AVATAR COLORS ===== */
.ac0{background:linear-gradient(135deg,#5e5ce6,#0a84ff)!important}
.ac1{background:linear-gradient(135deg,#30d158,#34c759)!important}
.ac2{background:linear-gradient(135deg,#ff9f0a,#ff6723)!important}
.ac3{background:linear-gradient(135deg,#ff453a,#ff2d55)!important}
.ac4{background:linear-gradient(135deg,#bf5af2,#af52de)!important}
.ac5{background:linear-gradient(135deg,#64d2ff,#5ac8fa)!important}
.ac6{background:linear-gradient(135deg,#ffd60a,#ff9500)!important}
.ac7{background:linear-gradient(135deg,#ff375f,#da1e5b)!important}

/* Spinner */
.spin-w{display:flex;align-items:center;justify-content:center;height:100%}
.spin{
  width:28px;height:28px;
  border:3px solid var(--bg-4);
  border-top-color:var(--accent);
  border-radius:50%;
  animation:spin 0.7s linear infinite;
}

@keyframes spin{to{transform:rotate(360deg)}}

/* ===== RESPONSIVE ===== */
@media(max-width:1000px){.mbar{display:none!important}}
@media(max-width:768px){
  .sidebar{display:none!important}
  .rail{width:58px}
  .ri{width:40px;height:40px;font-size:14px}
}
</style>
</head>
<body>

<!-- AUTH -->
<div id="authScreen">
  <div class="auth-bg"></div>
  <div class="auth-card">
    <div class="auth-logo">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
    </div>
    <div id="loginV">
      <h2>Welcome back</h2>
      <p class="sub">Sign in to continue to Chat</p>
      <div id="loginErr" class="err-box"></div>
      <div class="fg"><label>Email</label><input type="email" id="lEmail" placeholder="you@email.com"></div>
      <div class="fg"><label>Password</label><input type="password" id="lPw" placeholder="Your password"></div>
      <button class="btn btn-blue btn-full" id="lBtn">Sign In</button>
      <p class="auth-link">Don't have an account? <a id="toReg">Create one</a></p>
    </div>
    <div id="regV" style="display:none">
      <h2>Create account</h2>
      <p class="sub">Get started with Chat</p>
      <div id="regErr" class="err-box"></div>
      <div class="fg"><label>Email</label><input type="email" id="rEmail" placeholder="you@email.com"></div>
      <div class="fg"><label>Display Name</label><input type="text" id="rName" placeholder="What should we call you?" maxlength="32"></div>
      <div class="fg"><label>Password</label><input type="password" id="rPw" placeholder="6+ characters"></div>
      <button class="btn btn-blue btn-full" id="rBtn">Create Account</button>
      <p class="auth-link">Already have an account? <a id="toLog">Sign in</a></p>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <div class="app-row">

    <!-- Rail -->
    <div class="rail" id="rail">
      <div class="ri home active" id="homeBtn" title="Home">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        <span class="ri-pill"></span>
      </div>
      <div class="ri-sep"></div>
      <div id="srvList"></div>
      <div class="ri add" id="addSrv" title="Create or Join">+<span class="ri-pill"></span></div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sb-head">
        <h3 id="sbTitle">Home</h3>
        <button class="sb-btn" id="sbMenu" title="Options">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
        </button>
      </div>
      <div class="sb-body" id="sbBody"></div>
      <div class="ubar">
        <div class="ubar-av" id="ubAv" title="Change Avatar"><div class="ubar-dot"></div></div>
        <div class="ubar-info"><div class="n" id="ubN">User</div><div class="s">Online</div></div>
        <button class="ubar-btn" id="setBtn" title="Settings">
          <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        </button>
      </div>
    </div>

    <!-- Chat -->
    <div class="chat" id="chatArea" style="display:none">
      <div class="chat-head" id="chatHead">
        <span class="ch-icon" id="chIcon">#</span>
        <span class="ch-title" id="chTitle">general</span>
        <div class="chat-head-r">
          <button class="chat-hbtn on" id="togMbr" title="Members">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          </button>
        </div>
      </div>
      <div class="chat-body">
        <div class="msg-col">
          <div class="msg-scroll" id="msgScroll">
            <div class="spin-w"><div class="spin"></div></div>
          </div>
          <div class="typing-bar" id="typBar"></div>
          <div class="in-area">
            <div class="in-preview" id="inPrev">
              <div class="in-preview-inner" id="prevInner"></div>
            </div>
            <div class="in-box" id="inBox">
              <button class="in-btn" id="attachBtn" title="Upload Image">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
              </button>
              <textarea class="in-ta" id="msgIn" placeholder="Message #general" rows="1"></textarea>
              <button class="in-btn send" id="sendBtn" title="Send">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
              </button>
            </div>
            <input type="file" id="fileIn" accept="image/*">
          </div>
        </div>
        <div class="mbar show" id="mbar"></div>
      </div>
    </div>

    <!-- Home -->
    <div class="home" id="homeArea">
      <div class="home-head"><span class="ht">Home</span></div>
      <div class="home-body">
        <div class="home-empty">
          <span class="em">ðŸ’¬</span>
          <h3>Welcome to Chat</h3>
          <p>Create a server, join one with an invite, or message someone directly.</p>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Create/Join Server Modal -->
<div class="mo" id="moSrv">
  <div class="md">
    <h2>Add a server</h2>
    <p class="md-sub">Create your own or join an existing one.</p>
    <div class="fg"><label>Server Name</label><input type="text" id="newSrvN" placeholder="My Server" maxlength="100"></div>
    <button class="btn btn-blue btn-full" id="cSrvBtn">Create</button>
    <div class="or-line">or</div>
    <div class="fg"><label>Invite Code</label><input type="text" id="joinC" placeholder="Paste invite code"></div>
    <button class="btn btn-green btn-full" id="jSrvBtn">Join Server</button>
    <div class="md-foot"><button class="btn btn-ghost" id="xSrvMo">Cancel</button></div>
  </div>
</div>

<!-- Create Channel Modal -->
<div class="mo" id="moChM">
  <div class="md">
    <h2>New channel</h2>
    <p class="md-sub">Channels are where conversations happen.</p>
    <div class="fg"><label>Channel Name</label><input type="text" id="newChN" placeholder="general" maxlength="100"></div>
    <div class="md-foot">
      <button class="btn btn-ghost" id="xChMo">Cancel</button>
      <button class="btn btn-blue" id="cChBtn">Create</button>
    </div>
  </div>
</div>

<!-- Invite Modal -->
<div class="mo" id="moInv">
  <div class="md">
    <h2>Invite friends</h2>
    <p class="md-sub">Share this code so others can join your server.</p>
    <div class="invite-box">
      <code id="invCode"></code>
      <button class="btn btn-blue" id="cpInv">Copy</button>
    </div>
    <div class="md-foot"><button class="btn btn-ghost" id="xInvMo">Done</button></div>
  </div>
</div>

<!-- New DM Modal -->
<div class="mo" id="moDm">
  <div class="md">
    <h2>New Message</h2>
    <p class="md-sub">Enter the exact display name of the user.</p>
    <div class="fg"><label>Username</label><input type="text" id="dmUserN" placeholder="Enter username" maxlength="32"></div>
    <div class="md-foot">
      <button class="btn btn-ghost" id="xDmMo">Cancel</button>
      <button class="btn btn-blue" id="startDmBtn">Start Conversation</button>
    </div>
  </div>
</div>

<!-- Context Menu -->
<div class="ctx" id="ctx">
  <div class="ctx-i" id="ctxInv"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>Invite People</div>
  <div class="ctx-i" id="ctxNCh"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>New Channel</div>
  <div class="ctx-sep"></div>
  <div class="ctx-i danger" id="ctxLeave"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>Leave Server</div>
  <div class="ctx-i danger" id="ctxDel" style="display:none"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>Delete Server</div>
</div>

<!-- Settings -->
<div class="settings" id="setO">
  <div class="settings-l">
    <div class="settings-nav">
      <div class="sn-head">Settings</div>
      <div class="sn-item active">Account</div>
      <div class="sn-sep"></div>
      <div class="sn-item danger" id="logoutBtn">Log Out</div>
    </div>
  </div>
  <div class="settings-r">
    <button class="settings-x" id="xSet">âœ•</button>
    <h2>Account</h2>
    <div class="pcard">
      <div class="av-big" id="sAv" title="Click to change avatar">
        <div class="av-overlay">Edit</div>
      </div>
      <div class="pi">
        <h3 id="sN">User</h3>
        <p id="sE">user@email.com</p>
      </div>
    </div>
    <input type="file" id="pfpIn" accept="image/*">
    <div style="margin-top:28px">
      <div class="fg"><label>Display Name</label><input type="text" id="editN" maxlength="32"></div>
      <button class="btn btn-blue" id="savePf">Save Changes</button>
    </div>
  </div>
</div>

<!-- Lightbox -->
<div class="lb" id="lb"><img id="lbImg" src=""></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyBJMIUucxOusoVzs4lc-QurCxjlW6Hlsuw",
  authDomain:"chat-5f0bf.firebaseapp.com",
  projectId:"chat-5f0bf",
  storageBucket:"chat-5f0bf.firebasestorage.app",
  messagingSenderId:"211425841353",
  appId:"1:211425841353:web:e1c271a340d73abd0cfd18"
});

const auth=firebase.auth();
const db=firebase.firestore();
const TS=()=>firebase.firestore.FieldValue.serverTimestamp();
const AU=v=>firebase.firestore.FieldValue.arrayUnion(v);
const AR=v=>firebase.firestore.FieldValue.arrayRemove(v);
const FP=firebase.firestore.FieldPath;

// ===== IMGBB API for unlimited image hosting =====
const IMGBB_KEY='4f9b1a86d1ac89e2d2b0a38ef tried74';
// We'll use a free image hosting proxy approach
// Actually let's use a data URL chunking approach - store images across multiple docs
// Better: use imgbb free API or similar
// For maximum simplicity and unlimited size: we'll chunk base64 into Firestore docs

async function uploadImage(file){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=async e=>{
      try{
        const dataUrl=e.target.result;
        // Compress if needed
        const compressed=await compressImage(dataUrl,1600,0.82);
        // Store in a dedicated images collection with chunking
        const chunks=chunkString(compressed,900000); // ~900KB per chunk
        const imgRef=await db.collection('images').add({
          uploaderId:me.uid,
          chunkCount:chunks.length,
          createdAt:TS()
        });
        for(let i=0;i<chunks.length;i++){
          await db.collection('images').doc(imgRef.id).collection('chunks').doc(String(i)).set({
            data:chunks[i]
          });
        }
        resolve(imgRef.id);
      }catch(err){reject(err)}
    };
    reader.onerror=reject;
    reader.readAsDataURL(file);
  });
}

async function getImage(imageId){
  try{
    const doc=await db.collection('images').doc(imageId).get();
    if(!doc.exists)return null;
    const {chunkCount}=doc.data();
    let full='';
    for(let i=0;i<chunkCount;i++){
      const chunk=await db.collection('images').doc(imageId).collection('chunks').doc(String(i)).get();
      if(chunk.exists)full+=chunk.data().data;
    }
    return full;
  }catch(e){console.error(e);return null}
}

function compressImage(dataUrl,maxDim,quality){
  return new Promise(resolve=>{
    const img=new Image();
    img.onload=()=>{
      let w=img.width,h=img.height;
      if(w>maxDim||h>maxDim){
        if(w>h){h=Math.round(h*maxDim/w);w=maxDim}
        else{w=Math.round(w*maxDim/h);h=maxDim}
      }
      const c=document.createElement('canvas');
      c.width=w;c.height=h;
      c.getContext('2d').drawImage(img,0,0,w,h);
      resolve(c.toDataURL('image/jpeg',quality));
    };
    img.src=dataUrl;
  });
}

function chunkString(str,size){
  const chunks=[];
  for(let i=0;i<str.length;i+=size)chunks.push(str.substring(i,i+size));
  return chunks;
}

// Image cache
const imgCache={};

async function loadImageSrc(imageId){
  if(imgCache[imageId])return imgCache[imageId];
  const src=await getImage(imageId);
  if(src)imgCache[imageId]=src;
  return src;
}

// ===== STATE =====
let me=null,profile=null;
let curSrv=null,curCh=null,curDm=null;
let srvs=[],chs=[],mbrs=[];
let showMbrs=true,isHome=true,isDm=false;
let unsubs={msgs:null,chs:null,mbrs:null,srvs:null,typ:null,dms:null,dmMsgs:null};
let typTimer=null,pendingFile=null;
let dmList=[];
let editingMsgId=null;

const $=id=>document.getElementById(id);

// ===== AUTH =====
$('toReg').onclick=()=>{$('loginV').style.display='none';$('regV').style.display='block';$('regErr').style.display='none'};
$('toLog').onclick=()=>{$('regV').style.display='none';$('loginV').style.display='block';$('loginErr').style.display='none'};

$('lBtn').onclick=async()=>{
  const e=$('lEmail').value.trim(),p=$('lPw').value;
  if(!e||!p)return sErr($('loginErr'),'Please fill in all fields.');
  $('lBtn').disabled=true;
  try{await auth.signInWithEmailAndPassword(e,p)}catch(err){sErr($('loginErr'),aErr(err.code))}
  $('lBtn').disabled=false;
};

$('rBtn').onclick=async()=>{
  const e=$('rEmail').value.trim(),n=$('rName').value.trim(),p=$('rPw').value;
  if(!e||!n||!p)return sErr($('regErr'),'Please fill in all fields.');
  if(p.length<6)return sErr($('regErr'),'Password needs 6+ characters.');
  $('rBtn').disabled=true;
  try{
    const c=await auth.createUserWithEmailAndPassword(e,p);
    await db.collection('users').doc(c.user.uid).set({
      email:e,username:n,avatarColor:Math.floor(Math.random()*8),
      status:'online',createdAt:TS(),servers:[],pfp:null
    });
  }catch(err){sErr($('regErr'),aErr(err.code))}
  $('rBtn').disabled=false;
};

$('lPw').onkeydown=e=>{if(e.key==='Enter')$('lBtn').click()};
$('rPw').onkeydown=e=>{if(e.key==='Enter')$('rBtn').click()};

function sErr(el,m){el.textContent=m;el.style.display='block'}
function aErr(c){
  return{'auth/email-already-in-use':'Email already taken.','auth/invalid-email':'Invalid email.',
    'auth/wrong-password':'Wrong password.','auth/user-not-found':'Account not found.',
    'auth/weak-password':'Password too weak.','auth/invalid-credential':'Invalid credentials.',
    'auth/too-many-requests':'Too many attempts.'}[c]||'Something went wrong.';
}

auth.onAuthStateChanged(async u=>{
  if(u){
    me=u;
    const d=await db.collection('users').doc(u.uid).get();
    profile=d.exists?{id:u.uid,...d.data()}:{id:u.uid,username:u.email.split('@')[0],email:u.email,avatarColor:0,servers:[],pfp:null};
    db.collection('users').doc(u.uid).update({status:'online'}).catch(()=>{});
    $('authScreen').style.display='none';
    $('app').style.display='block';
    init();
  }else{
    me=null;profile=null;
    $('authScreen').style.display='flex';
    $('app').style.display='none';
    killAll();
  }
});

// ===== INIT =====
function init(){syncUI();loadSrvs();goHome()}

function syncUI(){
  const ini=(profile.username||'?')[0].toUpperCase();
  const cls='ac'+(profile.avatarColor||0);

  // User bar avatar
  $('ubAv').className='ubar-av '+cls;
  if(profile.pfp){
    $('ubAv').innerHTML='<img src="'+profile.pfp+'"><div class="ubar-dot"></div>';
  }else{
    $('ubAv').innerHTML=ini+'<div class="ubar-dot"></div>';
  }
  $('ubN').textContent=profile.username;

  // Settings
  $('sAv').className='av-big '+cls;
  if(profile.pfp){
    $('sAv').innerHTML='<img src="'+profile.pfp+'"><div class="av-overlay">Edit</div>';
  }else{
    $('sAv').innerHTML=ini+'<div class="av-overlay">Edit</div>';
  }
  $('sN').textContent=profile.username;
  $('sE').textContent=profile.email||me.email;
  $('editN').value=profile.username;
}

function killAll(){Object.values(unsubs).forEach(u=>u&&u());for(let k in unsubs)unsubs[k]=null}

// ===== PFP UPLOAD =====
$('sAv').onclick=()=>$('pfpIn').click();
$('ubAv').onclick=()=>$('pfpIn').click();

$('pfpIn').onchange=async e=>{
  const file=e.target.files[0];
  if(!file)return;
  try{
    const compressed=await compressImage(await readFile(file),256,0.8);
    await db.collection('users').doc(me.uid).update({pfp:compressed});
    profile.pfp=compressed;
    syncUI();
  }catch(err){console.error(err);alert('Failed to upload avatar.')}
  $('pfpIn').value='';
};

function readFile(file){
  return new Promise((res,rej)=>{
    const r=new FileReader();
    r.onload=e=>res(e.target.result);
    r.onerror=rej;
    r.readAsDataURL(file);
  });
}

// ===== SERVERS =====
function loadSrvs(){
  if(unsubs.srvs)unsubs.srvs();
  unsubs.srvs=db.collection('users').doc(me.uid).onSnapshot(async d=>{
    if(!d.exists)return;
    const data=d.data();
    profile={id:me.uid,...data};
    syncUI();
    const ids=data.servers||[];
    if(!ids.length){srvs=[];renderRail();return}
    const docs=await Promise.all(ids.map(id=>db.collection('servers').doc(id).get()));
    srvs=docs.filter(d=>d.exists).map(d=>({id:d.id,...d.data()}));
    renderRail();
  });
}

function renderRail(){
  $('srvList').innerHTML='';
  srvs.forEach(s=>{
    const el=document.createElement('div');
    el.className='ri'+(curSrv===s.id&&!isDm?' active':'');
    el.title=s.name;
    el.textContent=s.name?s.name.split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase():'?';
    const pill=document.createElement('span');pill.className='ri-pill';el.appendChild(pill);
    el.onclick=()=>openSrv(s.id);
    el.oncontextmenu=e=>showCtx(e,s);
    $('srvList').appendChild(el);
  });
}

function openSrv(id){
  isHome=false;isDm=false;curSrv=id;curDm=null;
  renderRail();
  $('homeBtn').classList.remove('active');
  $('chatArea').style.display='flex';
  $('homeArea').style.display='none';
  $('sidebar').style.display='flex';
  $('mbar').style.display=showMbrs?'block':'none';
  $('mbar').classList.toggle('show',showMbrs);
  $('togMbr').style.display='';
  $('chIcon').textContent='#';
  $('chIcon').style.display='';
  const s=srvs.find(x=>x.id===id);
  $('sbTitle').textContent=s?s.name:'Server';
  loadChs(id);loadMbrs(id);
}

$('homeBtn').onclick=()=>goHome();

function goHome(){
  isHome=true;isDm=false;curSrv=null;curCh=null;curDm=null;
  killChannelSubs();
  renderRail();
  $('homeBtn').classList.add('active');
  $('chatArea').style.display='none';
  $('homeArea').style.display='flex';
  $('sidebar').style.display='flex';
  $('sbTitle').textContent='Messages';
  renderHomeSidebar();
  loadDmList();
}

function killChannelSubs(){
  ['chs','msgs','mbrs','typ'].forEach(k=>{if(unsubs[k]){unsubs[k]();unsubs[k]=null}});
}

function renderHomeSidebar(){
  $('sbBody').innerHTML='';
  // "Friends" button
  const sec=document.createElement('div');
  sec.style.padding='4px';
  const fb=document.createElement('div');
  fb.className='ci'+(isHome&&!isDm?' active':'');
  fb.innerHTML='<span class="ci-icon">ðŸ‘‹</span><span class="ci-name">Friends</span>';
  fb.onclick=()=>{
    isDm=false;curDm=null;
    $('chatArea').style.display='none';
    $('homeArea').style.display='flex';
    renderHomeSidebar();
  };
  sec.appendChild(fb);
  $('sbBody').appendChild(sec);

  // DM section header
  const dmSec=document.createElement('div');
  dmSec.className='sb-section';
  dmSec.innerHTML='<span class="sb-section-t">Direct Messages</span>';
  const addDmBtn=document.createElement('button');
  addDmBtn.className='sb-section-btn';addDmBtn.textContent='+';addDmBtn.title='New DM';
  addDmBtn.onclick=()=>{$('moDm').classList.add('show');$('dmUserN').value='';setTimeout(()=>$('dmUserN').focus(),100)};
  dmSec.appendChild(addDmBtn);
  $('sbBody').appendChild(dmSec);

  // DM list
  dmList.forEach(dm=>{
    const other=dm.participants.find(p=>p!==me.uid);
    const item=document.createElement('div');
    item.className='dm-item'+(curDm===dm.id?' active':'');

    const av=document.createElement('div');
    av.className='dm-av ac'+(dm.otherProfile?.avatarColor||0);
    if(dm.otherProfile?.pfp){
      av.innerHTML='<img src="'+dm.otherProfile.pfp+'">';
    }else{
      av.textContent=(dm.otherProfile?.username||'?')[0].toUpperCase();
    }
    const dot=document.createElement('div');
    dot.className='dm-dot '+(dm.otherProfile?.status==='online'?'online':'offline');
    av.appendChild(dot);

    const info=document.createElement('div');
    info.className='dm-info';
    const name=document.createElement('div');
    name.className='dm-name';
    name.textContent=dm.otherProfile?.username||'Unknown';
    info.appendChild(name);

    if(dm.lastMessage){
      const prev=document.createElement('div');
      prev.className='dm-preview';
      prev.textContent=dm.lastMessage.substring(0,40);
      info.appendChild(prev);
    }

    item.appendChild(av);
    item.appendChild(info);
    item.onclick=()=>openDm(dm.id,dm.otherProfile);
    $('sbBody').appendChild(item);
  });
}

// ===== DM SYSTEM =====
function loadDmList(){
  if(unsubs.dms)unsubs.dms();
  unsubs.dms=db.collection('dms')
    .where('participants','array-contains',me.uid)
    .orderBy('updatedAt','desc')
    .onSnapshot(async snap=>{
      const dms=snap.docs.map(d=>({id:d.id,...d.data()}));
      // Load other profiles
      for(const dm of dms){
        const otherId=dm.participants.find(p=>p!==me.uid);
        if(otherId){
          try{
            const userDoc=await db.collection('users').doc(otherId).get();
            dm.otherProfile=userDoc.exists?{id:otherId,...userDoc.data()}:{id:otherId,username:'Unknown',avatarColor:0};
          }catch(e){
            dm.otherProfile={id:otherId,username:'Unknown',avatarColor:0};
          }
        }
      }
      dmList=dms;
      if(isHome)renderHomeSidebar();
    });
}

async function openDm(dmId,otherProfile){
  isDm=true;isHome=true;curDm=dmId;curSrv=null;curCh=null;
  renderRail();
  $('homeBtn').classList.add('active');
  $('chatArea').style.display='flex';
  $('homeArea').style.display='none';
  $('mbar').style.display='none';
  $('togMbr').style.display='none';

  // Set header
  $('chIcon').style.display='none';
  $('chTitle').textContent=otherProfile?.username||'Unknown';
  $('msgIn').placeholder='Message '+($('chTitle').textContent);

  renderHomeSidebar();
  loadDmMessages(dmId);
}

$('xDmMo').onclick=()=>$('moDm').classList.remove('show');

$('startDmBtn').onclick=async()=>{
  const name=$('dmUserN').value.trim();
  if(!name)return;
  $('startDmBtn').disabled=true;
  try{
    // Find user by username
    const snap=await db.collection('users').where('username','==',name).limit(1).get();
    if(snap.empty){alert('User not found.');$('startDmBtn').disabled=false;return}
    const otherDoc=snap.docs[0];
    const otherId=otherDoc.id;
    if(otherId===me.uid){alert("You can't DM yourself.");$('startDmBtn').disabled=false;return}

    // Check if DM already exists
    const existing=dmList.find(dm=>dm.participants.includes(otherId));
    if(existing){
      $('moDm').classList.remove('show');
      openDm(existing.id,existing.otherProfile);
      $('startDmBtn').disabled=false;
      return;
    }

    // Create new DM
    const dmRef=await db.collection('dms').add({
      participants:[me.uid,otherId],
      createdAt:TS(),
      updatedAt:TS(),
      lastMessage:''
    });

    $('moDm').classList.remove('show');
    const otherProfile={id:otherId,...otherDoc.data()};
    openDm(dmRef.id,otherProfile);
  }catch(e){console.error(e);alert('Failed to create DM.')}
  $('startDmBtn').disabled=false;
};

$('dmUserN').onkeydown=e=>{if(e.key==='Enter')$('startDmBtn').click()};

function loadDmMessages(dmId){
  if(unsubs.dmMsgs)unsubs.dmMsgs();
  $('msgScroll').innerHTML='<div class="spin-w"><div class="spin"></div></div>';

  unsubs.dmMsgs=db.collection('dms').doc(dmId)
    .collection('messages').orderBy('createdAt','asc').limitToLast(150)
    .onSnapshot(snap=>{
      const msgs=snap.docs.map(d=>({id:d.id,...d.data()}));
      renderDmMsgs(msgs);
    });
}

function renderDmMsgs(msgs){
  const atBot=isBot();
  $('msgScroll').innerHTML='';

  const w=document.createElement('div');
  w.className='msg-welcome';
  w.innerHTML='<div class="wi">âœ‰ï¸</div><h2>'+esc($('chTitle').textContent)+'</h2><p>This is the beginning of your conversation.</p>';
  $('msgScroll').appendChild(w);

  let lastA=null,lastT=null;

  msgs.forEach(m=>{
    const ng=m.authorId!==lastA||!lastT||!m.createdAt||(m.createdAt.toMillis()-lastT>420000);
    const el=document.createElement('div');
    el.className='mr'+(ng?' ng':'');
    el.dataset.id=m.id;
    const t=m.createdAt?m.createdAt.toDate():new Date();

    // Actions
    let actionsHtml='<div class="mr-actions">';
    if(m.authorId===me.uid){
      actionsHtml+='<button class="mr-act" onclick="startEdit(\''+m.id+'\',this)" title="Edit">âœï¸</button>';
      actionsHtml+='<button class="mr-act danger" onclick="deleteMsg(\''+m.id+'\',true)" title="Delete">ðŸ—‘</button>';
    }
    actionsHtml+='</div>';

    const editedTag=m.edited?'<span class="mr-edited">(edited)</span>':'';

    if(ng){
      const avHtml=m.authorPfp
        ?'<div class="mr-av ac'+(m.avatarColor||0)+'"><img src="'+m.authorPfp+'"></div>'
        :'<div class="mr-av ac'+(m.avatarColor||0)+'">'+esc((m.authorName||'?')[0].toUpperCase())+'</div>';

      el.innerHTML=avHtml+
        '<div class="mr-body"><div class="mr-head"><span class="mr-name">'+esc(m.authorName||'Unknown')+'</span>'+
        '<span class="mr-time">'+fDate(t)+' '+fTime(t)+'</span></div>'+
        (m.text?'<div class="mr-txt" id="mtxt-'+m.id+'">'+fmtTxt(m.text)+editedTag+'</div>':'')+
        '</div>'+actionsHtml;
    }else{
      el.innerHTML='<div class="mr-av hid"></div>'+
        '<div class="mr-body"><span class="mr-hover-t">'+fTime(t)+'</span>'+
        (m.text?'<div class="mr-txt" id="mtxt-'+m.id+'">'+fmtTxt(m.text)+editedTag+'</div>':'')+
        '</div>'+actionsHtml;
    }

    // Image
    if(m.imageId){
      const imgPlaceholder=document.createElement('div');
      imgPlaceholder.style.cssText='width:200px;height:150px;background:var(--bg-3);border-radius:var(--r-md);margin-top:6px;display:flex;align-items:center;justify-content:center';
      imgPlaceholder.innerHTML='<div class="spin"></div>';
      const body=el.querySelector('.mr-body');
      body.appendChild(imgPlaceholder);

      loadImageSrc(m.imageId).then(src=>{
        if(src){
          const img=document.createElement('img');
          img.className='mr-img';
          img.src=src;
          img.onclick=()=>openLb(src);
          img.loading='lazy';
          imgPlaceholder.replaceWith(img);
        }else{
          imgPlaceholder.innerHTML='<span style="color:var(--text-4);font-size:12px">Image unavailable</span>';
        }
      });
    }

    $('msgScroll').appendChild(el);
    lastA=m.authorId;lastT=m.createdAt?m.createdAt.toMillis():Date.now();
  });

  if(atBot||msgs.length===0)scrollEnd();
}

// ===== CREATE/JOIN SERVER =====
$('addSrv').onclick=()=>{
  $('moSrv').classList.add('show');
  $('newSrvN').value=(profile.username||'My')+"'s server";
  $('joinC').value='';
  setTimeout(()=>$('newSrvN').select(),100);
};
$('xSrvMo').onclick=()=>$('moSrv').classList.remove('show');

$('cSrvBtn').onclick=async()=>{
  const n=$('newSrvN').value.trim();if(!n)return;
  $('cSrvBtn').disabled=true;
  try{
    const code=genCode();
    const ref=await db.collection('servers').add({
      name:n,ownerId:me.uid,inviteCode:code,createdAt:TS(),members:[me.uid]
    });
    await db.collection('servers').doc(ref.id).collection('channels').add({name:'general',createdAt:TS()});
    await db.collection('users').doc(me.uid).update({servers:AU(ref.id)});
    $('moSrv').classList.remove('show');
    openSrv(ref.id);
  }catch(e){console.error(e);alert('Failed.')}
  $('cSrvBtn').disabled=false;
};

$('jSrvBtn').onclick=async()=>{
  const c=$('joinC').value.trim();if(!c)return;
  $('jSrvBtn').disabled=true;
  try{
    const snap=await db.collection('servers').where('inviteCode','==',c).limit(1).get();
    if(snap.empty){alert('Invalid invite code.');$('jSrvBtn').disabled=false;return}
    const sd=snap.docs[0],sid=sd.id;
    if((sd.data().members||[]).includes(me.uid)){
      $('moSrv').classList.remove('show');openSrv(sid);$('jSrvBtn').disabled=false;return;
    }
    await db.collection('servers').doc(sid).update({members:AU(me.uid)});
    await db.collection('users').doc(me.uid).update({servers:AU(sid)});
    $('moSrv').classList.remove('show');openSrv(sid);
  }catch(e){console.error(e);alert('Failed.')}
  $('jSrvBtn').disabled=false;
};

function genCode(){
  const c='ABCDEFGHJKMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
  let r='';for(let i=0;i<8;i++)r+=c[Math.floor(Math.random()*c.length)];return r;
}

// ===== CHANNELS =====
function loadChs(sid){
  if(unsubs.chs)unsubs.chs();
  unsubs.chs=db.collection('servers').doc(sid).collection('channels')
    .orderBy('createdAt','asc').onSnapshot(snap=>{
      chs=snap.docs.map(d=>({id:d.id,...d.data()}));
      renderChs();
      if(!curCh||!chs.find(c=>c.id===curCh)){if(chs.length)pickCh(chs[0].id)}
    });
}

function renderChs(){
  const srv=srvs.find(s=>s.id===curSrv);
  $('sbBody').innerHTML='';

  const sec=document.createElement('div');sec.className='sb-section';
  sec.innerHTML='<span class="sb-section-t">Channels</span>';
  if(srv&&srv.ownerId===me.uid){
    const b=document.createElement('button');b.className='sb-section-btn';b.textContent='+';
    b.title='New Channel';
    b.onclick=()=>{$('moChM').classList.add('show');$('newChN').value='';setTimeout(()=>$('newChN').focus(),100)};
    sec.appendChild(b);
  }
  $('sbBody').appendChild(sec);

  chs.forEach(ch=>{
    const el=document.createElement('div');
    el.className='ci'+(curCh===ch.id?' active':'');
    el.innerHTML='<span class="ci-icon">#</span><span class="ci-name">'+esc(ch.name)+'</span>';
    if(srv&&srv.ownerId===me.uid&&chs.length>1){
      const d=document.createElement('button');d.className='ci-x';d.textContent='Ã—';d.title='Delete';
      d.onclick=async e=>{e.stopPropagation();if(confirm('Delete #'+ch.name+'?'))await db.collection('servers').doc(curSrv).collection('channels').doc(ch.id).delete()};
      el.appendChild(d);
    }
    el.onclick=()=>pickCh(ch.id);
    $('sbBody').appendChild(el);
  });
}

function pickCh(id){
  curCh=id;isDm=false;curDm=null;
  const ch=chs.find(c=>c.id===id);
  if(ch){
    $('chTitle').textContent=ch.name;
    $('chIcon').textContent='#';
    $('chIcon').style.display='';
    $('msgIn').placeholder='Message #'+ch.name;
  }
  renderChs();loadMsgs();listenTyp();
}

$('xChMo').onclick=()=>$('moChM').classList.remove('show');
$('cChBtn').onclick=async()=>{
  let n=$('newChN').value.trim().toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-_]/g,'');
  if(!n)return;$('cChBtn').disabled=true;
  try{
    await db.collection('servers').doc(curSrv).collection('channels').add({name:n,createdAt:TS()});
    $('moChM').classList.remove('show');
  }catch(e){console.error(e)}
  $('cChBtn').disabled=false;
};
$('newChN').onkeydown=e=>{if(e.key==='Enter')$('cChBtn').click()};

// ===== SERVER MESSAGES =====
function loadMsgs(){
  if(unsubs.msgs)unsubs.msgs();
  if(!curSrv||!curCh)return;
  $('msgScroll').innerHTML='<div class="spin-w"><div class="spin"></div></div>';
  unsubs.msgs=db.collection('servers').doc(curSrv)
    .collection('channels').doc(curCh)
    .collection('messages').orderBy('createdAt','asc').limitToLast(150)
    .onSnapshot(snap=>renderMsgs(snap.docs.map(d=>({id:d.id,...d.data()}))));
}

function renderMsgs(msgs){
  const ch=chs.find(c=>c.id===curCh);
  const atBot=isBot();
  $('msgScroll').innerHTML='';

  const w=document.createElement('div');w.className='msg-welcome';
  w.innerHTML='<div class="wi">#</div><h2>Welcome to #'+esc(ch?ch.name:'channel')+'</h2><p>This is the beginning of #'+esc(ch?ch.name:'channel')+'. Say hi! ðŸ‘‹</p>';
  $('msgScroll').appendChild(w);

  let lastA=null,lastT=null;

  msgs.forEach(m=>{
    const ng=m.authorId!==lastA||!lastT||!m.createdAt||(m.createdAt.toMillis()-lastT>420000);
    const el=document.createElement('div');
    el.className='mr'+(ng?' ng':'');
    el.dataset.id=m.id;
    const t=m.createdAt?m.createdAt.toDate():new Date();

    // Actions
    let actionsHtml='<div class="mr-actions">';
    if(m.authorId===me.uid){
      actionsHtml+='<button class="mr-act" onclick="startEdit(\''+m.id+'\',this)" title="Edit">âœï¸</button>';
      actionsHtml+='<button class="mr-act danger" onclick="deleteMsg(\''+m.id+'\',false)" title="Delete">ðŸ—‘</button>';
    }
    const srv=srvs.find(s=>s.id===curSrv);
    if(srv&&srv.ownerId===me.uid&&m.authorId!==me.uid){
      actionsHtml+='<button class="mr-act danger" onclick="deleteMsg(\''+m.id+'\',false)" title="Delete">ðŸ—‘</button>';
    }
    actionsHtml+='</div>';

    const editedTag=m.edited?'<span class="mr-edited">(edited)</span>':'';

    if(ng){
      const avHtml=m.authorPfp
        ?'<div class="mr-av ac'+(m.avatarColor||0)+'"><img src="'+m.authorPfp+'"></div>'
        :'<div class="mr-av ac'+(m.avatarColor||0)+'">'+esc((m.authorName||'?')[0].toUpperCase())+'</div>';

      el.innerHTML=avHtml+
        '<div class="mr-body"><div class="mr-head"><span class="mr-name">'+esc(m.authorName||'Unknown')+'</span>'+
        '<span class="mr-time">'+fDate(t)+' '+fTime(t)+'</span></div>'+
        (m.text?'<div class="mr-txt" id="mtxt-'+m.id+'">'+fmtTxt(m.text)+editedTag+'</div>':'')+
        '</div>'+actionsHtml;
    }else{
      el.innerHTML='<div class="mr-av hid"></div>'+
        '<div class="mr-body"><span class="mr-hover-t">'+fTime(t)+'</span>'+
        (m.text?'<div class="mr-txt" id="mtxt-'+m.id+'">'+fmtTxt(m.text)+editedTag+'</div>':'')+
        '</div>'+actionsHtml;
    }

    // Image
    if(m.imageId){
      const imgPlaceholder=document.createElement('div');
      imgPlaceholder.style.cssText='width:200px;height:150px;background:var(--bg-3);border-radius:var(--r-md);margin-top:6px;display:flex;align-items:center;justify-content:center';
      imgPlaceholder.innerHTML='<div class="spin"></div>';
      const body=el.querySelector('.mr-body');
      body.appendChild(imgPlaceholder);

      loadImageSrc(m.imageId).then(src=>{
        if(src){
          const img=document.createElement('img');
          img.className='mr-img';img.src=src;
          img.onclick=()=>openLb(src);img.loading='lazy';
          imgPlaceholder.replaceWith(img);
        }else{
          imgPlaceholder.innerHTML='<span style="color:var(--text-4);font-size:12px">Image unavailable</span>';
        }
      });
    }

    $('msgScroll').appendChild(el);
    lastA=m.authorId;lastT=m.createdAt?m.createdAt.toMillis():Date.now();
  });

  if(atBot||msgs.length===0)scrollEnd();
}

// ===== EDIT & DELETE MESSAGES =====
window.startEdit=function(msgId,btn){
  const txtEl=document.getElementById('mtxt-'+msgId);
  if(!txtEl)return;

  // Get original text from Firestore
  const collection=isDm
    ?db.collection('dms').doc(curDm).collection('messages')
    :db.collection('servers').doc(curSrv).collection('channels').doc(curCh).collection('messages');

  collection.doc(msgId).get().then(doc=>{
    if(!doc.exists)return;
    const originalText=doc.data().text||'';

    const editBox=document.createElement('div');
    editBox.className='mr-edit-box';
    editBox.innerHTML='<textarea>'+esc(originalText)+'</textarea><div class="edit-hint">Escape to cancel Â· Enter to save</div>';

    txtEl.style.display='none';
    txtEl.parentElement.insertBefore(editBox,txtEl.nextSibling);

    const ta=editBox.querySelector('textarea');
    ta.focus();
    ta.selectionStart=ta.value.length;
    ta.style.height=ta.scrollHeight+'px';

    ta.oninput=()=>{ta.style.height='auto';ta.style.height=ta.scrollHeight+'px'};

    ta.onkeydown=async e=>{
      if(e.key==='Escape'){
        editBox.remove();txtEl.style.display='';
      }else if(e.key==='Enter'&&!e.shiftKey){
        e.preventDefault();
        const newText=ta.value.trim();
        if(!newText){
          editBox.remove();txtEl.style.display='';return;
        }
        if(newText===originalText){
          editBox.remove();txtEl.style.display='';return;
        }
        try{
          await collection.doc(msgId).update({text:newText,edited:true});
        }catch(err){console.error(err)}
        editBox.remove();txtEl.style.display='';
      }
    };
  });
};

window.deleteMsg=async function(msgId,isDmMsg){
  if(!confirm('Delete this message?'))return;
  try{
    if(isDmMsg||isDm){
      await db.collection('dms').doc(curDm).collection('messages').doc(msgId).delete();
    }else{
      await db.collection('servers').doc(curSrv).collection('channels').doc(curCh).collection('messages').doc(msgId).delete();
    }
  }catch(e){console.error(e)}
};

// ===== SEND =====
$('msgIn').onkeydown=e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send()}};
$('sendBtn').onclick=()=>send();

async function send(){
  const text=$('msgIn').value.trim();
  const hasFile=!!pendingFile;
  if(!text&&!hasFile)return;

  $('msgIn').value='';autoResize();

  const file=pendingFile;
  clearPreview();

  try{
    const msgObj={
      authorId:me.uid,
      authorName:profile.username,
      avatarColor:profile.avatarColor||0,
      authorPfp:profile.pfp||null,
      createdAt:TS(),
      edited:false
    };

    if(text)msgObj.text=text;

    if(file){
      const imageId=await uploadImage(file);
      msgObj.imageId=imageId;
    }

    if(isDm&&curDm){
      await db.collection('dms').doc(curDm).collection('messages').add(msgObj);
      await db.collection('dms').doc(curDm).update({
        updatedAt:TS(),
        lastMessage:text||'ðŸ“· Image'
      });
    }else if(curSrv&&curCh){
      await db.collection('servers').doc(curSrv)
        .collection('channels').doc(curCh)
        .collection('messages').add(msgObj);
      clearTyp();
    }
  }catch(e){console.error(e);alert('Failed to send.')}
}

$('msgIn').oninput=()=>{autoResize();if(!isDm)setTyp()};
function autoResize(){$('msgIn').style.height='auto';$('msgIn').style.height=Math.min($('msgIn').scrollHeight,200)+'px'}

// ===== IMAGE ATTACH =====
$('attachBtn').onclick=()=>$('fileIn').click();

$('fileIn').onchange=e=>{
  const file=e.target.files[0];
  if(!file)return;
  pendingFile=file;
  const reader=new FileReader();
  reader.onload=ev=>showPreview(ev.target.result);
  reader.readAsDataURL(file);
  $('fileIn').value='';
};

function showPreview(src){
  $('inPrev').classList.add('show');
  $('inBox').classList.add('has-preview');
  $('prevInner').innerHTML='<img src="'+src+'"><div class="in-preview-x" onclick="clearPreview()">Ã—</div>';
}

window.clearPreview=function(){
  pendingFile=null;
  $('inPrev').classList.remove('show');
  $('inBox').classList.remove('has-preview');
  $('prevInner').innerHTML='';
};

// Paste image
$('msgIn').addEventListener('paste',e=>{
  const items=e.clipboardData?.items;
  if(!items)return;
  for(const item of items){
    if(item.type.startsWith('image/')){
      e.preventDefault();
      const file=item.getAsFile();
      pendingFile=file;
      const reader=new FileReader();
      reader.onload=ev=>showPreview(ev.target.result);
      reader.readAsDataURL(file);
      break;
    }
  }
});

// Drag & drop
const inArea=document.querySelector('.in-area');
if(inArea){
  ['dragenter','dragover'].forEach(ev=>inArea.addEventListener(ev,e=>{
    e.preventDefault();e.stopPropagation();
    $('inBox').style.borderColor='var(--accent)';
    $('inBox').style.boxShadow='0 0 0 3px var(--accent-bg)';
  }));
  ['dragleave','drop'].forEach(ev=>inArea.addEventListener(ev,e=>{
    e.preventDefault();e.stopPropagation();
    $('inBox').style.borderColor='';$('inBox').style.boxShadow='';
  }));
  inArea.addEventListener('drop',e=>{
    const file=e.dataTransfer?.files?.[0];
    if(!file||!file.type.startsWith('image/'))return;
    pendingFile=file;
    const reader=new FileReader();
    reader.onload=ev=>showPreview(ev.target.result);
    reader.readAsDataURL(file);
  });
}

// ===== LIGHTBOX =====
function openLb(src){$('lbImg').src=src;$('lb').classList.add('show')}
window.openLb=openLb;
$('lb').onclick=()=>$('lb').classList.remove('show');

// ===== TYPING =====
function setTyp(){
  if(!curSrv||!curCh||isDm)return;
  const ref=db.collection('servers').doc(curSrv).collection('channels').doc(curCh).collection('typing').doc(me.uid);
  ref.set({username:profile.username,timestamp:TS()});
  if(typTimer)clearTimeout(typTimer);
  typTimer=setTimeout(()=>ref.delete().catch(()=>{}),5000);
}

function clearTyp(){
  if(!curSrv||!curCh||isDm)return;
  db.collection('servers').doc(curSrv).collection('channels').doc(curCh).collection('typing').doc(me.uid).delete().catch(()=>{});
  if(typTimer)clearTimeout(typTimer);
}

function listenTyp(){
  if(unsubs.typ)unsubs.typ();
  if(!curSrv||!curCh||isDm)return;
  unsubs.typ=db.collection('servers').doc(curSrv).collection('channels').doc(curCh).collection('typing')
    .onSnapshot(snap=>{
      const now=Date.now(),names=[];
      snap.docs.forEach(d=>{
        if(d.id===me.uid)return;
        const data=d.data();
        if(data.timestamp&&(now-data.timestamp.toMillis()<8000))names.push(data.username);
      });
      if(!names.length)$('typBar').innerHTML='';
      else if(names.length===1)$('typBar').innerHTML='<div class="td"><span></span><span></span><span></span></div><strong>'+esc(names[0])+'</strong> is typingâ€¦';
      else $('typBar').innerHTML='<div class="td"><span></span><span></span><span></span></div><strong>'+names.map(esc).join(', ')+'</strong> are typingâ€¦';
    });
}

// ===== MEMBERS =====
function loadMbrs(sid){
  if(unsubs.mbrs)unsubs.mbrs();
  unsubs.mbrs=db.collection('servers').doc(sid).onSnapshot(async doc=>{
    if(!doc.exists)return;
    const ids=doc.data().members||[];
    if(!ids.length){mbrs=[];renderMbrs();return}
    const all=[];
    for(let i=0;i<ids.length;i+=10){
      const batch=ids.slice(i,i+10);
      const s=await db.collection('users').where(FP.documentId(),'in',batch).get();
      s.docs.forEach(d=>all.push({id:d.id,...d.data()}));
    }
    mbrs=all;renderMbrs();
  });
}

function renderMbrs(){
  $('mbar').innerHTML='';
  const on=mbrs.filter(m=>m.status==='online');
  const rest=mbrs.filter(m=>m.status!=='online');

  if(on.length){
    const c=document.createElement('div');c.className='mbar-cat';c.textContent='ONLINE â€” '+on.length;
    $('mbar').appendChild(c);
    on.forEach(m=>$('mbar').appendChild(mkMbr(m,'online')));
  }
  if(rest.length){
    const c=document.createElement('div');c.className='mbar-cat';c.textContent='OFFLINE â€” '+rest.length;
    $('mbar').appendChild(c);
    rest.forEach(m=>$('mbar').appendChild(mkMbr(m,'offline')));
  }
}

function mkMbr(m,st){
  const el=document.createElement('div');
  el.className='mbar-i'+(st==='offline'?' off':'');

  const av=document.createElement('div');
  av.className='mbar-av ac'+(m.avatarColor||0);
  if(m.pfp){
    av.innerHTML='<img src="'+m.pfp+'">';
  }else{
    av.textContent=(m.username||'?')[0].toUpperCase();
  }
  const dot=document.createElement('div');
  dot.className='mbar-dot '+st;
  av.appendChild(dot);

  const name=document.createElement('span');
  name.className='mbar-n';name.textContent=m.username||'Unknown';

  el.appendChild(av);el.appendChild(name);

  // Click to DM
  el.onclick=async()=>{
    if(m.id===me.uid)return;
    // Check if DM exists
    const existing=dmList.find(dm=>dm.participants.includes(m.id));
    if(existing){
      goHome();
      setTimeout(()=>openDm(existing.id,existing.otherProfile),100);
      return;
    }
    // Create DM
    try{
      const dmRef=await db.collection('dms').add({
        participants:[me.uid,m.id],createdAt:TS(),updatedAt:TS(),lastMessage:''
      });
      goHome();
      setTimeout(()=>openDm(dmRef.id,m),100);
    }catch(e){console.error(e)}
  };

  return el;
}

$('togMbr').onclick=()=>{
  showMbrs=!showMbrs;
  $('mbar').classList.toggle('show',showMbrs);
  $('togMbr').classList.toggle('on',showMbrs);
};

// ===== CTX MENU =====
function showCtx(e,srv){
  e.preventDefault();
  const own=srv.ownerId===me.uid;
  $('ctxDel').style.display=own?'flex':'none';
  $('ctxLeave').style.display=own?'none':'flex';
  const cm=$('ctx');
  cm.style.display='block';
  cm.style.left=e.clientX+'px';cm.style.top=e.clientY+'px';
  cm.dataset.sid=srv.id;
  requestAnimationFrame(()=>{
    const r=cm.getBoundingClientRect();
    if(r.right>innerWidth)cm.style.left=(innerWidth-r.width-8)+'px';
    if(r.bottom>innerHeight)cm.style.top=(innerHeight-r.height-8)+'px';
  });
}

document.addEventListener('click',()=>$('ctx').style.display='none');

$('sbMenu').onclick=e=>{
  if(!curSrv||isDm)return;
  const s=srvs.find(x=>x.id===curSrv);
  if(s)showCtx(e,s);
};

$('ctxInv').onclick=()=>{
  const s=srvs.find(x=>x.id===$('ctx').dataset.sid);
  if(s){$('invCode').textContent=s.inviteCode;$('moInv').classList.add('show')}
};

$('cpInv').onclick=()=>{
  navigator.clipboard.writeText($('invCode').textContent);
  $('cpInv').textContent='Copied!';
  setTimeout(()=>$('cpInv').textContent='Copy',2000);
};

$('xInvMo').onclick=()=>$('moInv').classList.remove('show');

$('ctxNCh').onclick=()=>{
  curSrv=$('ctx').dataset.sid;
  $('moChM').classList.add('show');$('newChN').value='';
  setTimeout(()=>$('newChN').focus(),100);
};

$('ctxLeave').onclick=async()=>{
  const sid=$('ctx').dataset.sid;
  const s=srvs.find(x=>x.id===sid);
  if(!confirm('Leave "'+s?.name+'"?'))return;
  try{
    await db.collection('servers').doc(sid).update({members:AR(me.uid)});
    await db.collection('users').doc(me.uid).update({servers:AR(sid)});
    if(curSrv===sid)goHome();
  }catch(e){console.error(e)}
};

$('ctxDel').onclick=async()=>{
  const sid=$('ctx').dataset.sid;
  const s=srvs.find(x=>x.id===sid);
  if(!confirm('Delete "'+s?.name+'" permanently?'))return;
  try{
    const sd=await db.collection('servers').doc(sid).get();
    const mids=sd.data().members||[];
    for(const uid of mids)await db.collection('users').doc(uid).update({servers:AR(sid)});
    const cs=await db.collection('servers').doc(sid).collection('channels').get();
    for(const ch of cs.docs){
      const ms=await db.collection('servers').doc(sid).collection('channels').doc(ch.id).collection('messages').get();
      for(const m of ms.docs)await m.ref.delete();
      const ts=await db.collection('servers').doc(sid).collection('channels').doc(ch.id).collection('typing').get();
      for(const t of ts.docs)await t.ref.delete();
      await ch.ref.delete();
    }
    await db.collection('servers').doc(sid).delete();
    if(curSrv===sid)goHome();
  }catch(e){console.error(e)}
};

// ===== SETTINGS =====
$('setBtn').onclick=()=>{$('setO').classList.add('show');$('editN').value=profile.username;setTimeout(()=>$('editN').focus(),150)};
$('xSet').onclick=()=>$('setO').classList.remove('show');

$('savePf').onclick=async()=>{
  const n=$('editN').value.trim();if(!n)return;
  try{
    await db.collection('users').doc(me.uid).update({username:n});
    profile.username=n;syncUI();
    $('setO').classList.remove('show');
  }catch(e){console.error(e)}
};

$('logoutBtn').onclick=async()=>{
  $('setO').classList.remove('show');
  try{await db.collection('users').doc(me.uid).update({status:'offline'})}catch(e){}
  auth.signOut();
};

// ===== TEXT FORMAT =====
function fmtTxt(t){
  let s=esc(t);
  s=s.replace(/```([\s\S]*?)```/g,'<pre><code>$1</code></pre>');
  s=s.replace(/`([^`]+)`/g,'<code>$1</code>');
  s=s.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  s=s.replace(/\*(.+?)\*/g,'<em>$1</em>');
  s=s.replace(/__(.+?)__/g,'<u>$1</u>');
  s=s.replace(/~~(.+?)~~/g,'<s>$1</s>');
  s=s.replace(/(https?:\/\/[^\s<]+)/g,'<a href="$1" target="_blank" rel="noopener">$1</a>');
  return s;
}

// ===== UTILS =====
function esc(s){if(!s)return'';const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function fTime(d){return d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}
function fDate(d){
  const today=new Date(),y=new Date(today);y.setDate(y.getDate()-1);
  if(d.toDateString()===today.toDateString())return'Today';
  if(d.toDateString()===y.toDateString())return'Yesterday';
  return d.toLocaleDateString(undefined,{month:'short',day:'numeric'});
}

function isBot(){return $('msgScroll').scrollHeight-$('msgScroll').scrollTop-$('msgScroll').clientHeight<120}
function scrollEnd(){requestAnimationFrame(()=>{$('msgScroll').scrollTop=$('msgScroll').scrollHeight})}

// Close modals
document.querySelectorAll('.mo').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('show')}));
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){
    document.querySelectorAll('.mo.show').forEach(m=>m.classList.remove('show'));
    $('setO').classList.remove('show');
    $('lb').classList.remove('show');
  }
});

// Online/offline
document.addEventListener('visibilitychange',()=>{
  if(!me)return;
  db.collection('users').doc(me.uid).update({status:document.hidden?'idle':'online'}).catch(()=>{});
});

window.addEventListener('beforeunload',()=>{
  if(me)db.collection('users').doc(me.uid).update({status:'offline'}).catch(()=>{});
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}

:root{
  --bg-0:#000000;
  --bg-1:#0a0a0a;
  --bg-2:#111111;
  --bg-3:#1a1a1a;
  --bg-4:#222222;
  --bg-5:#2a2a2a;
  --bg-hover:rgba(255,255,255,0.04);
  --bg-active:rgba(255,255,255,0.08);
  --bg-elevated:#1c1c1e;
  --border:#2a2a2a;
  --border-light:#333;
  --text-primary:#f5f5f7;
  --text-secondary:#a1a1a6;
  --text-tertiary:#6e6e73;
  --text-quaternary:#48484a;
  --accent:#0a84ff;
  --accent-hover:#409cff;
  --accent-dim:rgba(10,132,255,0.15);
  --green:#30d158;
  --red:#ff453a;
  --orange:#ff9f0a;
  --yellow:#ffd60a;
  --purple:#bf5af2;
  --pink:#ff375f;
  --teal:#64d2ff;
  --shadow-sm:0 1px 3px rgba(0,0,0,0.4);
  --shadow-md:0 4px 16px rgba(0,0,0,0.5);
  --shadow-lg:0 12px 40px rgba(0,0,0,0.6);
  --radius-sm:8px;
  --radius-md:12px;
  --radius-lg:16px;
  --radius-xl:20px;
  --radius-full:9999px;
  --transition:0.2s cubic-bezier(0.25,0.1,0.25,1);
}

body{
  font-family:'Inter',-apple-system,BlinkMacSystemFont,'SF Pro Display',sans-serif;
  background:var(--bg-0);
  color:var(--text-primary);
  height:100vh;
  overflow:hidden;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  letter-spacing:-0.01em;
}

::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--bg-5);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--border-light)}

::selection{background:var(--accent);color:white}

/* ===== AUTH ===== */
.auth-container{
  display:flex;align-items:center;justify-content:center;
  height:100vh;
  background:var(--bg-0);
  position:relative;overflow:hidden;
}

.auth-bg{
  position:absolute;inset:0;
  background:radial-gradient(ellipse at 30% 20%,rgba(10,132,255,0.08) 0%,transparent 50%),
             radial-gradient(ellipse at 70% 80%,rgba(191,90,242,0.06) 0%,transparent 50%);
}

.auth-box{
  position:relative;
  background:var(--bg-2);
  border:1px solid var(--border);
  border-radius:var(--radius-xl);
  padding:48px 40px;
  width:420px;max-width:92vw;
  box-shadow:var(--shadow-lg);
  backdrop-filter:blur(40px);
}

.auth-logo{
  width:48px;height:48px;
  background:var(--accent);
  border-radius:var(--radius-md);
  display:flex;align-items:center;justify-content:center;
  margin:0 auto 24px;
  font-size:24px;font-weight:700;color:white;
}

.auth-box h2{
  color:var(--text-primary);text-align:center;
  margin-bottom:4px;font-size:26px;font-weight:700;
  letter-spacing:-0.03em;
}

.auth-box .subtitle{
  color:var(--text-secondary);text-align:center;
  margin-bottom:28px;font-size:15px;font-weight:400;
}

.form-group{margin-bottom:18px}

.form-group label{
  display:block;color:var(--text-secondary);
  font-size:13px;font-weight:500;
  margin-bottom:6px;letter-spacing:0;
}

.form-group input{
  width:100%;padding:12px 16px;
  background:var(--bg-3);
  border:1px solid var(--border);
  border-radius:var(--radius-sm);
  color:var(--text-primary);
  font-size:15px;font-family:inherit;
  outline:none;transition:all var(--transition);
}

.form-group input:focus{
  border-color:var(--accent);
  box-shadow:0 0 0 3px var(--accent-dim);
}

.form-group input::placeholder{color:var(--text-quaternary)}

.btn-primary{
  width:100%;padding:13px;
  background:var(--accent);color:white;
  border:none;border-radius:var(--radius-sm);
  font-size:15px;font-weight:600;font-family:inherit;
  cursor:pointer;transition:all var(--transition);
  margin-top:4px;letter-spacing:-0.01em;
}

.btn-primary:hover{background:var(--accent-hover);transform:translateY(-1px);box-shadow:0 4px 12px rgba(10,132,255,0.3)}
.btn-primary:active{transform:translateY(0)}
.btn-primary:disabled{opacity:0.5;cursor:not-allowed;transform:none}

.auth-switch{
  margin-top:20px;font-size:14px;
  color:var(--text-secondary);text-align:center;
}

.auth-switch a{
  color:var(--accent);cursor:pointer;
  text-decoration:none;font-weight:500;
}

.auth-switch a:hover{text-decoration:underline}

.error-msg{
  background:rgba(255,69,58,0.1);
  border:1px solid rgba(255,69,58,0.2);
  color:var(--red);padding:10px 14px;
  border-radius:var(--radius-sm);
  margin-bottom:16px;font-size:13px;
  display:none;font-weight:500;
}

/* ===== APP LAYOUT ===== */
.app-container{display:none;height:100vh}
.app-layout{display:flex;height:100%}

/* ===== SERVER RAIL ===== */
.server-rail{
  width:68px;
  background:var(--bg-1);
  display:flex;flex-direction:column;
  align-items:center;
  padding:12px 0;gap:2px;
  overflow-y:auto;flex-shrink:0;
  border-right:1px solid var(--border);
}

.server-rail::-webkit-scrollbar{display:none}

.srv-icon{
  width:44px;height:44px;
  border-radius:var(--radius-full);
  background:var(--bg-3);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;
  transition:all var(--transition);
  color:var(--text-secondary);
  font-weight:600;font-size:15px;
  position:relative;flex-shrink:0;
  border:1px solid transparent;
}

.srv-icon:hover{
  background:var(--bg-4);
  border-radius:var(--radius-md);
  color:var(--text-primary);
}

.srv-icon.active{
  background:var(--accent);
  border-radius:var(--radius-md);
  color:white;
}

.srv-icon.home-icon{
  background:linear-gradient(135deg,var(--accent),var(--purple));
  color:white;margin-bottom:4px;
}

.srv-icon.home-icon:hover{opacity:0.85}
.srv-icon.home-icon.active{opacity:1;box-shadow:0 0 0 2px var(--accent)}

.srv-icon.add-icon{
  background:transparent;
  border:1.5px dashed var(--border-light);
  color:var(--text-tertiary);font-size:20px;
  margin-top:2px;
}

.srv-icon.add-icon:hover{
  border-color:var(--accent);
  color:var(--accent);
  background:var(--accent-dim);
  border-radius:var(--radius-md);
}

.srv-pill{
  position:absolute;left:-10px;
  width:4px;height:0;
  background:var(--text-primary);
  border-radius:0 4px 4px 0;
  transition:height var(--transition);
}

.srv-icon:hover .srv-pill{height:16px}
.srv-icon.active .srv-pill{height:32px}

.srv-divider{
  width:28px;height:1px;
  background:var(--border);
  margin:6px 0;flex-shrink:0;
}

/* ===== CHANNEL SIDEBAR ===== */
.channel-sidebar{
  width:260px;background:var(--bg-1);
  display:flex;flex-direction:column;flex-shrink:0;
  border-right:1px solid var(--border);
}

.sidebar-header{
  height:52px;padding:0 16px;
  display:flex;align-items:center;justify-content:space-between;
  border-bottom:1px solid var(--border);
  flex-shrink:0;
}

.sidebar-header h3{
  font-size:15px;font-weight:700;
  color:var(--text-primary);
  letter-spacing:-0.02em;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}

.sidebar-header-btn{
  background:none;border:none;
  color:var(--text-tertiary);cursor:pointer;
  font-size:18px;padding:4px;border-radius:var(--radius-sm);
  transition:all var(--transition);
  display:flex;align-items:center;justify-content:center;
  width:28px;height:28px;
}

.sidebar-header-btn:hover{background:var(--bg-hover);color:var(--text-primary)}

.channel-list{
  flex:1;overflow-y:auto;padding:8px;
}

.ch-section{
  padding:16px 8px 4px;
  display:flex;align-items:center;justify-content:space-between;
}

.ch-section-title{
  font-size:11px;font-weight:700;
  text-transform:uppercase;letter-spacing:0.06em;
  color:var(--text-tertiary);
}

.ch-section-btn{
  background:none;border:none;color:var(--text-quaternary);
  cursor:pointer;font-size:15px;padding:0;
  transition:color var(--transition);
  width:16px;height:16px;display:flex;align-items:center;justify-content:center;
}

.ch-section-btn:hover{color:var(--text-secondary)}

.ch-item{
  display:flex;align-items:center;
  padding:7px 10px;border-radius:var(--radius-sm);
  cursor:pointer;gap:8px;
  color:var(--text-secondary);
  transition:all var(--transition);
  margin:1px 0;font-size:14px;font-weight:500;
}

.ch-item:hover{background:var(--bg-hover);color:var(--text-primary)}
.ch-item.active{background:var(--bg-active);color:var(--text-primary)}

.ch-item .ch-hash{
  font-size:17px;font-weight:400;
  color:var(--text-quaternary);flex-shrink:0;
  width:20px;text-align:center;
}

.ch-item.active .ch-hash{color:var(--text-tertiary)}

.ch-item .ch-name{
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}

.ch-item .ch-del{
  margin-left:auto;display:none;
  background:none;border:none;
  color:var(--text-quaternary);cursor:pointer;
  font-size:14px;padding:2px;
  border-radius:4px;transition:all var(--transition);
}

.ch-item:hover .ch-del{display:flex}
.ch-item .ch-del:hover{color:var(--red);background:rgba(255,69,58,0.1)}

/* ===== USER BAR ===== */
.user-bar{
  padding:8px 12px;
  display:flex;align-items:center;gap:10px;
  border-top:1px solid var(--border);
  flex-shrink:0;
}

.user-bar-avatar{
  width:32px;height:32px;border-radius:var(--radius-full);
  display:flex;align-items:center;justify-content:center;
  font-weight:600;font-size:13px;color:white;flex-shrink:0;
  position:relative;
}

.user-bar-status{
  position:absolute;bottom:-1px;right:-1px;
  width:10px;height:10px;border-radius:50%;
  border:2px solid var(--bg-1);
  background:var(--green);
}

.user-bar-info{flex:1;min-width:0}

.user-bar-info .name{
  font-size:13px;font-weight:600;
  color:var(--text-primary);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}

.user-bar-info .status-text{
  font-size:11px;color:var(--text-tertiary);font-weight:400;
}

.user-bar-btn{
  background:none;border:none;
  color:var(--text-tertiary);cursor:pointer;
  padding:6px;border-radius:var(--radius-sm);
  transition:all var(--transition);font-size:16px;
  display:flex;align-items:center;
}

.user-bar-btn:hover{background:var(--bg-hover);color:var(--text-primary)}

/* ===== CHAT AREA ===== */
.chat-area{
  flex:1;display:flex;flex-direction:column;
  min-width:0;background:var(--bg-2);
}

.chat-header{
  height:52px;padding:0 20px;
  display:flex;align-items:center;
  border-bottom:1px solid var(--border);
  flex-shrink:0;gap:10px;
}

.chat-header .ch-icon{
  color:var(--text-quaternary);font-size:20px;
}

.chat-header .ch-title{
  font-weight:600;color:var(--text-primary);
  font-size:15px;letter-spacing:-0.02em;
}

.chat-header-actions{
  margin-left:auto;display:flex;gap:2px;
}

.chat-header-btn{
  background:none;border:none;
  color:var(--text-tertiary);cursor:pointer;
  padding:6px 8px;border-radius:var(--radius-sm);
  font-size:17px;transition:all var(--transition);
  display:flex;align-items:center;
}

.chat-header-btn:hover{background:var(--bg-hover);color:var(--text-primary)}
.chat-header-btn.active{color:var(--accent);background:var(--accent-dim)}

/* ===== MESSAGES ===== */
.chat-body{display:flex;flex:1;min-height:0}

.messages-col{
  flex:1;display:flex;flex-direction:column;min-width:0;
}

.messages-scroll{
  flex:1;overflow-y:auto;padding:16px 0;
  display:flex;flex-direction:column;
}

.msg-welcome{
  padding:24px 24px 16px;
}

.msg-welcome .icon{
  width:56px;height:56px;
  background:var(--bg-4);
  border-radius:var(--radius-lg);
  display:flex;align-items:center;justify-content:center;
  font-size:28px;color:var(--text-tertiary);margin-bottom:12px;
}

.msg-welcome h2{
  font-size:24px;font-weight:700;
  color:var(--text-primary);margin-bottom:6px;
  letter-spacing:-0.03em;
}

.msg-welcome p{
  font-size:14px;color:var(--text-tertiary);
  line-height:1.5;
}

.msg-group{
  padding:3px 24px;display:flex;gap:14px;
  position:relative;
}

.msg-group:hover{background:var(--bg-hover)}

.msg-group.new-group{
  margin-top:14px;padding-top:6px;
}

.msg-av{
  width:36px;height:36px;border-radius:var(--radius-full);
  display:flex;align-items:center;justify-content:center;
  font-weight:600;color:white;font-size:14px;
  flex-shrink:0;cursor:pointer;
  transition:opacity var(--transition);
}

.msg-av:hover{opacity:0.8}
.msg-av.hide{visibility:hidden}

.msg-body{flex:1;min-width:0}

.msg-head{
  display:flex;align-items:baseline;gap:8px;
  margin-bottom:2px;
}

.msg-author{
  font-weight:600;font-size:14px;
  color:var(--text-primary);cursor:pointer;
  letter-spacing:-0.01em;
}

.msg-author:hover{text-decoration:underline}

.msg-time{
  font-size:11px;color:var(--text-quaternary);
  font-weight:400;
}

.msg-text{
  font-size:14.5px;line-height:1.5;
  color:var(--text-primary);
  word-wrap:break-word;white-space:pre-wrap;
  font-weight:400;
}

.msg-text strong{font-weight:700}
.msg-text em{font-style:italic}
.msg-text code{
  background:var(--bg-4);padding:2px 6px;
  border-radius:4px;font-family:'SF Mono','Fira Code',monospace;
  font-size:13px;
}
.msg-text pre{
  background:var(--bg-3);padding:12px 16px;
  border-radius:var(--radius-sm);margin:6px 0;
  overflow-x:auto;border:1px solid var(--border);
}
.msg-text pre code{background:none;padding:0}
.msg-text a{color:var(--accent);text-decoration:none}
.msg-text a:hover{text-decoration:underline}

.msg-image{
  max-width:400px;max-height:300px;
  border-radius:var(--radius-md);
  margin-top:6px;cursor:pointer;
  transition:opacity var(--transition);
  border:1px solid var(--border);
}

.msg-image:hover{opacity:0.9}

.msg-hover-time{
  position:absolute;left:4px;
  font-size:10px;color:var(--text-quaternary);
  display:none;width:50px;text-align:right;
  font-weight:400;padding-top:2px;
}

.msg-group:hover .msg-hover-time{display:block}

/* ===== IMAGE LIGHTBOX ===== */
.lightbox{
  position:fixed;inset:0;z-index:3000;
  background:rgba(0,0,0,0.85);
  display:none;align-items:center;justify-content:center;
  cursor:zoom-out;
  backdrop-filter:blur(20px);
}

.lightbox.show{display:flex}

.lightbox img{
  max-width:92vw;max-height:92vh;
  border-radius:var(--radius-md);
  box-shadow:var(--shadow-lg);
}

/* ===== TYPING ===== */
.typing-bar{
  padding:2px 24px;height:22px;
  font-size:12px;color:var(--text-tertiary);
  display:flex;align-items:center;gap:4px;
  flex-shrink:0;font-weight:400;
}

.typing-dots{display:inline-flex;gap:2px;margin-right:2px}
.typing-dots span{
  width:4px;height:4px;background:var(--text-tertiary);
  border-radius:50%;animation:tdot 1.4s infinite;
}
.typing-dots span:nth-child(2){animation-delay:.2s}
.typing-dots span:nth-child(3){animation-delay:.4s}

@keyframes tdot{
  0%,60%,100%{transform:translateY(0)}
  30%{transform:translateY(-3px)}
}

/* ===== MESSAGE INPUT ===== */
.input-area{
  padding:0 20px 20px;flex-shrink:0;
}

.input-box{
  background:var(--bg-3);
  border:1px solid var(--border);
  border-radius:var(--radius-md);
  display:flex;align-items:flex-end;
  padding:4px 4px 4px 6px;
  transition:border-color var(--transition);
}

.input-box:focus-within{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-dim)}

.input-btn{
  background:none;border:none;
  color:var(--text-quaternary);cursor:pointer;
  padding:8px;border-radius:var(--radius-sm);
  font-size:18px;transition:all var(--transition);
  display:flex;align-items:center;justify-content:center;
  flex-shrink:0;
}

.input-btn:hover{color:var(--text-secondary);background:var(--bg-hover)}

.input-textarea{
  flex:1;background:none;border:none;
  color:var(--text-primary);font-size:14.5px;
  padding:8px 8px;outline:none;font-family:inherit;
  resize:none;max-height:200px;min-height:20px;
  line-height:1.4;letter-spacing:-0.01em;
}

.input-textarea::placeholder{color:var(--text-quaternary)}

/* Image preview in input */
.input-preview{
  display:none;padding:8px 8px 4px;
}

.input-preview.show{display:block}

.input-preview-inner{
  position:relative;display:inline-block;
}

.input-preview img{
  max-height:120px;max-width:200px;
  border-radius:var(--radius-sm);
  border:1px solid var(--border);
}

.input-preview-remove{
  position:absolute;top:-6px;right:-6px;
  width:20px;height:20px;
  background:var(--red);color:white;
  border:2px solid var(--bg-3);
  border-radius:50%;cursor:pointer;
  font-size:12px;display:flex;
  align-items:center;justify-content:center;
  font-weight:700;
}

.input-preview-remove:hover{transform:scale(1.1)}

input[type="file"]{display:none}

/* ===== MEMBERS SIDEBAR ===== */
.members-sidebar{
  width:240px;background:var(--bg-1);
  overflow-y:auto;padding:12px 8px;
  flex-shrink:0;display:none;
  border-left:1px solid var(--border);
}

.members-sidebar.show{display:block}

.mbr-cat{
  padding:14px 10px 4px;
  font-size:11px;font-weight:700;
  text-transform:uppercase;letter-spacing:0.06em;
  color:var(--text-quaternary);
}

.mbr-item{
  display:flex;align-items:center;
  padding:6px 10px;border-radius:var(--radius-sm);
  cursor:pointer;gap:10px;
  transition:background var(--transition);
}

.mbr-item:hover{background:var(--bg-hover)}

.mbr-av{
  width:30px;height:30px;border-radius:var(--radius-full);
  display:flex;align-items:center;justify-content:center;
  font-weight:600;color:white;font-size:12px;
  flex-shrink:0;position:relative;
}

.mbr-dot{
  position:absolute;bottom:-1px;right:-1px;
  width:9px;height:9px;border-radius:50%;
  border:2px solid var(--bg-1);
}

.mbr-dot.online{background:var(--green)}
.mbr-dot.idle{background:var(--orange)}
.mbr-dot.offline{background:var(--text-quaternary)}

.mbr-name{
  font-size:13px;font-weight:500;
  color:var(--text-secondary);
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}

.mbr-item:hover .mbr-name{color:var(--text-primary)}
.mbr-item.offline-user .mbr-name{opacity:0.5}
.mbr-item.offline-user .mbr-av{opacity:0.5}

/* ===== FRIENDS / HOME ===== */
.home-area{
  display:none;flex:1;
  flex-direction:column;
  background:var(--bg-2);
}

.home-header{
  height:52px;padding:0 20px;
  display:flex;align-items:center;
  border-bottom:1px solid var(--border);
  gap:12px;flex-shrink:0;
}

.home-header .title{
  font-weight:700;color:var(--text-primary);
  font-size:15px;letter-spacing:-0.02em;
}

.home-content{
  flex:1;display:flex;
  align-items:center;justify-content:center;
}

.home-empty{text-align:center;padding:40px}

.home-empty .emoji{
  font-size:64px;margin-bottom:16px;
  filter:grayscale(0.2);
}

.home-empty h3{
  font-size:18px;font-weight:600;
  color:var(--text-secondary);margin-bottom:6px;
  letter-spacing:-0.02em;
}

.home-empty p{
  font-size:14px;color:var(--text-tertiary);
  line-height:1.5;max-width:300px;margin:0 auto;
}

/* ===== MODALS ===== */
.modal-overlay{
  position:fixed;inset:0;
  background:rgba(0,0,0,0.6);
  display:none;align-items:center;justify-content:center;
  z-index:1000;
  backdrop-filter:blur(8px);
}

.modal-overlay.show{display:flex}

.modal{
  background:var(--bg-2);
  border:1px solid var(--border);
  border-radius:var(--radius-xl);
  padding:32px;width:440px;max-width:92vw;
  box-shadow:var(--shadow-lg);
  animation:modalIn 0.25s cubic-bezier(0.25,0.1,0.25,1);
}

@keyframes modalIn{
  from{opacity:0;transform:scale(0.95) translateY(10px)}
  to{opacity:1;transform:scale(1) translateY(0)}
}

.modal h2{
  color:var(--text-primary);margin-bottom:4px;
  font-size:20px;font-weight:700;letter-spacing:-0.03em;
}

.modal .modal-sub{
  color:var(--text-tertiary);font-size:14px;
  margin-bottom:20px;
}

.modal-actions{
  display:flex;justify-content:flex-end;gap:8px;
  margin-top:20px;
}

.btn-ghost{
  padding:10px 18px;background:none;
  border:none;color:var(--text-secondary);
  cursor:pointer;font-size:14px;font-weight:500;
  border-radius:var(--radius-sm);
  font-family:inherit;transition:all var(--transition);
}

.btn-ghost:hover{background:var(--bg-hover);color:var(--text-primary)}

.btn-accent{
  padding:10px 20px;
  background:var(--accent);color:white;
  border:none;border-radius:var(--radius-sm);
  cursor:pointer;font-size:14px;font-weight:600;
  font-family:inherit;transition:all var(--transition);
}

.btn-accent:hover{background:var(--accent-hover)}
.btn-accent:disabled{opacity:0.5;cursor:not-allowed}

.btn-full{width:100%;margin-top:4px;padding:12px}

.or-line{
  text-align:center;color:var(--text-quaternary);
  font-size:12px;font-weight:700;
  text-transform:uppercase;letter-spacing:0.06em;
  padding:4px 0;position:relative;
}

.or-line::before,.or-line::after{
  content:'';position:absolute;top:50%;
  width:calc(50% - 20px);height:1px;
  background:var(--border);
}
.or-line::before{left:0}
.or-line::after{right:0}

.invite-display{
  background:var(--bg-3);
  border:1px solid var(--border);
  padding:14px 16px;border-radius:var(--radius-sm);
  display:flex;align-items:center;justify-content:space-between;
  margin-top:12px;
}

.invite-display code{
  font-family:'SF Mono','Fira Code',monospace;
  font-size:16px;color:var(--text-primary);
  font-weight:600;letter-spacing:0.02em;
}

.invite-display button{
  padding:6px 14px;background:var(--accent);
  color:white;border:none;border-radius:var(--radius-sm);
  cursor:pointer;font-size:13px;font-weight:600;
  font-family:inherit;transition:all var(--transition);
}

.invite-display button:hover{background:var(--accent-hover)}

/* ===== CONTEXT MENU ===== */
.ctx-menu{
  position:fixed;
  background:var(--bg-elevated);
  border:1px solid var(--border);
  border-radius:var(--radius-md);
  padding:6px;min-width:200px;
  box-shadow:var(--shadow-lg);
  z-index:1500;display:none;
  backdrop-filter:blur(40px);
  animation:ctxIn 0.15s ease-out;
}

@keyframes ctxIn{
  from{opacity:0;transform:scale(0.95)}
  to{opacity:1;transform:scale(1)}
}

.ctx-item{
  padding:8px 12px;border-radius:var(--radius-sm);
  cursor:pointer;font-size:13px;font-weight:500;
  color:var(--text-secondary);
  display:flex;align-items:center;gap:10px;
  transition:all 0.1s;
}

.ctx-item:hover{background:var(--accent);color:white}
.ctx-item.danger{color:var(--red)}
.ctx-item.danger:hover{background:var(--red);color:white}

.ctx-sep{
  height:1px;background:var(--border);
  margin:4px 6px;
}

/* ===== SETTINGS ===== */
.settings-overlay{
  position:fixed;inset:0;
  background:var(--bg-1);
  z-index:2000;display:none;
}

.settings-overlay.show{display:flex}

.settings-side{
  width:280px;
  display:flex;justify-content:flex-end;
  background:var(--bg-1);
  padding:48px 12px;
  border-right:1px solid var(--border);
}

.settings-nav{width:180px}

.settings-nav-head{
  font-size:11px;font-weight:700;
  text-transform:uppercase;letter-spacing:0.06em;
  color:var(--text-quaternary);padding:8px 10px;
}

.settings-nav-item{
  padding:8px 10px;border-radius:var(--radius-sm);
  cursor:pointer;font-size:14px;font-weight:500;
  color:var(--text-secondary);margin:1px 0;
  transition:all var(--transition);
}

.settings-nav-item:hover{background:var(--bg-hover);color:var(--text-primary)}
.settings-nav-item.active{background:var(--bg-active);color:var(--text-primary)}
.settings-nav-item.danger{color:var(--red)}
.settings-nav-item.danger:hover{background:rgba(255,69,58,0.1)}

.settings-nav-sep{
  height:1px;background:var(--border);margin:6px 10px;
}

.settings-main{
  flex:1;padding:48px 40px;
  overflow-y:auto;max-width:700px;
  position:relative;
}

.settings-main h2{
  font-size:20px;font-weight:700;
  color:var(--text-primary);margin-bottom:24px;
  letter-spacing:-0.03em;
}

.settings-close{
  position:absolute;top:16px;right:16px;
  width:36px;height:36px;border-radius:var(--radius-full);
  border:1.5px solid var(--border);
  background:none;color:var(--text-tertiary);
  cursor:pointer;font-size:18px;
  display:flex;align-items:center;justify-content:center;
  transition:all var(--transition);
}

.settings-close:hover{border-color:var(--text-secondary);color:var(--text-primary)}

.profile-card{
  background:var(--bg-3);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding:20px;display:flex;align-items:center;gap:16px;
}

.profile-card .av-lg{
  width:72px;height:72px;border-radius:var(--radius-full);
  display:flex;align-items:center;justify-content:center;
  font-size:30px;font-weight:700;color:white;flex-shrink:0;
}

.profile-card .info h3{
  font-size:18px;font-weight:700;
  color:var(--text-primary);letter-spacing:-0.02em;
}

.profile-card .info p{
  font-size:13px;color:var(--text-tertiary);margin-top:2px;
}

/* ===== AVATAR COLORS ===== */
.ac-0{background:linear-gradient(135deg,#5e5ce6,#0a84ff)!important}
.ac-1{background:linear-gradient(135deg,#30d158,#34c759)!important}
.ac-2{background:linear-gradient(135deg,#ff9f0a,#ff6723)!important}
.ac-3{background:linear-gradient(135deg,#ff453a,#ff2d55)!important}
.ac-4{background:linear-gradient(135deg,#bf5af2,#af52de)!important}
.ac-5{background:linear-gradient(135deg,#64d2ff,#5ac8fa)!important}
.ac-6{background:linear-gradient(135deg,#ffd60a,#ff9500)!important}
.ac-7{background:linear-gradient(135deg,#ff375f,#ff2d55)!important}

/* ===== SPINNER ===== */
.spinner-wrap{
  display:flex;align-items:center;justify-content:center;
  height:100%;
}

.spinner{
  width:32px;height:32px;
  border:3px solid var(--bg-4);
  border-top-color:var(--accent);
  border-radius:50%;
  animation:spin 0.8s linear infinite;
}

@keyframes spin{to{transform:rotate(360deg)}}

/* ===== RESPONSIVE ===== */
@media(max-width:900px){
  .members-sidebar{display:none!important}
}

@media(max-width:768px){
  .channel-sidebar{display:none!important}
  .server-rail{width:56px}
  .srv-icon{width:38px;height:38px;font-size:13px}
}
</style>
</head>
<body>

<!-- AUTH -->
<div id="authScreen" class="auth-container">
  <div class="auth-bg"></div>
  <div class="auth-box">
    <div class="auth-logo">C</div>
    <div id="loginView">
      <h2>Welcome back</h2>
      <p class="subtitle">Sign in to continue to Chat</p>
      <div id="loginError" class="error-msg"></div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="loginEmail" placeholder="you@email.com">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="loginPw" placeholder="Enter your password">
      </div>
      <button class="btn-primary" id="loginBtn">Sign In</button>
      <p class="auth-switch">Don't have an account? <a id="toRegister">Create one</a></p>
    </div>
    <div id="registerView" style="display:none">
      <h2>Create account</h2>
      <p class="subtitle">Set up your new Chat profile</p>
      <div id="regError" class="error-msg"></div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="regEmail" placeholder="you@email.com">
      </div>
      <div class="form-group">
        <label>Display Name</label>
        <input type="text" id="regName" placeholder="What should we call you?" maxlength="32">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="regPw" placeholder="6+ characters">
      </div>
      <button class="btn-primary" id="regBtn">Create Account</button>
      <p class="auth-switch">Already have an account? <a id="toLogin">Sign in</a></p>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app" class="app-container">
  <div class="app-layout">

    <!-- Server Rail -->
    <div class="server-rail" id="serverRail">
      <div class="srv-icon home-icon active" id="homeBtn" title="Home">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        <span class="srv-pill"></span>
      </div>
      <div class="srv-divider"></div>
      <div id="srvList"></div>
      <div class="srv-icon add-icon" id="addSrvBtn" title="Create or Join">
        +<span class="srv-pill"></span>
      </div>
    </div>

    <!-- Channel Sidebar -->
    <div class="channel-sidebar" id="chanSidebar">
      <div class="sidebar-header">
        <h3 id="sidebarTitle">Home</h3>
        <button class="sidebar-header-btn" id="sidebarMenuBtn" title="Options">‚ãØ</button>
      </div>
      <div class="channel-list" id="chanList"></div>
      <div class="user-bar">
        <div class="user-bar-avatar" id="ubAvatar"><div class="user-bar-status"></div></div>
        <div class="user-bar-info">
          <div class="name" id="ubName">User</div>
          <div class="status-text">Online</div>
        </div>
        <button class="user-bar-btn" id="settingsBtn" title="Settings">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
        </button>
      </div>
    </div>

    <!-- Chat Area -->
    <div class="chat-area" id="chatArea" style="display:none">
      <div class="chat-header">
        <span class="ch-icon">#</span>
        <span class="ch-title" id="chatTitle">general</span>
        <div class="chat-header-actions">
          <button class="chat-header-btn active" id="toggleMembers" title="Members">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          </button>
        </div>
      </div>
      <div class="chat-body">
        <div class="messages-col">
          <div class="messages-scroll" id="msgScroll">
            <div class="spinner-wrap"><div class="spinner"></div></div>
          </div>
          <div class="typing-bar" id="typingBar"></div>
          <div class="input-area">
            <div class="input-preview" id="inputPreview">
              <div class="input-preview-inner" id="previewInner"></div>
            </div>
            <div class="input-box">
              <button class="input-btn" id="attachBtn" title="Upload Image">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
              </button>
              <textarea class="input-textarea" id="msgInput" placeholder="Message #general" rows="1"></textarea>
              <button class="input-btn" id="sendBtn" title="Send" style="color:var(--accent)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
              </button>
            </div>
            <input type="file" id="fileInput" accept="image/*">
          </div>
        </div>
        <div class="members-sidebar show" id="membersSidebar"></div>
      </div>
    </div>

    <!-- Home Area -->
    <div class="home-area" id="homeArea">
      <div class="home-header">
        <span class="title">Home</span>
      </div>
      <div class="home-content">
        <div class="home-empty">
          <div class="emoji">üí¨</div>
          <h3>Welcome to Chat</h3>
          <p>Create a server or join one to start talking with friends.</p>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Modals -->
<div class="modal-overlay" id="createSrvModal">
  <div class="modal">
    <h2>Create a server</h2>
    <p class="modal-sub">Give your server a personality with a name.</p>
    <div class="form-group">
      <label>Server Name</label>
      <input type="text" id="newSrvName" placeholder="My Server" maxlength="100">
    </div>
    <button class="btn-accent btn-full" id="createSrvBtn">Create</button>
    <div class="or-line" style="margin:16px 0">or</div>
    <div class="form-group">
      <label>Join with Invite Code</label>
      <input type="text" id="joinCode" placeholder="Paste invite code">
    </div>
    <button class="btn-accent btn-full" id="joinSrvBtn" style="background:var(--green)">Join Server</button>
    <div class="modal-actions"><button class="btn-ghost" id="cancelSrvModal">Cancel</button></div>
  </div>
</div>

<div class="modal-overlay" id="createChModal">
  <div class="modal">
    <h2>New channel</h2>
    <p class="modal-sub">Channels are where conversations happen.</p>
    <div class="form-group">
      <label>Channel Name</label>
      <input type="text" id="newChName" placeholder="general" maxlength="100">
    </div>
    <div class="modal-actions">
      <button class="btn-ghost" id="cancelChModal">Cancel</button>
      <button class="btn-accent" id="createChBtn">Create</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="inviteModal">
  <div class="modal">
    <h2>Invite friends</h2>
    <p class="modal-sub">Share this code so others can join your server.</p>
    <div class="invite-display">
      <code id="inviteCode"></code>
      <button id="copyInvite">Copy</button>
    </div>
    <div class="modal-actions"><button class="btn-ghost" id="closeInvite">Done</button></div>
  </div>
</div>

<!-- Context Menu -->
<div class="ctx-menu" id="ctxMenu">
  <div class="ctx-item" id="ctxInvite">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
    Invite People
  </div>
  <div class="ctx-item" id="ctxNewCh">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
    New Channel
  </div>
  <div class="ctx-sep"></div>
  <div class="ctx-item danger" id="ctxLeave">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
    Leave Server
  </div>
  <div class="ctx-item danger" id="ctxDelete" style="display:none">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
    Delete Server
  </div>
</div>

<!-- Settings -->
<div class="settings-overlay" id="settingsOverlay">
  <div class="settings-side">
    <div class="settings-nav">
      <div class="settings-nav-head">Settings</div>
      <div class="settings-nav-item active">Account</div>
      <div class="settings-nav-sep"></div>
      <div class="settings-nav-item danger" id="logoutBtn">Log Out</div>
    </div>
  </div>
  <div class="settings-main">
    <button class="settings-close" id="closeSettings">‚úï</button>
    <h2>Account</h2>
    <div class="profile-card">
      <div class="av-lg" id="sAvatar">U</div>
      <div class="info">
        <h3 id="sName">User</h3>
        <p id="sEmail">user@email.com</p>
      </div>
    </div>
    <div style="margin-top:28px">
      <div class="form-group">
        <label>Display Name</label>
        <input type="text" id="editName" maxlength="32">
      </div>
      <button class="btn-accent" id="saveProfile">Save Changes</button>
    </div>
  </div>
</div>

<!-- Lightbox -->
<div class="lightbox" id="lightbox">
  <img id="lightboxImg" src="">
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyBJMIUucxOusoVzs4lc-QurCxjlW6Hlsuw",
  authDomain:"chat-5f0bf.firebaseapp.com",
  projectId:"chat-5f0bf",
  storageBucket:"chat-5f0bf.firebasestorage.app",
  messagingSenderId:"211425841353",
  appId:"1:211425841353:web:e1c271a340d73abd0cfd18"
});

const auth=firebase.auth(), db=firebase.firestore();
const TS=firebase.firestore.FieldValue.serverTimestamp;
const AU=firebase.firestore.FieldValue.arrayUnion;
const AR=firebase.firestore.FieldValue.arrayRemove;
const FP=firebase.firestore.FieldPath;

// ===== STATE =====
let me=null, profile=null;
let curSrv=null, curCh=null;
let srvs=[], chs=[], mbrs=[];
let showMbrs=true, isHome=true;
let unsubs={msgs:null,chs:null,mbrs:null,srvs:null,typ:null};
let typTimer=null, pendingImage=null;

// ===== DOM =====
const $=id=>document.getElementById(id);

// ===== AUTH =====
$('toRegister').onclick=()=>{$('loginView').style.display='none';$('registerView').style.display='block';$('regError').style.display='none'};
$('toLogin').onclick=()=>{$('registerView').style.display='none';$('loginView').style.display='block';$('loginError').style.display='none'};

$('loginBtn').onclick=async()=>{
  const e=$('loginEmail').value.trim(),p=$('loginPw').value;
  if(!e||!p)return showErr($('loginError'),'Please fill in all fields.');
  $('loginBtn').disabled=true;
  try{await auth.signInWithEmailAndPassword(e,p)}
  catch(err){showErr($('loginError'),authErr(err.code))}
  $('loginBtn').disabled=false;
};

$('regBtn').onclick=async()=>{
  const e=$('regEmail').value.trim(),n=$('regName').value.trim(),p=$('regPw').value;
  if(!e||!n||!p)return showErr($('regError'),'Please fill in all fields.');
  if(p.length<6)return showErr($('regError'),'Password needs 6+ characters.');
  $('regBtn').disabled=true;
  try{
    const c=await auth.createUserWithEmailAndPassword(e,p);
    await db.collection('users').doc(c.user.uid).set({
      email:e,username:n,avatarColor:Math.floor(Math.random()*8),
      status:'online',createdAt:TS(),servers:[]
    });
  }catch(err){showErr($('regError'),authErr(err.code))}
  $('regBtn').disabled=false;
};

$('loginPw').onkeydown=e=>{if(e.key==='Enter')$('loginBtn').click()};
$('regPw').onkeydown=e=>{if(e.key==='Enter')$('regBtn').click()};

function showErr(el,m){el.textContent=m;el.style.display='block'}
function authErr(c){
  const m={'auth/email-already-in-use':'Email already taken.','auth/invalid-email':'Invalid email.',
    'auth/wrong-password':'Wrong password.','auth/user-not-found':'Account not found.',
    'auth/weak-password':'Password too weak.','auth/invalid-credential':'Invalid credentials.',
    'auth/too-many-requests':'Too many attempts. Try later.'};
  return m[c]||'Something went wrong.';
}

auth.onAuthStateChanged(async u=>{
  if(u){
    me=u;
    const d=await db.collection('users').doc(u.uid).get();
    profile=d.exists?{id:u.uid,...d.data()}:{id:u.uid,username:u.email.split('@')[0],email:u.email,avatarColor:0,servers:[]};
    db.collection('users').doc(u.uid).update({status:'online'}).catch(()=>{});
    $('authScreen').style.display='none';
    $('app').style.display='block';
    init();
  }else{
    me=null;profile=null;
    $('authScreen').style.display='flex';
    $('app').style.display='none';
    killSubs();
  }
});

// ===== INIT =====
function init(){syncPanel();loadSrvs();goHome()}

function syncPanel(){
  const i=(profile.username||'?')[0].toUpperCase();
  const c='ac-'+(profile.avatarColor||0);
  $('ubAvatar').textContent=i;$('ubAvatar').className='user-bar-avatar '+c;
  const dot=document.createElement('div');dot.className='user-bar-status';
  $('ubAvatar').appendChild(dot);
  $('ubName').textContent=profile.username;
  $('sAvatar').textContent=i;$('sAvatar').className='av-lg '+c;
  $('sName').textContent=profile.username;
  $('sEmail').textContent=profile.email||me.email;
  $('editName').value=profile.username;
}

function killSubs(){Object.values(unsubs).forEach(u=>u&&u());for(let k in unsubs)unsubs[k]=null}

// ===== SERVERS =====
function loadSrvs(){
  if(unsubs.srvs)unsubs.srvs();
  unsubs.srvs=db.collection('users').doc(me.uid).onSnapshot(async d=>{
    if(!d.exists)return;
    const data=d.data();
    profile={id:me.uid,...data};syncPanel();
    const ids=data.servers||[];
    if(!ids.length){srvs=[];renderSrvs();return}
    const docs=await Promise.all(ids.map(id=>db.collection('servers').doc(id).get()));
    srvs=docs.filter(d=>d.exists).map(d=>({id:d.id,...d.data()}));
    renderSrvs();
  });
}

function renderSrvs(){
  $('srvList').innerHTML='';
  srvs.forEach(s=>{
    const el=document.createElement('div');
    el.className='srv-icon'+(curSrv===s.id?' active':'');
    el.title=s.name;
    el.textContent=s.name?s.name.split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase():'?';
    const pill=document.createElement('span');pill.className='srv-pill';el.appendChild(pill);
    el.onclick=()=>openSrv(s.id);
    el.oncontextmenu=e=>showCtx(e,s);
    $('srvList').appendChild(el);
  });
}

function openSrv(id){
  isHome=false;curSrv=id;
  renderSrvs();$('homeBtn').classList.remove('active');
  $('chatArea').style.display='flex';
  $('homeArea').style.display='none';
  $('chanSidebar').style.display='flex';
  const s=srvs.find(x=>x.id===id);
  $('sidebarTitle').textContent=s?s.name:'Server';
  loadChs(id);loadMbrs(id);
}

$('homeBtn').onclick=()=>goHome();

function goHome(){
  isHome=true;curSrv=null;curCh=null;
  [unsubs.chs,unsubs.msgs,unsubs.mbrs,unsubs.typ].forEach(u=>u&&u());
  unsubs.chs=unsubs.msgs=unsubs.mbrs=unsubs.typ=null;
  renderSrvs();$('homeBtn').classList.add('active');
  $('chatArea').style.display='none';
  $('homeArea').style.display='flex';
  $('chanSidebar').style.display='flex';
  $('sidebarTitle').textContent='Home';
  $('chanList').innerHTML=`<div style="padding:32px 16px;text-align:center;color:var(--text-tertiary);font-size:13px;line-height:1.6">
    <div style="font-size:32px;margin-bottom:8px">üè†</div>
    Select a server or create one to get started.</div>`;
}

// ===== CREATE / JOIN =====
$('addSrvBtn').onclick=()=>{
  $('createSrvModal').classList.add('show');
  $('newSrvName').value=(profile.username||'My')+"'s server";
  $('joinCode').value='';
  setTimeout(()=>$('newSrvName').select(),100);
};
$('cancelSrvModal').onclick=()=>$('createSrvModal').classList.remove('show');

$('createSrvBtn').onclick=async()=>{
  const n=$('newSrvName').value.trim();if(!n)return;
  $('createSrvBtn').disabled=true;
  try{
    const code=genCode();
    const ref=await db.collection('servers').add({
      name:n,ownerId:me.uid,inviteCode:code,createdAt:TS(),members:[me.uid]
    });
    await db.collection('servers').doc(ref.id).collection('channels').add({name:'general',createdAt:TS()});
    await db.collection('users').doc(me.uid).update({servers:AU(ref.id)});
    $('createSrvModal').classList.remove('show');
    openSrv(ref.id);
  }catch(e){console.error(e);alert('Failed.')}
  $('createSrvBtn').disabled=false;
};

$('joinSrvBtn').onclick=async()=>{
  const c=$('joinCode').value.trim();if(!c)return;
  $('joinSrvBtn').disabled=true;
  try{
    const snap=await db.collection('servers').where('inviteCode','==',c).limit(1).get();
    if(snap.empty){alert('Invalid code.');$('joinSrvBtn').disabled=false;return}
    const sd=snap.docs[0],sid=sd.id;
    if((sd.data().members||[]).includes(me.uid)){
      $('createSrvModal').classList.remove('show');openSrv(sid);$('joinSrvBtn').disabled=false;return;
    }
    await db.collection('servers').doc(sid).update({members:AU(me.uid)});
    await db.collection('users').doc(me.uid).update({servers:AU(sid)});
    $('createSrvModal').classList.remove('show');openSrv(sid);
  }catch(e){console.error(e);alert('Failed.')}
  $('joinSrvBtn').disabled=false;
};

function genCode(){
  const c='ABCDEFGHJKMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
  let r='';for(let i=0;i<8;i++)r+=c[Math.floor(Math.random()*c.length)];return r;
}

// ===== CHANNELS =====
function loadChs(sid){
  if(unsubs.chs)unsubs.chs();
  unsubs.chs=db.collection('servers').doc(sid).collection('channels')
    .orderBy('createdAt','asc').onSnapshot(snap=>{
      chs=snap.docs.map(d=>({id:d.id,...d.data()}));
      renderChs();
      if(!curCh||!chs.find(c=>c.id===curCh)){if(chs.length)pickCh(chs[0].id)}
    });
}

function renderChs(){
  const srv=srvs.find(s=>s.id===curSrv);
  $('chanList').innerHTML='';
  const sec=document.createElement('div');sec.className='ch-section';
  sec.innerHTML='<span class="ch-section-title">Channels</span>';
  if(srv&&srv.ownerId===me.uid){
    const b=document.createElement('button');b.className='ch-section-btn';b.textContent='+';
    b.title='New Channel';
    b.onclick=()=>{$('createChModal').classList.add('show');$('newChName').value='';setTimeout(()=>$('newChName').focus(),100)};
    sec.appendChild(b);
  }
  $('chanList').appendChild(sec);
  chs.forEach(ch=>{
    const el=document.createElement('div');
    el.className='ch-item'+(curCh===ch.id?' active':'');
    el.innerHTML=`<span class="ch-hash">#</span><span class="ch-name">${esc(ch.name)}</span>`;
    if(srv&&srv.ownerId===me.uid&&chs.length>1){
      const d=document.createElement('button');d.className='ch-del';d.textContent='√ó';d.title='Delete';
      d.onclick=async e=>{e.stopPropagation();if(confirm(`Delete #${ch.name}?`))await db.collection('servers').doc(curSrv).collection('channels').doc(ch.id).delete()};
      el.appendChild(d);
    }
    el.onclick=()=>pickCh(ch.id);
    $('chanList').appendChild(el);
  });
}

function pickCh(id){
  curCh=id;
  const ch=chs.find(c=>c.id===id);
  if(ch){$('chatTitle').textContent=ch.name;$('msgInput').placeholder=`Message #${ch.name}`}
  renderChs();loadMsgs();listenTyp();
}

$('cancelChModal').onclick=()=>$('createChModal').classList.remove('show');
$('createChBtn').onclick=async()=>{
  let n=$('newChName').value.trim().toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9\-_]/g,'');
  if(!n)return;$('createChBtn').disabled=true;
  try{await db.collection('servers').doc(curSrv).collection('channels').add({name:n,createdAt:TS()});$('createChModal').classList.remove('show')}catch(e){console.error(e)}
  $('createChBtn').disabled=false;
};
$('newChName').onkeydown=e=>{if(e.key==='Enter')$('createChBtn').click()};

// ===== MESSAGES =====
function loadMsgs(){
  if(unsubs.msgs)unsubs.msgs();
  if(!curSrv||!curCh)return;
  $('msgScroll').innerHTML='<div class="spinner-wrap"><div class="spinner"></div></div>';
  unsubs.msgs=db.collection('servers').doc(curSrv)
    .collection('channels').doc(curCh)
    .collection('messages').orderBy('createdAt','asc').limitToLast(150)
    .onSnapshot(snap=>renderMsgs(snap.docs.map(d=>({id:d.id,...d.data()}))));
}

function renderMsgs(msgs){
  const ch=chs.find(c=>c.id===curCh);
  const atBot=isBot();
  $('msgScroll').innerHTML='';
  const w=document.createElement('div');w.className='msg-welcome';
  w.innerHTML=`<div class="icon">#</div><h2>Welcome to #${esc(ch?ch.name:'channel')}</h2><p>This is the beginning of the #${esc(ch?ch.name:'channel')} channel. Say hi! üëã</p>`;
  $('msgScroll').appendChild(w);
  let lastA=null,lastT=null;
  msgs.forEach(m=>{
    const ng=m.authorId!==lastA||!lastT||!m.createdAt||(m.createdAt.toMillis()-lastT>420000);
    const el=document.createElement('div');
    el.className='msg-group'+(ng?' new-group':'');
    const t=m.createdAt?m.createdAt.toDate():new Date();
    let imgHtml='';
    if(m.imageData){
      imgHtml=`<img class="msg-image" src="${m.imageData}" alt="image" onclick="openLb(this.src)" loading="lazy">`;
    }
    if(ng){
      el.innerHTML=`<div class="msg-av ac-${m.avatarColor||0}">${esc((m.authorName||'?')[0].toUpperCase())}</div>
        <div class="msg-body"><div class="msg-head"><span class="msg-author">${esc(m.authorName||'Unknown')}</span>
        <span class="msg-time">${fDate(t)} ${fTime(t)}</span></div>
        ${m.text?`<div class="msg-text">${fmtTxt(m.text)}</div>`:''}${imgHtml}</div>`;
    }else{
      el.innerHTML=`<div class="msg-av hide"></div>
        <div class="msg-body"><span class="msg-hover-time">${fTime(t)}</span>
        ${m.text?`<div class="msg-text">${fmtTxt(m.text)}</div>`:''}${imgHtml}</div>`;
    }
    $('msgScroll').appendChild(el);
    lastA=m.authorId;lastT=m.createdAt?m.createdAt.toMillis():Date.now();
  });
  if(atBot||msgs.length===0)scrollEnd();
}

function fmtTxt(t){
  let s=esc(t);
  s=s.replace(/```([\s\S]*?)```/g,'<pre><code>$1</code></pre>');
  s=s.replace(/`([^`]+)`/g,'<code>$1</code>');
  s=s.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>');
  s=s.replace(/\*(.+?)\*/g,'<em>$1</em>');
  s=s.replace(/__(.+?)__/g,'<u>$1</u>');
  s=s.replace(/(https?:\/\/[^\s<]+)/g,'<a href="$1" target="_blank" rel="noopener">$1</a>');
  return s;
}

function isBot(){return $('msgScroll').scrollHeight-$('msgScroll').scrollTop-$('msgScroll').clientHeight<120}
function scrollEnd(){requestAnimationFrame(()=>{$('msgScroll').scrollTop=$('msgScroll').scrollHeight})}

// ===== SEND =====
$('msgInput').onkeydown=e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send()}};
$('sendBtn').onclick=()=>send();

async function send(){
  const text=$('msgInput').value.trim();
  const hasImg=!!pendingImage;
  if(!text&&!hasImg)return;
  if(!curSrv||!curCh)return;
  $('msgInput').value='';autoResize();
  const imgData=pendingImage;
  clearPreview();
  try{
    const msgObj={
      authorId:me.uid,authorName:profile.username,
      avatarColor:profile.avatarColor||0,
      createdAt:TS()
    };
    if(text)msgObj.text=text;
    if(imgData)msgObj.imageData=imgData;
    await db.collection('servers').doc(curSrv)
      .collection('channels').doc(curCh)
      .collection('messages').add(msgObj);
    clearTyp();
  }catch(e){console.error(e)}
}

$('msgInput').oninput=()=>{autoResize();setTyp()};
function autoResize(){$('msgInput').style.height='auto';$('msgInput').style.height=Math.min($('msgInput').scrollHeight,200)+'px'}

// ===== IMAGE UPLOAD (base64 ‚Üí Firestore) =====
$('attachBtn').onclick=()=>$('fileInput').click();

$('fileInput').onchange=e=>{
  const file=e.target.files[0];
  if(!file)return;
  // Max ~900KB after base64 (~670KB file) to stay under Firestore 1MB doc limit
  if(file.size>700*1024){alert('Image too large. Max ~700KB.');$('fileInput').value='';return}
  const reader=new FileReader();
  reader.onload=ev=>{
    // Compress via canvas
    const img=new Image();
    img.onload=()=>{
      const canvas=document.createElement('canvas');
      let w=img.width,h=img.height;
      const MAX=1200;
      if(w>MAX||h>MAX){
        if(w>h){h=Math.round(h*MAX/w);w=MAX}
        else{w=Math.round(w*MAX/h);h=MAX}
      }
      canvas.width=w;canvas.height=h;
      const ctx=canvas.getContext('2d');
      ctx.drawImage(img,0,0,w,h);
      const compressed=canvas.toDataURL('image/jpeg',0.7);
      // Check final size
      if(compressed.length>950000){
        alert('Image still too large after compression. Try a smaller image.');
        $('fileInput').value='';return;
      }
      pendingImage=compressed;
      showPreview(compressed);
    };
    img.src=ev.target.result;
  };
  reader.readAsDataURL(file);
  $('fileInput').value='';
};

function showPreview(src){
  $('inputPreview').classList.add('show');
  $('previewInner').innerHTML=`<img src="${src}"><div class="input-preview-remove" onclick="clearPreview()">√ó</div>`;
}

function clearPreview(){
  pendingImage=null;
  $('inputPreview').classList.remove('show');
  $('previewInner').innerHTML='';
}

// Paste image support
$('msgInput').addEventListener('paste',e=>{
  const items=e.clipboardData?.items;
  if(!items)return;
  for(const item of items){
    if(item.type.startsWith('image/')){
      e.preventDefault();
      const file=item.getAsFile();
      if(file.size>700*1024){alert('Image too large.');return}
      const reader=new FileReader();
      reader.onload=ev=>{
        const img=new Image();
        img.onload=()=>{
          const canvas=document.createElement('canvas');
          let w=img.width,h=img.height;
          const MAX=1200;
          if(w>MAX||h>MAX){if(w>h){h=Math.round(h*MAX/w);w=MAX}else{w=Math.round(w*MAX/h);h=MAX}}
          canvas.width=w;canvas.height=h;
          canvas.getContext('2d').drawImage(img,0,0,w,h);
          const compressed=canvas.toDataURL('image/jpeg',0.7);
          if(compressed.length>950000){alert('Image too large.');return}
          pendingImage=compressed;showPreview(compressed);
        };
        img.src=ev.target.result;
      };
      reader.readAsDataURL(file);
      break;
    }
  }
});

// Drag & drop
const inputArea=document.querySelector('.input-area');
['dragenter','dragover'].forEach(ev=>inputArea.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();inputArea.querySelector('.input-box').style.borderColor='var(--accent)'}));
['dragleave','drop'].forEach(ev=>inputArea.addEventListener(ev,e=>{e.preventDefault();e.stopPropagation();inputArea.querySelector('.input-box').style.borderColor=''}));
inputArea.addEventListener('drop',e=>{
  const file=e.dataTransfer?.files?.[0];
  if(!file||!file.type.startsWith('image/'))return;
  if(file.size>700*1024){alert('Image too large.');return}
  const reader=new FileReader();
  reader.onload=ev=>{
    const img=new Image();
    img.onload=()=>{
      const canvas=document.createElement('canvas');
      let w=img.width,h=img.height;const MAX=1200;
      if(w>MAX||h>MAX){if(w>h){h=Math.round(h*MAX/w);w=MAX}else{w=Math.round(w*MAX/h);h=MAX}}
      canvas.width=w;canvas.height=h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      const c=canvas.toDataURL('image/jpeg',0.7);
      if(c.length>950000){alert('Image too large.');return}
      pendingImage=c;showPreview(c);
    };
    img.src=ev.target.result;
  };
  reader.readAsDataURL(file);
});

// ===== LIGHTBOX =====
function openLb(src){$('lightboxImg').src=src;$('lightbox').classList.add('show')}
$('lightbox').onclick=()=>$('lightbox').classList.remove('show');

// ===== TYPING =====
function setTyp(){
  if(!curSrv||!curCh)return;
  const ref=db.collection('servers').doc(curSrv).collection('channels').doc(curCh).collection('typing').doc(me.uid);
  ref.set({username:profile.username,timestamp:TS()});
  if(typTimer)clearTimeout(typTimer);
  typTimer=setTimeout(()=>ref.delete().catch(()=>{}),5000);
}

function clearTyp(){
  if(!curSrv||!curCh)return;
  db.collection('servers').doc(curSrv).collection('channels').doc(curCh).collection('typing').doc(me.uid).delete().catch(()=>{});
  if(typTimer)clearTimeout(typTimer);
}

function listenTyp(){
  if(unsubs.typ)unsubs.typ();
  if(!curSrv||!curCh)return;
  unsubs.typ=db.collection('servers').doc(curSrv).collection('channels').doc(curCh).collection('typing')
    .onSnapshot(snap=>{
      const now=Date.now(),names=[];
      snap.docs.forEach(d=>{
        if(d.id===me.uid)return;
        const data=d.data();
        if(data.timestamp&&(now-data.timestamp.toMillis()<8000))names.push(data.username);
      });
      if(!names.length)$('typingBar').innerHTML='';
      else if(names.length===1)$('typingBar').innerHTML=`<div class="typing-dots"><span></span><span></span><span></span></div><strong>${esc(names[0])}</strong> is typing‚Ä¶`;
      else $('typingBar').innerHTML=`<div class="typing-dots"><span></span><span></span><span></span></div><strong>${names.map(esc).join(', ')}</strong> are typing‚Ä¶`;
    });
}

// ===== MEMBERS =====
function loadMbrs(sid){
  if(unsubs.mbrs)unsubs.mbrs();
  unsubs.mbrs=db.collection('servers').doc(sid).onSnapshot(async doc=>{
    if(!doc.exists)return;
    const ids=doc.data().members||[];
    if(!ids.length){mbrs=[];renderMbrs();return}
    const all=[];
    for(let i=0;i<ids.length;i+=10){
      const batch=ids.slice(i,i+10);
      const s=await db.collection('users').where(FP.documentId(),'in',batch).get();
      s.docs.forEach(d=>all.push({id:d.id,...d.data()}));
    }
    mbrs=all;renderMbrs();
  });
}

function renderMbrs(){
  $('membersSidebar').innerHTML='';
  const on=mbrs.filter(m=>m.status==='online');
  const rest=mbrs.filter(m=>m.status!=='online');
  if(on.length){
    const c=document.createElement('div');c.className='mbr-cat';c.textContent=`ONLINE ‚Äî ${on.length}`;
    $('membersSidebar').appendChild(c);
    on.forEach(m=>$('membersSidebar').appendChild(mkMbr(m,'online')));
  }
  if(rest.length){
    const c=document.createElement('div');c.className='mbr-cat';c.textContent=`OFFLINE ‚Äî ${rest.length}`;
    $('membersSidebar').appendChild(c);
    rest.forEach(m=>$('membersSidebar').appendChild(mkMbr(m,'offline')));
  }
}

function mkMbr(m,st){
  const el=document.createElement('div');
  el.className='mbr-item'+(st==='offline'?' offline-user':'');
  el.innerHTML=`<div class="mbr-av ac-${m.avatarColor||0}">${esc((m.username||'?')[0].toUpperCase())}<div class="mbr-dot ${st}"></div></div><span class="mbr-name">${esc(m.username||'Unknown')}</span>`;
  return el;
}

$('toggleMembers').onclick=()=>{
  showMbrs=!showMbrs;
  $('membersSidebar').classList.toggle('show',showMbrs);
  $('toggleMembers').classList.toggle('active',showMbrs);
};

// ===== CONTEXT MENU =====
function showCtx(e,srv){
  e.preventDefault();
  const own=srv.ownerId===me.uid;
  $('ctxDelete').style.display=own?'flex':'none';
  $('ctxLeave').style.display=own?'none':'flex';
  const cm=$('ctxMenu');
  cm.style.display='block';
  cm.style.left=e.clientX+'px';cm.style.top=e.clientY+'px';
  cm.dataset.sid=srv.id;
  const r=cm.getBoundingClientRect();
  if(r.right>innerWidth)cm.style.left=(innerWidth-r.width-8)+'px';
  if(r.bottom>innerHeight)cm.style.top=(innerHeight-r.height-8)+'px';
}

document.addEventListener('click',()=>$('ctxMenu').style.display='none');

$('sidebarMenuBtn').onclick=e=>{
  if(!curSrv)return;
  const s=srvs.find(x=>x.id===curSrv);
  if(s)showCtx(e,s);
};

$('ctxInvite').onclick=()=>{
  const s=srvs.find(x=>x.id===$('ctxMenu').dataset.sid);
  if(s){$('inviteCode').textContent=s.inviteCode;$('inviteModal').classList.add('show')}
};

$('copyInvite').onclick=()=>{
  navigator.clipboard.writeText($('inviteCode').textContent);
  $('copyInvite').textContent='Copied!';
  setTimeout(()=>$('copyInvite').textContent='Copy',2000);
};

$('closeInvite').onclick=()=>$('inviteModal').classList.remove('show');

$('ctxNewCh').onclick=()=>{
  curSrv=$('ctxMenu').dataset.sid;
  $('createChModal').classList.add('show');$('newChName').value='';
  setTimeout(()=>$('newChName').focus(),100);
};

$('ctxLeave').onclick=async()=>{
  const sid=$('ctxMenu').dataset.sid;
  const s=srvs.find(x=>x.id===sid);
  if(!confirm(`Leave "${s?.name}"?`))return;
  try{
    await db.collection('servers').doc(sid).update({members:AR(me.uid)});
    await db.collection('users').doc(me.uid).update({servers:AR(sid)});
    if(curSrv===sid)goHome();
  }catch(e){console.error(e)}
};

$('ctxDelete').onclick=async()=>{
  const sid=$('ctxMenu').dataset.sid;
  const s=srvs.find(x=>x.id===sid);
  if(!confirm(`Delete "${s?.name}" permanently?`))return;
  try{
    const sd=await db.collection('servers').doc(sid).get();
    const mids=sd.data().members||[];
    for(const uid of mids)await db.collection('users').doc(uid).update({servers:AR(sid)});
    const cs=await db.collection('servers').doc(sid).collection('channels').get();
    for(const ch of cs.docs){
      const ms=await db.collection('servers').doc(sid).collection('channels').doc(ch.id).collection('messages').get();
      for(const m of ms.docs)await m.ref.delete();
      const ts=await db.collection('servers').doc(sid).collection('channels').doc(ch.id).collection('typing').get();
      for(const t of ts.docs)await t.ref.delete();
      await ch.ref.delete();
    }
    await db.collection('servers').doc(sid).delete();
    if(curSrv===sid)goHome();
  }catch(e){console.error(e)}
};

// ===== SETTINGS =====
$('settingsBtn').onclick=()=>{$('settingsOverlay').classList.add('show');$('editName').value=profile.username;setTimeout(()=>$('editName').focus(),150)};
$('closeSettings').onclick=()=>$('settingsOverlay').classList.remove('show');

$('saveProfile').onclick=async()=>{
  const n=$('editName').value.trim();if(!n)return;
  try{await db.collection('users').doc(me.uid).update({username:n});profile.username=n;syncPanel();$('settingsOverlay').classList.remove('show')}catch(e){console.error(e)}
};

$('logoutBtn').onclick=async()=>{
  $('settingsOverlay').classList.remove('show');
  try{await db.collection('users').doc(me.uid).update({status:'offline'})}catch(e){}
  auth.signOut();
};

// ===== UTILS =====
function esc(s){if(!s)return'';const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function fTime(d){return d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}
function fDate(d){
  const today=new Date(),y=new Date(today);y.setDate(y.getDate()-1);
  if(d.toDateString()===today.toDateString())return'Today';
  if(d.toDateString()===y.toDateString())return'Yesterday';
  return d.toLocaleDateString(undefined,{month:'short',day:'numeric'});
}

// Close modals
document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('show')}));
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){
    document.querySelectorAll('.modal-overlay.show').forEach(m=>m.classList.remove('show'));
    $('settingsOverlay').classList.remove('show');
    $('lightbox').classList.remove('show');
  }
});

// Online status
document.addEventListener('visibilitychange',()=>{
  if(!me)return;
  db.collection('users').doc(me.uid).update({status:document.hidden?'idle':'online'}).catch(()=>{});
});

window.addEventListener('beforeunload',()=>{
  if(me)db.collection('users').doc(me.uid).update({status:'offline'}).catch(()=>{});
});

// Expose lightbox function
window.openLb=openLb;
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat.</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #0f0f23;
            --bg-quaternary: #1f1f3a;
            --accent: #6c5ce7;
            --accent-hover: #5b4cdb;
            --accent-light: rgba(108, 92, 231, 0.2);
            --text-primary: #ffffff;
            --text-secondary: #b2b2c9;
            --text-muted: #72728f;
            --online: #2ecc71;
            --idle: #f39c12;
            --dnd: #e74c3c;
            --offline: #636e72;
            --danger: #e74c3c;
            --success: #2ecc71;
            --border: rgba(255, 255, 255, 0.08);
            --message-hover: rgba(255, 255, 255, 0.03);
            --scrollbar: rgba(255, 255, 255, 0.1);
            --scrollbar-hover: rgba(255, 255, 255, 0.2);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--scrollbar);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-hover);
        }

        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-primary) 50%, var(--bg-secondary) 100%);
            padding: 20px;
        }

        .auth-box {
            background: var(--bg-quaternary);
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 420px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border);
        }

        .auth-logo {
            text-align: center;
            margin-bottom: 32px;
        }

        .auth-logo h1 {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent), #a29bfe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .auth-logo p {
            color: var(--text-secondary);
            margin-top: 8px;
            font-size: 14px;
        }

        .auth-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            background: var(--bg-tertiary);
            padding: 4px;
            border-radius: 10px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .auth-tab.active {
            background: var(--accent);
            color: white;
        }

        .auth-tab:hover:not(.active) {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 15px;
            transition: all 0.2s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-light);
        }

        .form-group input::placeholder {
            color: var(--text-muted);
        }

        .phone-input-group {
            display: flex;
            gap: 8px;
        }

        .phone-input-group select {
            width: 100px;
            padding: 14px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 15px;
            cursor: pointer;
        }

        .phone-input-group select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .phone-input-group input {
            flex: 1;
        }

        .btn {
            width: 100%;
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-google {
            background: white;
            color: #333;
            margin-top: 12px;
        }

        .btn-google:hover {
            background: #f8f8f8;
            transform: translateY(-1px);
        }

        .btn-google svg {
            width: 20px;
            height: 20px;
        }

        .divider {
            display: flex;
            align-items: center;
            margin: 24px 0;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        .divider span {
            padding: 0 16px;
            color: var(--text-muted);
            font-size: 13px;
        }

        .verification-sent {
            text-align: center;
            padding: 20px;
        }

        .verification-sent svg {
            width: 64px;
            height: 64px;
            color: var(--accent);
            margin-bottom: 16px;
        }

        .verification-input {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 24px 0;
        }

        .verification-input input {
            width: 48px;
            height: 56px;
            text-align: center;
            font-size: 24px;
            font-weight: 600;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
        }

        .verification-input input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .app-container {
            display: none;
            height: 100vh;
        }

        .app-container.active {
            display: flex;
        }

        .server-sidebar {
            width: 72px;
            background: var(--bg-tertiary);
            padding: 12px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            overflow-y: auto;
        }

        .server-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--bg-quaternary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            font-weight: 600;
            font-size: 18px;
            color: var(--text-primary);
            overflow: hidden;
        }

        .server-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .server-icon:hover,
        .server-icon.active {
            border-radius: 16px;
            background: var(--accent);
        }

        .server-icon::before {
            content: '';
            position: absolute;
            left: -12px;
            width: 4px;
            height: 0;
            background: var(--text-primary);
            border-radius: 0 4px 4px 0;
            transition: all 0.2s;
        }

        .server-icon:hover::before {
            height: 20px;
        }

        .server-icon.active::before {
            height: 36px;
        }

        .home-icon {
            background: var(--accent) !important;
            margin-bottom: 8px;
        }

        .home-icon svg {
            width: 28px;
            height: 28px;
        }

        .server-divider {
            width: 32px;
            height: 2px;
            background: var(--border);
            border-radius: 1px;
            margin: 4px 0;
        }

        .add-server {
            background: transparent !important;
            border: 2px dashed var(--border);
            color: var(--success);
        }

        .add-server:hover {
            background: var(--success) !important;
            color: white;
            border-color: transparent;
        }

        .add-server svg {
            width: 24px;
            height: 24px;
        }

        .channel-sidebar {
            width: 240px;
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
        }

        .server-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: background 0.2s;
        }

        .server-header:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .server-header h2 {
            font-size: 15px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .server-header svg {
            width: 18px;
            height: 18px;
            color: var(--text-secondary);
        }

        .channel-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px 8px;
        }

        .channel-category {
            margin-bottom: 16px;
        }

        .category-header {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .category-header:hover {
            color: var(--text-secondary);
        }

        .category-header svg {
            width: 12px;
            height: 12px;
            margin-right: 4px;
            transition: transform 0.2s;
        }

        .category-header.collapsed svg {
            transform: rotate(-90deg);
        }

        .category-actions {
            margin-left: auto;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .category-header:hover .category-actions {
            opacity: 1;
        }

        .category-actions svg {
            width: 16px;
            height: 16px;
        }

        .channel-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin: 2px 0;
            border-radius: 6px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.15s;
        }

        .channel-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .channel-item.active {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
        }

        .channel-item svg {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            flex-shrink: 0;
        }

        .channel-name {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .channel-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .channel-item:hover .channel-actions {
            opacity: 1;
        }

        .channel-action-btn {
            padding: 4px;
            border-radius: 4px;
            color: var(--text-muted);
            transition: all 0.15s;
        }

        .channel-action-btn:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.1);
        }

        .channel-action-btn svg {
            width: 16px;
            height: 16px;
            margin: 0;
        }

        .user-panel {
            padding: 12px;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            position: relative;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-status {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--online);
            border: 3px solid var(--bg-tertiary);
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-tag {
            font-size: 11px;
            color: var(--text-muted);
        }

        .user-actions {
            display: flex;
            gap: 4px;
        }

        .user-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .user-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .user-action-btn svg {
            width: 18px;
            height: 18px;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
        }

        .chat-header {
            height: 48px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border);
            background: var(--bg-primary);
        }

        .chat-header svg {
            width: 22px;
            height: 22px;
            color: var(--text-muted);
            margin-right: 10px;
        }

        .chat-header h3 {
            font-size: 16px;
            font-weight: 600;
        }

        .chat-header-actions {
            margin-left: auto;
            display: flex;
            gap: 8px;
        }

        .header-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .header-btn:hover {
            color: var(--text-primary);
        }

        .header-btn svg {
            width: 20px;
            height: 20px;
            margin: 0;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
        }

        .messages-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-top: auto;
        }

        .message {
            display: flex;
            padding: 4px 12px;
            border-radius: 8px;
            transition: background 0.15s;
        }

        .message:hover {
            background: var(--message-hover);
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
            margin-right: 12px;
            flex-shrink: 0;
            margin-top: 4px;
            overflow: hidden;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message-content {
            flex: 1;
            min-width: 0;
        }

        .message-header {
            display: flex;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 4px;
        }

        .message-author {
            font-weight: 600;
            font-size: 15px;
            color: var(--text-primary);
        }

        .message-timestamp {
            font-size: 11px;
            color: var(--text-muted);
        }

        .message-text {
            font-size: 14px;
            line-height: 1.5;
            color: var(--text-secondary);
            word-wrap: break-word;
        }

        .message-compact {
            padding-left: 64px;
        }

        .message-compact .message-avatar {
            display: none;
        }

        .message-compact .message-header {
            display: none;
        }

        .message-compact:hover .compact-time {
            opacity: 1;
        }

        .compact-time {
            position: absolute;
            left: 12px;
            font-size: 10px;
            color: var(--text-muted);
            opacity: 0;
            transition: opacity 0.15s;
        }

        .message-actions {
            position: absolute;
            right: 12px;
            top: -16px;
            display: flex;
            background: var(--bg-quaternary);
            border-radius: 6px;
            border: 1px solid var(--border);
            opacity: 0;
            transition: opacity 0.15s;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .message-action-btn {
            padding: 6px 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
        }

        .message-action-btn:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .message-action-btn svg {
            width: 18px;
            height: 18px;
        }

        .chat-input-container {
            padding: 0 16px 24px;
        }

        .chat-input-wrapper {
            background: var(--bg-quaternary);
            border-radius: 12px;
            display: flex;
            align-items: flex-end;
            padding: 4px;
        }

        .chat-input-actions {
            display: flex;
            padding: 8px;
        }

        .input-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .input-action-btn:hover {
            color: var(--text-primary);
        }

        .input-action-btn svg {
            width: 22px;
            height: 22px;
        }

        .chat-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 15px;
            padding: 12px 0;
            resize: none;
            max-height: 200px;
            line-height: 1.4;
        }

        .chat-input:focus {
            outline: none;
        }

        .chat-input::placeholder {
            color: var(--text-muted);
        }

        .send-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--accent);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 6px;
            transition: all 0.2s;
        }

        .send-btn:hover {
            background: var(--accent-hover);
            transform: scale(1.05);
        }

        .send-btn:disabled {
            background: var(--bg-tertiary);
            color: var(--text-muted);
            cursor: not-allowed;
            transform: none;
        }

        .send-btn svg {
            width: 20px;
            height: 20px;
        }

        .member-sidebar {
            width: 240px;
            background: var(--bg-secondary);
            padding: 16px;
            overflow-y: auto;
        }

        .member-category {
            margin-bottom: 20px;
        }

        .member-category-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .member-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .member-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .member-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            margin-right: 10px;
            position: relative;
            overflow: hidden;
        }

        .member-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .member-status-dot {
            position: absolute;
            bottom: -1px;
            right: -1px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid var(--bg-secondary);
        }

        .member-status-dot.online {
            background: var(--online);
        }

        .member-status-dot.offline {
            background: var(--offline);
        }

        .member-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .member-item:hover .member-name {
            color: var(--text-primary);
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-quaternary);
            border-radius: 16px;
            padding: 24px;
            width: 100%;
            max-width: 440px;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.2s;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .modal-close svg {
            width: 20px;
            height: 20px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .modal-actions .btn {
            flex: 1;
        }

        .btn-secondary {
            background: transparent;
            color: var(--text-secondary);
        }

        .btn-secondary:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .home-view {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .home-view.active {
            display: flex;
        }

        .dm-list {
            padding: 8px;
        }

        .dm-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
        }

        .dm-header h3 {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .dm-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .dm-item:hover,
        .dm-item.active {
            background: rgba(255, 255, 255, 0.05);
        }

        .dm-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            margin-right: 12px;
            position: relative;
            overflow: hidden;
        }

        .dm-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .dm-info {
            flex: 1;
        }

        .dm-name {
            font-size: 14px;
            font-weight: 500;
        }

        .dm-status {
            font-size: 12px;
            color: var(--text-muted);
        }

        .welcome-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px;
        }

        .welcome-screen svg {
            width: 120px;
            height: 120px;
            color: var(--accent);
            margin-bottom: 24px;
        }

        .welcome-screen h2 {
            font-size: 28px;
            margin-bottom: 12px;
        }

        .welcome-screen p {
            color: var(--text-secondary);
            max-width: 400px;
            line-height: 1.6;
        }

        .typing-indicator {
            padding: 8px 16px;
            font-size: 13px;
            color: var(--text-muted);
            display: none;
        }

        .typing-indicator.active {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dots span {
            width: 6px;
            height: 6px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-4px);
            }
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 3000;
        }

        .toast {
            padding: 14px 20px;
            background: var(--bg-quaternary);
            border-radius: 10px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .toast.success {
            border-color: var(--success);
        }

        .toast.error {
            border-color: var(--danger);
        }

        .toast svg {
            width: 20px;
            height: 20px;
        }

        .toast.success svg {
            color: var(--success);
        }

        .toast.error svg {
            color: var(--danger);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .settings-view {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            display: none;
            z-index: 1500;
        }

        .settings-view.active {
            display: flex;
        }

        .settings-sidebar {
            width: 240px;
            background: var(--bg-secondary);
            padding: 60px 20px 20px;
            overflow-y: auto;
        }

        .settings-category {
            margin-bottom: 24px;
        }

        .settings-category-title {
            font-size: 11px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 12px;
        }

        .settings-item {
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 14px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
        }

        .settings-item:hover,
        .settings-item.active {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .settings-item.danger {
            color: var(--danger);
        }

        .settings-content {
            flex: 1;
            padding: 60px 40px 40px;
            overflow-y: auto;
        }

        .settings-close {
            position: fixed;
            top: 60px;
            right: 40px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: transparent;
            border: 2px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .settings-close:hover {
            border-color: var(--text-primary);
            color: var(--text-primary);
        }

        .settings-section {
            max-width: 600px;
        }

        .settings-section h2 {
            font-size: 20px;
            margin-bottom: 20px;
        }

        .settings-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .settings-row {
            display: flex;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
        }

        .settings-row:last-child {
            border-bottom: none;
        }

        .settings-row-info {
            flex: 1;
        }

        .settings-row-label {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .settings-row-value {
            font-size: 13px;
            color: var(--text-muted);
        }

        .settings-row .btn {
            width: auto;
            padding: 8px 16px;
            font-size: 13px;
        }

        .context-menu {
            position: fixed;
            background: var(--bg-quaternary);
            border-radius: 8px;
            border: 1px solid var(--border);
            padding: 6px;
            min-width: 180px;
            z-index: 2000;
            display: none;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .context-menu.active {
            display: block;
        }

        .context-item {
            padding: 10px 12px;
            border-radius: 4px;
            font-size: 14px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.15s;
        }

        .context-item:hover {
            background: var(--accent);
            color: white;
        }

        .context-item.danger:hover {
            background: var(--danger);
        }

        .context-item svg {
            width: 18px;
            height: 18px;
        }

        .context-divider {
            height: 1px;
            background: var(--border);
            margin: 6px 0;
        }

        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            text-align: center;
            padding: 40px;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 18px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .invite-code {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .invite-code input {
            flex: 1;
            padding: 14px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: monospace;
        }

        .invite-code .btn {
            width: auto;
            padding: 14px 20px;
        }

        @media (max-width: 1200px) {
            .member-sidebar {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .channel-sidebar {
                display: none;
            }
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="auth-logo">
                <h1>Chat.</h1>
                <p>Connect with friends and communities</p>
            </div>

            <div class="auth-tabs">
                <button class="auth-tab active" data-tab="email">Email</button>
                <button class="auth-tab" data-tab="phone">Phone</button>
            </div>

            <form class="auth-form active" id="emailForm" data-form="email">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="emailInput" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="passwordInput" placeholder="Enter your password" required>
                </div>
                <div class="form-group" id="usernameGroup" style="display: none;">
                    <label>Username</label>
                    <input type="text" id="usernameInput" placeholder="Choose a username">
                </div>
                <button type="submit" class="btn btn-primary" id="emailSubmitBtn">Sign In</button>
                <p style="text-align: center; margin-top: 12px;">
                    <a href="#" id="toggleAuthMode" style="color: var(--accent); text-decoration: none; font-size: 14px;">Need an account? Register</a>
                </p>
                <div class="divider"><span>or continue with</span></div>
                <button type="button" class="btn btn-google" id="googleSignIn">
                    <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
                    Continue with Google
                </button>
            </form>

            <form class="auth-form" id="phoneForm" data-form="phone">
                <div id="phoneStep1">
                    <div class="form-group">
                        <label>Phone Number</label>
                        <div class="phone-input-group">
                            <select id="countryCode">
                                <option value="+1">+1</option>
                                <option value="+44">+44</option>
                                <option value="+91">+91</option>
                                <option value="+86">+86</option>
                                <option value="+81">+81</option>
                                <option value="+49">+49</option>
                                <option value="+33">+33</option>
                                <option value="+55">+55</option>
                                <option value="+7">+7</option>
                            </select>
                            <input type="tel" id="phoneInput" placeholder="Phone number" required>
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary" id="sendCodeBtn">Send Code</button>
                    <div id="recaptcha-container"></div>
                </div>
                <div id="phoneStep2" style="display: none;">
                    <div class="verification-sent">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                        </svg>
                        <h3>Verification Code Sent</h3>
                        <p style="color: var(--text-secondary); font-size: 14px;">Enter the 6-digit code we sent to your phone</p>
                    </div>
                    <div class="verification-input">
                        <input type="text" maxlength="1" class="code-input">
                        <input type="text" maxlength="1" class="code-input">
                        <input type="text" maxlength="1" class="code-input">
                        <input type="text" maxlength="1" class="code-input">
                        <input type="text" maxlength="1" class="code-input">
                        <input type="text" maxlength="1" class="code-input">
                    </div>
                    <button type="button" class="btn btn-primary" id="verifyCodeBtn">Verify</button>
                </div>
            </form>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        <div class="server-sidebar">
            <div class="server-icon home-icon active" data-server="home" title="Home">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
            </div>
            <div class="server-divider"></div>
            <div id="serverList"></div>
            <div class="server-icon add-server" id="addServerBtn" title="Add a Server">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
            </div>
        </div>

        <div class="channel-sidebar" id="channelSidebar">
            <div class="home-view active" id="homeView">
                <div class="server-header">
                    <h2>Direct Messages</h2>
                </div>
                <div class="dm-list">
                    <div class="dm-header">
                        <h3>Friends</h3>
                    </div>
                    <div id="dmList"></div>
                </div>
            </div>

            <div class="server-view hidden" id="serverView">
                <div class="server-header" id="serverHeader">
                    <h2 id="serverName">Server Name</h2>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>
                <div class="channel-list" id="channelList"></div>
            </div>

            <div class="user-panel">
                <div class="user-avatar" id="userAvatar">
                    <div class="user-status"></div>
                </div>
                <div class="user-info">
                    <div class="user-name" id="userName">Username</div>
                    <div class="user-tag" id="userTag">#0000</div>
                </div>
                <div class="user-actions">
                    <button class="user-action-btn" id="settingsBtn" title="Settings">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/><path d="M12 1v4m0 14v4m-9-9h4m14 0h-4m-2.5-6.5L16 5m-8 14l2.5-2.5M5 8l2.5 2.5M16 19l2.5-2.5"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="chat-header">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M5.88 21.26l.1-.72.16-1.2.06-.43-.39-.16a5.92 5.92 0 0 1-3.8-5.5c0-3.3 3.04-6 6.74-6s6.75 2.7 6.75 6c0 3.3-3.05 6-6.75 6a7.3 7.3 0 0 1-1.6-.18l-.45-.1-.43.18c-.75.32-1.53.56-2.39.85l.05-.26z"/>
                </svg>
                <h3 id="chatTitle">Welcome</h3>
                <div class="chat-header-actions">
                    <button class="header-btn" id="toggleMembersBtn" title="Toggle Member List">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="welcome-screen" id="welcomeScreen">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                <h2>Welcome to Chat.</h2>
                <p>Select a server or DM to start chatting with your friends and communities.</p>
            </div>

            <div class="messages-container hidden" id="messagesContainer">
                <div class="messages-list" id="messagesList"></div>
            </div>

            <div class="typing-indicator" id="typingIndicator">
                <div class="typing-dots">
                    <span></span><span></span><span></span>
                </div>
                <span id="typingUsers">Someone is typing...</span>
            </div>

            <div class="chat-input-container hidden" id="chatInputContainer">
                <div class="chat-input-wrapper">
                    <div class="chat-input-actions">
                        <button class="input-action-btn" title="Attach file">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/>
                            </svg>
                        </button>
                    </div>
                    <textarea class="chat-input" id="messageInput" placeholder="Message #general" rows="1"></textarea>
                    <button class="send-btn" id="sendBtn" disabled>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="member-sidebar" id="memberSidebar">
            <div class="member-category">
                <div class="member-category-title">Online — <span id="onlineCount">0</span></div>
                <div id="onlineMembers"></div>
            </div>
            <div class="member-category">
                <div class="member-category-title">Offline — <span id="offlineCount">0</span></div>
                <div id="offlineMembers"></div>
            </div>
        </div>
    </div>

    <div class="settings-view" id="settingsView">
        <div class="settings-sidebar">
            <div class="settings-category">
                <div class="settings-category-title">User Settings</div>
                <div class="settings-item active">My Account</div>
                <div class="settings-item">Profiles</div>
                <div class="settings-item">Privacy & Safety</div>
            </div>
            <div class="settings-category">
                <div class="settings-category-title">App Settings</div>
                <div class="settings-item">Appearance</div>
                <div class="settings-item">Notifications</div>
            </div>
            <div class="settings-category">
                <div class="settings-item danger" id="logoutBtn">Log Out</div>
            </div>
        </div>
        <div class="settings-content">
            <div class="settings-section">
                <h2>My Account</h2>
                <div class="settings-card">
                    <div class="settings-row">
                        <div class="user-avatar" id="settingsAvatar" style="width: 80px; height: 80px; font-size: 32px;">
                            <img src="" id="settingsAvatarImg" style="display: none;">
                        </div>
                        <div class="settings-row-info" style="margin-left: 20px;">
                            <div class="settings-row-label" id="settingsUsername">Username</div>
                            <div class="settings-row-value" id="settingsEmail">email@example.com</div>
                        </div>
                        <button class="btn btn-primary" id="editProfileBtn">Edit Profile</button>
                    </div>
                </div>
                <div class="settings-card">
                    <div class="settings-row">
                        <div class="settings-row-info">
                            <div class="settings-row-label">Username</div>
                            <div class="settings-row-value" id="settingsUsernameValue">username#0000</div>
                        </div>
                        <button class="btn btn-secondary" id="editUsernameBtn">Edit</button>
                    </div>
                    <div class="settings-row">
                        <div class="settings-row-info">
                            <div class="settings-row-label">Email</div>
                            <div class="settings-row-value" id="settingsEmailValue">email@example.com</div>
                        </div>
                    </div>
                    <div class="settings-row">
                        <div class="settings-row-info">
                            <div class="settings-row-label">Phone Number</div>
                            <div class="settings-row-value" id="settingsPhoneValue">Not set</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <button class="settings-close" id="settingsClose">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
        </button>
    </div>

    <div class="modal-overlay" id="createServerModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Create a Server</h2>
                <button class="modal-close" onclick="closeModal('createServerModal')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="form-group">
                <label>Server Name</label>
                <input type="text" id="newServerName" placeholder="My Awesome Server">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('createServerModal')">Cancel</button>
                <button class="btn btn-primary" id="createServerBtn">Create</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="createChannelModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Create Channel</h2>
                <button class="modal-close" onclick="closeModal('createChannelModal')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="form-group">
                <label>Channel Name</label>
                <input type="text" id="newChannelName" placeholder="new-channel">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('createChannelModal')">Cancel</button>
                <button class="btn btn-primary" id="createChannelBtn">Create</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="inviteModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Invite Friends</h2>
                <button class="modal-close" onclick="closeModal('inviteModal')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <p style="color: var(--text-secondary); margin-bottom: 8px;">Share this invite code with friends:</p>
            <div class="invite-code">
                <input type="text" id="inviteCodeInput" readonly>
                <button class="btn btn-primary" id="copyInviteBtn">Copy</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="joinServerModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Join a Server</h2>
                <button class="modal-close" onclick="closeModal('joinServerModal')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <div class="form-group">
                <label>Invite Code</label>
                <input type="text" id="joinServerCode" placeholder="Enter invite code">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('joinServerModal')">Cancel</button>
                <button class="btn btn-primary" id="joinServerBtn">Join</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="serverOptionsModal">
        <div class="modal">
            <div class="modal-header">
                <h2>Add a Server</h2>
                <button class="modal-close" onclick="closeModal('serverOptionsModal')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>
            <button class="btn btn-primary" onclick="closeModal('serverOptionsModal'); openModal('createServerModal')" style="margin-bottom: 12px;">
                Create My Own
            </button>
            <button class="btn btn-secondary" onclick="closeModal('serverOptionsModal'); openModal('joinServerModal')">
                Join a Server
            </button>
        </div>
    </div>

    <div class="context-menu" id="contextMenu">
        <div class="context-item" id="contextInvite">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/>
            </svg>
            Invite People
        </div>
        <div class="context-item" id="contextCreateChannel">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            Create Channel
        </div>
        <div class="context-divider"></div>
        <div class="context-item danger" id="contextLeaveServer">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/>
            </svg>
            Leave Server
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBJMIUucxOusoVzs4lc-QurCxjlW6Hlsuw",
            authDomain: "chat-5f0bf.firebaseapp.com",
            projectId: "chat-5f0bf",
            storageBucket: "chat-5f0bf.firebasestorage.app",
            messagingSenderId: "211425841353",
            appId: "1:211425841353:web:e1c271a340d73abd0cfd18"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // App State
        let currentUser = null;
        let currentServer = null;
        let currentChannel = null;
        let isRegistering = false;
        let confirmationResult = null;
        let unsubscribeMessages = null;
        let unsubscribeServers = null;
        let unsubscribeMembers = null;

        // DOM Elements
        const loadingOverlay = document.getElementById('loadingOverlay');
        const authContainer = document.getElementById('authContainer');
        const appContainer = document.getElementById('appContainer');
        const settingsView = document.getElementById('settingsView');

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            initializeAuth();
            initializeEventListeners();
        });

        // Auth State Observer
        function initializeAuth() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    currentUser = user;
                    await ensureUserProfile(user);
                    showApp();
                    loadServers();
                    updateUserPanel();
                } else {
                    currentUser = null;
                    showAuth();
                }
            });
        }

        // Ensure User Profile Exists
        async function ensureUserProfile(user) {
            const userRef = db.collection('users').doc(user.uid);
            const doc = await userRef.get();
            
            if (!doc.exists) {
                const tag = Math.floor(1000 + Math.random() * 9000);
                await userRef.set({
                    uid: user.uid,
                    email: user.email || '',
                    phone: user.phoneNumber || '',
                    displayName: user.displayName || user.email?.split('@')[0] || 'User',
                    photoURL: user.photoURL || '',
                    tag: tag,
                    status: 'online',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } else {
                await userRef.update({
                    status: 'online',
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        }

        // Event Listeners
        function initializeEventListeners() {
            // Auth Tabs
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelector(`.auth-form[data-form="${tab.dataset.tab}"]`).classList.add('active');
                });
            });

            // Toggle Auth Mode
            document.getElementById('toggleAuthMode').addEventListener('click', (e) => {
                e.preventDefault();
                isRegistering = !isRegistering;
                document.getElementById('usernameGroup').style.display = isRegistering ? 'block' : 'none';
                document.getElementById('emailSubmitBtn').textContent = isRegistering ? 'Create Account' : 'Sign In';
                e.target.textContent = isRegistering ? 'Already have an account? Sign In' : 'Need an account? Register';
            });

            // Email Auth
            document.getElementById('emailForm').addEventListener('submit', handleEmailAuth);

            // Google Auth
            document.getElementById('googleSignIn').addEventListener('click', handleGoogleAuth);

            // Phone Auth
            document.getElementById('sendCodeBtn').addEventListener('click', handleSendCode);
            document.getElementById('verifyCodeBtn').addEventListener('click', handleVerifyCode);

            // Verification code inputs
            document.querySelectorAll('.code-input').forEach((input, index, inputs) => {
                input.addEventListener('input', (e) => {
                    if (e.target.value && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }
                });
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Backspace' && !e.target.value && index > 0) {
                        inputs[index - 1].focus();
                    }
                });
            });

            // Server Actions
            document.getElementById('addServerBtn').addEventListener('click', () => openModal('serverOptionsModal'));
            document.getElementById('createServerBtn').addEventListener('click', createServer);
            document.getElementById('joinServerBtn').addEventListener('click', joinServer);

            // Channel Actions
            document.getElementById('createChannelBtn').addEventListener('click', createChannel);

            // Message Input
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');

            messageInput.addEventListener('input', () => {
                sendBtn.disabled = !messageInput.value.trim();
                messageInput.style.height = 'auto';
                messageInput.style.height = messageInput.scrollHeight + 'px';
            });

            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            sendBtn.addEventListener('click', sendMessage);

            // Home Button
            document.querySelector('.home-icon').addEventListener('click', showHome);

            // Settings
            document.getElementById('settingsBtn').addEventListener('click', () => {
                settingsView.classList.add('active');
                updateSettingsUI();
            });

            document.getElementById('settingsClose').addEventListener('click', () => {
                settingsView.classList.remove('active');
            });

            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Server Header Context Menu
            document.getElementById('serverHeader').addEventListener('click', (e) => {
                if (!currentServer) return;
                const contextMenu = document.getElementById('contextMenu');
                contextMenu.style.top = e.clientY + 'px';
                contextMenu.style.left = e.clientX + 'px';
                contextMenu.classList.add('active');
            });

            // Context Menu Actions
            document.getElementById('contextInvite').addEventListener('click', () => {
                closeContextMenu();
                showInviteModal();
            });

            document.getElementById('contextCreateChannel').addEventListener('click', () => {
                closeContextMenu();
                openModal('createChannelModal');
            });

            document.getElementById('contextLeaveServer').addEventListener('click', () => {
                closeContextMenu();
                leaveServer();
            });

            // Copy Invite
            document.getElementById('copyInviteBtn').addEventListener('click', () => {
                const input = document.getElementById('inviteCodeInput');
                input.select();
                document.execCommand('copy');
                showToast('Copied to clipboard!', 'success');
            });

            // Toggle Members
            document.getElementById('toggleMembersBtn').addEventListener('click', () => {
                document.getElementById('memberSidebar').classList.toggle('hidden');
            });

            // Close menus on click outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.context-menu') && !e.target.closest('.server-header')) {
                    closeContextMenu();
                }
            });
        }

        // Email Authentication
        async function handleEmailAuth(e) {
            e.preventDefault();
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;

            try {
                if (isRegistering) {
                    const username = document.getElementById('usernameInput').value;
                    const result = await auth.createUserWithEmailAndPassword(email, password);
                    if (username) {
                        await result.user.updateProfile({ displayName: username });
                    }
                    showToast('Account created!', 'success');
                } else {
                    await auth.signInWithEmailAndPassword(email, password);
                    showToast('Welcome back!', 'success');
                }
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // Google Authentication
        async function handleGoogleAuth() {
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                await auth.signInWithPopup(provider);
                showToast('Signed in with Google!', 'success');
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        // Phone Authentication
        async function handleSendCode() {
            const countryCode = document.getElementById('countryCode').value;
            const phone = document.getElementById('phoneInput').value;
            const phoneNumber = countryCode + phone;

            try {
                window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                    size: 'invisible'
                });

                confirmationResult = await auth.signInWithPhoneNumber(phoneNumber, window.recaptchaVerifier);
                document.getElementById('phoneStep1').style.display = 'none';
                document.getElementById('phoneStep2').style.display = 'block';
                showToast('Code sent!', 'success');
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function handleVerifyCode() {
            const inputs = document.querySelectorAll('.code-input');
            const code = Array.from(inputs).map(i => i.value).join('');

            try {
                await confirmationResult.confirm(code);
                showToast('Phone verified!', 'success');
            } catch (error) {
                showToast('Invalid code', 'error');
            }
        }

        // Show/Hide Views
        function showAuth() {
            loadingOverlay.style.display = 'none';
            authContainer.style.display = 'flex';
            appContainer.classList.remove('active');
        }

        function showApp() {
            loadingOverlay.style.display = 'none';
            auth         function showApp() {
            loadingOverlay.style.display = 'none';
            authContainer.style.display = 'none';
            appContainer.classList.add('active');
        }

        function showHome() {
            document.querySelectorAll('.server-icon').forEach(s => s.classList.remove('active'));
            document.querySelector('.home-icon').classList.add('active');
            document.getElementById('homeView').classList.add('active');
            document.getElementById('serverView').classList.add('hidden');
            document.getElementById('welcomeScreen').classList.remove('hidden');
            document.getElementById('messagesContainer').classList.add('hidden');
            document.getElementById('chatInputContainer').classList.add('hidden');
            document.getElementById('chatTitle').textContent = 'Welcome';
            currentServer = null;
            currentChannel = null;
            if (unsubscribeMessages) unsubscribeMessages();
        }

        // Update User Panel
        async function updateUserPanel() {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();

            document.getElementById('userName').textContent = userData?.displayName || 'User';
            document.getElementById('userTag').textContent = '#' + (userData?.tag || '0000');

            const avatar = document.getElementById('userAvatar');
            if (currentUser.photoURL) {
                avatar.innerHTML = `<img src="${currentUser.photoURL}" alt=""><div class="user-status"></div>`;
            } else {
                avatar.innerHTML = `${(userData?.displayName || 'U')[0].toUpperCase()}<div class="user-status"></div>`;
            }
        }

        // Update Settings UI
        async function updateSettingsUI() {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();

            document.getElementById('settingsUsername').textContent = userData?.displayName || 'User';
            document.getElementById('settingsEmail').textContent = currentUser.email || 'Not set';
            document.getElementById('settingsUsernameValue').textContent = `${userData?.displayName}#${userData?.tag}`;
            document.getElementById('settingsEmailValue').textContent = currentUser.email || 'Not set';
            document.getElementById('settingsPhoneValue').textContent = currentUser.phoneNumber || 'Not set';

            const avatar = document.getElementById('settingsAvatar');
            const avatarImg = document.getElementById('settingsAvatarImg');
            if (currentUser.photoURL) {
                avatarImg.src = currentUser.photoURL;
                avatarImg.style.display = 'block';
            } else {
                avatarImg.style.display = 'none';
                avatar.textContent = (userData?.displayName || 'U')[0].toUpperCase();
            }
        }

        // Load Servers
        function loadServers() {
            if (unsubscribeServers) unsubscribeServers();

            unsubscribeServers = db.collection('servers')
                .where('members', 'array-contains', currentUser.uid)
                .onSnapshot(snapshot => {
                    const serverList = document.getElementById('serverList');
                    serverList.innerHTML = '';

                    snapshot.forEach(doc => {
                        const server = { id: doc.id, ...doc.data() };
                        const serverEl = createServerElement(server);
                        serverList.appendChild(serverEl);
                    });
                });
        }

        // Create Server Element
        function createServerElement(server) {
            const el = document.createElement('div');
            el.className = 'server-icon';
            el.dataset.server = server.id;
            el.title = server.name;

            if (server.icon) {
                el.innerHTML = `<img src="${server.icon}" alt="${server.name}">`;
            } else {
                el.textContent = server.name.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
            }

            el.addEventListener('click', () => selectServer(server));
            return el;
        }

        // Select Server
        async function selectServer(server) {
            currentServer = server;

            document.querySelectorAll('.server-icon').forEach(s => s.classList.remove('active'));
            document.querySelector(`[data-server="${server.id}"]`).classList.add('active');

            document.getElementById('homeView').classList.remove('active');
            document.getElementById('serverView').classList.remove('hidden');
            document.getElementById('serverName').textContent = server.name;

            loadChannels(server.id);
            loadMembers(server.id);
        }

        // Load Channels
        function loadChannels(serverId) {
            db.collection('servers').doc(serverId).collection('channels')
                .orderBy('createdAt')
                .onSnapshot(snapshot => {
                    const channelList = document.getElementById('channelList');
                    channelList.innerHTML = `
                        <div class="channel-category">
                            <div class="category-header">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"/>
                                </svg>
                                TEXT CHANNELS
                                <div class="category-actions">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="cursor:pointer;" onclick="openModal('createChannelModal')">
                                        <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                                    </svg>
                                </div>
                            </div>
                            <div id="textChannels"></div>
                        </div>
                    `;

                    const textChannels = document.getElementById('textChannels');

                    if (snapshot.empty) {
                        db.collection('servers').doc(serverId).collection('channels').add({
                            name: 'general',
                            type: 'text',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        return;
                    }

                    let firstChannel = null;
                    snapshot.forEach(doc => {
                        const channel = { id: doc.id, ...doc.data() };
                        if (!firstChannel) firstChannel = channel;
                        const channelEl = createChannelElement(channel);
                        textChannels.appendChild(channelEl);
                    });

                    if (firstChannel && !currentChannel) {
                        selectChannel(firstChannel);
                    }
                });
        }

        // Create Channel Element
        function createChannelElement(channel) {
            const el = document.createElement('div');
            el.className = 'channel-item' + (currentChannel?.id === channel.id ? ' active' : '');
            el.dataset.channel = channel.id;
            el.innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 9h16M4 15h16M10 3L8 21M16 3l-2 18"/>
                </svg>
                <span class="channel-name">${channel.name}</span>
            `;
            el.addEventListener('click', () => selectChannel(channel));
            return el;
        }

        // Select Channel
        function selectChannel(channel) {
            currentChannel = channel;

            document.querySelectorAll('.channel-item').forEach(c => c.classList.remove('active'));
            const channelEl = document.querySelector(`[data-channel="${channel.id}"]`);
            if (channelEl) channelEl.classList.add('active');

            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('messagesContainer').classList.remove('hidden');
            document.getElementById('chatInputContainer').classList.remove('hidden');
            document.getElementById('chatTitle').textContent = channel.name;
            document.getElementById('messageInput').placeholder = `Message #${channel.name}`;

            loadMessages();
        }

        // Load Messages
        function loadMessages() {
            if (unsubscribeMessages) unsubscribeMessages();

            const messagesList = document.getElementById('messagesList');
            messagesList.innerHTML = '';

            unsubscribeMessages = db.collection('servers').doc(currentServer.id)
                .collection('channels').doc(currentChannel.id)
                .collection('messages')
                .orderBy('timestamp', 'asc')
                .limitToLast(50)
                .onSnapshot(snapshot => {
                    messagesList.innerHTML = '';
                    let lastAuthor = null;
                    let lastTime = null;

                    snapshot.forEach(doc => {
                        const msg = { id: doc.id, ...doc.data() };
                        const isCompact = msg.authorId === lastAuthor && 
                            lastTime && msg.timestamp?.toMillis() - lastTime < 300000;
                        
                        const messageEl = createMessageElement(msg, isCompact);
                        messagesList.appendChild(messageEl);

                        lastAuthor = msg.authorId;
                        lastTime = msg.timestamp?.toMillis();
                    });

                    const container = document.getElementById('messagesContainer');
                    container.scrollTop = container.scrollHeight;
                });
        }

        // Create Message Element
        function createMessageElement(msg, isCompact) {
            const el = document.createElement('div');
            el.className = 'message' + (isCompact ? ' message-compact' : '');
            el.style.position = 'relative';

            const time = msg.timestamp?.toDate();
            const timeStr = time ? time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
            const dateStr = time ? time.toLocaleDateString() : '';

            el.innerHTML = `
                ${!isCompact ? `
                    <div class="message-avatar" style="background: hsl(${hashCode(msg.authorId) % 360}, 70%, 50%);">
                        ${msg.authorAvatar ? `<img src="${msg.authorAvatar}" alt="">` : (msg.authorName?.[0]?.toUpperCase() || 'U')}
                    </div>
                ` : '<span class="compact-time">' + timeStr + '</span>'}
                <div class="message-content">
                    ${!isCompact ? `
                        <div class="message-header">
                            <span class="message-author">${msg.authorName || 'Unknown'}</span>
                            <span class="message-timestamp">${dateStr} ${timeStr}</span>
                        </div>
                    ` : ''}
                    <div class="message-text">${escapeHtml(msg.content)}</div>
                </div>
            `;

            return el;
        }

        // Send Message
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content || !currentServer || !currentChannel) return;

            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            const userData = userDoc.data();

            try {
                await db.collection('servers').doc(currentServer.id)
                    .collection('channels').doc(currentChannel.id)
                    .collection('messages').add({
                        content,
                        authorId: currentUser.uid,
                        authorName: userData?.displayName || 'Unknown',
                        authorAvatar: currentUser.photoURL || '',
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });

                input.value = '';
                input.style.height = 'auto';
                document.getElementById('sendBtn').disabled = true;
            } catch (error) {
                showToast('Failed to send message', 'error');
            }
        }

        // Create Server
        async function createServer() {
            const name = document.getElementById('newServerName').value.trim();
            if (!name) return showToast('Please enter a server name', 'error');

            try {
                const inviteCode = generateInviteCode();
                const serverRef = await db.collection('servers').add({
                    name,
                    ownerId: currentUser.uid,
                    members: [currentUser.uid],
                    inviteCode,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                await serverRef.collection('channels').add({
                    name: 'general',
                    type: 'text',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                closeModal('createServerModal');
                document.getElementById('newServerName').value = '';
                showToast('Server created!', 'success');
            } catch (error) {
                showToast('Failed to create server', 'error');
            }
        }

        // Join Server
        async function joinServer() {
            const code = document.getElementById('joinServerCode').value.trim();
            if (!code) return showToast('Please enter an invite code', 'error');

            try {
                const snapshot = await db.collection('servers')
                    .where('inviteCode', '==', code)
                    .limit(1)
                    .get();

                if (snapshot.empty) {
                    return showToast('Invalid invite code', 'error');
                }

                const serverDoc = snapshot.docs[0];
                const serverData = serverDoc.data();

                if (serverData.members.includes(currentUser.uid)) {
                    return showToast('You are already in this server', 'error');
                }

                await serverDoc.ref.update({
                    members: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                });

                closeModal('joinServerModal');
                document.getElementById('joinServerCode').value = '';
                showToast('Joined server!', 'success');
            } catch (error) {
                showToast('Failed to join server', 'error');
            }
        }

        // Create Channel
        async function createChannel() {
            const name = document.getElementById('newChannelName').value.trim().toLowerCase().replace(/\s+/g, '-');
            if (!name || !currentServer) return showToast('Please enter a channel name', 'error');

            try {
                await db.collection('servers').doc(currentServer.id)
                    .collection('channels').add({
                        name,
                        type: 'text',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                closeModal('createChannelModal');
                document.getElementById('newChannelName').value = '';
                showToast('Channel created!', 'success');
            } catch (error) {
                showToast('Failed to create channel', 'error');
            }
        }

        // Leave Server
        async function leaveServer() {
            if (!currentServer) return;

            if (currentServer.ownerId === currentUser.uid) {
                return showToast('You cannot leave a server you own', 'error');
            }

            try {
                await db.collection('servers').doc(currentServer.id).update({
                    members: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
                });

                showHome();
                showToast('Left server', 'success');
            } catch (error) {
                showToast('Failed to leave server', 'error');
            }
        }

        // Load Members
        function loadMembers(serverId) {
            if (unsubscribeMembers) unsubscribeMembers();

            unsubscribeMembers = db.collection('servers').doc(serverId).onSnapshot(async doc => {
                const server = doc.data();
                const members = server?.members || [];

                const onlineContainer = document.getElementById('onlineMembers');
                const offlineContainer = document.getElementById('offlineMembers');
                onlineContainer.innerHTML = '';
                offlineContainer.innerHTML = '';

                let onlineCount = 0;
                let offlineCount = 0;

                for (const memberId of members) {
                    try {
                        const userDoc = await db.collection('users').doc(memberId).get();
                        const userData = userDoc.data();
                        const isOnline = userData?.status === 'online';

                        const memberEl = document.createElement('div');
                        memberEl.className = 'member-item';
                        memberEl.innerHTML = `
                            <div class="member-avatar" style="background: hsl(${hashCode(memberId) % 360}, 70%, 50%);">
                                ${userData?.photoURL ? `<img src="${userData.photoURL}" alt="">` : (userData?.displayName?.[0] || 'U').toUpperCase()}
                                <div class="member-status-dot ${isOnline ? 'online' : 'offline'}"></div>
                            </div>
                            <span class="member-name">${userData?.displayName || 'Unknown'}</span>
                        `;

                        if (isOnline) {
                            onlineContainer.appendChild(memberEl);
                            onlineCount++;
                        } else {
                            offlineContainer.appendChild(memberEl);
                            offlineCount++;
                        }
                    } catch (err) {
                        console.error('Error loading member:', err);
                    }
                }

                document.getElementById('onlineCount').textContent = onlineCount;
                document.getElementById('offlineCount').textContent = offlineCount;
            });
        }

        // Show Invite Modal
        function showInviteModal() {
            if (!currentServer) return;
            document.getElementById('inviteCodeInput').value = currentServer.inviteCode || '';
            openModal('inviteModal');
        }

        // Logout
        async function handleLogout() {
            try {
                if (currentUser) {
                    await db.collection('users').doc(currentUser.uid).update({
                        status: 'offline',
                        lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                await auth.signOut();
                settingsView.classList.remove('active');
                showToast('Logged out', 'success');
            } catch (error) {
                showToast('Failed to log out', 'error');
            }
        }

        // Utility Functions
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function closeContextMenu() {
            document.getElementById('contextMenu').classList.remove('active');
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    ${type === 'success' 
                        ? '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>'
                        : '<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>'
                    }
                </svg>
                <span>${message}</span>
            `;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        function generateInviteCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
            let code = '';
            for (let i = 0; i < 8; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function hashCode(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            return Math.abs(hash);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Set user offline on page close
        window.addEventListener('beforeunload', () => {
            if (currentUser) {
                db.collection('users').doc(currentUser.uid).update({
                    status: 'offline',
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        });

        // Handle visibility change
        document.addEventListener('visibilitychange', () => {
            if (currentUser) {
                db.collection('users').doc(currentUser.uid).update({
                    status: document.hidden ? 'idle' : 'online',
                    lastSeen: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
        });
    </script>
</body>
</html>

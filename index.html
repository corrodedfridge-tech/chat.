<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat.</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--bg-primary:#000;--bg-secondary:#0a0a0a;--bg-tertiary:#111;--bg-elevated:#1a1a1a;--bg-hover:#222;--white:#fff;--gray-500:#737373;--accent:#5865F2;--border:rgba(255,255,255,0.08);--radius:12px}
        body{font-family:'Space Grotesk',sans-serif;background:var(--bg-primary);color:var(--white);height:100vh;overflow:hidden}
        
        /* Loading */
        .loading-screen{position:fixed;inset:0;background:#000;display:flex;justify-content:center;align-items:center;z-index:9999}
        
        /* Auth */
        .auth-container{min-height:100vh;display:none;align-items:center;justify-content:center;background:#000;padding:20px}
        .auth-card{width:100%;max-width:400px;background:#0a0a0a;border:1px solid var(--border);border-radius:24px;padding:40px}
        .form-group{margin-bottom:16px}
        .form-input{width:100%;padding:12px;background:#111;border:1px solid var(--border);border-radius:8px;color:#fff;outline:none}
        .btn{width:100%;padding:12px;border:none;border-radius:8px;background:#fff;color:#000;font-weight:700;cursor:pointer;margin-top:8px}
        .btn:hover{opacity:0.9}
        
        /* Layout */
        .app-container{display:none;height:100vh}
        .app-container.active{display:flex}
        
        /* Server Bar */
        .servers-bar{width:72px;background:#0a0a0a;display:flex;flex-direction:column;align-items:center;padding:12px 0;gap:8px;border-right:1px solid var(--border)}
        .server-btn{width:48px;height:48px;border-radius:50%;background:#111;color:#fff;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px;overflow:hidden;transition:0.2s}
        .server-btn:hover,.server-btn.active{border-radius:16px;background:var(--accent)}
        .server-btn img{width:100%;height:100%;object-fit:cover}
        
        /* Sidebar */
        .sidebar{width:260px;background:#111;display:flex;flex-direction:column;border-right:1px solid var(--border)}
        .sidebar-header{height:50px;padding:0 16px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);font-weight:700}
        .sidebar-content{flex:1;overflow-y:auto;padding:8px}
        
        /* Items */
        .nav-item{display:flex;align-items:center;padding:8px;border-radius:4px;cursor:pointer;gap:10px;color:#aaa}
        .nav-item:hover,.nav-item.active{background:#222;color:#fff}
        .nav-avatar{width:32px;height:32px;border-radius:50%;background:#333;overflow:hidden;flex-shrink:0}
        .nav-avatar img{width:100%;height:100%;object-fit:cover}
        
        /* Main Chat */
        .main-content{flex:1;display:flex;flex-direction:column;background:#000}
        .chat-header{height:50px;padding:0 20px;display:flex;align-items:center;border-bottom:1px solid var(--border);font-weight:700}
        .messages-container{flex:1;padding:20px;overflow-y:auto;display:flex;flex-direction:column}
        
        /* Message */
        .message{display:flex;margin-top:16px;gap:16px}
        .message:hover{background:#050505}
        .message.stacked{margin-top:2px}
        .msg-pfp{width:40px;height:40px;border-radius:50%;background:#333;flex-shrink:0;overflow:hidden;cursor:pointer}
        .msg-pfp img{width:100%;height:100%;object-fit:cover}
        .message.stacked .msg-pfp{opacity:0;height:0}
        .msg-info{flex:1}
        .msg-header{display:flex;gap:8px;align-items:baseline;margin-bottom:4px}
        .message.stacked .msg-header{display:none}
        .msg-name{font-weight:700;font-size:15px;cursor:pointer}
        .msg-name:hover{text-decoration:underline}
        .msg-date{font-size:11px;color:var(--gray-500)}
        .msg-text{color:#dcddde;line-height:1.4;white-space:pre-wrap;word-break:break-word}
        .msg-image{max-width:300px;max-height:300px;border-radius:8px;margin-top:6px;cursor:pointer}
        
        /* Input */
        .chat-input-area{padding:0 20px 24px}
        .chat-input-box{background:#111;border-radius:8px;padding:8px;display:flex;align-items:center;border:1px solid var(--border)}
        .chat-upload-btn{width:32px;height:32px;border-radius:50%;background:#222;color:#fff;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;margin-right:8px;font-size:20px}
        .chat-input{flex:1;background:transparent;border:none;color:#fff;padding:8px;outline:none;resize:none;height:40px}
        
        /* User Panel */
        .user-panel{padding:10px;background:#0a0a0a;display:flex;align-items:center;gap:8px}
        .up-avatar{width:32px;height:32px;border-radius:50%;background:#333;overflow:hidden;cursor:pointer}
        .up-avatar img{width:100%;height:100%;object-fit:cover}
        
        /* Modals */
        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:2000}
        .modal{background:#111;border:1px solid var(--border);border-radius:12px;padding:24px;width:100%;max-width:400px}
        .hidden{display:none!important}
        
        /* Scrollbar */
        ::-webkit-scrollbar{width:8px}
        ::-webkit-scrollbar-track{background:#0a0a0a}
        ::-webkit-scrollbar-thumb{background:#222;border-radius:4px}
    </style>
</head><body>
    <div class="loading-screen" id="loadingScreen">Loading...</div>

    <!-- AUTH -->
    <div class="auth-container" id="authContainer">
        <div class="auth-card">
            <h1 style="text-align:center;margin-bottom:20px">Chat.</h1>
            <div style="display:flex;gap:10px;margin-bottom:20px">
                <button class="btn" style="background:#222;color:#fff" id="tabLogin">Login</button>
                <button class="btn" style="background:#222;color:#fff" id="tabSignup">Sign Up</button>
            </div>
            <!-- Login -->
            <form id="loginForm">
                <div class="form-group"><input type="email" id="lEmail" class="form-input" placeholder="Email" required></div>
                <div class="form-group"><input type="password" id="lPass" class="form-input" placeholder="Password" required></div>
                <button type="submit" class="btn">Log In</button>
            </form>
            <!-- Signup -->
            <form id="signupForm" class="hidden">
                <div class="form-group"><input type="email" id="sEmail" class="form-input" placeholder="Email" required></div>
                <div class="form-group"><input type="text" id="sUser" class="form-input" placeholder="Username (Unique)" required></div>
                <div class="form-group"><input type="password" id="sPass" class="form-input" placeholder="Password" required></div>
                <button type="submit" class="btn">Create Account</button>
            </form>
            <button class="btn" id="googleBtn" style="background:#4285F4;color:#fff;margin-top:16px">Google</button>
        </div>
    </div>

    <!-- APP -->
    <div class="app-container" id="appContainer">
        <!-- Servers -->
        <div class="servers-bar">
            <button class="server-btn active" id="homeBtn" title="Direct Messages">DM</button>
            <div style="width:32px;height:2px;background:var(--border)"></div>
            <div id="serverList" style="display:flex;flex-direction:column;gap:8px;align-items:center;width:100%"></div>
            <button class="server-btn" id="addServerBtn" style="color:#22c55e;background:#111">+</button>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <div id="dmSidebar">
                <div class="sidebar-header">
                    <span>Friends</span>
                    <button id="addFriendBtn" style="background:none;border:none;color:#fff;cursor:pointer;font-size:20px">+</button>
                </div>
                <div class="sidebar-content" id="friendsList"></div>
            </div>
            
            <div id="serverSidebar" class="hidden">
                <div class="sidebar-header">
                    <span id="serverNameDisplay">Server</span>
                    <button id="leaveServerBtn" style="background:none;border:none;color:#ef4444;cursor:pointer;font-size:12px">Leave</button>
                </div>
                <div class="sidebar-content">
                    <div style="font-size:12px;font-weight:700;color:var(--gray-500);margin-bottom:8px">CHANNELS <span id="addChannelBtn" style="float:right;cursor:pointer">+</span></div>
                    <div id="channelList"></div>
                </div>
            </div>

            <div class="user-panel">
                <div class="up-avatar" id="myAvatarBtn"><img src="" id="myAvatarImg" onerror="this.style.display='none'"></div>
                <div style="flex:1;overflow:hidden">
                    <div style="font-size:14px;font-weight:700" id="myDisplayName">User</div>
                    <div style="font-size:11px;color:var(--gray-500)" id="myUsername">@user</div>
                </div>
                <button id="settingsBtn" style="background:none;border:none;color:#aaa;cursor:pointer">⚙️</button>
            </div>
        </div>

        <!-- Main Chat -->
        <div class="main-content">
            <div class="chat-header">
                <span id="chatTitle">Chat</span>
            </div>
            <div class="messages-container" id="messagesList"></div>
            <div class="chat-input-area" id="inputArea">
                <div class="chat-input-box">
                    <button class="chat-upload-btn" id="uploadBtn" title="Upload Image">+</button>
                    <!-- Hidden file inputs -->
                    <input type="file" id="fileInput" accept="image/*" hidden>
                    <input type="file" id="pfpInput" accept="image/*" hidden>
                    
                    <textarea class="chat-input" id="msgInput" placeholder="Message..." rows="1"></textarea>
                    <button class="btn" id="sendBtn" style="width:auto;padding:8px 16px;margin:0">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="modalOverlay">
        <!-- Settings -->
        <div class="modal hidden" id="settingsModal">
            <h2>Settings</h2>
            <div class="form-group"><label>Display Name</label><input class="form-input" id="editDisplay"></div>
            <div class="form-group"><label>Bio</label><input class="form-input" id="editBio"></div>
            <div style="display:flex;gap:10px;align-items:center;margin:10px 0">
                <div class="up-avatar" style="width:60px;height:60px"><img id="settingsPfpPreview"></div>
                <button class="btn" style="width:auto" onclick="document.getElementById('pfpInput').click()">Upload PFP</button>
            </div>
            <button class="btn" id="saveProfileBtn">Save</button>
            <button class="btn" id="logoutBtn" style="background:#ef4444;color:#fff;margin-top:10px">Log Out</button>
        </div>
        <!-- Add Friend -->
        <div class="modal hidden" id="friendModal">
            <h2>Add Friend</h2>
            <div class="form-group"><input class="form-input" id="friendInput" placeholder="Enter username (e.g. coolguy)"></div>
            <button class="btn" id="submitFriend">Send Request</button>
        </div>
        <!-- Add Server -->
        <div class="modal hidden" id="serverModal">
            <h2>Add Server</h2>
            <input class="form-input" id="newServerName" placeholder="New Server Name" style="margin-bottom:10px">
            <button class="btn" id="submitServer">Create</button>
            <hr style="border:0;border-top:1px solid #333;margin:15px 0">
            <input class="form-input" id="joinCode" placeholder="Invite Code" style="margin-bottom:10px">
            <button class="btn" id="submitJoin">Join</button>
        </div>
    </div>    <!-- Firebase SDKs (No Storage needed anymore) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBJMIUucxOusoVzs4lc-QurCxjlW6Hlsuw",
            authDomain: "chat-5f0bf.firebaseapp.com",
            projectId: "chat-5f0bf",
            storageBucket: "chat-5f0bf.firebasestorage.app",
            messagingSenderId: "211425841353",
            appId: "1:211425841353:web:e1c271a340d73abd0cfd18"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUser = null;
        let userData = null;
        let currentContext = 'dm'; 
        let currentId = null; // friendUid OR serverId
        let currentChannelId = null; 
        let unsubListener = null;

        // --- AUTH ---
        auth.onAuthStateChanged(user => {
            if(user) {
                currentUser = user;
                ensureProfile(user).then(() => {
                    document.getElementById('authContainer').style.display = 'none';
                    document.getElementById('appContainer').classList.add('active');
                    loadServers();
                    loadFriends();
                    updateUI();
                });
            } else {
                document.getElementById('authContainer').style.display = 'flex';
                document.getElementById('appContainer').classList.remove('active');
                document.getElementById('loadingScreen').style.display = 'none';
            }
        });

        async function ensureProfile(user) {
            const ref = db.collection('users').doc(user.uid);
            const doc = await ref.get();
            if(!doc.exists) {
                let username = user.email ? user.email.split('@')[0] : 'user'+Date.now();
                await ref.set({
                    uid: user.uid,
                    email: user.email || '',
                    displayName: user.displayName || 'User',
                    username: username.toLowerCase().replace(/\s/g, ''),
                    photoURL: '',
                    bio: 'Hello!',
                    friends: [],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            }
            userData = (await ref.get()).data();
            document.getElementById('loadingScreen').style.display = 'none';
        }

        // --- NAVIGATION ---
        function switchContext(ctx, id) {
            currentContext = ctx;
            currentId = id;
            document.getElementById('inputArea').style.display = 'block';
            
            if(ctx === 'dm') {
                // DM Mode
                document.getElementById('dmSidebar').classList.remove('hidden');
                document.getElementById('serverSidebar').classList.add('hidden');
                document.getElementById('homeBtn').classList.add('active');
                document.querySelectorAll('.server-btn').forEach(b => b.classList.remove('active'));
                
                if(id) {
                    openDM(id);
                } else {
                    document.getElementById('messagesList').innerHTML = '<div style="text-align:center;color:#555;margin-top:20px">Select a friend to chat</div>';
                    document.getElementById('chatTitle').innerText = "Friends";
                    document.getElementById('inputArea').style.display = 'none';
                }
            } else {
                // Server Mode
                document.getElementById('dmSidebar').classList.add('hidden');
                document.getElementById('serverSidebar').classList.remove('hidden');
                document.getElementById('homeBtn').classList.remove('active');
                document.querySelectorAll('.server-btn').forEach(b => {
                    b.classList.toggle('active', b.dataset.id === id);
                });
                loadChannels(id);
            }
        }

        // --- DM LOGIC (THE FIX) ---
        async function openDM(friendUid) {
            // 1. Get friend details
            const fDoc = await db.collection('users').doc(friendUid).get();
            const f = fDoc.data();
            document.getElementById('chatTitle').innerText = `@${f.username}`;
            
            // 2. Determine DM ID (Sorted UIDs ensures both users look at the same doc)
            const dmId = [currentUser.uid, friendUid].sort().join('_');
            
            // 3. Force update the DM doc. 
            // Using set with merge:true is safe. It creates if missing, updates if exists.
            // This ensures "members" exists so Security Rules allow the read.
            await db.collection('dms').doc(dmId).set({
                members: [currentUser.uid, friendUid],
                lastActive: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });

            // 4. Listen
            listenMessages(db.collection('dms').doc(dmId).collection('messages'));
        }

        // --- SERVERS ---
        function loadServers() {
            db.collection('servers').where('members', 'array-contains', currentUser.uid)
            .onSnapshot(snap => {
                const list = document.getElementById('serverList');
                list.innerHTML = '';
                snap.forEach(doc => {
                    const s = doc.data();
                    const btn = document.createElement('button');
                    btn.className = 'server-btn';
                    btn.dataset.id = doc.id;
                    if(s.icon) btn.innerHTML = `<img src="${s.icon}">`;
                    else btn.innerText = s.name.substring(0,2).toUpperCase();
                    
                    btn.onclick = () => {
                        document.getElementById('serverNameDisplay').innerText = s.name;
                        switchContext('server', doc.id);
                    };
                    list.appendChild(btn);
                });
            });
        }

        function loadChannels(serverId) {
            db.collection('servers').doc(serverId).collection('channels').orderBy('createdAt')
            .onSnapshot(snap => {
                const list = document.getElementById('channelList');
                list.innerHTML = '';
                let first = null;
                snap.forEach(doc => {
                    if(!first) first = doc;
                    const c = doc.data();
                    const el = document.createElement('div');
                    el.className = 'nav-item';
                    el.innerText = `# ${c.name}`;
                    el.onclick = () => {
                        currentChannelId = doc.id;
                        document.getElementById('chatTitle').innerText = `# ${c.name}`;
                        // Visual Active State
                        document.querySelectorAll('#channelList .nav-item').forEach(x => x.classList.remove('active'));
                        el.classList.add('active');
                        listenMessages(db.collection('servers').doc(serverId).collection('channels').doc(doc.id).collection('messages'));
                    };
                    list.appendChild(el);
                });
                if(first && !currentChannelId) {
                    currentChannelId = first.id;
                    document.getElementById('chatTitle').innerText = `# ${first.data().name}`;
                    listenMessages(db.collection('servers').doc(serverId).collection('channels').doc(first.id).collection('messages'));
                }
            });
        }

        // --- MESSAGES ---
        function listenMessages(ref) {
            if(unsubListener) unsubListener();
            document.getElementById('messagesList').innerHTML = ''; // Clear old
            
            unsubListener = ref.orderBy('createdAt', 'asc').limitToLast(50)
            .onSnapshot(snap => {
                const list = document.getElementById('messagesList');
                list.innerHTML = '';
                let prevAuth = null;
                
                snap.forEach(doc => {
                    const m = doc.data();
                    const stacked = prevAuth === m.authorId;
                    const el = document.createElement('div');
                    el.className = `message ${stacked ? 'stacked' : ''}`;
                    
                    let body = m.type === 'image' ? 
                        `<img src="${m.content}" class="msg-image" onclick="window.open(this.src)">` : 
                        `<div class="msg-text">${m.content}</div>`;
                    
                    if(stacked) {
                        el.innerHTML = `<div style="width:40px;margin-right:16px"></div><div class="msg-info">${body}</div>`;
                    } else {
                        const date = m.createdAt ? m.createdAt.toDate().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : 'Sending...';
                        el.innerHTML = `
                            <div class="msg-pfp"><img src="${m.authorPfp || 'https://via.placeholder.com/40'}"></div>
                            <div class="msg-info">
                                <div class="msg-header">
                                    <span class="msg-name">${m.authorName}</span>
                                    <span class="msg-date">${date}</span>
                                </div>
                                ${body}
                            </div>
                        `;
                    }
                    list.appendChild(el);
                    prevAuth = m.authorId;
                });
                list.scrollTop = list.scrollHeight;
            });
        }

        async function sendMessage(content, type='text') {
            if(!content) return;
            const msg = {
                content, type,
                authorId: currentUser.uid,
                authorName: userData.displayName,
                authorPfp: userData.photoURL || '',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            try {
                if(currentContext === 'dm') {
                    if(!currentId) return alert("Select a friend first!");
                    const dmId = [currentUser.uid, currentId].sort().join('_');
                    await db.collection('dms').doc(dmId).collection('messages').add(msg);
                } else {
                    if(!currentId || !currentChannelId) return;
                    await db.collection('servers').doc(currentId).collection('channels').doc(currentChannelId).collection('messages').add(msg);
                }
            } catch(e) {
                console.error(e);
                alert("Error sending: " + e.message);
            }
        }

        // --- FRIENDS LIST ---
        function loadFriends() {
            db.collection('users').doc(currentUser.uid).onSnapshot(async doc => {
                userData = doc.data(); 
                updateUI();
                const list = document.getElementById('friendsList');
                list.innerHTML = '';
                
                if(userData.friends && userData.friends.length > 0) {
                    for(const fid of userData.friends) {
                        const fDoc = await db.collection('users').doc(fid).get();
                        if(fDoc.exists) {
                            const f = fDoc.data();
                            const el = document.createElement('div');
                            el.className = 'nav-item';
                            el.innerHTML = `
                                <div class="nav-avatar"><img src="${f.photoURL||'https://via.placeholder.com/32'}"></div>
                                <div style="overflow:hidden">
                                    <div style="font-weight:700;font-size:14px">${f.displayName}</div>
                                    <div style="font-size:11px;color:#666">@${f.username}</div>
                                </div>
                            `;
                            el.onclick = () => switchContext('dm', fid);
                            list.appendChild(el);
                        }
                    }
                } else {
                    list.innerHTML = '<div style="padding:12px;color:var(--gray-500);font-size:13px">Add friends to chat!</div>';
                }
            });
        }

        // --- IMAGE COMPRESSION (Free Storage) ---
        function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scale = 500 / Math.max(img.width, img.height); // Scale down to 500px max
                        canvas.width = img.width * Math.min(1, scale);
                        canvas.height = img.height * Math.min(1, scale);
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.6)); 
                    }
                }
            });
        }

        // --- INPUTS & BUTTONS ---
        const msgInput = document.getElementById('msgInput');
        msgInput.onkeydown = (e) => {
            if(e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage(msgInput.value.trim());
                msgInput.value = '';
            }
        };
        document.getElementById('sendBtn').onclick = () => {
            const val = msgInput.value.trim();
            if(val) { sendMessage(val); msgInput.value = ''; }
        };

        // Upload Button Logic
        document.getElementById('uploadBtn').onclick = () => document.getElementById('fileInput').click();
        document.getElementById('fileInput').onchange = async (e) => {
            const file = e.target.files[0];
            if(file) {
                const base64 = await compressImage(file);
                sendMessage(base64, 'image');
            }
        };

        // Profile PFP Upload
        document.getElementById('pfpInput').onchange = async (e) => {
            const file = e.target.files[0];
            if(file) {
                const base64 = await compressImage(file);
                document.getElementById('settingsPfpPreview').src = base64;
            }
        };

        // --- MODALS & UI ---
        function updateUI() {
            document.getElementById('myDisplayName').innerText = userData.displayName;
            document.getElementById('myUsername').innerText = '@' + userData.username;
            document.getElementById('myAvatarImg').src = userData.photoURL || 'https://via.placeholder.com/32';
            document.getElementById('editDisplay').value = userData.displayName;
            document.getElementById('editBio').value = userData.bio;
            document.getElementById('settingsPfpPreview').src = userData.photoURL;
        }
        function showModal(id) {
            document.getElementById('modalOverlay').style.display = 'flex';
            document.querySelectorAll('.modal').forEach(m => m.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }
        function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }
        document.querySelectorAll('.modal-close').forEach(b => b.onclick = closeModal);

        document.getElementById('addFriendBtn').onclick = () => showModal('friendModal');
        document.getElementById('addServerBtn').onclick = () => showModal('serverModal');
        document.getElementById('settingsBtn').onclick = () => showModal('settingsModal');
        document.getElementById('myAvatarBtn').onclick = () => showModal('settingsModal');
        document.getElementById('addChannelBtn').onclick = () => showModal('addChannelModal');
        document.getElementById('homeBtn').onclick = () => switchContext('dm', null);

        // --- ACTIONS ---
        document.getElementById('tabLogin').onclick = () => {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('signupForm').classList.add('hidden');
        };
        document.getElementById('tabSignup').onclick = () => {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.remove('hidden');
        };

        document.getElementById('loginForm').onsubmit = async (e) => {
            e.preventDefault();
            try { await auth.signInWithEmailAndPassword(document.getElementById('lEmail').value, document.getElementById('lPass').value); }
            catch(err) { alert(err.message); }
        };

        document.getElementById('signupForm').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('sEmail').value;
            const pass = document.getElementById('sPass').value;
            const user = document.getElementById('sUser').value.toLowerCase().replace(/\s/g, '');
            try {
                const check = await db.collection('users').where('username', '==', user).get();
                if(!check.empty) throw new Error("Username already taken!");
                const cred = await auth.createUserWithEmailAndPassword(email, pass);
                await db.collection('users').doc(cred.user.uid).set({
                    uid: cred.user.uid, email, displayName: user, username: user,
                    photoURL: '', bio: 'New here!', friends: [],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
            } catch(err) { alert(err.message); }
        };

        document.getElementById('submitFriend').onclick = async () => {
            const username = document.getElementById('friendInput').value.trim().toLowerCase();
            const snap = await db.collection('users').where('username','==',username).get();
            if(snap.empty) return alert("User not found");
            const fid = snap.docs[0].id;
            if(fid === currentUser.uid) return alert("Can't add self");
            await db.collection('users').doc(currentUser.uid).update({friends: firebase.firestore.FieldValue.arrayUnion(fid)});
            await db.collection('users').doc(fid).update({friends: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)});
            closeModal();
        };

        document.getElementById('submitServer').onclick = async () => {
            const name = document.getElementById('newServerName').value;
            const code = Math.random().toString(36).substring(7);
            const ref = await db.collection('servers').add({
                name, owner: currentUser.uid, inviteCode: code, icon: '',
                members: [currentUser.uid]
            });
            await ref.collection('channels').add({name:'general', createdAt: firebase.firestore.FieldValue.serverTimestamp()});
            closeModal();
        };

        document.getElementById('submitJoin').onclick = async () => {
            const code = document.getElementById('joinCode').value;
            const snap = await db.collection('servers').where('inviteCode','==',code).get();
            if(snap.empty) return alert("Invalid code");
            await snap.docs[0].ref.update({members: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)});
            closeModal();
        };

        document.getElementById('submitCreateChannel').onclick = async () => {
            const name = document.getElementById('newChannelName').value;
            if(name && currentId && currentContext === 'server') {
                await db.collection('servers').doc(currentId).collection('channels').add({
                    name, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                closeModal();
            }
        };

        document.getElementById('saveProfileBtn').onclick = async () => {
            const newPfp = document.getElementById('settingsPfpPreview').src;
            await db.collection('users').doc(currentUser.uid).update({
                displayName: document.getElementById('editDisplay').value,
                bio: document.getElementById('editBio').value,
                photoURL: newPfp.startsWith('data:') ? newPfp : userData.photoURL
            });
            closeModal();
        };

        document.getElementById('logoutBtn').onclick = () => auth.signOut();
        document.getElementById('googleBtn').onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    </script>
</body>
</html>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
* { margin:0; padding:0; box-sizing:border-box; }
:root {
  --bg-primary: #000000;
  --bg-secondary: #0a0a0a;
  --bg-tertiary: #111111;
  --bg-hover: #1a1a1a;
  --bg-active: #222222;
  --bg-input: #1a1a1a;
  --bg-modal: #111111;
  --text-primary: #ffffff;
  --text-secondary: #a0a0a0;
  --text-muted: #666666;
  --border: #222222;
  --accent: #ffffff;
  --accent-dim: rgba(255,255,255,0.1);
  --danger: #ff453a;
  --success: #30d158;
  --online: #30d158;
  --scrollbar: #333333;
  --message-hover: rgba(255,255,255,0.02);
}
body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  height: 100vh;
  overflow: hidden;
  -webkit-font-smoothing: antialiased;
}

/* AUTH SCREENS */
.auth-container {
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100vh;
  background: var(--bg-primary);
}
.auth-box {
  background: var(--bg-secondary);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 48px;
  width: 420px;
  max-width: 90vw;
}
.auth-box h1 {
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 8px;
  letter-spacing: -0.5px;
}
.auth-box p {
  color: var(--text-secondary);
  margin-bottom: 32px;
  font-size: 14px;
}
.auth-box .logo {
  font-size: 40px;
  margin-bottom: 24px;
  display: block;
}
.form-group {
  margin-bottom: 20px;
}
.form-group label {
  display: block;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-secondary);
  margin-bottom: 8px;
}
.form-group input {
  width: 100%;
  padding: 12px 16px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 12px;
  color: var(--text-primary);
  font-size: 15px;
  font-family: inherit;
  outline: none;
  transition: border-color 0.2s;
}
.form-group input:focus {
  border-color: var(--text-muted);
}
.btn {
  width: 100%;
  padding: 12px;
  border: none;
  border-radius: 12px;
  font-size: 15px;
  font-weight: 600;
  font-family: inherit;
  cursor: pointer;
  transition: all 0.2s;
}
.btn-primary {
  background: var(--accent);
  color: #000;
}
.btn-primary:hover {
  opacity: 0.9;
  transform: scale(0.98);
}
.btn-secondary {
  background: transparent;
  color: var(--text-secondary);
  border: 1px solid var(--border);
  margin-top: 12px;
}
.btn-secondary:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}
.auth-switch {
  text-align: center;
  margin-top: 24px;
  font-size: 13px;
  color: var(--text-secondary);
}
.auth-switch a {
  color: var(--accent);
  cursor: pointer;
  text-decoration: none;
  font-weight: 500;
}

/* MAIN APP LAYOUT */
.app-container {
  display: none;
  height: 100vh;
  flex-direction: row;
}
.app-container.active {
  display: flex;
}

/* SERVER LIST */
.server-list {
  width: 72px;
  min-width: 72px;
  background: var(--bg-primary);
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 12px 0;
  gap: 4px;
  overflow-y: auto;
  border-right: 1px solid var(--border);
}
.server-list::-webkit-scrollbar { width: 0; }
.server-icon {
  width: 48px;
  height: 48px;
  border-radius: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
  background: var(--bg-tertiary);
  color: var(--text-secondary);
  font-size: 18px;
  font-weight: 600;
  position: relative;
  overflow: hidden;
  flex-shrink: 0;
}
.server-icon img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.server-icon:hover, .server-icon.active {
  border-radius: 12px;
  background: var(--bg-active);
  color: var(--text-primary);
}
.server-icon.active::before {
  content: '';
  position: absolute;
  left: -16px;
  width: 4px;
  height: 24px;
  background: var(--accent);
  border-radius: 0 4px 4px 0;
}
.server-icon.home-btn {
  background: var(--bg-tertiary);
  margin-bottom: 4px;
}
.server-icon.home-btn.active {
  background: var(--accent);
  color: #000;
}
.server-divider {
  width: 32px;
  height: 1px;
  background: var(--border);
  margin: 4px 0;
  flex-shrink: 0;
}
.server-icon.add-server {
  background: transparent;
  border: 1px dashed var(--text-muted);
  color: var(--text-muted);
  font-size: 22px;
}
.server-icon.add-server:hover {
  border-color: var(--accent);
  color: var(--accent);
  background: transparent;
}

/* CHANNEL / DM SIDEBAR */
.sidebar {
  width: 260px;
  min-width: 260px;
  background: var(--bg-secondary);
  display: flex;
  flex-direction: column;
  border-right: 1px solid var(--border);
}
.sidebar-header {
  padding: 16px 16px;
  border-bottom: 1px solid var(--border);
  font-weight: 700;
  font-size: 15px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  min-height: 52px;
}
.sidebar-header .actions {
  display: flex;
  gap: 8px;
}
.sidebar-header .actions button {
  background: none;
  border: none;
  color: var(--text-secondary);
  cursor: pointer;
  font-size: 16px;
  padding: 4px;
  border-radius: 6px;
  transition: all 0.15s;
}
.sidebar-header .actions button:hover {
  color: var(--text-primary);
  background: var(--bg-hover);
}
.sidebar-content {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
}
.sidebar-content::-webkit-scrollbar { width: 4px; }
.sidebar-content::-webkit-scrollbar-thumb { background: var(--scrollbar); border-radius: 4px; }

.channel-category {
  padding: 16px 8px 4px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  display: flex;
  align-items: center;
  justify-content: space-between;
  cursor: pointer;
}
.channel-category .add-ch {
  font-size: 14px;
  opacity: 0;
  transition: opacity 0.15s;
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
}
.channel-category:hover .add-ch {
  opacity: 1;
}
.channel-item, .dm-item {
  display: flex;
  align-items: center;
  padding: 8px 12px;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.15s;
  gap: 10px;
  font-size: 14px;
  color: var(--text-secondary);
  margin: 1px 0;
}
.channel-item:hover, .dm-item:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}
.channel-item.active, .dm-item.active {
  background: var(--bg-active);
  color: var(--text-primary);
}
.channel-item i {
  font-size: 16px;
  opacity: 0.5;
  width: 20px;
  text-align: center;
}
.dm-item .dm-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--bg-active);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 13px;
  font-weight: 600;
  overflow: hidden;
  flex-shrink: 0;
}
.dm-item .dm-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.dm-item .dm-info {
  flex: 1;
  min-width: 0;
}
.dm-item .dm-name {
  font-weight: 500;
  font-size: 14px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.dm-item .dm-status {
  font-size: 11px;
  color: var(--text-muted);
}
.dm-item .online-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--online);
  flex-shrink: 0;
}

/* USER PANEL */
.user-panel {
  padding: 12px;
  border-top: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 10px;
  background: var(--bg-secondary);
}
.user-panel .user-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: var(--bg-active);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  overflow: hidden;
  cursor: pointer;
  flex-shrink: 0;
}
.user-panel .user-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.user-panel .user-info {
  flex: 1;
  min-width: 0;
}
.user-panel .user-name {
  font-size: 13px;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.user-panel .user-tag {
  font-size: 11px;
  color: var(--text-muted);
}
.user-panel .panel-actions {
  display: flex;
  gap: 4px;
}
.user-panel .panel-actions button {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 14px;
  padding: 6px;
  border-radius: 6px;
  transition: all 0.15s;
}
.user-panel .panel-actions button:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}

/* MAIN CHAT AREA */
.chat-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: var(--bg-primary);
  min-width: 0;
}
.chat-header {
  padding: 12px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 12px;
  min-height: 52px;
  background: var(--bg-primary);
}
.chat-header .ch-icon {
  color: var(--text-muted);
  font-size: 18px;
}
.chat-header .ch-name {
  font-weight: 700;
  font-size: 15px;
}
.chat-header .ch-topic {
  font-size: 12px;
  color: var(--text-muted);
  margin-left: 8px;
  padding-left: 12px;
  border-left: 1px solid var(--border);
}
.chat-header .header-actions {
  margin-left: auto;
  display: flex;
  gap: 4px;
}
.chat-header .header-actions button {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 16px;
  padding: 6px 8px;
  border-radius: 6px;
  transition: all 0.15s;
}
.chat-header .header-actions button:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}

/* MESSAGES */
.messages-container {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
}
.messages-container::-webkit-scrollbar { width: 6px; }
.messages-container::-webkit-scrollbar-thumb { background: var(--scrollbar); border-radius: 6px; }
.messages-list {
  display: flex;
  flex-direction: column;
  margin-top: auto;
}
.message {
  display: flex;
  gap: 14px;
  padding: 6px 12px;
  border-radius: 8px;
  transition: background 0.1s;
  margin: 1px 0;
}
.message:hover {
  background: var(--message-hover);
}
.message.grouped {
  padding-top: 2px;
  padding-bottom: 2px;
}
.message .msg-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--bg-tertiary);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 14px;
  overflow: hidden;
  flex-shrink: 0;
  cursor: pointer;
}
.message .msg-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.message.grouped .msg-avatar {
  visibility: hidden;
  width: 40px;
}
.message.grouped .msg-avatar-placeholder {
  width: 40px;
  flex-shrink: 0;
}
.message .msg-content {
  flex: 1;
  min-width: 0;
}
.message .msg-header {
  display: flex;
  align-items: baseline;
  gap: 8px;
  margin-bottom: 2px;
}
.message .msg-author {
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
}
.message .msg-author:hover {
  text-decoration: underline;
}
.message .msg-time {
  font-size: 11px;
  color: var(--text-muted);
}
.message .msg-text {
  font-size: 14px;
  line-height: 1.5;
  color: var(--text-secondary);
  word-wrap: break-word;
}
.message .msg-text img {
  max-width: 400px;
  max-height: 300px;
  border-radius: 12px;
  margin-top: 8px;
  display: block;
  cursor: pointer;
}
.message .msg-image {
  max-width: 400px;
  max-height: 300px;
  border-radius: 12px;
  margin-top: 8px;
  cursor: pointer;
}
.message.grouped .msg-header {
  display: none;
}
.msg-hover-time {
  font-size: 10px;
  color: var(--text-muted);
  opacity: 0;
  min-width: 40px;
  text-align: center;
  line-height: 40px;
}
.message.grouped:hover .msg-hover-time {
  opacity: 1;
}
.welcome-msg {
  padding: 20px 12px;
  margin-bottom: 16px;
}
.welcome-msg h2 {
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 8px;
}
.welcome-msg p {
  color: var(--text-muted);
  font-size: 14px;
}

/* MESSAGE INPUT */
.message-input-container {
  padding: 0 20px 20px;
}
.message-input-wrapper {
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-radius: 14px;
  display: flex;
  align-items: flex-end;
  padding: 4px;
  transition: border-color 0.2s;
}
.message-input-wrapper:focus-within {
  border-color: var(--text-muted);
}
.input-actions {
  display: flex;
  gap: 2px;
  padding: 6px 4px;
}
.input-actions button {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 18px;
  padding: 6px;
  border-radius: 8px;
  transition: all 0.15s;
}
.input-actions button:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}
.message-input {
  flex: 1;
  background: none;
  border: none;
  color: var(--text-primary);
  font-size: 14px;
  font-family: inherit;
  padding: 10px 8px;
  outline: none;
  resize: none;
  max-height: 200px;
  line-height: 1.4;
}
.message-input::placeholder {
  color: var(--text-muted);
}
.send-btn {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 18px;
  padding: 6px 10px;
  margin: 6px 4px;
  border-radius: 8px;
  transition: all 0.15s;
}
.send-btn:hover {
  background: var(--accent);
  color: #000;
}

/* MODAL */
.modal-overlay {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(8px);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}
.modal-overlay.active {
  display: flex;
}
.modal {
  background: var(--bg-modal);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 32px;
  width: 460px;
  max-width: 90vw;
  max-height: 85vh;
  overflow-y: auto;
  position: relative;
}
.modal::-webkit-scrollbar { width: 4px; }
.modal::-webkit-scrollbar-thumb { background: var(--scrollbar); border-radius: 4px; }
.modal h2 {
  font-size: 22px;
  font-weight: 700;
  margin-bottom: 8px;
  letter-spacing: -0.3px;
}
.modal p.modal-desc {
  color: var(--text-secondary);
  font-size: 13px;
  margin-bottom: 24px;
}
.modal-close {
  position: absolute;
  top: 20px;
  right: 20px;
  background: none;
  border: none;
  color: var(--text-muted);
  font-size: 20px;
  cursor: pointer;
  padding: 4px;
  border-radius: 6px;
  transition: all 0.15s;
}
.modal-close:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}

/* GIF PICKER */
.gif-picker {
  display: none;
  position: absolute;
  bottom: 70px;
  left: 20px;
  width: 420px;
  height: 460px;
  background: var(--bg-modal);
  border: 1px solid var(--border);
  border-radius: 16px;
  z-index: 500;
  flex-direction: column;
  overflow: hidden;
}
.gif-picker.active {
  display: flex;
}
.gif-picker-header {
  padding: 12px;
  border-bottom: 1px solid var(--border);
}
.gif-picker-header input {
  width: 100%;
  padding: 10px 14px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 10px;
  color: var(--text-primary);
  font-size: 13px;
  font-family: inherit;
  outline: none;
}
.gif-picker-header input:focus {
  border-color: var(--text-muted);
}
.gif-grid {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 6px;
  align-content: start;
}
.gif-grid::-webkit-scrollbar { width: 4px; }
.gif-grid::-webkit-scrollbar-thumb { background: var(--scrollbar); border-radius: 4px; }
.gif-grid img {
  width: 100%;
  border-radius: 8px;
  cursor: pointer;
  transition: transform 0.1s;
}
.gif-grid img:hover {
  transform: scale(0.97);
}
.gif-grid .gif-loading {
  grid-column: 1 / -1;
  text-align: center;
  padding: 40px;
  color: var(--text-muted);
  font-size: 13px;
}

/* IMAGE PREVIEW */
.image-preview {
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.9);
  z-index: 2000;
  align-items: center;
  justify-content: center;
  cursor: zoom-out;
}
.image-preview.active {
  display: flex;
}
.image-preview img {
  max-width: 90vw;
  max-height: 90vh;
  border-radius: 8px;
}

/* PFP Upload */
.pfp-upload-area {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  border: 2px dashed var(--text-muted);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  margin: 0 auto 20px;
  overflow: hidden;
  transition: all 0.2s;
  position: relative;
}
.pfp-upload-area:hover {
  border-color: var(--accent);
}
.pfp-upload-area img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.pfp-upload-area .pfp-overlay {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.2s;
  font-size: 20px;
}
.pfp-upload-area:hover .pfp-overlay {
  opacity: 1;
}

/* MEMBERS SIDEBAR */
.members-sidebar {
  width: 240px;
  min-width: 240px;
  background: var(--bg-secondary);
  border-left: 1px solid var(--border);
  padding: 16px 8px;
  overflow-y: auto;
  display: none;
}
.members-sidebar.active {
  display: block;
}
.members-sidebar::-webkit-scrollbar { width: 4px; }
.members-sidebar::-webkit-scrollbar-thumb { background: var(--scrollbar); border-radius: 4px; }
.member-category {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  padding: 16px 8px 4px;
}
.member-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 6px 8px;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.15s;
}
.member-item:hover {
  background: var(--bg-hover);
}
.member-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--bg-active);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  font-weight: 600;
  overflow: hidden;
  position: relative;
  flex-shrink: 0;
}
.member-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.member-name {
  font-size: 13px;
  font-weight: 500;
  color: var(--text-secondary);
}

/* Image upload preview in input */
.upload-preview {
  display: none;
  padding: 8px 12px;
  background: var(--bg-tertiary);
  border: 1px solid var(--border);
  border-bottom: none;
  border-radius: 14px 14px 0 0;
  margin: 0;
}
.upload-preview.active {
  display: flex;
  align-items: center;
  gap: 12px;
}
.upload-preview img {
  width: 60px;
  height: 60px;
  object-fit: cover;
  border-radius: 8px;
}
.upload-preview .upload-info {
  flex: 1;
  font-size: 13px;
  color: var(--text-secondary);
}
.upload-preview .remove-upload {
  background: none;
  border: none;
  color: var(--danger);
  cursor: pointer;
  font-size: 16px;
  padding: 4px;
}
.upload-preview.active + .message-input-wrapper {
  border-radius: 0 0 14px 14px;
  border-top: none;
}

/* Server icon upload */
.server-icon-upload {
  width: 80px;
  height: 80px;
  border-radius: 16px;
  border: 2px dashed var(--text-muted);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  margin: 0 auto 20px;
  overflow: hidden;
  transition: all 0.2s;
  font-size: 28px;
  color: var(--text-muted);
}
.server-icon-upload:hover {
  border-color: var(--accent);
  color: var(--accent);
}
.server-icon-upload img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* Context Menu */
.context-menu {
  display: none;
  position: fixed;
  background: var(--bg-modal);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 6px;
  z-index: 3000;
  min-width: 180px;
}
.context-menu.active {
  display: block;
}
.context-menu-item {
  padding: 8px 12px;
  font-size: 13px;
  cursor: pointer;
  border-radius: 6px;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: background 0.1s;
  color: var(--text-secondary);
}
.context-menu-item:hover {
  background: var(--bg-hover);
  color: var(--text-primary);
}
.context-menu-item.danger {
  color: var(--danger);
}
.context-menu-item.danger:hover {
  background: rgba(255,69,58,0.1);
}

/* Empty state */
.empty-state {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: var(--text-muted);
  text-align: center;
  padding: 40px;
}
.empty-state i {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.3;
}
.empty-state h3 {
  font-size: 18px;
  margin-bottom: 8px;
  color: var(--text-secondary);
}
.empty-state p {
  font-size: 13px;
  max-width: 300px;
}

/* Typing indicator */
.typing-indicator {
  padding: 4px 20px 0;
  font-size: 12px;
  color: var(--text-muted);
  min-height: 20px;
}
.typing-indicator span {
  font-weight: 600;
  color: var(--text-secondary);
}

/* Notification badge */
.notif-badge {
  position: absolute;
  bottom: -2px;
  right: -2px;
  background: var(--danger);
  color: #fff;
  font-size: 10px;
  font-weight: 700;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 2px solid var(--bg-primary);
}

/* Invite modal */
.invite-code {
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 12px 16px;
  font-family: 'SF Mono', monospace;
  font-size: 14px;
  color: var(--accent);
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin: 12px 0;
}
.invite-code button {
  background: var(--accent);
  color: #000;
  border: none;
  padding: 6px 14px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
}

/* Search bar in DMs */
.dm-search {
  padding: 8px;
}
.dm-search input {
  width: 100%;
  padding: 8px 12px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text-primary);
  font-size: 13px;
  font-family: inherit;
  outline: none;
}
.dm-search input:focus {
  border-color: var(--text-muted);
}

.section-label {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--text-muted);
  padding: 12px 12px 4px;
}

/* Settings */
.settings-section {
  margin-bottom: 24px;
}
.settings-section h3 {
  font-size: 14px;
  font-weight: 600;
  margin-bottom: 12px;
  color: var(--text-secondary);
}
.settings-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 0;
  border-bottom: 1px solid var(--border);
}
.settings-row:last-child {
  border-bottom: none;
}
.settings-row label {
  font-size: 14px;
}
.settings-row span {
  font-size: 12px;
  color: var(--text-muted);
}
.danger-zone {
  border: 1px solid rgba(255,69,58,0.3);
  border-radius: 12px;
  padding: 16px;
}
.danger-zone h3 {
  color: var(--danger) !important;
}
.btn-danger {
  background: var(--danger);
  color: #fff;
}
.btn-sm {
  width: auto;
  padding: 8px 16px;
  font-size: 13px;
}
</style>
</head>
<body>

<!-- AUTH: LOGIN -->
<div class="auth-container" id="loginPage">
  <div class="auth-box">
    <span class="logo">ðŸ’¬</span>
    <h1>Welcome back</h1>
    <p>Sign in to continue to Chat</p>
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="loginEmail" placeholder="name@example.com">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
    </div>
    <button class="btn btn-primary" onclick="login()">Sign In</button>
    <div class="auth-switch">
      Don't have an account? <a onclick="showRegister()">Create one</a>
    </div>
  </div>
</div>

<!-- AUTH: REGISTER -->
<div class="auth-container" id="registerPage" style="display:none">
  <div class="auth-box">
    <span class="logo">ðŸ’¬</span>
    <h1>Create account</h1>
    <p>Join Chat and start messaging</p>
    <div class="form-group">
      <label>Display Name</label>
      <input type="text" id="regName" placeholder="John Doe">
    </div>
    <div class="form-group">
      <label>Email</label>
      <input type="email" id="regEmail" placeholder="name@example.com">
    </div>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="regPassword" placeholder="Min 6 characters">
    </div>
    <button class="btn btn-primary" onclick="register()">Create Account</button>
    <div class="auth-switch">
      Already have an account? <a onclick="showLogin()">Sign in</a>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div class="app-container" id="appContainer">

  <!-- SERVER LIST -->
  <div class="server-list" id="serverList">
    <div class="server-icon home-btn active" onclick="goHome()" title="Direct Messages">
      <i class="fas fa-comment-dots"></i>
    </div>
    <div class="server-divider"></div>
    <div id="serverIcons"></div>
    <div class="server-icon add-server" onclick="openModal('createServerModal')" title="Create Server">
      <i class="fas fa-plus"></i>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <!-- DM SIDEBAR (default) -->
    <div id="dmSidebar">
      <div class="sidebar-header">
        <span>Messages</span>
        <div class="actions">
          <button onclick="openModal('newDmModal')" title="New Message"><i class="fas fa-pen-to-square"></i></button>
        </div>
      </div>
      <div class="dm-search">
        <input type="text" placeholder="Search conversations..." id="dmSearchInput" oninput="filterDMs()">
      </div>
      <div class="sidebar-content" id="dmList">
      </div>
    </div>

    <!-- SERVER SIDEBAR -->
    <div id="serverSidebar" style="display:none">
      <div class="sidebar-header">
        <span id="serverNameDisplay">Server</span>
        <div class="actions">
          <button onclick="openServerSettings()" title="Settings"><i class="fas fa-gear"></i></button>
          <button onclick="openModal('inviteModal')" title="Invite"><i class="fas fa-user-plus"></i></button>
        </div>
      </div>
      <div class="sidebar-content" id="channelList">
      </div>
    </div>

    <!-- USER PANEL -->
    <div class="user-panel">
      <div class="user-avatar" id="userPanelAvatar" onclick="openModal('profileModal')">
        <span id="userAvatarLetter"></span>
      </div>
      <div class="user-info">
        <div class="user-name" id="userPanelName">User</div>
        <div class="user-tag" id="userPanelTag">Online</div>
      </div>
      <div class="panel-actions">
        <button onclick="openModal('settingsModal')" title="Settings"><i class="fas fa-gear"></i></button>
        <button onclick="logout()" title="Logout"><i class="fas fa-arrow-right-from-bracket"></i></button>
      </div>
    </div>
  </div>

  <!-- CHAT AREA -->
  <div class="chat-area" id="chatArea">
    <!-- No channel selected state -->
    <div class="empty-state" id="emptyState">
      <i class="fas fa-comment-dots"></i>
      <h3>Welcome to Chat</h3>
      <p>Select a conversation or server to start messaging</p>
    </div>

    <!-- Active chat -->
    <div id="activeChat" style="display:none">
      <div class="chat-header">
        <span class="ch-icon" id="chatIcon"><i class="fas fa-hashtag"></i></span>
        <span class="ch-name" id="chatName">general</span>
        <span class="ch-topic" id="chatTopic"></span>
        <div class="header-actions">
          <button onclick="toggleMembers()" title="Members" id="membersToggle"><i class="fas fa-users"></i></button>
        </div>
      </div>
      <div style="display:flex;flex:1;overflow:hidden;">
        <div style="flex:1;display:flex;flex-direction:column;min-width:0;">
          <div class="messages-container" id="messagesContainer">
            <div class="messages-list" id="messagesList"></div>
          </div>
          <div class="typing-indicator" id="typingIndicator"></div>
          <div class="message-input-container" style="position:relative;">
            <div class="upload-preview" id="uploadPreview">
              <img id="uploadPreviewImg" src="">
              <div class="upload-info" id="uploadPreviewName">image.png</div>
              <button class="remove-upload" onclick="removeUpload()"><i class="fas fa-times"></i></button>
            </div>
            <div class="message-input-wrapper">
              <div class="input-actions">
                <button onclick="triggerImageUpload()" title="Upload Image"><i class="fas fa-plus-circle"></i></button>
                <button onclick="toggleGifPicker()" title="GIFs"><i class="fas fa-icons"></i></button>
              </div>
              <textarea class="message-input" id="messageInput" placeholder="Message #general" rows="1" onkeydown="handleKeyDown(event)" oninput="autoResize(this); handleTyping()"></textarea>
              <button class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
            </div>
            <input type="file" id="imageUploadInput" accept="image/*" style="display:none" onchange="handleImageUpload(event)">
            <div class="gif-picker" id="gifPicker">
              <div class="gif-picker-header">
                <input type="text" placeholder="Search GIFs..." id="gifSearchInput" oninput="searchGifsDebounced()">
              </div>
              <div class="gif-grid" id="gifGrid">
                <div class="gif-loading">Search for GIFs above</div>
              </div>
            </div>
          </div>
        </div>
        <div class="members-sidebar" id="membersSidebar">
          <div class="member-category" id="membersCount">Members â€” 0</div>
          <div id="membersList"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODALS -->

<!-- Create Server -->
<div class="modal-overlay" id="createServerModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('createServerModal')"><i class="fas fa-xmark"></i></button>
    <h2>Create a server</h2>
    <p class="modal-desc">Your server is where you and your friends hang out.</p>
    <div class="server-icon-upload" id="serverIconUpload" onclick="document.getElementById('serverIconInput').click()">
      <i class="fas fa-camera"></i>
    </div>
    <input type="file" id="serverIconInput" accept="image/*" style="display:none" onchange="previewServerIcon(event)">
    <div class="form-group">
      <label>Server Name</label>
      <input type="text" id="createServerName" placeholder="My Awesome Server">
    </div>
    <button class="btn btn-primary" onclick="createServer()">Create Server</button>
  </div>
</div>

<!-- Join Server -->
<div class="modal-overlay" id="joinServerModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('joinServerModal')"><i class="fas fa-xmark"></i></button>
    <h2>Join a server</h2>
    <p class="modal-desc">Enter a server invite code to join.</p>
    <div class="form-group">
      <label>Invite Code</label>
      <input type="text" id="joinServerCode" placeholder="Enter invite code">
    </div>
    <button class="btn btn-primary" onclick="joinServer()">Join Server</button>
  </div>
</div>

<!-- Invite Modal -->
<div class="modal-overlay" id="inviteModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('inviteModal')"><i class="fas fa-xmark"></i></button>
    <h2>Invite people</h2>
    <p class="modal-desc">Share this invite code with friends.</p>
    <div class="invite-code">
      <span id="inviteCodeDisplay">LOADING...</span>
      <button onclick="copyInvite()">Copy</button>
    </div>
  </div>
</div>

<!-- New DM -->
<div class="modal-overlay" id="newDmModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('newDmModal')"><i class="fas fa-xmark"></i></button>
    <h2>New Message</h2>
    <p class="modal-desc">Start a conversation with someone by entering their email.</p>
    <div class="form-group">
      <label>Recipient Email</label>
      <input type="email" id="newDmEmail" placeholder="friend@example.com">
    </div>
    <button class="btn btn-primary" onclick="createDM()">Start Conversation</button>
  </div>
</div>

<!-- Create Channel -->
<div class="modal-overlay" id="createChannelModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('createChannelModal')"><i class="fas fa-xmark"></i></button>
    <h2>Create channel</h2>
    <p class="modal-desc">Add a new text channel to the server.</p>
    <div class="form-group">
      <label>Channel Name</label>
      <input type="text" id="createChannelName" placeholder="general">
    </div>
    <button class="btn btn-primary" onclick="createChannel()">Create Channel</button>
  </div>
</div>

<!-- Profile Modal -->
<div class="modal-overlay" id="profileModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('profileModal')"><i class="fas fa-xmark"></i></button>
    <h2>Your Profile</h2>
    <p class="modal-desc">Customize how others see you.</p>
    <div class="pfp-upload-area" id="pfpUploadArea" onclick="document.getElementById('pfpInput').click()">
      <div class="pfp-overlay"><i class="fas fa-camera"></i></div>
      <span id="pfpPreviewLetter" style="font-size:32px;font-weight:700;"></span>
    </div>
    <input type="file" id="pfpInput" accept="image/*" style="display:none" onchange="handlePfpUpload(event)">
    <div class="form-group">
      <label>Display Name</label>
      <input type="text" id="profileDisplayName" placeholder="Your name">
    </div>
    <button class="btn btn-primary" onclick="saveProfile()">Save Changes</button>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('settingsModal')"><i class="fas fa-xmark"></i></button>
    <h2>Settings</h2>
    <div class="settings-section">
      <h3>Account</h3>
      <div class="settings-row">
        <div>
          <label>Email</label><br>
          <span id="settingsEmail">-</span>
        </div>
      </div>
      <div class="settings-row">
        <div>
          <label>User ID</label><br>
          <span id="settingsUid" style="font-family:monospace">-</span>
        </div>
      </div>
    </div>
    <div class="settings-section danger-zone">
      <h3>Danger Zone</h3>
      <button class="btn btn-danger btn-sm" onclick="logout()">Log Out</button>
    </div>
  </div>
</div>

<!-- Server Settings Modal -->
<div class="modal-overlay" id="serverSettingsModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('serverSettingsModal')"><i class="fas fa-xmark"></i></button>
    <h2>Server Settings</h2>
    <div class="form-group">
      <label>Server Name</label>
      <input type="text" id="editServerName" placeholder="Server name">
    </div>
    <button class="btn btn-primary" onclick="saveServerSettings()" style="margin-bottom:16px">Save</button>
    <div class="settings-section danger-zone" style="margin-top:12px">
      <h3>Danger Zone</h3>
      <button class="btn btn-danger btn-sm" onclick="leaveServer()">Leave Server</button>
      <button class="btn btn-danger btn-sm" onclick="deleteServer()" id="deleteServerBtn" style="margin-left:8px;display:none">Delete Server</button>
    </div>
  </div>
</div>

<!-- Image Preview -->
<div class="image-preview" id="imagePreview" onclick="this.classList.remove('active')">
  <img id="imagePreviewImg" src="">
</div>

<!-- Context Menu -->
<div class="context-menu" id="contextMenu">
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
// ==================== FIREBASE INIT ====================
const firebaseConfig = {
  apiKey: "AIzaSyBJMIUucxOusoVzs4lc-QurCxjlW6Hlsuw",
  authDomain: "chat-5f0bf.firebaseapp.com",
  projectId: "chat-5f0bf",
  storageBucket: "chat-5f0bf.firebasestorage.app",
  messagingSenderId: "211425841353",
  appId: "1:211425841353:web:e1c271a340d73abd0cfd18"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ==================== STATE ====================
let currentUser = null;
let currentUserData = null;
let currentView = 'home'; // 'home' or 'server'
let currentServerId = null;
let currentChannelId = null;
let currentDmId = null;
let currentChatType = null; // 'channel' or 'dm'
let messageUnsub = null;
let typingTimeout = null;
let gifSearchTimeout = null;
let pendingImageData = null;
let serverIconData = null;
let usersCache = {};

// ==================== AUTH ====================
function showLogin() {
  document.getElementById('loginPage').style.display = 'flex';
  document.getElementById('registerPage').style.display = 'none';
}
function showRegister() {
  document.getElementById('loginPage').style.display = 'none';
  document.getElementById('registerPage').style.display = 'flex';
}

async function login() {
  const email = document.getElementById('loginEmail').value.trim();
  const pw = document.getElementById('loginPassword').value;
  if (!email || !pw) return alert('Please fill in all fields.');
  try {
    await auth.signInWithEmailAndPassword(email, pw);
  } catch(e) { alert(e.message); }
}

async function register() {
  const name = document.getElementById('regName').value.trim();
  const email = document.getElementById('regEmail').value.trim();
  const pw = document.getElementById('regPassword').value;
  if (!name || !email || !pw) return alert('Please fill in all fields.');
  try {
    const cred = await auth.createUserWithEmailAndPassword(email, pw);
    await db.collection('users').doc(cred.user.uid).set({
      displayName: name,
      email: email,
      photoURL: '',
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      status: 'online'
    });
  } catch(e) { alert(e.message); }
}

function logout() {
  if (currentUser) {
    db.collection('users').doc(currentUser.uid).update({ status: 'offline' });
  }
  auth.signOut();
}

auth.onAuthStateChanged(async (user) => {
  if (user) {
    currentUser = user;
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('registerPage').style.display = 'none';
    document.getElementById('appContainer').classList.add('active');
    await loadUserData();
    loadServers();
    loadDMs();
    db.collection('users').doc(user.uid).update({ status: 'online' });
  } else {
    currentUser = null;
    currentUserData = null;
    document.getElementById('appContainer').classList.remove('active');
    document.getElementById('loginPage').style.display = 'flex';
    if (messageUnsub) messageUnsub();
  }
});

async function loadUserData() {
  const doc = await db.collection('users').doc(currentUser.uid).get();
  if (doc.exists) {
    currentUserData = doc.data();
    updateUserPanel();
  }
}

function updateUserPanel() {
  if (!currentUserData) return;
  const name = currentUserData.displayName || 'User';
  document.getElementById('userPanelName').textContent = name;
  document.getElementById('userPanelTag').textContent = 'Online';
  const avatarEl = document.getElementById('userPanelAvatar');
  if (currentUserData.photoURL) {
    avatarEl.innerHTML = `<img src="${currentUserData.photoURL}">`;
  } else {
    avatarEl.innerHTML = `<span>${name.charAt(0).toUpperCase()}</span>`;
  }
  document.getElementById('settingsEmail').textContent = currentUserData.email || '';
  document.getElementById('settingsUid').textContent = currentUser.uid;
}

// ==================== USER CACHE ====================
async function getUser(uid) {
  if (usersCache[uid]) return usersCache[uid];
  const doc = await db.collection('users').doc(uid).get();
  if (doc.exists) {
    usersCache[uid] = doc.data();
    return doc.data();
  }
  return { displayName: 'Unknown', photoURL: '' };
}

async function getUserByEmail(email) {
  const snap = await db.collection('users').where('email', '==', email).limit(1).get();
  if (snap.empty) return null;
  const doc = snap.docs[0];
  return { uid: doc.id, ...doc.data() };
}

// ==================== SERVERS ====================
function loadServers() {
  db.collection('servers').where('members', 'array-contains', currentUser.uid)
    .onSnapshot(snap => {
      const container = document.getElementById('serverIcons');
      container.innerHTML = '';
      snap.forEach(doc => {
        const data = doc.data();
        const div = document.createElement('div');
        div.className = `server-icon ${currentServerId === doc.id ? 'active' : ''}`;
        div.title = data.name;
        div.onclick = () => selectServer(doc.id);
        div.oncontextmenu = (e) => showServerContext(e, doc.id, data);
        if (data.iconURL) {
          div.innerHTML = `<img src="${data.iconURL}">`;
        } else {
          div.textContent = data.name ? data.name.charAt(0).toUpperCase() : 'S';
        }
        container.appendChild(div);
      });
      // Add join server button after servers
      const joinDiv = document.createElement('div');
      joinDiv.className = 'server-icon add-server';
      joinDiv.title = 'Join Server';
      joinDiv.innerHTML = '<i class="fas fa-arrow-right-to-bracket"></i>';
      joinDiv.onclick = () => openModal('joinServerModal');
      joinDiv.style.fontSize = '18px';
      // Already have add button, add join below
    });
}

async function createServer() {
  const name = document.getElementById('createServerName').value.trim();
  if (!name) return alert('Please enter a server name.');
  const inviteCode = Math.random().toString(36).substring(2, 8).toUpperCase();
  const serverData = {
    name,
    iconURL: serverIconData || '',
    ownerId: currentUser.uid,
    members: [currentUser.uid],
    inviteCode,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  const ref = await db.collection('servers').add(serverData);
  // Create default general channel
  await db.collection('servers').doc(ref.id).collection('channels').add({
    name: 'general',
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  closeModal('createServerModal');
  document.getElementById('createServerName').value = '';
  serverIconData = null;
  document.getElementById('serverIconUpload').innerHTML = '<i class="fas fa-camera"></i>';
  selectServer(ref.id);
}

async function joinServer() {
  const code = document.getElementById('joinServerCode').value.trim().toUpperCase();
  if (!code) return alert('Enter an invite code.');
  const snap = await db.collection('servers').where('inviteCode', '==', code).limit(1).get();
  if (snap.empty) return alert('Invalid invite code.');
  const doc = snap.docs[0];
  const data = doc.data();
  if (data.members.includes(currentUser.uid)) {
    closeModal('joinServerModal');
    selectServer(doc.id);
    return;
  }
  await db.collection('servers').doc(doc.id).update({
    members: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
  });
  closeModal('joinServerModal');
  document.getElementById('joinServerCode').value = '';
  selectServer(doc.id);
}

async function selectServer(serverId) {
  currentView = 'server';
  currentServerId = serverId;
  currentDmId = null;
  currentChatType = null;
  currentChannelId = null;

  // Update server icon active states
  document.querySelectorAll('.server-icon').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.server-icon.home-btn').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('#serverIcons .server-icon').forEach(el => {
    if (el.title) {
      // We'll use data attribute approach instead
    }
  });

  // Show server sidebar
  document.getElementById('dmSidebar').style.display = 'none';
  document.getElementById('serverSidebar').style.display = '';

  const doc = await db.collection('servers').doc(serverId).get();
  if (!doc.exists) return;
  const data = doc.data();
  document.getElementById('serverNameDisplay').textContent = data.name;

  loadChannels(serverId);
  showEmptyState();
  refreshServerIcons();
}

function refreshServerIcons() {
  setTimeout(() => {
    document.querySelectorAll('#serverIcons .server-icon').forEach(el => el.classList.remove('active'));
    // Mark current
    document.querySelectorAll('#serverIcons .server-icon').forEach(el => {
      // We need to identify which one is current
    });
  }, 100);
}

function loadChannels(serverId) {
  db.collection('servers').doc(serverId).collection('channels')
    .orderBy('createdAt')
    .onSnapshot(snap => {
      const container = document.getElementById('channelList');
      container.innerHTML = '';
      const cat = document.createElement('div');
      cat.className = 'channel-category';
      cat.innerHTML = `TEXT CHANNELS <button class="add-ch" onclick="openModal('createChannelModal')"><i class="fas fa-plus"></i></button>`;
      container.appendChild(cat);

      let firstChannelId = null;
      snap.forEach(doc => {
        if (!firstChannelId) firstChannelId = doc.id;
        const data = doc.data();
        const div = document.createElement('div');
        div.className = `channel-item ${currentChannelId === doc.id ? 'active' : ''}`;
        div.innerHTML = `<i class="fas fa-hashtag"></i><span>${data.name}</span>`;
        div.onclick = () => selectChannel(doc.id, data.name);
        container.appendChild(div);
      });

      // Auto-select first channel if none selected
      if (!currentChannelId && firstChannelId) {
        const firstSnap = snap.docs[0];
        selectChannel(firstSnap.id, firstSnap.data().name);
      }
    });
}

async function createChannel() {
  if (!currentServerId) return;
  const name = document.getElementById('createChannelName').value.trim().toLowerCase().replace(/\s+/g, '-');
  if (!name) return alert('Enter a channel name.');
  await db.collection('servers').doc(currentServerId).collection('channels').add({
    name,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });
  closeModal('createChannelModal');
  document.getElementById('createChannelName').value = '';
}

function selectChannel(channelId, channelName) {
  currentChannelId = channelId;
  currentChatType = 'channel';
  currentDmId = null;

  // Update active states
  document.querySelectorAll('.channel-item').forEach(el => el.classList.remove('active'));
  // Find and mark active (will be updated on next snapshot)

  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('activeChat').style.display = 'flex';
  document.getElementById('activeChat').style.flexDirection = 'column';
  document.getElementById('activeChat').style.flex = '1';
  document.getElementById('chatIcon').innerHTML = '<i class="fas fa-hashtag"></i>';
  document.getElementById('chatName').textContent = channelName;
  document.getElementById('chatTopic').textContent = '';
  document.getElementById('messageInput').placeholder = `Message #${channelName}`;
  document.getElementById('membersToggle').style.display = '';

  loadMessages();
  loadMembers();
}

// ==================== DMS ====================
function goHome() {
  currentView = 'home';
  currentServerId = null;
  currentChannelId = null;
  currentChatType = null;

  document.querySelectorAll('.server-icon').forEach(el => el.classList.remove('active'));
  document.querySelector('.server-icon.home-btn').classList.add('active');

  document.getElementById('dmSidebar').style.display = '';
  document.getElementById('serverSidebar').style.display = 'none';

  if (!currentDmId) showEmptyState();
}

function loadDMs() {
  db.collection('dms').where('members', 'array-contains', currentUser.uid)
    .orderBy('lastMessageAt', 'desc')
    .onSnapshot(async (snap) => {
      const container = document.getElementById('dmList');
      container.innerHTML = '';

      if (snap.empty) {
        container.innerHTML = '<div class="section-label">No conversations yet</div>';
        return;
      }

      container.innerHTML = '<div class="section-label">Direct Messages</div>';

      for (const doc of snap.docs) {
        const data = doc.data();
        const otherUid = data.members.find(m => m !== currentUser.uid);
        const otherUser = await getUser(otherUid);

        const div = document.createElement('div');
        div.className = `dm-item ${currentDmId === doc.id ? 'active' : ''}`;
        div.onclick = () => selectDM(doc.id, otherUser, otherUid);

        const avatarContent = otherUser.photoURL
          ? `<img src="${otherUser.photoURL}">`
          : (otherUser.displayName || 'U').charAt(0).toUpperCase();

        div.innerHTML = `
          <div class="dm-avatar">${avatarContent}</div>
          <div class="dm-info">
            <div class="dm-name">${otherUser.displayName || 'User'}</div>
            <div class="dm-status">${data.lastMessage ? truncate(data.lastMessage, 30) : 'No messages yet'}</div>
          </div>
        `;
        container.appendChild(div);
      }
    });
}

function truncate(str, max) {
  return str.length > max ? str.substring(0, max) + '...' : str;
}

async function createDM() {
  const email = document.getElementById('newDmEmail').value.trim();
  if (!email) return alert('Enter an email address.');
  if (email === currentUserData.email) return alert("You can't message yourself.");

  const targetUser = await getUserByEmail(email);
  if (!targetUser) return alert('User not found.');

  // Check if DM already exists
  const existing = await db.collection('dms')
    .where('members', 'array-contains', currentUser.uid)
    .get();

  let existingDmId = null;
  existing.forEach(doc => {
    const data = doc.data();
    if (data.members.includes(targetUser.uid)) {
      existingDmId = doc.id;
    }
  });

  if (existingDmId) {
    closeModal('newDmModal');
    document.getElementById('newDmEmail').value = '';
    const otherUser = await getUser(targetUser.uid);
    goHome();
    selectDM(existingDmId, otherUser, targetUser.uid);
    return;
  }

  const ref = await db.collection('dms').add({
    members: [currentUser.uid, targetUser.uid],
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    lastMessageAt: firebase.firestore.FieldValue.serverTimestamp(),
    lastMessage: ''
  });

  closeModal('newDmModal');
  document.getElementById('newDmEmail').value = '';
  goHome();
  selectDM(ref.id, targetUser, targetUser.uid);
}

function selectDM(dmId, otherUser, otherUid) {
  currentDmId = dmId;
  currentChatType = 'dm';
  currentChannelId = null;
  currentServerId = null;
  currentView = 'home';

  document.querySelectorAll('.dm-item').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.server-icon').forEach(el => el.classList.remove('active'));
  document.querySelector('.server-icon.home-btn').classList.add('active');
  document.getElementById('dmSidebar').style.display = '';
  document.getElementById('serverSidebar').style.display = 'none';

  document.getElementById('emptyState').style.display = 'none';
  document.getElementById('activeChat').style.display = 'flex';
  document.getElementById('activeChat').style.flexDirection = 'column';
  document.getElementById('activeChat').style.flex = '1';
  document.getElementById('chatIcon').innerHTML = '<i class="fas fa-at"></i>';
  document.getElementById('chatName').textContent = otherUser.displayName || 'User';
  document.getElementById('chatTopic').textContent = '';
  document.getElementById('messageInput').placeholder = `Message ${otherUser.displayName || 'User'}`;
  document.getElementById('membersToggle').style.display = 'none';
  document.getElementById('membersSidebar').classList.remove('active');

  loadMessages();
}

function filterDMs() {
  const q = document.getElementById('dmSearchInput').value.toLowerCase();
  document.querySelectorAll('.dm-item').forEach(el => {
    const name = el.querySelector('.dm-name')?.textContent?.toLowerCase() || '';
    el.style.display = name.includes(q) ? '' : 'none';
  });
}

// ==================== MESSAGES ====================
function loadMessages() {
  if (messageUnsub) messageUnsub();

  const container = document.getElementById('messagesList');
  container.innerHTML = '';

  let collectionPath;
  if (currentChatType === 'channel') {
    collectionPath = db.collection('servers').doc(currentServerId)
      .collection('channels').doc(currentChannelId)
      .collection('messages');
  } else if (currentChatType === 'dm') {
    collectionPath = db.collection('dms').doc(currentDmId)
      .collection('messages');
  } else return;

  messageUnsub = collectionPath.orderBy('createdAt').limitToLast(100)
    .onSnapshot(async (snap) => {
      container.innerHTML = '';

      // Welcome message
      const welcomeDiv = document.createElement('div');
      welcomeDiv.className = 'welcome-msg';
      if (currentChatType === 'channel') {
        welcomeDiv.innerHTML = `<h2>Welcome to #${document.getElementById('chatName').textContent}</h2><p>This is the start of the channel.</p>`;
      } else {
        welcomeDiv.innerHTML = `<h2>${document.getElementById('chatName').textContent}</h2><p>This is the beginning of your conversation.</p>`;
      }
      container.appendChild(welcomeDiv);

      let lastAuthor = null;
      let lastTime = null;

      for (const doc of snap.docs) {
        const data = doc.data();
        const user = await getUser(data.authorId);
        const isGrouped = lastAuthor === data.authorId && lastTime &&
          data.createdAt && (data.createdAt.toMillis() - lastTime < 300000); // 5 min

        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${isGrouped ? 'grouped' : ''}`;
        msgDiv.oncontextmenu = (e) => showMessageContext(e, doc.id, data);

        const time = data.createdAt ? formatTime(data.createdAt.toDate()) : '';
        const fullTime = data.createdAt ? formatFullTime(data.createdAt.toDate()) : '';

        let contentHtml = '';
        if (data.text) {
          contentHtml += `<div class="msg-text">${escapeHtml(data.text)}</div>`;
        }
        if (data.imageURL) {
          contentHtml += `<img class="msg-image" src="${data.imageURL}" onclick="previewImage('${data.imageURL}')">`;
        }
        if (data.gifURL) {
          contentHtml += `<img class="msg-image" src="${data.gifURL}" onclick="previewImage('${data.gifURL}')">`;
        }

        const avatarContent = user.photoURL
          ? `<img src="${user.photoURL}">`
          : (user.displayName || 'U').charAt(0).toUpperCase();

        if (isGrouped) {
          msgDiv.innerHTML = `
            <div class="msg-hover-time">${time}</div>
            <div class="msg-content">${contentHtml}</div>
          `;
        } else {
          msgDiv.innerHTML = `
            <div class="msg-avatar">${avatarContent}</div>
            <div class="msg-content">
              <div class="msg-header">
                <span class="msg-author">${escapeHtml(user.displayName || 'Unknown')}</span>
                <span class="msg-time">${fullTime}</span>
              </div>
              ${contentHtml}
            </div>
          `;
        }

        container.appendChild(msgDiv);
        lastAuthor = data.authorId;
        lastTime = data.createdAt ? data.createdAt.toMillis() : null;
      }

      // Scroll to bottom
      const mc = document.getElementById('messagesContainer');
      mc.scrollTop = mc.scrollHeight;
    });
}

async function sendMessage() {
  const input = document.getElementById('messageInput');
  const text = input.value.trim();

  if (!text && !pendingImageData) return;

  let collectionPath;
  if (currentChatType === 'channel') {
    collectionPath = db.collection('servers').doc(currentServerId)
      .collection('channels').doc(currentChannelId)
      .collection('messages');
  } else if (currentChatType === 'dm') {
    collectionPath = db.collection('dms').doc(currentDmId)
      .collection('messages');
  } else return;

  const msgData = {
    authorId: currentUser.uid,
    text: text,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };

  if (pendingImageData) {
    msgData.imageURL = pendingImageData;
    removeUpload();
  }

  await collectionPath.add(msgData);

  // Update DM last message
  if (currentChatType === 'dm') {
    db.collection('dms').doc(currentDmId).update({
      lastMessage: text || 'ðŸ“· Image',
      lastMessageAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }

  input.value = '';
  autoResize(input);
}

function sendGifMessage(gifUrl) {
  let collectionPath;
  if (currentChatType === 'channel') {
    collectionPath = db.collection('servers').doc(currentServerId)
      .collection('channels').doc(currentChannelId)
      .collection('messages');
  } else if (currentChatType === 'dm') {
    collectionPath = db.collection('dms').doc(currentDmId)
      .collection('messages');
  } else return;

  collectionPath.add({
    authorId: currentUser.uid,
    text: '',
    gifURL: gifUrl,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  if (currentChatType === 'dm') {
    db.collection('dms').doc(currentDmId).update({
      lastMessage: 'GIF',
      lastMessageAt: firebase.firestore.FieldValue.serverTimestamp()
    });
  }

  toggleGifPicker();
}

function handleKeyDown(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 200) + 'px';
}

// ==================== TYPING INDICATOR ====================
function handleTyping() {
  // Simplified - could implement with firebase
}

// ==================== MEMBERS ====================
async function loadMembers() {
  if (currentChatType !== 'channel' || !currentServerId) return;
  const doc = await db.collection('servers').doc(currentServerId).get();
  if (!doc.exists) return;
  const data = doc.data();
  const members = data.members || [];

  document.getElementById('membersCount').textContent = `Members â€” ${members.length}`;
  const container = document.getElementById('membersList');
  container.innerHTML = '';

  for (const uid of members) {
    const user = await getUser(uid);
    const div = document.createElement('div');
    div.className = 'member-item';
    const avatarContent = user.photoURL
      ? `<img src="${user.photoURL}">`
      : (user.displayName || 'U').charAt(0).toUpperCase();
    div.innerHTML = `
      <div class="member-avatar">${avatarContent}</div>
      <span class="member-name">${escapeHtml(user.displayName || 'Unknown')}</span>
    `;
    container.appendChild(div);
  }
}

function toggleMembers() {
  document.getElementById('membersSidebar').classList.toggle('active');
}

// ==================== IMAGE UPLOAD (Base64 - no Firebase Storage) ====================
function triggerImageUpload() {
  document.getElementById('imageUploadInput').click();
}

function handleImageUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  if (file.size > 2 * 1024 * 1024) {
    alert('Image must be under 2MB (stored as base64).');
    return;
  }
  const reader = new FileReader();
  reader.onload = (e) => {
    pendingImageData = e.target.result;
    document.getElementById('uploadPreview').classList.add('active');
    document.getElementById('uploadPreviewImg').src = pendingImageData;
    document.getElementById('uploadPreviewName').textContent = file.name;
  };
  reader.readAsDataURL(file);
  event.target.value = '';
}

function removeUpload() {
  pendingImageData = null;
  document.getElementById('uploadPreview').classList.remove('active');
  document.getElementById('uploadPreviewImg').src = '';
}

// ==================== PFP UPLOAD ====================
function handlePfpUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  if (file.size > 1 * 1024 * 1024) {
    alert('Profile picture must be under 1MB.');
    return;
  }
  const reader = new FileReader();
  reader.onload = (e) => {
    const area = document.getElementById('pfpUploadArea');
    area.innerHTML = `<img src="${e.target.result}"><div class="pfp-overlay"><i class="fas fa-camera"></i></div>`;
    area.dataset.url = e.target.result;
  };
  reader.readAsDataURL(file);
  event.target.value = '';
}

async function saveProfile() {
  const name = document.getElementById('profileDisplayName').value.trim();
  const area = document.getElementById('pfpUploadArea');
  const photoURL = area.dataset.url || currentUserData.photoURL || '';

  const updates = {};
  if (name) updates.displayName = name;
  updates.photoURL = photoURL;

  await db.collection('users').doc(currentUser.uid).update(updates);
  currentUserData = { ...currentUserData, ...updates };
  usersCache[currentUser.uid] = currentUserData;
  updateUserPanel();
  closeModal('profileModal');
}

// ==================== SERVER ICON UPLOAD ====================
function previewServerIcon(event) {
  const file = event.target.files[0];
  if (!file) return;
  if (file.size > 1 * 1024 * 1024) {
    alert('Server icon must be under 1MB.');
    return;
  }
  const reader = new FileReader();
  reader.onload = (e) => {
    serverIconData = e.target.result;
    document.getElementById('serverIconUpload').innerHTML = `<img src="${serverIconData}">`;
  };
  reader.readAsDataURL(file);
  event.target.value = '';
}

// ==================== GIF PICKER (Tenor) ====================
const TENOR_KEY = 'AIzaSyBJMIUucxOusoVzs4lc-QurCxjlW6Hlsuw'; // Using same API key for demo, ideally use a Tenor key

function toggleGifPicker() {
  const picker = document.getElementById('gifPicker');
  picker.classList.toggle('active');
  if (picker.classList.contains('active')) {
    document.getElementById('gifSearchInput').focus();
    loadTrendingGifs();
  }
}

function searchGifsDebounced() {
  clearTimeout(gifSearchTimeout);
  gifSearchTimeout = setTimeout(searchGifs, 400);
}

async function loadTrendingGifs() {
  const grid = document.getElementById('gifGrid');
  grid.innerHTML = '<div class="gif-loading"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
  try {
    const res = await fetch(`https://tenor.googleapis.com/v2/featured?key=${TENOR_KEY}&limit=30&media_filter=tinygif`);
    const data = await res.json();
    renderGifs(data.results);
  } catch(e) {
    grid.innerHTML = '<div class="gif-loading">Search for GIFs above</div>';
  }
}

async function searchGifs() {
  const query = document.getElementById('gifSearchInput').value.trim();
  if (!query) { loadTrendingGifs(); return; }
  const grid = document.getElementById('gifGrid');
  grid.innerHTML = '<div class="gif-loading"><i class="fas fa-spinner fa-spin"></i> Searching...</div>';
  try {
    const res = await fetch(`https://tenor.googleapis.com/v2/search?q=${encodeURIComponent(query)}&key=${TENOR_KEY}&limit=30&media_filter=tinygif`);
    const data = await res.json();
    renderGifs(data.results);
  } catch(e) {
    grid.innerHTML = '<div class="gif-loading">Failed to load GIFs</div>';
  }
}

function renderGifs(results) {
  const grid = document.getElementById('gifGrid');
  grid.innerHTML = '';
  if (!results || results.length === 0) {
    grid.innerHTML = '<div class="gif-loading">No GIFs found</div>';
    return;
  }
  results.forEach(gif => {
    const url = gif.media_formats?.tinygif?.url || gif.media_formats?.gif?.url;
    if (!url) return;
    const img = document.createElement('img');
    img.src = url;
    img.loading = 'lazy';
    img.onclick = () => sendGifMessage(url);
    grid.appendChild(img);
  });
}

// ==================== SERVER SETTINGS ====================
function openServerSettings() {
  if (!currentServerId) return;
  db.collection('servers').doc(currentServerId).get().then(doc => {
    if (!doc.exists) return;
    const data = doc.data();
    document.getElementById('editServerName').value = data.name;
    document.getElementById('deleteServerBtn').style.display =
      data.ownerId === currentUser.uid ? '' : 'none';
    openModal('serverSettingsModal');
  });
}

async function saveServerSettings() {
  const name = document.getElementById('editServerName').value.trim();
  if (!name) return;
  await db.collection('servers').doc(currentServerId).update({ name });
  document.getElementById('serverNameDisplay').textContent = name;
  closeModal('serverSettingsModal');
}

async function leaveServer() {
  if (!confirm('Are you sure you want to leave this server?')) return;
  await db.collection('servers').doc(currentServerId).update({
    members: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
  });
  closeModal('serverSettingsModal');
  goHome();
  showEmptyState();
}

async function deleteServer() {
  if (!confirm('Are you sure you want to DELETE this server? This cannot be undone.')) return;
  await db.collection('servers').doc(currentServerId).delete();
  closeModal('serverSettingsModal');
  goHome();
  showEmptyState();
}

// ==================== INVITE ====================
function openInviteModal() {
  openModal('inviteModal');
}

// Update invite display when modal opens
function updateInviteCode() {
  if (!currentServerId) return;
  db.collection('servers').doc(currentServerId).get().then(doc => {
    if (doc.exists) {
      document.getElementById('inviteCodeDisplay').textContent = doc.data().inviteCode || 'N/A';
    }
  });
}

function copyInvite() {
  const code = document.getElementById('inviteCodeDisplay').textContent;
  navigator.clipboard.writeText(code).then(() => {
    const btn = event.target;
    btn.textContent = 'Copied!';
    setTimeout(() => btn.textContent = 'Copy', 2000);
  });
}

// ==================== CONTEXT MENUS ====================
function showServerContext(e, serverId, data) {
  e.preventDefault();
  const menu = document.getElementById('contextMenu');
  menu.innerHTML = '';
  menu.innerHTML += `<div class="context-menu-item" onclick="openModal('inviteModal');updateInviteCode();closeContext()"><i class="fas fa-user-plus"></i> Invite People</div>`;
  if (data.ownerId === currentUser.uid) {
    menu.innerHTML += `<div class="context-menu-item" onclick="currentServerId='${serverId}';openServerSettings();closeContext()"><i class="fas fa-gear"></i> Server Settings</div>`;
  }
  menu.innerHTML += `<div class="context-menu-item danger" onclick="currentServerId='${serverId}';leaveServer();closeContext()"><i class="fas fa-arrow-right-from-bracket"></i> Leave Server</div>`;
  showContextAt(menu, e);
}

function showMessageContext(e, msgId, data) {
  e.preventDefault();
  const menu = document.getElementById('contextMenu');
  menu.innerHTML = '';
  if (data.text) {
    menu.innerHTML += `<div class="context-menu-item" onclick="navigator.clipboard.writeText('${escapeHtml(data.text).replace(/'/g,"\\'")}');closeContext()"><i class="fas fa-copy"></i> Copy Text</div>`;
  }
  if (data.authorId === currentUser.uid) {
    menu.innerHTML += `<div class="context-menu-item danger" onclick="deleteMessage('${msgId}');closeContext()"><i class="fas fa-trash"></i> Delete Message</div>`;
  }
  showContextAt(menu, e);
}

function showContextAt(menu, e) {
  menu.style.left = Math.min(e.clientX, window.innerWidth - 200) + 'px';
  menu.style.top = Math.min(e.clientY, window.innerHeight - 150) + 'px';
  menu.classList.add('active');
}

function closeContext() {
  document.getElementById('contextMenu').classList.remove('active');
}

document.addEventListener('click', closeContext);

async function deleteMessage(msgId) {
  let collectionPath;
  if (currentChatType === 'channel') {
    collectionPath = db.collection('servers').doc(currentServerId)
      .collection('channels').doc(currentChannelId)
      .collection('messages');
  } else if (currentChatType === 'dm') {
    collectionPath = db.collection('dms').doc(currentDmId)
      .collection('messages');
  } else return;
  await collectionPath.doc(msgId).delete();
}

// ==================== MODALS ====================
function openModal(id) {
  document.getElementById(id).classList.add('active');
  if (id === 'profileModal') {
    document.getElementById('profileDisplayName').value = currentUserData?.displayName || '';
    const area = document.getElementById('pfpUploadArea');
    if (currentUserData?.photoURL) {
      area.innerHTML = `<img src="${currentUserData.photoURL}"><div class="pfp-overlay"><i class="fas fa-camera"></i></div>`;
      area.dataset.url = currentUserData.photoURL;
    } else {
      const letter = (currentUserData?.displayName || 'U').charAt(0).toUpperCase();
      area.innerHTML = `<span id="pfpPreviewLetter" style="font-size:32px;font-weight:700;">${letter}</span><div class="pfp-overlay"><i class="fas fa-camera"></i></div>`;
      area.dataset.url = '';
    }
  }
  if (id === 'inviteModal') {
    updateInviteCode();
  }
}

function closeModal(id) {
  document.getElementById(id).classList.remove('active');
}

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) overlay.classList.remove('active');
  });
});

// ==================== IMAGE PREVIEW ====================
function previewImage(url) {
  document.getElementById('imagePreviewImg').src = url;
  document.getElementById('imagePreview').classList.add('active');
}

// ==================== HELPERS ====================
function showEmptyState() {
  document.getElementById('emptyState').style.display = 'flex';
  document.getElementById('activeChat').style.display = 'none';
  if (messageUnsub) { messageUnsub(); messageUnsub = null; }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function formatTime(date) {
  return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function formatFullTime(date) {
  const now = new Date();
  const isToday = date.toDateString() === now.toDateString();
  const yesterday = new Date(now);
  yesterday.setDate(yesterday.getDate() - 1);
  const isYesterday = date.toDateString() === yesterday.toDateString();

  const time = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  if (isToday) return `Today at ${time}`;
  if (isYesterday) return `Yesterday at ${time}`;
  return `${date.toLocaleDateString()} ${time}`;
}

// Close gif picker on outside click
document.addEventListener('click', (e) => {
  const picker = document.getElementById('gifPicker');
  if (picker.classList.contains('active') && !picker.contains(e.target) && !e.target.closest('.input-actions')) {
    picker.classList.remove('active');
  }
});

// Keyboard shortcut - Escape to close modals
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
    document.getElementById('gifPicker').classList.remove('active');
    document.getElementById('imagePreview').classList.remove('active');
  }
});
</script>
</body>
</html>
